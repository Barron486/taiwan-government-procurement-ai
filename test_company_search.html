<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å¸æœå°‹æ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 30px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="test-box">
        <h2 class="mb-4">ğŸ” å…¬å¸æœå°‹æ¸¬è©¦å·¥å…·</h2>
        
        <div class="alert alert-info">
            <strong>ä½¿ç”¨èªªæ˜ï¼š</strong>è¼¸å…¥å…¬å¸åç¨±ï¼Œç³»çµ±æœƒå˜—è©¦å¤šç¨®æœå°‹ç­–ç•¥ä¾†æ‰¾åˆ°ç›¸é—œæ¨™æ¡ˆã€‚
        </div>

        <div class="mb-3">
            <label class="form-label">å…¬å¸åç¨±ï¼š</label>
            <input type="text" class="form-control" id="companyName" placeholder="ä¾‹å¦‚ï¼šé¾å¾·ç”ŸæŠ€æœ‰é™å…¬å¸" value="é¾å¾·ç”ŸæŠ€æœ‰é™å…¬å¸">
        </div>

        <button class="btn btn-primary btn-lg" onclick="testSearch()">
            <i class="fas fa-search me-2"></i>é–‹å§‹æ¸¬è©¦
        </button>
        <button class="btn btn-secondary btn-lg ms-2" onclick="clearResult()">
            æ¸…é™¤çµæœ
        </button>

        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        const API_BASE = 'https://pcc-api.openfun.app/api';

        function log(message, type = 'info') {
            const result = document.getElementById('result');
            result.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            result.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            result.scrollTop = result.scrollHeight;
        }

        function clearResult() {
            document.getElementById('result').innerHTML = '';
            document.getElementById('result').style.display = 'none';
        }

        async function searchPages(type, query, maxPages = 3) {
            let allResults = [];
            
            for (let page = 1; page <= maxPages; page++) {
                try {
                    const url = `${API_BASE}/searchby${type}?query=${encodeURIComponent(query)}&page=${page}`;
                    log(`è«‹æ±‚: ${url}`, 'info');
                    
                    const response = await fetch(url);
                    log(`å›æ‡‰: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                    
                    if (!response.ok) {
                        if (response.status === 403) {
                            log('âš ï¸ æ”¶åˆ° 403ï¼Œä½†åœ¨ç€è¦½å™¨ä¸­é€™é€šå¸¸ä¸å½±éŸ¿åŠŸèƒ½', 'warning');
                        }
                        break;
                    }
                    
                    const data = await response.json();
                    const records = data.records || [];
                    log(`ç¬¬ ${page} é æ‰¾åˆ° ${records.length} ç­†çµæœ`, 'success');
                    
                    if (records.length === 0) break;
                    
                    allResults = allResults.concat(records);
                } catch (error) {
                    log(`éŒ¯èª¤: ${error.message}`, 'error');
                    break;
                }
            }
            
            return allResults;
        }

        async function testSearch() {
            clearResult();
            const companyName = document.getElementById('companyName').value.trim();
            
            if (!companyName) {
                alert('è«‹è¼¸å…¥å…¬å¸åç¨±');
                return;
            }

            log(`========================================`, 'info');
            log(`é–‹å§‹æœå°‹: ${companyName}`, 'info');
            log(`========================================`, 'info');

            // å®šç¾©æœå°‹ç­–ç•¥
            const strategies = [
                { query: companyName, desc: 'å®Œæ•´å…¬å¸åç¨±' },
                { query: companyName.replace(/è‚¡ä»½æœ‰é™å…¬å¸|æœ‰é™å…¬å¸/g, '').trim(), desc: 'ç°¡åŒ–å…¬å¸åç¨±' },
                { query: companyName.split(' ')[0], desc: 'ç¬¬ä¸€éƒ¨åˆ†' },
                { query: companyName.replace(/\(.*\)/g, '').trim(), desc: 'ç§»é™¤æ‹¬è™Ÿ' }
            ];

            // æå–ä¸­æ–‡é—œéµå­—
            const keywords = companyName.match(/[\u4e00-\u9fff]+/g);
            if (keywords) {
                keywords.forEach(keyword => {
                    if (keyword.length >= 2 && keyword.length <= 6) {
                        strategies.push({ query: keyword, desc: `é—œéµå­—: ${keyword}` });
                    }
                });
            }

            let totalResults = [];
            let successCount = 0;

            // å˜—è©¦æ¯å€‹ç­–ç•¥
            for (const strategy of strategies) {
                if (!strategy.query || strategy.query.length < 2) continue;
                
                log(`\n--- ç­–ç•¥: ${strategy.desc} ---`, 'info');
                log(`æœå°‹é—œéµå­—: "${strategy.query}"`, 'info');
                
                try {
                    const results = await searchPages('companyname', strategy.query, 3);
                    
                    if (results.length > 0) {
                        log(`âœ“ æˆåŠŸï¼æ‰¾åˆ° ${results.length} ç­†çµæœ`, 'success');
                        totalResults = totalResults.concat(results);
                        successCount++;
                        
                        // é¡¯ç¤ºå‰3ç­†ç¯„ä¾‹
                        log(`ç¯„ä¾‹æ¨™æ¡ˆ:`, 'info');
                        results.slice(0, 3).forEach((r, i) => {
                            log(`  ${i+1}. ${r.brief?.title || 'ç„¡æ¨™é¡Œ'} (${r.date || 'æœªçŸ¥æ—¥æœŸ'})`, 'info');
                        });
                    } else {
                        log(`âœ— æ²’æœ‰æ‰¾åˆ°çµæœ`, 'warning');
                    }
                } catch (error) {
                    log(`âœ— æœå°‹å¤±æ•—: ${error.message}`, 'error');
                }
            }

            // å»é‡è¤‡
            const seen = new Set();
            const uniqueResults = totalResults.filter(r => {
                const key = `${r.unit_id}-${r.job_number}-${r.date}`;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });

            // æœ€çµ‚çµæœ
            log(`\n========================================`, 'info');
            log(`æ¸¬è©¦å®Œæˆï¼`, 'info');
            log(`========================================`, 'info');
            log(`æˆåŠŸçš„ç­–ç•¥æ•¸: ${successCount}/${strategies.length}`, 'info');
            log(`ç¸½å…±æ‰¾åˆ°: ${totalResults.length} ç­†è³‡æ–™`, 'info');
            log(`å»é‡è¤‡å¾Œ: ${uniqueResults.length} ç­†è³‡æ–™`, uniqueResults.length > 0 ? 'success' : 'error');

            if (uniqueResults.length === 0) {
                log(`\nâš ï¸ çµè«–: æœªæ‰¾åˆ°ä»»ä½•è³‡æ–™`, 'error');
                log(`\nå¯èƒ½åŸå› :`, 'warning');
                log(`1. API æœå‹™çœŸçš„ç„¡æ³•ä½¿ç”¨`, 'warning');
                log(`2. å…¬å¸åç¨±ä¸æ­£ç¢º`, 'warning');
                log(`3. è©²å…¬å¸æ²’æœ‰æ”¿åºœæ¡è³¼è¨˜éŒ„`, 'warning');
                log(`\nå»ºè­°:`, 'info');
                log(`1. æŒ‰ F12 é–‹å•Ÿé–‹ç™¼è€…å·¥å…·ï¼ŒæŸ¥çœ‹ Network æ¨™ç±¤`, 'info');
                log(`2. ç¢ºèªæ˜¯å¦æœ‰ API è«‹æ±‚æˆåŠŸè¿”å›`, 'info');
                log(`3. å˜—è©¦å…¶ä»–å…¬å¸åç¨±æ¸¬è©¦`, 'info');
            } else {
                log(`\nâœ“ çµè«–: API æ­£å¸¸é‹ä½œï¼ŒæˆåŠŸæ‰¾åˆ°è³‡æ–™ï¼`, 'success');
                log(`\nå¦‚æœ company_analysis.html é‚„æ˜¯å¤±æ•—ï¼Œè«‹ï¼š`, 'info');
                log(`1. æ¸…é™¤ç€è¦½å™¨å¿«å–`, 'info');
                log(`2. é‡æ–°æ•´ç†é é¢`, 'info');
                log(`3. æª¢æŸ¥æ˜¯å¦æœ‰ JavaScript éŒ¯èª¤`, 'info');
            }
        }
    </script>
</body>
</html>
