<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公司搜尋測試</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 30px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="test-box">
        <h2 class="mb-4">🔍 公司搜尋測試工具</h2>
        
        <div class="alert alert-info">
            <strong>使用說明：</strong>輸入公司名稱，系統會嘗試多種搜尋策略來找到相關標案。
        </div>

        <div class="mb-3">
            <label class="form-label">公司名稱：</label>
            <input type="text" class="form-control" id="companyName" placeholder="例如：龐德生技有限公司" value="龐德生技有限公司">
        </div>

        <button class="btn btn-primary btn-lg" onclick="testSearch()">
            <i class="fas fa-search me-2"></i>開始測試
        </button>
        <button class="btn btn-secondary btn-lg ms-2" onclick="clearResult()">
            清除結果
        </button>

        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script>
        const API_BASE = 'https://pcc-api.openfun.app/api';

        function log(message, type = 'info') {
            const result = document.getElementById('result');
            result.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            result.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            result.scrollTop = result.scrollHeight;
        }

        function clearResult() {
            document.getElementById('result').innerHTML = '';
            document.getElementById('result').style.display = 'none';
        }

        async function searchPages(type, query, maxPages = 3) {
            let allResults = [];
            
            for (let page = 1; page <= maxPages; page++) {
                try {
                    const url = `${API_BASE}/searchby${type}?query=${encodeURIComponent(query)}&page=${page}`;
                    log(`請求: ${url}`, 'info');
                    
                    const response = await fetch(url);
                    log(`回應: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                    
                    if (!response.ok) {
                        if (response.status === 403) {
                            log('⚠️ 收到 403，但在瀏覽器中這通常不影響功能', 'warning');
                        }
                        break;
                    }
                    
                    const data = await response.json();
                    const records = data.records || [];
                    log(`第 ${page} 頁找到 ${records.length} 筆結果`, 'success');
                    
                    if (records.length === 0) break;
                    
                    allResults = allResults.concat(records);
                } catch (error) {
                    log(`錯誤: ${error.message}`, 'error');
                    break;
                }
            }
            
            return allResults;
        }

        async function testSearch() {
            clearResult();
            const companyName = document.getElementById('companyName').value.trim();
            
            if (!companyName) {
                alert('請輸入公司名稱');
                return;
            }

            log(`========================================`, 'info');
            log(`開始搜尋: ${companyName}`, 'info');
            log(`========================================`, 'info');

            // 定義搜尋策略
            const strategies = [
                { query: companyName, desc: '完整公司名稱' },
                { query: companyName.replace(/股份有限公司|有限公司/g, '').trim(), desc: '簡化公司名稱' },
                { query: companyName.split(' ')[0], desc: '第一部分' },
                { query: companyName.replace(/\(.*\)/g, '').trim(), desc: '移除括號' }
            ];

            // 提取中文關鍵字
            const keywords = companyName.match(/[\u4e00-\u9fff]+/g);
            if (keywords) {
                keywords.forEach(keyword => {
                    if (keyword.length >= 2 && keyword.length <= 6) {
                        strategies.push({ query: keyword, desc: `關鍵字: ${keyword}` });
                    }
                });
            }

            let totalResults = [];
            let successCount = 0;

            // 嘗試每個策略
            for (const strategy of strategies) {
                if (!strategy.query || strategy.query.length < 2) continue;
                
                log(`\n--- 策略: ${strategy.desc} ---`, 'info');
                log(`搜尋關鍵字: "${strategy.query}"`, 'info');
                
                try {
                    const results = await searchPages('companyname', strategy.query, 3);
                    
                    if (results.length > 0) {
                        log(`✓ 成功！找到 ${results.length} 筆結果`, 'success');
                        totalResults = totalResults.concat(results);
                        successCount++;
                        
                        // 顯示前3筆範例
                        log(`範例標案:`, 'info');
                        results.slice(0, 3).forEach((r, i) => {
                            log(`  ${i+1}. ${r.brief?.title || '無標題'} (${r.date || '未知日期'})`, 'info');
                        });
                    } else {
                        log(`✗ 沒有找到結果`, 'warning');
                    }
                } catch (error) {
                    log(`✗ 搜尋失敗: ${error.message}`, 'error');
                }
            }

            // 去重複
            const seen = new Set();
            const uniqueResults = totalResults.filter(r => {
                const key = `${r.unit_id}-${r.job_number}-${r.date}`;
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });

            // 最終結果
            log(`\n========================================`, 'info');
            log(`測試完成！`, 'info');
            log(`========================================`, 'info');
            log(`成功的策略數: ${successCount}/${strategies.length}`, 'info');
            log(`總共找到: ${totalResults.length} 筆資料`, 'info');
            log(`去重複後: ${uniqueResults.length} 筆資料`, uniqueResults.length > 0 ? 'success' : 'error');

            if (uniqueResults.length === 0) {
                log(`\n⚠️ 結論: 未找到任何資料`, 'error');
                log(`\n可能原因:`, 'warning');
                log(`1. API 服務真的無法使用`, 'warning');
                log(`2. 公司名稱不正確`, 'warning');
                log(`3. 該公司沒有政府採購記錄`, 'warning');
                log(`\n建議:`, 'info');
                log(`1. 按 F12 開啟開發者工具，查看 Network 標籤`, 'info');
                log(`2. 確認是否有 API 請求成功返回`, 'info');
                log(`3. 嘗試其他公司名稱測試`, 'info');
            } else {
                log(`\n✓ 結論: API 正常運作，成功找到資料！`, 'success');
                log(`\n如果 company_analysis.html 還是失敗，請：`, 'info');
                log(`1. 清除瀏覽器快取`, 'info');
                log(`2. 重新整理頁面`, 'info');
                log(`3. 檢查是否有 JavaScript 錯誤`, 'info');
            }
        }
    </script>
</body>
</html>
