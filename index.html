<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>å°ç£æ”¿åºœæ¡è³¼å…¬å‘ŠæŸ¥è©¢ç³»çµ± - AI åˆ†æç‰ˆ</title>
    
    <!-- API é…ç½® - å¿…é ˆåœ¨å…¶ä»– script ä¹‹å‰è¼‰å…¥ -->
    <script src="config.js"></script>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
        }
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 1400px;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .search-section {
            padding: 30px;
        }
        .time-shortcuts {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .time-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .time-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        .time-btn.active {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 15px 40px;
            font-weight: 600;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        .result-item {
            border: none;
            border-radius: 15px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            padding: 25px;
            transition: all 0.3s ease;
        }
        .result-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        .ai-analysis {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        .ai-loading {
            text-align: center;
            padding: 20px;
        }
        .spinner-border {
            width: 2rem;
            height: 2rem;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .company-btn {
            transition: all 0.2s ease;
        }
        .company-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .company-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.8rem;
            margin: 2px;
            display: inline-block;
        }
        .ai-insights {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
        }
        .ai-insights h6 {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .date-range {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .date-range h6 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        .date-display {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1976d2;
        }
        
        /* å½ˆå‡ºå¼é€šçŸ¥æ¨£å¼ */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            max-width: 500px;
            width: 90%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease-out;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }
        
        .notification.success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
        }
        
        .notification.info {
            background: linear-gradient(135deg, #339af0 0%, #228be6 100%);
            color: white;
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
            color: #333;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px 10px;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin: 0;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .notification-close:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        .notification-body {
            padding: 0 20px 15px;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .notification-actions {
            padding-top: 10px;
            margin-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        
        .notification-actions .btn {
            background: rgba(255,255,255,0.9);
            border: none;
            color: #333;
            font-weight: 600;
        }
        
        .notification-actions .btn:hover {
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .notification-actions .btn.btn-success {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 15px;
            }
            .time-shortcuts {
                justify-content: center;
            }
            .time-btn {
                flex: 1;
                min-width: 80px;
            }
        }
        /* å°è©±çª—å£æ¨£å¼ */
        .chat-message {
            margin-bottom: 15px;
        }
        
        .user-message .message-content {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 18px 18px 4px 18px;
            display: inline-block;
            max-width: 80%;
            margin-left: auto;
        }
        
        .bot-message .message-content {
            background: #f8f9fa;
            color: #333;
            padding: 10px 15px;
            border-radius: 18px 18px 18px 4px;
            display: inline-block;
            max-width: 80%;
            border: 1px solid #dee2e6;
        }
        
        .chat-messages {
            scroll-behavior: smooth;
        }
        
        .message-text {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-search me-3"></i>å°ç£æ”¿åºœæ¡è³¼å…¬å‘ŠæŸ¥è©¢ç³»çµ±</h1>
            <p><i class="fas fa-robot me-2"></i>AI æ™ºèƒ½åˆ†æç‰ˆ - ç›´æ¥é€£æ¥æ”¿åºœæ¡è³¼ API</p>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <!-- Search Form -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-search me-2"></i>æœå°‹æ¢ä»¶
                    </h5>
                    
                    <!-- æœå°‹é—œéµå­—æ¬„ä½ -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="titleQuery" class="form-label fw-bold">æ¨™æ¡ˆåç¨±</label>
                            <input type="text" class="form-control" id="titleQuery" placeholder="è¼¸å…¥æ¨™æ¡ˆåç¨±é—œéµå­—">
                        </div>
                        <div class="col-md-3">
                            <label for="companyNameQuery" class="form-label fw-bold">å…¬å¸åç¨±</label>
                            <input type="text" class="form-control" id="companyNameQuery" placeholder="è¼¸å…¥å…¬å¸åç¨±é—œéµå­—">
                        </div>
                        <div class="col-md-3">
                            <label for="companyIdQuery" class="form-label fw-bold">çµ±ä¸€ç·¨è™Ÿ</label>
                            <input type="text" class="form-control" id="companyIdQuery" placeholder="è¼¸å…¥çµ±ä¸€ç·¨è™Ÿ">
                        </div>
                        <div class="col-md-3">
                            <label for="unitQuery" class="form-label fw-bold">æ©Ÿé—œä»£ç¢¼</label>
                            <input type="text" class="form-control" id="unitQuery" placeholder="è¼¸å…¥æ©Ÿé—œä»£ç¢¼">
                        </div>
                    </div>
                    
                    <!-- æœå°‹é‚è¼¯é¸æ“‡ -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <label class="form-label fw-bold">æœå°‹é‚è¼¯</label>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="searchLogic" id="searchAnd" value="and" checked>
                                <label class="btn btn-outline-primary" for="searchAnd">
                                    <i class="fas fa-plus me-1"></i>AND (ä¸”)
                                </label>
                                
                                <input type="radio" class="btn-check" name="searchLogic" id="searchOr" value="or">
                                <label class="btn btn-outline-success" for="searchOr">
                                    <i class="fas fa-arrows-alt-h me-1"></i>OR (æˆ–)
                                </label>
                            </div>
                            <small class="form-text text-muted ms-2">
                                ANDï¼šæ‰€æœ‰æ¢ä»¶éƒ½å¿…é ˆç¬¦åˆ | ORï¼šä»»ä¸€æ¢ä»¶ç¬¦åˆå³å¯
                            </small>
                        </div>
                    </div>
                    
                    <!-- æ—¥æœŸå€é–“é¸æ“‡ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="startDate" class="form-label fw-bold">é–‹å§‹æ—¥æœŸ</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-6">
                            <label for="endDate" class="form-label fw-bold">çµæŸæ—¥æœŸ</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                    
                    <!-- å¿«é€Ÿæ—¥æœŸé¸æ“‡å’Œæ¨™æ¡ˆé¡å‹ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">å¿«é€Ÿé¸æ“‡æ—¥æœŸç¯„åœ</label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('today')">ä»Šæ—¥</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('last3days')">è¿‘3å¤©</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('last7days')">è¿‘7å¤©</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('last30days')">è¿‘30å¤©</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('thisYear')">æœ¬å¹´è‡³ä»Š</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('all')">å…¨éƒ¨</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">æ¨™æ¡ˆé¡å‹</label>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="tenderType" id="allType" value="all" checked>
                                <label class="btn btn-outline-primary" for="allType">å…¨éƒ¨</label>
                                
                                <input type="radio" class="btn-check" name="tenderType" id="openType" value="open">
                                <label class="btn btn-outline-success" for="openType">é–‹æ¨™</label>
                                
                                <input type="radio" class="btn-check" name="tenderType" id="awardType" value="award">
                                <label class="btn btn-outline-warning" for="awardType">æ±ºæ¨™</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- API Key è¨­å®š -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="geminiKey" class="form-label fw-bold">Gemini API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="geminiKey" placeholder="è¼¸å…¥æ‚¨çš„ Gemini API Key">
                                <button class="btn btn-outline-info" type="button" onclick="showGeminiHelp()" title="å¦‚ä½•å–å¾— Gemini API Key">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="chatgptKey" class="form-label fw-bold">ChatGPT API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="chatgptKey" placeholder="è¼¸å…¥æ‚¨çš„ ChatGPT API Key">
                                <button class="btn btn-outline-info" type="button" onclick="showChatGPTHelp()" title="å¦‚ä½•å–å¾— ChatGPT API Key">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æœå°‹æŒ‰éˆ• -->
                    <div class="row">
                        <div class="col-12 d-flex justify-content-between align-items-center">
                            <div>
                                <button type="button" class="btn btn-primary btn-lg me-3" onclick="performSearch()">
                                    <i class="fas fa-search me-2"></i>æœå°‹æ¨™æ¡ˆ
                                </button>
                                <button type="button" class="btn btn-success btn-lg me-3" onclick="performGeminiAgentSearch()" id="geminiAgentBtn" disabled>
                                    <i class="fas fa-robot me-2"></i>Gemini Agent æœå°‹
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg me-3" onclick="clearSearch()">
                                    <i class="fas fa-times me-2"></i>æ¸…é™¤
                                </button>
                                <button type="button" class="btn btn-info btn-lg me-3" onclick="showSearchHelp()">
                                    <i class="fas fa-question-circle me-2"></i>æœå°‹èªªæ˜
                                </button>
                                <button type="button" class="btn btn-warning btn-lg" onclick="toggleAutoMonitor()">
                                    <i class="fas fa-clock me-2"></i>è‡ªå‹•ç›£æ§
                                </button>
                            </div>
                            <div class="text-muted small">
                                <i class="fas fa-info-circle me-1"></i>
                                å¯åŒæ™‚ä½¿ç”¨å¤šå€‹æœå°‹æ¢ä»¶ï¼Œç³»çµ±æœƒè‡ªå‹•çµ„åˆæœå°‹
                            </div>
                        </div>
                    </div>
                    
                    <!-- è‡ªå‹•ç›£æ§è¨­å®šå€å¡Š -->
                    <div id="autoMonitorSection" class="mt-4" style="display: none;">
                        <div class="card border-warning">
                            <div class="card-header bg-warning bg-opacity-10 border-warning">
                                <h5 class="mb-0">
                                    <i class="fas fa-bell me-2"></i>è‡ªå‹•ç›£æ§è¨­å®š
                                    <span class="badge bg-success ms-2" id="monitorStatus">å·²åœç”¨</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- ç›£æ§é—œéµå­—è¨­å®š -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-tags me-1"></i>ç›£æ§é—œéµå­—
                                        <small class="text-muted">(æ¯è¡Œä¸€å€‹é—œéµå­—)</small>
                                    </label>
                                    <textarea class="form-control" id="monitorKeywords" rows="5" 
                                              placeholder="è¼¸å…¥è¦ç›£æ§çš„é—œéµå­—ï¼Œæ¯è¡Œä¸€å€‹&#10;ä¾‹å¦‚ï¼š&#10;é†«ç™‚è¨­å‚™&#10;è³‡è¨Šç³»çµ±&#10;è¾¦å…¬ç”¨å“"></textarea>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>ç³»çµ±æœƒä½¿ç”¨é€™äº›é—œéµå­—æœå°‹æ¨™æ¡ˆåç¨±
                                    </small>
                                </div>
                                
                                <!-- ç›£æ§æ™‚é–“è¨­å®š -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-clock me-1"></i>è‡ªå‹•æœå°‹æ™‚é–“
                                    </label>
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="monitor08" checked>
                                                <label class="form-check-label" for="monitor08">
                                                    <i class="fas fa-sun me-1 text-warning"></i>æ¯å¤© 08:00 è‡ªå‹•æœå°‹
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="monitor17" checked>
                                                <label class="form-check-label" for="monitor17">
                                                    <i class="fas fa-moon me-1 text-info"></i>æ¯å¤© 17:00 è‡ªå‹•æœå°‹
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- ç›£æ§ç¯„åœè¨­å®š -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-calendar me-1"></i>æœå°‹ç¯„åœ
                                    </label>
                                    <select class="form-select" id="monitorDateRange">
                                        <option value="today" selected>åƒ…ä»Šæ—¥</option>
                                        <option value="last3days">æœ€è¿‘3å¤©</option>
                                        <option value="last7days">æœ€è¿‘7å¤©</option>
                                    </select>
                                </div>
                                
                                <!-- é€šçŸ¥è¨­å®š -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-bell me-1"></i>é€šçŸ¥è¨­å®š
                                    </label>
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="monitorNotifyBrowser" checked>
                                        <label class="form-check-label" for="monitorNotifyBrowser">
                                            <i class="fas fa-desktop me-1"></i>ç€è¦½å™¨é€šçŸ¥ï¼ˆéœ€æˆæ¬Šï¼‰
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="monitorNotifySound" checked>
                                        <label class="form-check-label" for="monitorNotifySound">
                                            <i class="fas fa-volume-up me-1"></i>è²éŸ³æé†’
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“é¡¯ç¤º -->
                                <div class="alert alert-info mb-4">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>ä¸‹æ¬¡è‡ªå‹•æœå°‹æ™‚é–“ï¼š</strong>
                                    <span id="nextAutoSearch">æœªå•Ÿç”¨</span>
                                </div>
                                
                                <!-- æ§åˆ¶æŒ‰éˆ• -->
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-success" onclick="startAutoMonitor()">
                                        <i class="fas fa-play me-1"></i>å•Ÿå‹•ç›£æ§
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="stopAutoMonitor()">
                                        <i class="fas fa-stop me-1"></i>åœæ­¢ç›£æ§
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="testAutoMonitor()">
                                        <i class="fas fa-vial me-1"></i>ç«‹å³æ¸¬è©¦
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="saveMonitorSettings()">
                                        <i class="fas fa-save me-1"></i>å„²å­˜è¨­å®š
                                    </button>
                                    <button type="button" class="btn btn-info" onclick="showMonitorHistory()">
                                        <i class="fas fa-history me-1"></i>ç›£æ§è¨˜éŒ„
                                    </button>
                                </div>
                                
                                <!-- ç›£æ§çµ±è¨ˆ -->
                                <div class="mt-4 p-3 bg-light rounded">
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <i class="fas fa-search fa-2x text-primary"></i>
                                            </div>
                                            <div class="fw-bold" id="monitorSearchCount">0</div>
                                            <small class="text-muted">ä»Šæ—¥æœå°‹æ¬¡æ•¸</small>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <i class="fas fa-file-alt fa-2x text-success"></i>
                                            </div>
                                            <div class="fw-bold" id="monitorResultCount">0</div>
                                            <small class="text-muted">ç™¼ç¾æ¨™æ¡ˆæ•¸</small>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <i class="fas fa-star fa-2x text-warning"></i>
                                            </div>
                                            <div class="fw-bold" id="monitorNewCount">0</div>
                                            <small class="text-muted">æ–°å¢æ¨™æ¡ˆæ•¸</small>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <i class="fas fa-clock fa-2x text-info"></i>
                                            </div>
                                            <div class="fw-bold" id="monitorLastTime">--:--</div>
                                            <small class="text-muted">æœ€å¾Œæœå°‹æ™‚é–“</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center mt-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                </div>
                <p class="mt-3 mb-0">æ­£åœ¨æœå°‹æ”¿åºœæ¡è³¼è³‡æ–™...</p>
            </div>

            <!-- AI Analysis Loading -->
            <div id="aiLoading" class="ai-loading" style="display: none;">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">AI åˆ†æä¸­...</span>
                </div>
                <p class="mt-3 mb-0"><i class="fas fa-robot me-2"></i>Gemini AI æ­£åœ¨åˆ†ææ¨™æ¡ˆå…§å®¹...</p>
            </div>

            <!-- Messages -->
            <div id="messageArea"></div>

            <!-- Search Results -->
            <div id="searchResults" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list me-2"></i>æœå°‹çµæœ</h5>
                            <div class="d-flex align-items-center">
                                <div id="resultStats" class="text-muted me-3"></div>
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearSearchResults()" title="æ¸…é™¤æœå°‹çµæœ">
                                    <i class="fas fa-times me-1"></i>æ¸…é™¤çµæœ
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- æœå°‹çµæœéæ¿¾å™¨ -->
                        <div class="row mb-3" id="resultFilters" style="display: none;">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">éæ¿¾æ¨™æ¡ˆé¡å‹</label>
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="resultFilter" id="filterAll" value="all" checked>
                                    <label class="btn btn-outline-primary" for="filterAll">å…¨éƒ¨</label>
                                    
                                    <input type="radio" class="btn-check" name="resultFilter" id="filterOpen" value="open">
                                    <label class="btn btn-outline-success" for="filterOpen">é–‹æ¨™</label>
                                    
                                    <input type="radio" class="btn-check" name="resultFilter" id="filterAward" value="award">
                                    <label class="btn btn-outline-danger" for="filterAward">æ±ºæ¨™</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">æ’åºæ–¹å¼</label>
                                <select class="form-select" id="sortBy" onchange="sortResults()">
                                    <option value="date_desc">æ—¥æœŸï¼ˆæ–°åˆ°èˆŠï¼‰</option>
                                    <option value="date_asc">æ—¥æœŸï¼ˆèˆŠåˆ°æ–°ï¼‰</option>
                                    <option value="title">æ¨™æ¡ˆåç¨±</option>
                                    <option value="unit">æ©Ÿé—œåç¨±</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div id="resultStats" class="text-muted me-3"></div>
                            <div class="d-flex align-items-center gap-2">
                                <label for="pageSize" class="form-label mb-0">æ¯é é¡¯ç¤º</label>
                                <select id="pageSize" class="form-select form-select-sm" style="width: auto;" onchange="changePageSize(this.value)">
                                    <option value="10">10ç­†</option>
                                    <option value="50">50ç­†</option>
                                    <option value="100">100ç­†</option>
                                </select>
                            </div>
                        </div>
                        <div id="resultsList"></div>
                        <div id="pagination" class="mt-4"></div>
                    </div>
                </div>
            </div>

            <!-- AI Analysis Results -->
            <div id="aiAnalysisResults" class="mt-4" style="display: none;">
                <div class="ai-analysis">
                    <h5><i class="fas fa-robot me-2"></i>Gemini AI åˆ†æçµæœ</h5>
                    <div id="aiContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI å°è©±çª—å£ -->
    <div class="modal fade" id="chatModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-comments me-2"></i>AI å°è©±åŠ©æ‰‹</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="chatMessages" class="chat-messages" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: #f8f9fa;">
                        <!-- å°è©±å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                    <div class="input-group">
                        <input type="text" id="chatInput" class="form-control" placeholder="è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ..." onkeypress="handleChatKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendChatMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = 'https://pcc-api.openfun.app/api';
        // API é…ç½®ï¼šæ ¹æ“šç’°å¢ƒè‡ªå‹•åˆ‡æ›
        const USE_PROXY = window.API_CONFIG && window.API_CONFIG.getApiBase();
        const API_PROXY = USE_PROXY || null;
        const API_BASES = USE_PROXY ? [] : [
            'https://pcc-api.openfun.app/api',
            'https://pcc.g0v.ronny.tw/api'
        ];

        console.log('ğŸ”§ API æ¨¡å¼:', USE_PROXY ? 'ä½¿ç”¨ Vercel ä»£ç†' : 'ç›´æ¥å‘¼å« API');

        // ä»¥å¤šå€‹ API_BASES é€²è¡Œé€¾æ™‚+é‡è©¦+å‚™æ´åˆ‡æ›ï¼ˆæˆ–ä½¿ç”¨ä»£ç†ï¼‰
        async function fetchFromApis(path, options = {}, timeoutMs = 10000, retriesPerBase = 2) {
            let lastError = null;
            const tried = [];
            
            // å¦‚æœä½¿ç”¨ä»£ç†æ¨¡å¼
            if (API_PROXY) {
                const url = window.API_CONFIG.buildUrl(path, extractParams(path));
                tried.push(url);
                
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
                    
                    const resp = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!resp.ok) {
                        const errorText = await resp.text();
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText} - ${errorText}`);
                    }
                    
                    console.log('âœ… API ä»£ç†è«‹æ±‚æˆåŠŸ');
                    return { resp, url };
                    
                } catch (err) {
                    lastError = err;
                    console.error('âŒ API ä»£ç†è«‹æ±‚å¤±æ•—:', err.message);
                    throw new Error(`API ä»£ç†å¤±æ•—: ${err.message}`);
                }
            }
            
            // ç›´æ¥ API æ¨¡å¼ï¼ˆæœ¬åœ°é–‹ç™¼ï¼‰
            for (const base of API_BASES) {
                for (let attempt = 1; attempt <= retriesPerBase; attempt++) {
                    const url = `${base}${path}`;
                    tried.push(url);
                    
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
                        
                        const resp = await fetch(url, { 
                            ...options, 
                            signal: controller.signal 
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!resp.ok) {
                            const errorText = await resp.text();
                            throw new Error(`HTTP ${resp.status}: ${resp.statusText} - ${errorText}`);
                        }
                        
                        return { resp, url };
                    } catch (err) {
                        lastError = err;
                        console.warn(`API è«‹æ±‚å¤±æ•— (ä¾†æº: ${base}, å˜—è©¦ ${attempt}/${retriesPerBase}): ${err.message}`);
                        
                        // å¦‚æœé‚„æœ‰é‡è©¦æ©Ÿæœƒï¼Œç­‰å¾…å¾Œé‡è©¦
                        if (attempt < retriesPerBase) {
                            await new Promise(r => setTimeout(r, attempt * 800));
                        }
                    }
                }
            }
            
            const errorMessage = `æ‰€æœ‰ API ä¾†æºå‡å¤±æ•—ã€‚æœ€å¾ŒéŒ¯èª¤: ${lastError?.message || 'æœªçŸ¥éŒ¯èª¤'}. å·²å˜—è©¦ä¾†æº: ${tried.join(' , ')}`;
            throw new Error(errorMessage);
        }
        
        // å¾è·¯å¾‘ä¸­æå–åƒæ•¸
        function extractParams(path) {
            const params = {};
            if (path.includes('?')) {
                const [basePath, queryString] = path.split('?');
                const urlParams = new URLSearchParams(queryString);
                for (const [key, value] of urlParams) {
                    params[key] = value;
                }
                // è¿”å›æ²’æœ‰åƒæ•¸çš„è·¯å¾‘
                return params;
            }
            return {};
        }
        let currentTimeRange = 0; // 0 = ä»Šæ—¥
        let searchResults = [];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¨­ç½®é è¨­æ—¥æœŸç‚ºä»Šæ—¥
            setDateRange('today');
            
            // æ·»åŠ éæ¿¾å™¨äº‹ä»¶ç›£è½å™¨
            document.querySelectorAll('input[name="resultFilter"]').forEach(radio => {
                radio.addEventListener('change', filterAndDisplayResults);
            });
            
            // ç›£è½ Gemini API Key è¼¸å…¥
            const geminiKeyInput = document.getElementById('geminiKey');
            const geminiAgentBtn = document.getElementById('geminiAgentBtn');
            
            geminiKeyInput.addEventListener('input', function() {
                if (this.value.trim().length > 0) {
                    geminiAgentBtn.disabled = false;
                    geminiAgentBtn.classList.remove('btn-success');
                    geminiAgentBtn.classList.add('btn-success');
                } else {
                    geminiAgentBtn.disabled = true;
                    geminiAgentBtn.classList.remove('btn-success');
                    geminiAgentBtn.classList.add('btn-secondary');
                }
            });
            
            showMessage('æ­¡è¿ä½¿ç”¨ AI æ™ºèƒ½åˆ†æç‰ˆï¼è«‹è¼¸å…¥æœå°‹æ¢ä»¶é–‹å§‹æœå°‹ã€‚', 'success');
        });

        // è¨­ç½®æ™‚é–“ç¯„åœ
        function setTimeRange(days) {
            currentTimeRange = days;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateDateDisplay();
        }

        // æ›´æ–°æ—¥æœŸé¡¯ç¤º
        function updateDateDisplay() {
            const today = new Date();
            const dateDisplay = document.getElementById('dateDisplay');
            
            if (currentTimeRange === 0) {
                const todayStr = formatDate(today);
                dateDisplay.textContent = `æœå°‹ä»Šæ—¥ (${todayStr}) çš„æ¨™æ¡ˆ`;
            } else if (currentTimeRange === 'custom') {
                dateDisplay.textContent = 'è‡ªè¨‚æ™‚é–“ç¯„åœ';
            } else {
                const startDate = new Date(today);
                startDate.setDate(today.getDate() - currentTimeRange);
                const startStr = formatDate(startDate);
                const endStr = formatDate(today);
                dateDisplay.textContent = `æœå°‹ ${startStr} è‡³ ${endStr} çš„æ¨™æ¡ˆ`;
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }

        // é¡¯ç¤ºè‡ªè¨‚ç¯„åœ
        function showCustomRange() {
            const startDate = prompt('è«‹è¼¸å…¥é–‹å§‹æ—¥æœŸ (YYYYMMDD):', '20241201');
            const endDate = prompt('è«‹è¼¸å…¥çµæŸæ—¥æœŸ (YYYYMMDD):', '20241219');
            
            if (startDate && endDate) {
                currentTimeRange = 'custom';
                document.getElementById('dateDisplay').textContent = 
                    `æœå°‹ ${startDate} è‡³ ${endDate} çš„æ¨™æ¡ˆ`;
            }
        }

        // æ›´æ–°è¡¨å–®æ¬„ä½
        function updateFormFields() {
            const searchType = document.getElementById('searchType').value;
            const unitInput = document.getElementById('unitInput');
            
            if (searchType === 'unit') {
                unitInput.style.display = 'block';
            } else {
                unitInput.style.display = 'none';
            }
        }

        // æ¸…é™¤è¡¨å–®
        function clearSearch() {
            document.getElementById('titleQuery').value = '';
            document.getElementById('companyNameQuery').value = '';
            document.getElementById('companyIdQuery').value = '';
            document.getElementById('unitQuery').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('allType').checked = true; // é‡ç½®ç‚ºå…¨éƒ¨
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('aiAnalysisResults').style.display = 'none';
            document.getElementById('messageArea').innerHTML = '';
            showMessage('è¡¨å–®å·²æ¸…é™¤ï¼Œè«‹é‡æ–°è¼¸å…¥æœå°‹æ¢ä»¶ã€‚', 'success');
        }
        
        // è¨­å®šæ—¥æœŸç¯„åœ
        function setDateRange(range) {
            const today = new Date();
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            switch(range) {
                case 'today':
                    const todayStr = today.toISOString().split('T')[0];
                    startDateInput.value = todayStr;
                    endDateInput.value = todayStr;
                    break;
                case 'last3days':
                    const threeDaysAgo = new Date(today);
                    threeDaysAgo.setDate(today.getDate() - 3);
                    startDateInput.value = threeDaysAgo.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    break;
                case 'last7days':
                    const sevenDaysAgo = new Date(today);
                    sevenDaysAgo.setDate(today.getDate() - 7);
                    startDateInput.value = sevenDaysAgo.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    break;
                case 'last30days':
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(today.getDate() - 30);
                    startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    break;
                case 'thisYear':
                    const thisYear = today.getFullYear();
                    const yearStart = new Date(thisYear, 0, 1); // 1æœˆ1æ—¥
                    startDateInput.value = yearStart.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    break;
                case 'all':
                    startDateInput.value = '';
                    endDateInput.value = '';
                    break;
            }
        }
        
        // éæ¿¾æ—¥æœŸç¯„åœ
        function filterByDateRange(results, startDate, endDate) {
            return results.filter(record => {
                const recordDate = record.date.toString();
                const recordDateStr = recordDate.substring(0, 4) + '-' + 
                                    recordDate.substring(4, 6) + '-' + 
                                    recordDate.substring(6, 8);
                
                if (startDate && recordDateStr < startDate) return false;
                if (endDate && recordDateStr > endDate) return false;
                return true;
            });
        }
        
        // éæ¿¾æ¨™æ¡ˆé¡å‹
        function filterByTenderType(results, tenderType) {
            return results.filter(record => {
                const type = record.brief?.type || '';
                
                if (tenderType === 'open') {
                    // é–‹æ¨™ï¼šåŒ…å«ã€Œå…¬é–‹æ‹›æ¨™ã€ã€ã€Œå…¬é–‹å–å¾—ã€ç­‰æ‹›æ¨™éšæ®µ
                    return type.includes('å…¬é–‹æ‹›æ¨™') || 
                           type.includes('å…¬é–‹å–å¾—') || 
                           type.includes('å…¬é–‹å¾µæ±‚') ||
                           type.includes('é™åˆ¶æ€§æ‹›æ¨™') ||
                           type.includes('é¸æ“‡æ€§æ‹›æ¨™') ||
                           type.includes('æ‹›æ¨™å…¬å‘Š');
                } else if (tenderType === 'award') {
                    // æ±ºæ¨™ï¼šåŒ…å«ã€Œæ±ºæ¨™ã€ã€ã€Œå¾—æ¨™ã€ç­‰æ±ºæ¨™éšæ®µ
                    return type.includes('æ±ºæ¨™') || 
                           type.includes('å¾—æ¨™') ||
                           type.includes('å®šæœŸå¥‘ç´„') ||
                           type.includes('é–‹å£åˆç´„') ||
                           type.includes('ç„¡æ³•æ±ºæ¨™');
                }
                
                return true;
            });
        }
        
        // å»é‡è¤‡
        function removeDuplicates(results) {
            const seen = new Set();
            return results.filter(record => {
                const key = record.job_number + '_' + record.unit_id;
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
        }
        
        // æ ¹æ“šå…¬å¸åç¨±éæ¿¾çµæœï¼ˆAND é‚è¼¯ç”¨ï¼‰
        function filterByCompanyName(results, companyName) {
            return results.filter(record => {
                const companies = record.brief?.companies?.names || [];
                return companies.some(name => 
                    name.toLowerCase().includes(companyName.toLowerCase())
                );
            });
        }
        
        // æ ¹æ“šçµ±ä¸€ç·¨è™Ÿéæ¿¾çµæœï¼ˆAND é‚è¼¯ç”¨ï¼‰
        function filterByCompanyId(results, companyId) {
            return results.filter(record => {
                const companies = record.brief?.companies?.ids || [];
                return companies.some(id => 
                    id.includes(companyId)
                );
            });
        }
        
        // æ ¹æ“šæ©Ÿé—œä»£ç¢¼éæ¿¾çµæœï¼ˆAND é‚è¼¯ç”¨ï¼‰
        function filterByUnitId(results, unitId) {
            return results.filter(record => {
                return record.unit_id && record.unit_id.includes(unitId);
            });
        }
        
        // é¡¯ç¤ºæœå°‹èªªæ˜
        function showSearchHelp() {
            const helpText = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>æœå°‹èªªæ˜</h6>
                    <ul class="mb-0">
                        <li><strong>æœå°‹é‚è¼¯ï¼š</strong>
                            <ul>
                                <li><strong>AND (ä¸”)ï¼š</strong>æ‰€æœ‰å¡«å¯«çš„æ¢ä»¶éƒ½å¿…é ˆç¬¦åˆï¼Œçµæœæ›´ç²¾ç¢º</li>
                                <li><strong>OR (æˆ–)ï¼š</strong>ä»»ä¸€æ¢ä»¶ç¬¦åˆå³å¯ï¼Œçµæœæ›´å»£æ³›</li>
                            </ul>
                        </li>
                        <li><strong>æœå°‹æ¬„ä½ï¼š</strong>
                            <ul>
                                <li><strong>æ¨™æ¡ˆåç¨±ï¼š</strong>æœå°‹æ¨™æ¡ˆæ¨™é¡Œä¸­åŒ…å«çš„é—œéµå­—</li>
                                <li><strong>å…¬å¸åç¨±ï¼š</strong>æœå°‹æŠ•æ¨™å» å•†åç¨±</li>
                                <li><strong>çµ±ä¸€ç·¨è™Ÿï¼š</strong>æœå°‹ç‰¹å®šå…¬å¸çš„çµ±ä¸€ç·¨è™Ÿ</li>
                                <li><strong>æ©Ÿé—œä»£ç¢¼ï¼š</strong>æœå°‹ç‰¹å®šæ©Ÿé—œçš„æ¨™æ¡ˆ</li>
                            </ul>
                        </li>
                        <li><strong>Gemini Agent æœå°‹ï¼š</strong>
                            <ul>
                                <li><strong>æ™ºèƒ½åˆ†æï¼š</strong>AI æœƒåˆ†ææ¨™æ¡ˆç‰¹å¾µä¸¦æ‰¾å‡ºåŒé¡å‹æ¡ˆä»¶</li>
                                <li><strong>è‡ªå‹•æ“´å±•ï¼š</strong>æ ¹æ“šåˆ†æçµæœè‡ªå‹•æœå°‹ç›¸é—œé—œéµå­—</li>
                                <li><strong>æ™ºèƒ½æ’åºï¼š</strong>æŒ‰ç›¸é—œæ€§é‡æ–°æ’åºæœå°‹çµæœ</li>
                                <li><strong>éœ€è¦ API Keyï¼š</strong>å¿…é ˆå…ˆè¨­å®š Gemini API Key</li>
                            </ul>
                        </li>
                        <li><strong>æ—¥æœŸç¯„åœï¼š</strong>å¯é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸä¾†ç¯©é¸æ¨™æ¡ˆç™¼å¸ƒæ™‚é–“</li>
                        <li><strong>å¿«é€Ÿé¸æ“‡ï¼š</strong>ä½¿ç”¨å¿«é€ŸæŒ‰éˆ•å¿«é€Ÿè¨­å®šå¸¸ç”¨çš„æ—¥æœŸç¯„åœï¼ˆåŒ…å«ã€Œæœ¬å¹´è‡³ä»Šã€ï¼‰</li>
                    </ul>
                </div>
            `;
            showMessage(helpText, 'info');
        }
        
        // é¡¯ç¤º Gemini API Key èªªæ˜
        function showGeminiHelp() {
            const helpText = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-key me-2"></i>å¦‚ä½•å–å¾— Gemini API Key</h6>
                    <ol>
                        <li>å‰å¾€ <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-decoration-none">Google AI Studio</a></li>
                        <li>ä½¿ç”¨æ‚¨çš„ Google å¸³è™Ÿç™»å…¥</li>
                        <li>é»æ“Šã€ŒCreate API Keyã€æŒ‰éˆ•</li>
                        <li>è¤‡è£½ç”Ÿæˆçš„ API Key</li>
                        <li>å°‡ API Key è²¼åˆ°ä¸Šæ–¹è¼¸å…¥æ¡†ä¸­</li>
                    </ol>
                    <p class="mb-0 mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            è¨­å®š API Key å¾Œå³å¯ä½¿ç”¨ AI å°è©±å’Œåˆ†æåŠŸèƒ½
                        </small>
                    </p>
                </div>
            `;
            showMessage(helpText, 'info');
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const alertClass = type === 'error' ? 'alert-danger' : type === 'warning' ? 'alert-warning' : 'alert-success';
            
            // éŒ¯èª¤è¨Šæ¯æ·»åŠ è¤‡è£½æŒ‰éˆ•
            const copyButton = type === 'error' ? `
                <button class="btn btn-outline-danger btn-sm mt-2" onclick="copyMessageAreaError()" title="è¤‡è£½éŒ¯èª¤è¨Šæ¯">
                    <i class="fas fa-copy me-1"></i>è¤‡è£½éŒ¯èª¤è¨Šæ¯
                </button>
            ` : '';
            
            messageArea.innerHTML = `
                <div class="alert ${alertClass}">
                    <div class="alert-message">${message}</div>
                    ${copyButton}
                </div>
            `;
            
            // æˆåŠŸè¨Šæ¯è‡ªå‹•æ¶ˆå¤±ï¼ŒéŒ¯èª¤è¨Šæ¯ä¿ç•™è®“ä½¿ç”¨è€…æ‰‹å‹•é—œé–‰
            if (type === 'success') {
                setTimeout(() => {
                    messageArea.innerHTML = '';
                }, 3000);
            }
        }
        
        // è¤‡è£½ messageArea ä¸­çš„éŒ¯èª¤è¨Šæ¯
        async function copyMessageAreaError() {
            const messageArea = document.getElementById('messageArea');
            const alertMessage = messageArea.querySelector('.alert-message');
            if (!alertMessage) return;
            
            const textContent = alertMessage.textContent || alertMessage.innerText || '';
            
            try {
                await navigator.clipboard.writeText(textContent);
                const copyBtn = messageArea.querySelector('button');
                if (copyBtn) {
                    const originalHTML = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>å·²è¤‡è£½';
                    copyBtn.classList.remove('btn-outline-danger');
                    copyBtn.classList.add('btn-success');
                    setTimeout(() => {
                        copyBtn.innerHTML = originalHTML;
                        copyBtn.classList.add('btn-outline-danger');
                        copyBtn.classList.remove('btn-success');
                    }, 2000);
                }
            } catch (error) {
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½éŒ¯èª¤è¨Šæ¯');
            }
        }

        // åŸ·è¡Œæœå°‹
        async function performSearch() {
            // å–å¾—æ‰€æœ‰æœå°‹æ¢ä»¶
            const titleQuery = document.getElementById('titleQuery').value.trim();
            const companyNameQuery = document.getElementById('companyNameQuery').value.trim();
            const companyIdQuery = document.getElementById('companyIdQuery').value.trim();
            const unitQuery = document.getElementById('unitQuery').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const tenderType = document.querySelector('input[name="tenderType"]:checked').value;
            const searchLogic = document.querySelector('input[name="searchLogic"]:checked').value;
            
            console.log('æœå°‹æ¢ä»¶:', { titleQuery, companyNameQuery, companyIdQuery, unitQuery, tenderType, searchLogic });
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•æœå°‹æ¢ä»¶
            if (!titleQuery && !companyNameQuery && !companyIdQuery && !unitQuery) {
                showMessage('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æœå°‹æ¢ä»¶', 'error');
                return;
            }
            
            showLoading(true);
            hideMessage();
            
            try {
                let allResults = [];
                let searchCount = 0;
                
                // æ ¹æ“šæœå°‹é‚è¼¯æ±ºå®šæœå°‹æ–¹å¼
                if (searchLogic === 'and') {
                    // AND é‚è¼¯ï¼šæ‰€æœ‰æ¢ä»¶éƒ½å¿…é ˆç¬¦åˆ
                    console.log('ä½¿ç”¨ AND é‚è¼¯æœå°‹');
                    
                    // å…ˆæœå°‹ç¬¬ä¸€å€‹æ¢ä»¶
                    let currentResults = [];
                    if (titleQuery) {
                        console.log('é–‹å§‹æ¨™æ¡ˆåç¨±æœå°‹:', titleQuery);
                        currentResults = await searchAllPages('title', titleQuery);
                        console.log('æ¨™æ¡ˆåç¨±æœå°‹çµæœ:', currentResults.length, 'ç­†');
                        searchCount++;
                    } else if (companyNameQuery) {
                        console.log('é–‹å§‹å…¬å¸åç¨±æœå°‹:', companyNameQuery);
                        currentResults = await searchAllPages('companyname', companyNameQuery);
                        console.log('å…¬å¸åç¨±æœå°‹çµæœ:', currentResults.length, 'ç­†');
                        searchCount++;
                    } else if (companyIdQuery) {
                        console.log('é–‹å§‹çµ±ä¸€ç·¨è™Ÿæœå°‹:', companyIdQuery);
                        currentResults = await searchAllPages('companyid', companyIdQuery);
                        console.log('çµ±ä¸€ç·¨è™Ÿæœå°‹çµæœ:', currentResults.length, 'ç­†');
                        searchCount++;
                    } else if (unitQuery) {
                        console.log('é–‹å§‹æ©Ÿé—œä»£ç¢¼æœå°‹:', unitQuery);
                        currentResults = await searchAllPages('unit', unitQuery);
                        console.log('æ©Ÿé—œä»£ç¢¼æœå°‹çµæœ:', currentResults.length, 'ç­†');
                        searchCount++;
                    }
                    
                    // å°çµæœé€²è¡Œå…¶ä»–æ¢ä»¶çš„éæ¿¾
                    if (companyNameQuery && currentResults.length > 0) {
                        currentResults = filterByCompanyName(currentResults, companyNameQuery);
                        console.log('å…¬å¸åç¨±éæ¿¾å¾Œ:', currentResults.length, 'ç­†');
                    }
                    if (companyIdQuery && currentResults.length > 0) {
                        currentResults = filterByCompanyId(currentResults, companyIdQuery);
                        console.log('çµ±ä¸€ç·¨è™Ÿéæ¿¾å¾Œ:', currentResults.length, 'ç­†');
                    }
                    if (unitQuery && currentResults.length > 0) {
                        currentResults = filterByUnitId(currentResults, unitQuery);
                        console.log('æ©Ÿé—œä»£ç¢¼éæ¿¾å¾Œ:', currentResults.length, 'ç­†');
                    }
                    
                    allResults = currentResults;
                    
                } else {
                    // OR é‚è¼¯ï¼šä»»ä¸€æ¢ä»¶ç¬¦åˆå³å¯
                    console.log('ä½¿ç”¨ OR é‚è¼¯æœå°‹');
                    
                    // æ ¹æ“šæ¨™æ¡ˆåç¨±æœå°‹
                    if (titleQuery) {
                        console.log('é–‹å§‹æ¨™æ¡ˆåç¨±æœå°‹:', titleQuery);
                        const results = await searchAllPages('title', titleQuery);
                        console.log('æ¨™æ¡ˆåç¨±æœå°‹çµæœ:', results.length, 'ç­†');
                        allResults = allResults.concat(results);
                        searchCount++;
                    }
                    
                    // æ ¹æ“šå…¬å¸åç¨±æœå°‹
                    if (companyNameQuery) {
                        console.log('é–‹å§‹å…¬å¸åç¨±æœå°‹:', companyNameQuery);
                        const results = await searchAllPages('companyname', companyNameQuery);
                        console.log('å…¬å¸åç¨±æœå°‹çµæœ:', results.length, 'ç­†');
                        allResults = allResults.concat(results);
                        searchCount++;
                    }
                    
                    // æ ¹æ“šçµ±ä¸€ç·¨è™Ÿæœå°‹
                    if (companyIdQuery) {
                        console.log('é–‹å§‹çµ±ä¸€ç·¨è™Ÿæœå°‹:', companyIdQuery);
                        const results = await searchAllPages('companyid', companyIdQuery);
                        console.log('çµ±ä¸€ç·¨è™Ÿæœå°‹çµæœ:', results.length, 'ç­†');
                        allResults = allResults.concat(results);
                        searchCount++;
                    }
                    
                    // æ ¹æ“šæ©Ÿé—œä»£ç¢¼æœå°‹
                    if (unitQuery) {
                        console.log('é–‹å§‹æ©Ÿé—œä»£ç¢¼æœå°‹:', unitQuery);
                        const results = await searchAllPages('unit', unitQuery);
                        console.log('æ©Ÿé—œä»£ç¢¼æœå°‹çµæœ:', results.length, 'ç­†');
                        allResults = allResults.concat(results);
                        searchCount++;
                    }
                    
                    console.log('åˆä½µå‰ç¸½çµæœ:', allResults.length, 'ç­†');
                    
                    // å»é‡è¤‡
                    allResults = removeDuplicates(allResults);
                    console.log('å»é‡è¤‡å¾Œ:', allResults.length, 'ç­†');
                }
                
                // éæ¿¾æ—¥æœŸç¯„åœ
                if (startDate || endDate) {
                    allResults = filterByDateRange(allResults, startDate, endDate);
                    console.log('æ—¥æœŸéæ¿¾å¾Œ:', allResults.length, 'ç­†');
                }
                
                // éæ¿¾æ¨™æ¡ˆé¡å‹
                if (tenderType !== 'all') {
                    allResults = filterByTenderType(allResults, tenderType);
                    console.log('é¡å‹éæ¿¾å¾Œ:', allResults.length, 'ç­†');
                }
                
                if (allResults.length > 0) {
                    searchResults = allResults;
                    displayResults(allResults);
                    
                    const typeText = tenderType === 'all' ? '' : `ï¼ˆ${tenderType === 'open' ? 'é–‹æ¨™' : 'æ±ºæ¨™'}ï¼‰`;
                    const logicText = searchLogic === 'and' ? 'AND' : 'OR';
                    showMessage(`æœå°‹å®Œæˆï¼æ‰¾åˆ° ${allResults.length} ç­†è³‡æ–™${typeText}ï¼ˆä½¿ç”¨ ${logicText} é‚è¼¯ï¼Œ${searchCount} å€‹æœå°‹æ¢ä»¶ï¼‰`, 'success');
                    
                    // å·²å–æ¶ˆè‡ªå‹• AI åˆ†æï¼Œå¦‚éœ€åˆ†æè«‹æ‰‹å‹•é»æ“Šã€ŒAI åˆ†æã€æŒ‰éˆ•
                } else {
                    console.log('æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™');
                    showMessage('æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„è³‡æ–™', 'error');
                }
                
            } catch (error) {
                console.error('æœå°‹éŒ¯èª¤:', error);
                showMessage(`æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Gemini Agent æ™ºèƒ½æœå°‹
        async function performGeminiAgentSearch() {
            const geminiKey = document.getElementById('geminiKey').value.trim();
            if (!geminiKey) {
                showMessage('è«‹å…ˆè¼¸å…¥ Gemini API Key æ‰èƒ½ä½¿ç”¨ Agent æœå°‹åŠŸèƒ½', 'error');
                return;
            }

            const titleQuery = document.getElementById('titleQuery').value.trim();
            if (!titleQuery) {
                showMessage('è«‹å…ˆè¼¸å…¥æ¨™æ¡ˆåç¨±é—œéµå­—ï¼ŒAgent æœƒæ ¹æ“šæ­¤é—œéµå­—æœå°‹åŒé¡å‹æ¡ˆä»¶', 'error');
                return;
            }

            showLoading(true);
            hideMessage();

            try {
                showMessage('Gemini Agent æ­£åœ¨åˆ†ææ¨™æ¡ˆé¡å‹ä¸¦æœå°‹ç›¸ä¼¼æ¡ˆä»¶...', 'info');

                // 1. å…ˆé€²è¡ŒåŸºæœ¬æœå°‹ç²å–æ¨£æœ¬è³‡æ–™
                let sampleResults = await searchAllPages('title', titleQuery);
                console.log('åˆå§‹æœå°‹çµæœ:', sampleResults.length, 'ç­†');
                
                if (sampleResults.length === 0) {
                    // å¦‚æœæ²’æœ‰æ‰¾åˆ°çµæœï¼Œå˜—è©¦æ›´å»£æ³›çš„æœå°‹
                    showMessage('æ­£åœ¨å˜—è©¦æ›´å»£æ³›çš„æœå°‹...', 'info');
                    
                    // å˜—è©¦æœå°‹éƒ¨åˆ†é—œéµå­—
                    const words = titleQuery.split(/\s+/).filter(word => word.length > 1);
                    let broaderResults = [];
                    
                    for (const word of words.slice(0, 3)) {
                        try {
                            const wordResults = await searchAllPages('title', word);
                            broaderResults = broaderResults.concat(wordResults);
                            console.log(`é—œéµå­— "${word}" æœå°‹çµæœ:`, wordResults.length, 'ç­†');
                        } catch (error) {
                            console.warn(`é—œéµå­— "${word}" æœå°‹å¤±æ•—:`, error);
                        }
                    }
                    
                    if (broaderResults.length === 0) {
                        showMessage('æœªæ‰¾åˆ°ç›¸é—œæ¨™æ¡ˆï¼Œè«‹å˜—è©¦å…¶ä»–é—œéµå­—', 'error');
                        return;
                    }
                    
                    // ä½¿ç”¨æ›´å»£æ³›çš„æœå°‹çµæœä½œç‚ºæ¨£æœ¬
                    sampleResults = broaderResults.slice(0, 10);
                    console.log('ä½¿ç”¨æ›´å»£æ³›æœå°‹çµæœ:', sampleResults.length, 'ç­†');
                }

                // 2. ä½¿ç”¨ Gemini åˆ†ææ¨™æ¡ˆç‰¹å¾µ
                const analysisPrompt = `
è«‹åˆ†æä»¥ä¸‹æ”¿åºœæ¡è³¼æ¨™æ¡ˆçš„ç‰¹å¾µï¼Œä¸¦æä¾›ç›¸é—œçš„æœå°‹é—œéµå­—å»ºè­°ï¼š

æ¨™æ¡ˆè³‡æ–™ï¼š
${JSON.stringify(sampleResults.slice(0, 5), null, 2)}

è«‹åˆ†æï¼š
1. æ¨™æ¡ˆçš„ä¸»è¦é¡å‹å’Œé ˜åŸŸ
2. ç›¸é—œçš„æŠ€è¡“é—œéµå­—
3. å¯èƒ½æ¶‰åŠçš„ç”¢å“æˆ–æœå‹™é¡åˆ¥
4. ç›¸é—œçš„æ©Ÿé—œé¡å‹
5. å»ºè­°çš„æœå°‹é—œéµå­—ï¼ˆè‡³å°‘5å€‹ï¼‰

è«‹ä»¥ JSON æ ¼å¼å›æ‡‰ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š
{
  "category": "æ¨™æ¡ˆé¡åˆ¥",
  "keywords": ["é—œéµå­—1", "é—œéµå­—2", "é—œéµå­—3"],
  "related_terms": ["ç›¸é—œè¡“èª1", "ç›¸é—œè¡“èª2"],
  "product_types": ["ç”¢å“é¡å‹1", "ç”¢å“é¡å‹2"],
  "agency_types": ["æ©Ÿé—œé¡å‹1", "æ©Ÿé—œé¡å‹2"]
}
`;

                const analysisResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: analysisPrompt
                            }]
                        }]
                    })
                });

                if (!analysisResponse.ok) {
                    throw new Error(`Gemini API éŒ¯èª¤: ${analysisResponse.status}`);
                }

                const analysisData = await analysisResponse.json();
                const analysisText = analysisData.candidates[0].content.parts[0].text;
                
                // è§£æ Gemini å›æ‡‰
                let analysis;
                try {
                    // æå– JSON éƒ¨åˆ†
                    const jsonMatch = analysisText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        analysis = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('ç„¡æ³•è§£æ Gemini å›æ‡‰');
                    }
                } catch (parseError) {
                    console.error('è§£æ Gemini å›æ‡‰å¤±æ•—:', parseError);
                    // ä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ
                    analysis = {
                        category: "æ”¿åºœæ¡è³¼æ¨™æ¡ˆ",
                        keywords: [titleQuery, "æ¡è³¼", "æ¨™æ¡ˆ", "æ‹›æ¨™", "æ±ºæ¨™"],
                        related_terms: [titleQuery],
                        product_types: ["æœå‹™", "ç”¢å“"],
                        agency_types: ["æ”¿åºœæ©Ÿé—œ"]
                    };
                }

                console.log('Gemini åˆ†æçµæœ:', analysis);

                // 3. æ ¹æ“šåˆ†æçµæœé€²è¡Œæ“´å±•æœå°‹
                let allAgentResults = [...sampleResults];
                const searchKeywords = analysis.keywords || [titleQuery];

                // æœå°‹ç›¸é—œé—œéµå­—
                for (const keyword of searchKeywords.slice(0, 3)) { // é™åˆ¶æœå°‹æ•¸é‡é¿å…éå¤šè«‹æ±‚
                    if (keyword !== titleQuery) {
                        try {
                            const keywordResults = await searchAllPages('title', keyword);
                            allAgentResults = allAgentResults.concat(keywordResults);
                            console.log(`é—œéµå­— "${keyword}" æœå°‹çµæœ:`, keywordResults.length, 'ç­†');
                        } catch (error) {
                            console.warn(`é—œéµå­— "${keyword}" æœå°‹å¤±æ•—:`, error);
                        }
                    }
                }

                // 4. å»é‡è¤‡ä¸¦éæ¿¾
                allAgentResults = removeDuplicates(allAgentResults);
                console.log('å»é‡è¤‡å¾Œçµæœ:', allAgentResults.length, 'ç­†');

                // 5. ä½¿ç”¨ Gemini é€²è¡Œæ™ºèƒ½æ’åº
                const rankingPrompt = `
è«‹æ ¹æ“šä»¥ä¸‹æ¨™æ¡ˆèˆ‡åŸå§‹æœå°‹é—œéµå­— "${titleQuery}" çš„ç›¸é—œæ€§é€²è¡Œæ’åºï¼š

æ¨™æ¡ˆåˆ—è¡¨ï¼š
${JSON.stringify(allAgentResults.slice(0, 20), null, 2)}

è«‹å›å‚³æ’åºå¾Œçš„æ¨™æ¡ˆç´¢å¼•é™£åˆ—ï¼ˆæœ€ç›¸é—œçš„åœ¨å‰ï¼‰ï¼Œæ ¼å¼ï¼š[0, 5, 2, 8, ...]
`;

                try {
                    const rankingResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: rankingPrompt
                                }]
                            }]
                        })
                    });

                    if (rankingResponse.ok) {
                        const rankingData = await rankingResponse.json();
                        const rankingText = rankingData.candidates[0].content.parts[0].text;
                        const rankingMatch = rankingText.match(/\[[\d\s,]+\]/);
                        if (rankingMatch) {
                            const ranking = JSON.parse(rankingMatch[0]);
                            // é‡æ–°æ’åºçµæœ
                            const sortedResults = ranking.map(index => allAgentResults[index]).filter(Boolean);
                            allAgentResults = [...sortedResults, ...allAgentResults.filter((_, index) => !ranking.includes(index))];
                        }
                    }
                } catch (rankingError) {
                    console.warn('æ™ºèƒ½æ’åºå¤±æ•—ï¼Œä½¿ç”¨åŸå§‹é †åº:', rankingError);
                }

                // 6. é¡¯ç¤ºçµæœ
                if (allAgentResults.length > 0) {
                    searchResults = allAgentResults;
                    displayResults(allAgentResults, true);

                    // åœ¨æœå°‹çµæœå€åŸŸé¡¯ç¤º Gemini Agent åˆ†æçµæœ
                    const searchResultsDiv = document.getElementById('searchResults');
                    if (searchResultsDiv) {
                        const geminiAnalysisDiv = document.createElement('div');
                        geminiAnalysisDiv.className = 'gemini-analysis mb-4';
                        geminiAnalysisDiv.innerHTML = `
                            <div class="alert alert-success">
                                <h6><i class="fas fa-robot me-2"></i>Gemini Agent åˆ†æçµæœ</h6>
                                <p><strong>æ¨™æ¡ˆé¡åˆ¥ï¼š</strong>${analysis.category}</p>
                                <p><strong>ç›¸é—œé—œéµå­—ï¼š</strong>${analysis.keywords.join(', ')}</p>
                                <p><strong>æ‰¾åˆ° ${allAgentResults.length} ç­†ç›¸é—œæ¨™æ¡ˆ</strong></p>
                            </div>
                        `;
                        searchResultsDiv.insertBefore(geminiAnalysisDiv, searchResultsDiv.firstChild);
                    }

                    showMessage(`Gemini Agent æœå°‹å®Œæˆï¼æ‰¾åˆ° ${allAgentResults.length} ç­†ç›¸é—œæ¨™æ¡ˆ`, 'success');
                } else {
                    showMessage('Gemini Agent æœªæ‰¾åˆ°ç›¸é—œæ¨™æ¡ˆ', 'error');
                }

            } catch (error) {
                console.error('Gemini Agent æœå°‹éŒ¯èª¤:', error);
                showMessage(`Gemini Agent æœå°‹å¤±æ•—ï¼š${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // æ ¹æ“šæ™‚é–“ç¯„åœæœå°‹
        async function searchByTimeRange(searchType, query, page) {
            // ç›´æ¥æœå°‹æ‰€æœ‰è³‡æ–™ï¼Œä¸é™åˆ¶æ—¥æœŸ
            return await searchAllData(searchType, query, page);
        }
        
        // æœå°‹æ‰€æœ‰è³‡æ–™ï¼ˆä¸é™åˆ¶æ—¥æœŸï¼‰
        async function searchAllData(searchType, query, page) {
            let path = '';
            let params = new URLSearchParams();
            
            if (searchType === 'unit') {
                path = '/listbyunit';
                params.append('unit_id', query);
            } else {
                switch(searchType) {
                    case 'companyname':
                        path = '/searchbycompanyname';
                        params.append('query', query);
                        break;
                    case 'companyid':
                        path = '/searchbycompanyid';
                        params.append('query', query);
                        break;
                    case 'title':
                        path = '/searchbytitle';
                        params.append('query', query);
                        break;
                }
            }
            
            params.append('page', page);
            
            const fullPath = `${path}?${params.toString()}`;
            console.log(`API èª¿ç”¨è·¯å¾‘: ${fullPath}`);
            
            const { resp: response, url: usedUrl } = await fetchFromApis(fullPath, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            }, 10000, 1);  // æ¸›å°‘é‡è©¦æ¬¡æ•¸å¾ 2 æ¬¡åˆ° 1 æ¬¡
            
            console.log(`æˆåŠŸä½¿ç”¨ API: ${usedUrl}`);
            
            const data = await response.json();
            console.log(`API å›æ‡‰:`, data);
            
            // å„²å­˜æœå°‹çµæœçš„ç¸½ç­†æ•¸å’Œåˆ†é è³‡è¨Š
            window.searchMeta = {
                totalRecords: data.total_records || 0,
                totalPages: data.total_pages || 0,
                currentPage: parseInt(page) || 1,
                query: query,
                searchType: searchType
            };
            
            return data.records || [];
        }
        
        // æœå°‹æ‰€æœ‰é é¢çš„è³‡æ–™ï¼ˆé™åˆ¶æœ€å¤š20é ä»¥ç²å–æ›´å¤šçµæœï¼‰
        async function searchAllPages(searchType, query) {
            let allResults = [];
            let page = 1;
            let hasMorePages = true;
            let maxPages = 20; // å¢åŠ é æ•¸é™åˆ¶ä»¥ç²å–æ›´å¤šçµæœ
            
            console.log(`é–‹å§‹æœå°‹ ${searchType}: ${query}`);
            
            while (hasMorePages && page <= maxPages) {
                try {
                    console.log(`æœå°‹ç¬¬ ${page} é ...`);
                    const results = await searchAllData(searchType, query, page);
                    console.log(`ç¬¬ ${page} é æ‰¾åˆ° ${results.length} ç­†è³‡æ–™`);
                    
                    if (results && results.length > 0) {
                        allResults = allResults.concat(results);
                    }
                    
                    // æª¢æŸ¥æ˜¯å¦é‚„æœ‰æ›´å¤šé é¢
                    if (window.searchMeta && page < window.searchMeta.totalPages && page < maxPages) {
                        page++;
                    } else {
                        hasMorePages = false;
                    }
                } catch (error) {
                    console.error(`æœå°‹ç¬¬ ${page} é æ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                    hasMorePages = false;
                }
            }
            
            console.log(`æœå°‹å®Œæˆï¼Œç¸½å…±æ‰¾åˆ° ${allResults.length} ç­†è³‡æ–™`);
            return allResults;
        }

        // æŒ‰æ—¥æœŸæœå°‹
        async function searchByDate(searchType, query, date) {
            let url = '';
            let params = new URLSearchParams();
            
            if (searchType === 'unit') {
                url = `${API_BASE}/listbyunit`;
                params.append('unit_id', query);
            } else {
                // å…ˆæœå°‹ï¼Œç„¶å¾Œéæ¿¾æ—¥æœŸ
                switch(searchType) {
                    case 'companyname':
                        url = `${API_BASE}/searchbycompanyname`;
                        params.append('query', query);
                        break;
                    case 'companyid':
                        url = `${API_BASE}/searchbycompanyid`;
                        params.append('query', query);
                        break;
                    case 'title':
                        url = `${API_BASE}/searchbytitle`;
                        params.append('query', query);
                        break;
                }
            }
            
            const response = await fetch(`${url}?${params.toString()}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (searchType === 'unit') {
                return data.records || [];
            } else {
                // éæ¿¾æŒ‡å®šæ—¥æœŸçš„çµæœ
                const targetDate = date.replace(/-/g, '');
                return (data.records || []).filter(record => record.date === targetDate);
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸç‚º API æ ¼å¼
        function formatDateForAPI(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        // éš±è—è¨Šæ¯
        function hideMessage() {
            document.getElementById('messageArea').innerHTML = '';
        }

        // é¡¯ç¤ºæœå°‹çµæœ
        function displayResults(results, isGeminiSearch = false) {
            const resultsDiv = document.getElementById('searchResults');
            const resultsList = document.getElementById('resultsList');
            const resultStats = document.getElementById('resultStats');
            const resultFilters = document.getElementById('resultFilters');
            
            resultsDiv.style.display = 'block';
            resultFilters.style.display = 'block';
            resultsList.innerHTML = '';
            
            // å„²å­˜åŸå§‹çµæœ
            window.allSearchResults = results;
            window.isGeminiSearch = isGeminiSearch;
            
            const searchType = isGeminiSearch ? 'Gemini Agent æœå°‹' : 'ä¸€èˆ¬æœå°‹';
            
            // çµ±è¨ˆé–‹æ¨™å’Œæ±ºæ¨™æ•¸é‡
            const openCount = results.filter(r => r.brief?.type && (r.brief.type.includes('é–‹æ¨™') || r.brief.type.includes('æ‹›æ¨™'))).length;
            const awardCount = results.filter(r => r.brief?.type && (r.brief.type.includes('æ±ºæ¨™') || r.brief.type.includes('å¾—æ¨™'))).length;
            
            resultStats.innerHTML = `
                <div class="row text-center">
                    <div class="col-4">
                        <div class="stats-card">
                            <div class="stats-number">${results.length}</div>
                            <div class="stats-label">ç¸½è¨ˆ</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stats-card">
                            <div class="stats-number text-primary">${openCount}</div>
                            <div class="stats-label">é–‹æ¨™</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stats-card">
                            <div class="stats-number text-danger">${awardCount}</div>
                            <div class="stats-label">æ±ºæ¨™</div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">${searchType}</small>
                </div>
            `;
            

            // é¡¯ç¤ºçµæœ
            filterAndDisplayResults();
        }
        
        // åˆ†é ç‹€æ…‹
        let pageSize = 10;
        let currentPage = 1;

        function changePageSize(value) {
            pageSize = parseInt(value) || 10;
            currentPage = 1;
            filterAndDisplayResults();
        }

        function goToPage(page) {
            currentPage = page;
            filterAndDisplayResults();
        }

        // éæ¿¾å’Œé¡¯ç¤ºçµæœ
        function filterAndDisplayResults() {
            const resultsList = document.getElementById('resultsList');
            const filterType = document.querySelector('input[name="resultFilter"]:checked').value;
            const sortBy = document.getElementById('sortBy').value;
            
            let filteredResults = [...window.allSearchResults];
            
            // éæ¿¾æ¨™æ¡ˆé¡å‹
            if (filterType !== 'all') {
                filteredResults = filterByTenderType(filteredResults, filterType);
            }
            
            // æ’åº
            filteredResults = sortResultsBy(filteredResults, sortBy);
            
            // åˆ†é 
            const total = filteredResults.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;
            const start = (currentPage - 1) * pageSize;
            const end = Math.min(start + pageSize, total);

            // é¡¯ç¤ºç•¶é 
            resultsList.innerHTML = '';
            filteredResults.slice(start, end).forEach((record, idx) => {
                const resultItem = createResultItem(record, start + idx, window.isGeminiSearch || false);
                resultsList.appendChild(resultItem);
            });

            // åˆ†é  UI
            const pagination = document.getElementById('pagination');
            const createPageBtn = (label, page, disabled = false, active = false) => {
                return `<li class=\"page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}\"><a class=\"page-link\" href=\"javascript:void(0)\" onclick=\"${!disabled ? `goToPage(${page})` : ''}\">${label}</a></li>`;
            };
            let pagesHtml = '<nav><ul class="pagination pagination-sm">';
            pagesHtml += createPageBtn('Â«', 1, currentPage === 1);
            pagesHtml += createPageBtn('â€¹', Math.max(1, currentPage - 1), currentPage === 1);
            const windowSize = 5;
            const startPage = Math.max(1, currentPage - Math.floor(windowSize / 2));
            const endPage = Math.min(totalPages, startPage + windowSize - 1);
            for (let p = startPage; p <= endPage; p++) {
                pagesHtml += createPageBtn(p, p, false, p === currentPage);
            }
            pagesHtml += createPageBtn('â€º', Math.min(totalPages, currentPage + 1), currentPage === totalPages);
            pagesHtml += createPageBtn('Â»', totalPages, currentPage === totalPages);
            pagesHtml += '</ul></nav>';
            pagination.innerHTML = pagesHtml;
            
            // æ›´æ–°çµ±è¨ˆ
            const resultStats = document.getElementById('resultStats');
            resultStats.innerHTML = `
                <div class="stats-card">
                    <div class="stats-number">${total === 0 ? 0 : (start + 1)}-${end}</div>
                    <div class="stats-label">é¡¯ç¤ºæ¨™æ¡ˆï¼ˆå…± ${total} ç­†ï¼‰</div>
                </div>
            `;
        }
        
        // æ’åºçµæœ
        function sortResults() {
            filterAndDisplayResults();
        }
        
        // æ ¹æ“šæ¢ä»¶æ’åº
        function sortResultsBy(results, sortBy) {
            return results.sort((a, b) => {
                switch (sortBy) {
                    case 'date_desc':
                        return b.date - a.date;
                    case 'date_asc':
                        return a.date - b.date;
                    case 'title':
                        return (a.brief?.title || '').localeCompare(b.brief?.title || '');
                    case 'unit':
                        return (a.unit_name || '').localeCompare(b.unit_name || '');
                    default:
                        return 0;
                }
            });
        }

        // å‰µå»ºçµæœé …ç›®
        function createResultItem(record, index, isGeminiSearch = false) {
            const div = document.createElement('div');
            div.className = 'result-item';
            
            const brief = record.brief || {};
            const companies = brief.companies || {};
            
            // æ§‹å»ºæ”¿åºœæ¡è³¼ç¶²é€£çµ
            const govUrl = buildGovUrl(record);
            
            // å¦‚æœæ²’æœ‰æ”¿åºœæ¡è³¼ç¶²é€£çµï¼Œå˜—è©¦ç•°æ­¥ç²å–è©³ç´°è³‡è¨Š
            if (govUrl === '#' || govUrl.includes('pcc.g0v.ronny.tw')) {
                // ç•°æ­¥ç²å–è©³ç´°è³‡è¨Šä¾†æ§‹å»ºæ­£ç¢ºçš„é€£çµ
                fetchTenderDetailForUrl(record.unit_id, record.job_number).then(detailUrl => {
                    if (detailUrl && detailUrl !== '#') {
                        // æ›´æ–°é€£çµ
                        const link = div.querySelector('a');
                        if (link) {
                            link.href = detailUrl;
                        }
                    }
                }).catch(error => {
                    console.log('ç„¡æ³•ç²å–è©³ç´°è³‡è¨Š:', error);
                });
            }
            
            // åˆ¤æ–·æ˜¯å¦ç‚ºæ±ºæ¨™é¡å‹
            const isAward = brief.type && (brief.type.includes('æ±ºæ¨™') || brief.type.includes('å¾—æ¨™'));
            const badgeClass = isAward ? 'bg-danger' : 'bg-primary';
            const titleClass = isAward ? 'text-danger' : 'text-primary';
            
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h5 class="mb-0">
                        <a href="${govUrl}" target="_blank" class="${titleClass} text-decoration-none">
                            ${brief.title || 'ç„¡æ¨™é¡Œ'}
                            <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                        </a>
                        ${isGeminiSearch ? '<span class="text-warning ms-2" title="Gemini æ¨è–¦"><i class="fas fa-star"></i></span>' : ''}
                    </h5>
                    <span class="badge ${badgeClass}">${brief.type || 'æœªçŸ¥é¡å‹'}</span>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <small class="text-muted"><i class="fas fa-calendar me-1"></i>æ—¥æœŸ: ${record.date || 'æœªçŸ¥'}</small>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted"><i class="fas fa-building me-1"></i>æ©Ÿé—œ: ${record.unit_name || 'æœªçŸ¥'}</small>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted"><i class="fas fa-hashtag me-1"></i>ä»£ç¢¼: ${record.job_number || 'æœªçŸ¥'}</small>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted"><i class="fas fa-coins me-1"></i>é ç®—: <span class="budget-amount" data-unit-id="${record.unit_id || ''}" data-job-number="${record.job_number || ''}">${(record.detail && record.detail['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡']) ? record.detail['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡'] : 'è¼‰å…¥ä¸­â€¦'}</span></small>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-12">
                        <small class="text-muted"><i class="fas fa-tag me-1"></i>åˆ†é¡: ${brief.category || 'æœªçŸ¥'}</small>
                    </div>
                </div>
                ${companies.names && companies.names.length > 0 ? `
                    <div class="mb-3">
                        <strong><i class="fas fa-users me-1"></i>ç›¸é—œå…¬å¸:</strong>
                        <div class="mt-2">
                            ${companies.names.map(name => `<button class="btn btn-outline-info btn-sm me-2 mb-1 company-btn" onclick="openCompanyAnalysis('${name}')" title="é»æ“Šåœ¨æ–°åˆ†é ä¸­åˆ†æ ${name} çš„å¾—æ¨™æƒ…æ³">${name}</button>`).join('')}
                        </div>
                    </div>
                ` : ''}
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary btn-sm" onclick="showDetail('${record.unit_id}', '${record.job_number}', '${record.date}')">
                        <i class="fas fa-info-circle me-1"></i>è©³ç´°è³‡æ–™
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="startChat('${brief.title || 'ç„¡æ¨™é¡Œ'}', '${record.unit_name || 'æœªçŸ¥æ©Ÿé—œ'}', '${brief.type || 'æœªçŸ¥é¡å‹'}')">
                        <i class="fas fa-comments me-1"></i>AI å°è©±
                    </button>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="åˆ†äº«æ¨™æ¡ˆ">
                            <i class="fas fa-share-alt me-1"></i>åˆ†äº«
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="shareToLineAsync('${(brief.title || 'ç„¡æ¨™é¡Œ').replace(/'/g, "\\'")}', '${(record.unit_name || 'æœªçŸ¥æ©Ÿé—œ').replace(/'/g, "\\'")}', '${record.unit_id || ''}', '${record.job_number || ''}')">
                                <i class="fab fa-line text-success me-2"></i>åˆ†äº«åˆ° Line
                            </a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="shareToGmailAsync('${(brief.title || 'ç„¡æ¨™é¡Œ').replace(/'/g, "\\'")}', '${(record.unit_name || 'æœªçŸ¥æ©Ÿé—œ').replace(/'/g, "\\'")}', '${record.job_number || 'æœªçŸ¥'}', '${record.unit_id || ''}', '${record.job_number || ''}')">
                                <i class="fas fa-envelope text-danger me-2"></i>åˆ†äº«åˆ° Gmail
                            </a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="copyLinkAsync('${(brief.title || 'ç„¡æ¨™é¡Œ').replace(/'/g, "\\'")}', '${record.unit_id || ''}', '${record.job_number || ''}')">
                                <i class="fas fa-copy text-primary me-2"></i>è¤‡è£½é€£çµ
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="${buildGovUrl(record)}" target="_blank">
                                <i class="fas fa-external-link-alt me-2"></i>å‰å¾€æ”¿åºœæ¡è³¼ç¶²é é¢
                            </a></li>
                        </ul>
                    </div>
                </div>
            `;
            
            // éåŒæ­¥è¼‰å…¥é ç®—é‡‘é¡ï¼ˆä½¿ç”¨æœ¬å°ˆæ¡ˆ APIï¼‰ï¼Œå«å¿«å–èˆ‡é‡è©¦
            try {
                const budgetSpan = div.querySelector('.budget-amount');
                const unitId = budgetSpan?.dataset.unitId;
                const jobNumber = budgetSpan?.dataset.jobNumber;
                if (budgetSpan && unitId && jobNumber && budgetSpan.textContent.includes('è¼‰å…¥ä¸­')) {
                    loadAndFillBudget(budgetSpan, unitId, jobNumber);
                }
            } catch (e) {
                console.warn('è¼‰å…¥é ç®—é‡‘é¡æ™‚ç™¼ç”Ÿä¾‹å¤–:', e);
            }

            return div;
        }

        const budgetCache = new Map();
        async function loadAndFillBudget(el, unitId, jobNumber) {
            const cacheKey = `${unitId}::${jobNumber}`;
            if (budgetCache.has(cacheKey)) {
                el.textContent = budgetCache.get(cacheKey);
                return;
            }
            try {
                // åªä½¿ç”¨ fetchFromApis çš„å…§å»ºé‡è©¦æ©Ÿåˆ¶ï¼ˆ1æ¬¡é‡è©¦ï¼‰ï¼Œé¿å…éå¤š API è«‹æ±‚
                const { resp } = await fetchFromApis(`/tender?unit_id=${encodeURIComponent(unitId)}&job_number=${encodeURIComponent(jobNumber)}`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                }, 10000, 1);  // æ¯å€‹ä¾†æºåªé‡è©¦ 1 æ¬¡
                const data = await resp.json();
                const rec = (data.records && data.records[0]) || data;
                const amount = rec?.detail?.['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡'] || rec?.brief?.budget || '';
                if (amount) {
                    budgetCache.set(cacheKey, amount);
                    el.textContent = amount;
                } else {
                    el.textContent = 'ç„¡è³‡æ–™';
                }
            } catch (err) {
                console.warn('é ç®—é‡‘é¡è¼‰å…¥å¤±æ•—ï¼ˆå¯èƒ½æ˜¯é€Ÿç‡é™åˆ¶ï¼‰ï¼š', unitId, jobNumber);
                el.textContent = 'é»æ“Šè©³ç´°æŸ¥çœ‹';
                el.title = `é»æ“Šã€Œè©³ç´°è³‡æ–™ã€æŸ¥çœ‹å®Œæ•´è³‡è¨Š`;
            }
        }

        // ç²å–æ¨™æ¡ˆè©³ç´°è³‡è¨Šä¾†æ§‹å»ºæ­£ç¢ºçš„æ”¿åºœæ¡è³¼ç¶²é€£çµ
        async function fetchTenderDetailForUrl(unitId, jobNumber) {
            try {
                const response = await fetch(`${API_BASE}/tender?unit_id=${unitId}&job_number=${jobNumber}`);
                if (!response.ok) {
                    return '#';
                }
                
                const data = await response.json();
                const record = data.records && data.records.length > 0 ? data.records[0] : data;
                
                // ä½¿ç”¨è©³ç´°è³‡è¨Šæ§‹å»ºæ­£ç¢ºçš„é€£çµ
                return buildGovUrl(record);
            } catch (error) {
                console.error('ç²å–æ¨™æ¡ˆè©³ç´°è³‡è¨Šå¤±æ•—:', error);
                return '#';
            }
        }

        // å–å¾—æ¨™æ¡ˆè­˜åˆ¥ç¢¼ pkPmsMainï¼ˆè‹¥æœ‰è©³ç´°è³‡æ–™ï¼‰
        function getPkPmsMain(record) {
            if (record && record.detail && record.detail.pkPmsMain) {
                return record.detail.pkPmsMain;
            }
            return '';
        }

        // æ§‹å»ºæ”¿åºœæ¡è³¼ç¶² URL
        function buildGovUrl(record) {
            // å„ªå…ˆä½¿ç”¨ detail.url ä¸­çš„æ”¿åºœæ¡è³¼ç¶²é€£çµ
            if (record.detail && record.detail.url && record.detail.url.startsWith('https://web.pcc.gov.tw')) {
                return record.detail.url;
            }
            // å¦‚æœæœ‰ pkPmsMainï¼Œæ§‹å»ºæ”¿åºœæ¡è³¼ç¶²é€£çµ
            if (record.detail && record.detail.pkPmsMain) {
                return `https://web.pcc.gov.tw/tps/QueryTender/query/searchTenderDetail?pkPmsMain=${record.detail.pkPmsMain}`;
            }
            // å¦‚æœæœ‰ç›´æ¥çš„ url æ¬„ä½ä¸”æ˜¯æ”¿åºœæ¡è³¼ç¶²é€£çµ
            if (record.url && record.url.startsWith('https://web.pcc.gov.tw')) {
                return record.url;
            }
            // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ pcc.g0v.ronny.tw çš„ tender.html
            if (record.job_number && record.unit_id && record.date) {
                const dateStr = record.date.toString();
                const filename = record.filename || 'unknown';
                return `https://pcc.g0v.ronny.tw/tender.html?unit_id=${record.unit_id}&job_number=${record.job_number}&date=${dateStr}&filename=${filename}`;
            } else if (record.url) {
                if (record.url.startsWith('http')) {
                    return record.url;
                } else {
                    return `https://pcc.g0v.ronny.tw${record.url}`;
                }
            }
            return '#';
        }

        // é—œé–‰è©³ç´°è³‡æ–™æ¨¡æ…‹æ¡†
        function closeDetailModal() {
            const modal = document.getElementById('detailModal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            }
        }

        // åˆ‡æ›æ¨™æ¡ˆè¨˜éŒ„åˆ†é 
        function switchTenderRecord(index) {
            if (!window.tenderRecords || !window.tenderRecords[index]) {
                return;
            }
            
            const record = window.tenderRecords[index];
            const brief = record.brief || {};
            const detail = record.detail || {};
            
            // æ ¼å¼åŒ–æ—¥æœŸ
            const dateStr = record.date ? record.date.toString() : '';
            const formattedDate = dateStr ? `${dateStr.substring(0,4)}å¹´${dateStr.substring(4,6)}æœˆ${dateStr.substring(6,8)}æ—¥` : 'ç„¡è³‡æ–™';
            
            // æ›´æ–°å…§å®¹
            const content = document.getElementById('tenderDetailContent');
            if (content) {
                content.innerHTML = `
                    <h6>åŸºæœ¬è³‡è¨Š</h6>
                    <table class="table table-sm">
                        <tr><td><strong>æ¨™æ¡ˆåç¨±</strong></td><td>${brief.title || 'ç„¡è³‡æ–™'}</td></tr>
                        <tr><td><strong>æ¨™æ¡ˆé¡å‹</strong></td><td>${brief.type || 'ç„¡è³‡æ–™'}</td></tr>
                        <tr><td><strong>ç™¼å¸ƒæ—¥æœŸ</strong></td><td>${formattedDate}</td></tr>
                        <tr><td><strong>æ©Ÿé—œåç¨±</strong></td><td>${detail['æ©Ÿé—œè³‡æ–™:æ©Ÿé—œåç¨±'] || 'ç„¡è³‡æ–™'}</td></tr>
                        <tr><td><strong>æ¨™æ¡ˆç·¨è™Ÿ</strong></td><td>${record.job_number || 'ç„¡è³‡æ–™'}</td></tr>
                        <tr><td><strong>æ©Ÿé—œä»£ç¢¼</strong></td><td>${record.unit_id || 'ç„¡è³‡æ–™'}</td></tr>
                        <tr><td><strong>åˆ†é¡</strong></td><td>${brief.category || 'ç„¡è³‡æ–™'}</td></tr>
                        <tr><td><strong>é ç®—é‡‘é¡</strong></td><td>${detail['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡'] || 'ç„¡è³‡æ–™'}</td></tr>
                    </table>
                    
                    ${isTenderAwarded(brief.type, detail) ? getAwardInfo(detail) : getTenderInfo(detail)}

                    ${isTenderAwarded(brief.type, detail) ? renderAwardItemsSection(detail, record.job_number || '') : ''}
                    
                    <div class="mt-3">
                        <h6>é‡è¦æ™‚é–“æé†’</h6>
                        <div class="d-flex gap-2 flex-wrap">
                            ${detail['é ˜æŠ•é–‹æ¨™:é–‹æ¨™æ™‚é–“'] ? `
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="addToCalendar('${brief.title || 'æ¨™æ¡ˆ'} - é–‹æ¨™', '${detail['é ˜æŠ•é–‹æ¨™:é–‹æ¨™æ™‚é–“']}', '${detail['é ˜æŠ•é–‹æ¨™:é–‹æ¨™åœ°é»'] || detail['æ©Ÿé—œè³‡æ–™:æ©Ÿé—œåç¨±'] || 'æ”¿åºœæ©Ÿé—œ'}', '${buildGovUrl(record)}')">
                                    <i class="fas fa-calendar-plus me-1"></i>é–‹æ¨™æ™‚é–“åŠ å…¥è¡Œäº‹æ›†
                                </button>
                            ` : ''}
                            ${detail['é ˜æŠ•é–‹æ¨™:æˆªæ­¢æŠ•æ¨™'] ? `
                                <button class="btn btn-outline-warning btn-sm" 
                                        onclick="addToCalendar('${brief.title || 'æ¨™æ¡ˆ'} - æˆªæ­¢æŠ•æ¨™', '${detail['é ˜æŠ•é–‹æ¨™:æˆªæ­¢æŠ•æ¨™']}', '${detail['é ˜æŠ•é–‹æ¨™:é–‹æ¨™åœ°é»'] || detail['æ©Ÿé—œè³‡æ–™:æ©Ÿé—œåç¨±'] || 'æ”¿åºœæ©Ÿé—œ'}', '${buildGovUrl(record)}')">
                                    <i class="fas fa-calendar-times me-1"></i>æˆªæ­¢æŠ•æ¨™åŠ å…¥è¡Œäº‹æ›†
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${brief.companies?.names?.length > 0 ? `
                        <h6 class="mt-3">ç›¸é—œå…¬å¸</h6>
                        <ul>
                            ${brief.companies.names.map(name => `<li>${name}</li>`).join('')}
                        </ul>
                    ` : '<p class="mt-3">ç„¡ç›¸é—œå…¬å¸è³‡æ–™</p>'}
                    
                    <div class="mt-3">
                        <a href="${buildGovUrl(record)}" target="_blank" class="btn btn-primary me-2">
                            <i class="fas fa-external-link-alt me-1"></i>æŸ¥çœ‹å®Œæ•´æ¨™æ¡ˆé é¢
                        </a>
                        <button class="btn btn-secondary me-2" onclick="closeDetailModal()">
                            <i class="fas fa-times me-1"></i>é—œé–‰æ­¤é é¢
                        </button>
                    </div>
                `;
            }
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('[data-record-index]').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.recordIndex) === index) {
                    btn.classList.add('active');
                }
            });
        }

        // é¡¯ç¤ºè©³ç´°è³‡æ–™
        async function showDetail(unitId, jobNumber, date) {
            try {
                showMessage('æ­£åœ¨è¼‰å…¥æ¨™æ¡ˆè©³ç´°è³‡æ–™...', 'info');

                const { resp, url } = await fetchFromApis(`/tender?unit_id=${encodeURIComponent(unitId)}&job_number=${encodeURIComponent(jobNumber)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                }, 12000, 1);  // æ¸›å°‘é‡è©¦æ¬¡æ•¸å¾ 2 æ¬¡åˆ° 1 æ¬¡

                console.log('æˆåŠŸä½¿ç”¨ API:', url);
                console.log('API å›æ‡‰ç‹€æ…‹:', resp.status, resp.statusText);
                const data = await resp.json();
                console.log('API å›æ‡‰è³‡æ–™:', data);
                
                // å–å¾—æ‰€æœ‰è¨˜éŒ„
                const records = data.records || [data];
                const currentRecord = records[0];
                const brief = currentRecord.brief || {};
                const detail = currentRecord.detail || {};
                
                // æ ¼å¼åŒ–æ—¥æœŸ
                const dateStr = currentRecord.date ? currentRecord.date.toString() : date.toString();
                const formattedDate = `${dateStr.substring(0,4)}å¹´${dateStr.substring(4,6)}æœˆ${dateStr.substring(6,8)}æ—¥`;
                
                // ç”Ÿæˆåˆ†é æŒ‰éˆ•
                const paginationButtons = records.length > 1 ? `
                    <div class="mb-3">
                        <h6>æ¨™æ¡ˆé€²åº¦åˆ†é </h6>
                        <div class="btn-group" role="group">
                            ${records.map((record, index) => {
                                const recordDate = record.date ? record.date.toString() : '';
                                const recordFormattedDate = recordDate ? `${recordDate.substring(0,4)}å¹´${recordDate.substring(4,6)}æœˆ${recordDate.substring(6,8)}æ—¥` : '';
                                const recordType = record.brief?.type || 'ç„¡è³‡æ–™';
                                const isActive = index === 0 ? 'active' : '';
                                return `
                                    <button type="button" class="btn btn-outline-primary btn-sm ${isActive}" 
                                            onclick="switchTenderRecord(${index})" 
                                            data-record-index="${index}">
                                        ${recordFormattedDate}<br>
                                        <small>${recordType}</small>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : '';
                
                // é¡¯ç¤ºè©³ç´°è³‡æ–™
                const detailHtml = `
                    <div class="modal fade" id="detailModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">æ¨™æ¡ˆè©³ç´°è³‡æ–™</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    ${paginationButtons}
                                    
                                    <div id="tenderDetailContent">
                                        <h6>åŸºæœ¬è³‡è¨Š</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>æ¨™æ¡ˆåç¨±</strong></td><td>${brief.title || 'ç„¡è³‡æ–™'}</td></tr>
                                            <tr><td><strong>æ¨™æ¡ˆé¡å‹</strong></td><td>${brief.type || 'ç„¡è³‡æ–™'}</td></tr>
                                            <tr><td><strong>ç™¼å¸ƒæ—¥æœŸ</strong></td><td>${formattedDate}</td></tr>
                                            <tr><td><strong>æ©Ÿé—œåç¨±</strong></td><td>${detail['æ©Ÿé—œè³‡æ–™:æ©Ÿé—œåç¨±'] || 'ç„¡è³‡æ–™'}</td></tr>
                                            <tr><td><strong>æ¨™æ¡ˆç·¨è™Ÿ</strong></td><td>${currentRecord.job_number || 'ç„¡è³‡æ–™'}</td></tr>
                                            <tr><td><strong>æ©Ÿé—œä»£ç¢¼</strong></td><td>${currentRecord.unit_id || 'ç„¡è³‡æ–™'}</td></tr>
                                            <tr><td><strong>åˆ†é¡</strong></td><td>${brief.category || 'ç„¡è³‡æ–™'}</td></tr>
                                            <tr><td><strong>é ç®—é‡‘é¡</strong></td><td>${detail['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡'] || 'ç„¡è³‡æ–™'}</td></tr>
                                        </table>
                                        
                                        ${isTenderAwarded(brief.type, detail) ? getAwardInfo(detail) : getTenderInfo(detail)}
                                        
                                        <div class="mt-3">
                                            <h6>é‡è¦æ™‚é–“æé†’</h6>
                                            <div class="d-flex gap-2 flex-wrap">
                                                ${detail['é ˜æŠ•é–‹æ¨™:é–‹æ¨™æ™‚é–“'] ? `
                                                    <button class="btn btn-outline-primary btn-sm" 
                                                            onclick="addToCalendar('${brief.title || 'æ¨™æ¡ˆ'} - é–‹æ¨™', '${detail['é ˜æŠ•é–‹æ¨™:é–‹æ¨™æ™‚é–“']}', '${detail['é ˜æŠ•é–‹æ¨™:é–‹æ¨™åœ°é»'] || detail['æ©Ÿé—œè³‡æ–™:æ©Ÿé—œåç¨±'] || 'æ”¿åºœæ©Ÿé—œ'}', '${buildGovUrl(currentRecord)}')">
                                                        <i class="fas fa-calendar-plus me-1"></i>é–‹æ¨™æ™‚é–“åŠ å…¥è¡Œäº‹æ›†
                                                    </button>
                                                ` : ''}
                                                ${detail['é ˜æŠ•é–‹æ¨™:æˆªæ­¢æŠ•æ¨™'] ? `
                                                    <button class="btn btn-outline-warning btn-sm" 
                                                            onclick="addToCalendar('${brief.title || 'æ¨™æ¡ˆ'} - æˆªæ­¢æŠ•æ¨™', '${detail['é ˜æŠ•é–‹æ¨™:æˆªæ­¢æŠ•æ¨™']}', '${detail['é ˜æŠ•é–‹æ¨™:é–‹æ¨™åœ°é»'] || detail['æ©Ÿé—œè³‡æ–™:æ©Ÿé—œåç¨±'] || 'æ”¿åºœæ©Ÿé—œ'}', '${buildGovUrl(currentRecord)}')">
                                                        <i class="fas fa-calendar-times me-1"></i>æˆªæ­¢æŠ•æ¨™åŠ å…¥è¡Œäº‹æ›†
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                        
                                        ${isTenderAwarded(brief.type, detail) ? renderAwardItemsSection(detail, currentRecord.job_number || currentRecord.brief?.job_number || '') : ''}
                                        
                                        ${brief.companies?.names?.length > 0 ? `
                                            <h6 class="mt-3">ç›¸é—œå…¬å¸</h6>
                                            <ul>
                                                ${brief.companies.names.map(name => `<li>${name}</li>`).join('')}
                                            </ul>
                                        ` : '<p class="mt-3">ç„¡ç›¸é—œå…¬å¸è³‡æ–™</p>'}
                                        
                                        <div class="mt-3">
                                            <a href="${buildGovUrl(currentRecord)}" target="_blank" class="btn btn-primary me-2">
                                                <i class="fas fa-external-link-alt me-1"></i>æŸ¥çœ‹å®Œæ•´æ¨™æ¡ˆé é¢
                                            </a>
                                            <button class="btn btn-secondary me-2" onclick="closeDetailModal()">
                                                <i class="fas fa-times me-1"></i>é—œé–‰æ­¤é é¢
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // å„²å­˜è¨˜éŒ„è³‡æ–™ä¾›åˆ†é ä½¿ç”¨
                window.tenderRecords = records;
                
                // ç§»é™¤èˆŠçš„ modalï¼ˆåŒ…æ‹¬ backdropï¼‰
                const oldModal = document.getElementById('detailModal');
                if (oldModal) {
                    console.log('ç§»é™¤èˆŠçš„ modal');
                    const bsModal = bootstrap.Modal.getInstance(oldModal);
                    if (bsModal) {
                        bsModal.dispose();
                    }
                    oldModal.remove();
                }
                // ç§»é™¤å¯èƒ½æ®˜ç•™çš„ backdrop
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                    console.log('ç§»é™¤æ®˜ç•™çš„ backdrop');
                    backdrop.remove();
                });
                
                // ç¢ºä¿ body æ²’æœ‰ modal-open class
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                // æ·»åŠ æ–°çš„ modal
                console.log('æ·»åŠ æ–°çš„ modal');
                document.body.insertAdjacentHTML('beforeend', detailHtml);
                
                // é¡¯ç¤º modal
                const modalElement = document.getElementById('detailModal');
                if (!modalElement) {
                    throw new Error('ç„¡æ³•å‰µå»º modal å…ƒç´ ');
                }
                
                console.log('åˆå§‹åŒ– Bootstrap Modal');
                try {
                    const modal = new bootstrap.Modal(modalElement, {
                        backdrop: true,
                        keyboard: true,
                        focus: true
                    });
                    
                    console.log('é¡¯ç¤º modal');
                    modal.show();
                    
                    // ç›£è½ modal é¡¯ç¤ºäº‹ä»¶
                    modalElement.addEventListener('shown.bs.modal', function () {
                        console.log('Modal å·²æˆåŠŸé¡¯ç¤º');
                    });
                    
                    // ç›£è½ modal éš±è—äº‹ä»¶
                    modalElement.addEventListener('hidden.bs.modal', function () {
                        console.log('Modal å·²é—œé–‰');
                        // æ¸…ç†
                        modalElement.remove();
                        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                    });
                    
                } catch (modalError) {
                    console.error('Modal åˆå§‹åŒ–éŒ¯èª¤:', modalError);
                    throw new Error(`Modal åˆå§‹åŒ–å¤±æ•—: ${modalError.message}`);
                }
                
                // æ¸…é™¤è¼‰å…¥è¨Šæ¯
                hideMessage();
                console.log('è©³ç´°è³‡æ–™è¼‰å…¥å®Œæˆ');
                
            } catch (error) {
                console.error('è¼‰å…¥è©³ç´°è³‡æ–™éŒ¯èª¤:', error);
                
                let errorMessage = 'è¼‰å…¥è©³ç´°è³‡æ–™å¤±æ•—ï¼š<br>';
                
                // è§£æéŒ¯èª¤è¨Šæ¯
                if (error.message.includes('æ‰€æœ‰ API ä¾†æºå‡å¤±æ•—')) {
                    errorMessage += 'ç„¡æ³•é€£æ¥åˆ°ä»»ä½• API ä¾†æº<br>';
                    errorMessage += `<small class="text-muted">éŒ¯èª¤è©³æƒ…ï¼š${error.message}</small>`;
                } else if (error.name === 'AbortError') {
                    errorMessage += 'è«‹æ±‚è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š';
                } else if (error.message.includes('HTTP')) {
                    errorMessage += `API å›æ‡‰éŒ¯èª¤ï¼š${error.message}`;
                } else {
                    errorMessage += `${error.message}`;
                }
                
                errorMessage += `<br><br><small class="text-muted">æ¨™æ¡ˆè³‡è¨Šï¼š${unitId} / ${jobNumber}</small>`;
                errorMessage += `<br><small class="text-muted">å»ºè­°ï¼šç¨å¾Œå†è©¦ï¼Œæˆ–å˜—è©¦é‡æ–°æ•´ç†é é¢</small>`;
                
                showNotification('è¼‰å…¥è©³ç´°è³‡æ–™å¤±æ•—', errorMessage, 'error');
            }
        }

        // éåŒæ­¥å–å¾—å®˜æ–¹é€£çµï¼ˆå„ªå…ˆå–å¾— pkPmsMainï¼‰
        const urlCache = new Map();
        async function getOfficialUrl(unitId, jobNumber) {
            const cacheKey = `${unitId}::${jobNumber}`;
            if (urlCache.has(cacheKey)) {
                return urlCache.get(cacheKey);
            }
            try {
                const { resp } = await fetchFromApis(`/tender?unit_id=${encodeURIComponent(unitId)}&job_number=${encodeURIComponent(jobNumber)}`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                }, 10000, 1);
                const data = await resp.json();
                const rec = (data.records && data.records[0]) || data;
                const url = buildGovUrl(rec);
                urlCache.set(cacheKey, url);
                return url;
            } catch (err) {
                console.warn('ç„¡æ³•å–å¾—å®˜æ–¹é€£çµï¼Œä½¿ç”¨å‚™ç”¨:', err);
                return `https://pcc.g0v.ronny.tw/tender.html?unit_id=${unitId}&job_number=${jobNumber}`;
            }
        }

        // åˆ†äº«åˆ° Lineï¼ˆéåŒæ­¥å–å¾—å®˜æ–¹é€£çµï¼‰
        async function shareToLineAsync(title, unitName, unitId, jobNumber) {
            showNotification('æ­£åœ¨æº–å‚™åˆ†äº«é€£çµ...', 'info');
            const govUrl = await getOfficialUrl(unitId, jobNumber);
            const message = `ğŸ“‹ ${title}\nğŸ¢ æ©Ÿé—œï¼š${unitName}\nğŸ”— é€£çµï¼š${govUrl}`;
            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
            window.open(lineUrl, '_blank');
            showNotification('å·²é–‹å•Ÿ Line åˆ†äº«', 'è«‹é¸æ“‡è¦åˆ†äº«çš„å°è±¡', 'success');
        }

        // åˆ†äº«åˆ° Gmailï¼ˆéåŒæ­¥å–å¾—å®˜æ–¹é€£çµï¼‰
        async function shareToGmailAsync(title, unitName, jobNumber, unitId, jobNum) {
            showNotification('æ­£åœ¨æº–å‚™åˆ†äº«é€£çµ...', 'info');
            const govUrl = await getOfficialUrl(unitId, jobNum);
            const subject = `æ”¿åºœæ¡è³¼æ¨™æ¡ˆï¼š${title}`;
            const body = `
æ”¿åºœæ¡è³¼æ¨™æ¡ˆè³‡è¨Š

æ¨™æ¡ˆåç¨±ï¼š${title}
æ©Ÿé—œåç¨±ï¼š${unitName}
æ¡ˆè™Ÿï¼š${jobNumber}

è©³ç´°è³‡æ–™é€£çµï¼š
${govUrl}

---
æ­¤éƒµä»¶ç”±æ”¿åºœæ¡è³¼æ¨™æ¡ˆæŸ¥è©¢ç³»çµ±è‡ªå‹•ç”¢ç”Ÿ
            `.trim();
            
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(gmailUrl, '_blank');
            showNotification('å·²é–‹å•Ÿ Gmail', 'è«‹å¡«å¯«æ”¶ä»¶äºº', 'success');
        }

        // è¤‡è£½å®˜æ–¹é€£çµï¼ˆéåŒæ­¥å–å¾—ï¼‰
        async function copyLinkAsync(title, unitId, jobNumber) {
            showNotification('æ­£åœ¨å–å¾—å®˜æ–¹é€£çµ...', 'info');
            const govUrl = await getOfficialUrl(unitId, jobNumber);
            try {
                await navigator.clipboard.writeText(govUrl);
                showNotification('é€£çµå·²è¤‡è£½', `å·²è¤‡è£½ã€Œ${title}ã€çš„å®˜æ–¹é€£çµåˆ°å‰ªè²¼ç°¿`, 'success');
            } catch (error) {
                // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å‚³çµ±çš„è¤‡è£½æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = govUrl;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showNotification('é€£çµå·²è¤‡è£½', `å·²è¤‡è£½ã€Œ${title}ã€çš„å®˜æ–¹é€£çµåˆ°å‰ªè²¼ç°¿`, 'success');
                } catch (err) {
                    showNotification('è¤‡è£½å¤±æ•—', 'ç„¡æ³•è¤‡è£½é€£çµï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'error');
                }
                
                document.body.removeChild(textArea);
            }
        }

        // åŠ å…¥ Google Calendar
        function addToCalendar(title, dateStr, unit, url) {
            try {
                // ç¢ºä¿ URL æ˜¯æ­£ç¢ºçš„æ”¿åºœæ¡è³¼ç¶²é€£çµ
                const govUrl = buildGovUrl({url: url});
                
                // è§£ææ—¥æœŸå­—ä¸² (æ ¼å¼: 114/10/03 15:30 æˆ– 114/10/17 17:00)
                let year, month, day, hour, minute;
                
                if (dateStr && dateStr.includes('/')) {
                    const parts = dateStr.split(' ');
                    const datePart = parts[0]; // 114/10/03
                    const timePart = parts[1] || '09:00'; // 15:30 æˆ–é è¨­ 09:00
                    
                    const [y, m, d] = datePart.split('/');
                    const [h, min] = timePart.split(':');
                    
                    // æ°‘åœ‹å¹´è½‰è¥¿å…ƒå¹´
                    year = parseInt(y) + 1911;
                    month = m.padStart(2, '0');
                    day = d.padStart(2, '0');
                    hour = h.padStart(2, '0');
                    minute = min.padStart(2, '0');
                } else {
                    // å¦‚æœæ²’æœ‰æ—¥æœŸï¼Œä½¿ç”¨ç•¶å‰æ—¥æœŸ
                    const now = new Date();
                    year = now.getFullYear();
                    month = String(now.getMonth() + 1).padStart(2, '0');
                    day = String(now.getDate()).padStart(2, '0');
                    hour = '09';
                    minute = '00';
                }
                
                // æ§‹å»º Google Calendar URL
                const startDate = `${year}${month}${day}T${hour}${minute}00`;
                const endDate = `${year}${month}${day}T${String(parseInt(hour) + 1).padStart(2, '0')}${minute}00`;
                
                const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent(`æ©Ÿé—œï¼š${unit}\næ¨™æ¡ˆé€£çµï¼š${govUrl}`)}&location=${encodeURIComponent(unit)}`;
                
                // æ‰“é–‹ Google Calendar
                window.open(calendarUrl, '_blank');
                
                showMessage('å·²é–‹å•Ÿ Google Calendar æ–°å¢äº‹ä»¶é é¢', 'success');
                
            } catch (error) {
                console.error('åŠ å…¥è¡Œäº‹æ›†éŒ¯èª¤:', error);
                showMessage(`åŠ å…¥è¡Œäº‹æ›†å¤±æ•—ï¼š${error.message}`, 'error');
            }
        }
        
        // é–‹å§‹ AI å°è©±
        function startChat(title, unit, type) {
            const chatModal = document.getElementById('chatModal');
            if (chatModal) {
                const modal = new bootstrap.Modal(chatModal);
                modal.show();
                
                // è¨­å®šå°è©±ä¸Šä¸‹æ–‡
                window.currentChatContext = {
                    title: title,
                    unit: unit,
                    type: type
                };
                
                // æ¸…ç©ºå°è©±è¨˜éŒ„
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `
                    <div class="chat-message bot-message">
                        <div class="message-content">
                            <strong>AI åŠ©æ‰‹ï¼š</strong>æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„æ”¿åºœæ¡è³¼æ¨™æ¡ˆ AI åŠ©æ‰‹ã€‚æˆ‘å¯ä»¥å¹«æ‚¨åˆ†ææ¨™æ¡ˆè³‡è¨Šã€å›ç­”ç›¸é—œå•é¡Œï¼Œæˆ–æä¾›æŠ•æ¨™å»ºè­°ã€‚
                            <br><br>
                            <strong>ç•¶å‰æ¨™æ¡ˆï¼š</strong>${title}<br>
                            <strong>æ©Ÿé—œï¼š</strong>${unit}<br>
                            <strong>é¡å‹ï¼š</strong>${type}
                            <br><br>
                            è«‹å‘Šè¨´æˆ‘æ‚¨æƒ³äº†è§£ä»€éº¼ï¼Ÿ
                        </div>
                    </div>
                `;
            } else {
                showMessage('å°è©±åŠŸèƒ½å°šæœªåˆå§‹åŒ–ï¼Œè«‹å…ˆè¨­å®š Gemini API Key', 'error');
            }
        }

        // è™•ç†å°è©±è¼¸å…¥éµç›¤äº‹ä»¶
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
        
        // ç™¼é€å°è©±è¨Šæ¯
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            input.value = '';
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ Gemini API Key
            const geminiKey = document.getElementById('geminiKey').value.trim();
            if (!geminiKey) {
                addChatMessage('user', message);
                addChatMessage('bot', 'è«‹å…ˆåœ¨æœå°‹å€åŸŸè¨­å®š Gemini API Key æ‰èƒ½ä½¿ç”¨å°è©±åŠŸèƒ½ã€‚');
                return;
            }
            
            // æ·»åŠ ç”¨æˆ¶è¨Šæ¯
            addChatMessage('user', message);
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­
            const loadingId = addChatMessage('bot', 'æ­£åœ¨æ€è€ƒä¸­...', true);
            
            try {
                // æ§‹å»ºå°è©±æç¤º
                const context = window.currentChatContext || {};
                const prompt = `ä½ æ˜¯æ”¿åºœæ¡è³¼æ¨™æ¡ˆçš„å°ˆæ¥­ AI åŠ©æ‰‹ã€‚è«‹æ ¹æ“šä»¥ä¸‹æ¨™æ¡ˆè³‡è¨Šå›ç­”ç”¨æˆ¶å•é¡Œï¼š

æ¨™æ¡ˆåç¨±ï¼š${context.title || 'æœªçŸ¥'}
æ©Ÿé—œï¼š${context.unit || 'æœªçŸ¥'}
é¡å‹ï¼š${context.type || 'æœªçŸ¥'}

ç”¨æˆ¶å•é¡Œï¼š${message}

è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œæä¾›å°ˆæ¥­ã€å¯¦ç”¨çš„å»ºè­°ã€‚å¦‚æœå•é¡Œèˆ‡æ¨™æ¡ˆç„¡é—œï¼Œè«‹ç¦®è²Œåœ°å¼•å°ç”¨æˆ¶å›åˆ°æ¨™æ¡ˆç›¸é—œè©±é¡Œã€‚`;
                
                // èª¿ç”¨ Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API éŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 'æŠ±æ­‰ï¼Œæˆ‘ç„¡æ³•ç”Ÿæˆå›æ‡‰ã€‚';
                
                // æ›´æ–°è¼‰å…¥ä¸­çš„è¨Šæ¯
                updateChatMessage(loadingId, 'bot', aiResponse);
                
            } catch (error) {
                console.error('å°è©±éŒ¯èª¤:', error);
                updateChatMessage(loadingId, 'bot', `æŠ±æ­‰ï¼Œç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}`);
            }
        }
        
        // æ·»åŠ å°è©±è¨Šæ¯
        function addChatMessage(sender, message, isLoading = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `chat-message ${sender}-message mb-3`;
            
            const senderName = sender === 'user' ? 'æ‚¨' : 'AI åŠ©æ‰‹';
            const messageClass = sender === 'user' ? 'text-end' : 'text-start';
            
            messageDiv.innerHTML = `
                <div class="message-content ${messageClass}">
                    <strong>${senderName}ï¼š</strong>
                    <div class="message-text">${message}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageId;
        }
        
        // æ›´æ–°å°è©±è¨Šæ¯
        function updateChatMessage(messageId, sender, message) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                const messageText = messageDiv.querySelector('.message-text');
                if (messageText) {
                    messageText.innerHTML = message;
                }
            }
        }



        // é–‹å•Ÿå…¬å¸åˆ†æé é¢
        function openCompanyAnalysis(companyName) {
            // åœ¨æ–°åˆ†é ä¸­é–‹å•Ÿå…¬å¸åˆ†æé é¢ï¼ˆä¸å†å¼·åˆ¶è¦æ±‚ API Keyï¼‰
            const geminiKey = document.getElementById('geminiKey').value.trim();
            const analysisUrl = geminiKey 
                ? `company_analysis.html?company=${encodeURIComponent(companyName)}&key=${encodeURIComponent(geminiKey)}`
                : `company_analysis.html?company=${encodeURIComponent(companyName)}`;
            
            // åœ¨æ–°åˆ†é ä¸­é–‹å•Ÿ
            window.open(analysisUrl, '_blank');
            
            showNotification('åˆ†æé–‹å§‹', `æ­£åœ¨æ–°åˆ†é ä¸­åˆ†æ ${companyName} çš„å¾—æ¨™æƒ…æ³...`, 'info');
        }

        // æ¸…é™¤æœå°‹çµæœ
        function clearSearchResults() {
            // éš±è—æœå°‹çµæœå€åŸŸ
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('resultFilters').style.display = 'none';
            
            // æ¸…ç©ºçµæœåˆ—è¡¨
            document.getElementById('resultsList').innerHTML = '';
            
            // æ¸…ç©ºçµ±è¨ˆè³‡æ–™
            document.getElementById('resultStats').innerHTML = '';
            
            // æ¸…ç©ºå…¨åŸŸè®Šæ•¸
            window.allSearchResults = [];
            window.isGeminiSearch = false;
            
            // ç¢ºä¿æœå°‹æŒ‰éˆ•å’Œè¼¸å…¥æ¡†å¯ç”¨
            document.querySelectorAll('input, button').forEach(element => {
                element.disabled = false;
            });
            
            // é¡¯ç¤ºæ¸…é™¤è¨Šæ¯
            showNotification('æ¸…é™¤å®Œæˆ', 'æœå°‹çµæœå·²æ¸…é™¤ï¼Œå¯ä»¥é€²è¡Œæ–°çš„æœå°‹', 'success');
        }

        // é¡¯ç¤º Gemini API Key å¹«åŠ©
        function showGeminiHelp() {
            const helpText = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-robot me-2"></i>å¦‚ä½•å–å¾— Gemini API Key</h6>
                    <ol>
                        <li>å‰å¾€ <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></li>
                        <li>ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</li>
                        <li>é»æ“Šã€ŒCreate API Keyã€</li>
                        <li>è¤‡è£½ç”¢ç”Ÿçš„ API Key ä¸¦è²¼åˆ°ä¸Šæ–¹æ¬„ä½</li>
                    </ol>
                    <p class="mb-0"><strong>æ³¨æ„ï¼š</strong>API Key ç”¨æ–¼ AI å°è©±å’Œæ™ºèƒ½åˆ†æåŠŸèƒ½ï¼Œä¸æœƒå„²å­˜åœ¨æœ¬æ©Ÿã€‚</p>
                </div>
            `;
            showMessage(helpText, 'info');
        }

        // é¡¯ç¤º ChatGPT API Key å¹«åŠ©
        function showChatGPTHelp() {
            const helpText = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-comments me-2"></i>å¦‚ä½•å–å¾— ChatGPT API Key</h6>
                    <ol>
                        <li>å‰å¾€ <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a></li>
                        <li>ä½¿ç”¨ OpenAI å¸³è™Ÿç™»å…¥ï¼ˆå¦‚ç„¡å¸³è™Ÿè«‹å…ˆè¨»å†Šï¼‰</li>
                        <li>é»æ“Šã€ŒCreate new secret keyã€</li>
                        <li>è¤‡è£½ç”¢ç”Ÿçš„ API Key ä¸¦è²¼åˆ°ä¸Šæ–¹æ¬„ä½</li>
                    </ol>
                    <p class="mb-0"><strong>æ³¨æ„ï¼š</strong>API Key ç”¨æ–¼ ChatGPT å°è©±åŠŸèƒ½ï¼Œè«‹å¦¥å–„ä¿ç®¡ï¼Œä¸æœƒå„²å­˜åœ¨æœ¬æ©Ÿã€‚</p>
                </div>
            `;
            showMessage(helpText, 'info');
        }

        // è¤‡è£½éŒ¯èª¤è¨Šæ¯åˆ°å‰ªè²¼ç°¿
        async function copyErrorMessage() {
            const notification = document.querySelector('.notification.error .notification-body');
            if (!notification) return;
            
            // ç§»é™¤ HTML æ¨™ç±¤ï¼Œåªä¿ç•™æ–‡å­—å…§å®¹
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = notification.innerHTML;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';
            
            try {
                await navigator.clipboard.writeText(textContent);
                // é¡¯ç¤ºè¤‡è£½æˆåŠŸçš„å°æç¤º
                const copyBtn = document.querySelector('.copy-error-btn');
                if (copyBtn) {
                    const originalHTML = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>å·²è¤‡è£½';
                    copyBtn.classList.add('btn-success');
                    copyBtn.classList.remove('btn-outline-secondary');
                    setTimeout(() => {
                        copyBtn.innerHTML = originalHTML;
                        copyBtn.classList.remove('btn-success');
                        copyBtn.classList.add('btn-outline-secondary');
                    }, 2000);
                }
            } catch (error) {
                // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å‚³çµ±çš„è¤‡è£½æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = textContent;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    alert('éŒ¯èª¤è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
                } catch (err) {
                    alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½éŒ¯èª¤è¨Šæ¯');
                }
                
                document.body.removeChild(textArea);
            }
        }

        // é¡¯ç¤ºå½ˆå‡ºå¼é€šçŸ¥
        function showNotification(title, message, type = 'info', duration = 5000) {
            // ç§»é™¤ç¾æœ‰çš„é€šçŸ¥
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // å‰µå»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconMap = {
                'error': 'fas fa-exclamation-triangle',
                'success': 'fas fa-check-circle',
                'info': 'fas fa-info-circle',
                'warning': 'fas fa-exclamation-circle'
            };
            
            // éŒ¯èª¤è¨Šæ¯æ·»åŠ è¤‡è£½æŒ‰éˆ•
            const errorActions = type === 'error' ? `
                <div class="notification-actions">
                    <button class="btn btn-sm copy-error-btn" onclick="copyErrorMessage()" title="è¤‡è£½éŒ¯èª¤è¨Šæ¯ä»¥ä¾¿å›å ±å•é¡Œ">
                        <i class="fas fa-copy me-1"></i>è¤‡è£½éŒ¯èª¤è¨Šæ¯
                    </button>
                </div>
            ` : '';
            
            notification.innerHTML = `
                <div class="notification-header">
                    <h6 class="notification-title">
                        <i class="${iconMap[type] || 'fas fa-info-circle'} me-2"></i>${title}
                    </h6>
                    <button class="notification-close" onclick="closeNotification()" title="é—œé–‰">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="notification-body">
                    <div class="notification-message">${message}</div>
                    ${errorActions}
                </div>
            `;
            
            // æ·»åŠ åˆ°é é¢
            document.body.appendChild(notification);
            
            // è‡ªå‹•é—œé–‰ï¼ˆé™¤äº†éŒ¯èª¤é€šçŸ¥ï¼‰
            if (type !== 'error' && duration > 0) {
                setTimeout(() => {
                    closeNotification();
                }, duration);
            }
        }

        // é—œé–‰é€šçŸ¥
        function closeNotification() {
            const notification = document.querySelector('.notification');
            if (notification) {
                notification.style.animation = 'slideUp 0.3s ease-out';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }
        }

        // æ·»åŠ é—œé–‰å‹•ç•«
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideUp {
                from {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(-50%) translateY(-20px);
                }
            }
        `;
        document.head.appendChild(style);

        // é¡¯ç¤ºè¨Šæ¯ï¼ˆå…¼å®¹èˆŠç‰ˆæœ¬ï¼‰
        function showMessage(message, type = 'info') {
            showNotification('ç³»çµ±è¨Šæ¯', message, type);
        }

        // éš±è—è¨Šæ¯ï¼ˆå…¼å®¹èˆŠç‰ˆæœ¬ï¼‰
        function hideMessage() {
            closeNotification();
        }

        // åŸ·è¡Œ AI åˆ†æ
        async function performAIAnalysis(results, geminiKey) {
            if (!results || results.length === 0) {
                return;
            }

            try {
                // é¡¯ç¤º AI åˆ†æè¼‰å…¥ä¸­
                document.getElementById('aiLoading').style.display = 'block';
                document.getElementById('aiAnalysisResults').style.display = 'block';

                // æ§‹å»ºåˆ†ææç¤º
                const analysisPrompt = `è«‹åˆ†æä»¥ä¸‹æ”¿åºœæ¡è³¼æ¨™æ¡ˆè³‡æ–™ï¼š

æ¨™æ¡ˆè³‡æ–™ï¼š
${JSON.stringify(results.slice(0, 10), null, 2)}

è«‹æä¾›ä»¥ä¸‹åˆ†æï¼š

1. **æ¨™æ¡ˆé¡å‹åˆ†æ**
   - é–‹æ¨™èˆ‡æ±ºæ¨™æ¡ˆä»¶æ¯”ä¾‹
   - ä¸»è¦æ¨™æ¡ˆé¡å‹åˆ†å¸ƒ

2. **æ©Ÿé—œåˆ†æ**
   - ä¸»è¦ç™¼åŒ…æ©Ÿé—œ
   - æ©Ÿé—œé¡å‹åˆ†å¸ƒ

3. **æ™‚é–“è¶¨å‹¢åˆ†æ**
   - æ¨™æ¡ˆç™¼å¸ƒæ™‚é–“åˆ†å¸ƒ
   - æ˜¯å¦æœ‰å­£ç¯€æ€§è¶¨å‹¢

4. **é‡‘é¡åˆ†æ**
   - æ¨™æ¡ˆé‡‘é¡åˆ†å¸ƒ
   - é«˜é‡‘é¡æ¨™æ¡ˆç‰¹å¾µ

5. **é—œéµæ´å¯Ÿ**
   - é‡è¦ç™¼ç¾
   - å»ºè­°é—œæ³¨çš„æ¨™æ¡ˆ

è«‹ä»¥å°ˆæ¥­ã€ç°¡æ½”çš„æ–¹å¼å‘ˆç¾åˆ†æçµæœï¼Œä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚`;

                // èª¿ç”¨ Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: analysisPrompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Gemini API éŒ¯èª¤: ${response.status}`);
                }

                const data = await response.json();
                const analysisText = data.candidates[0].content.parts[0].text;

                // é¡¯ç¤ºåˆ†æçµæœ
                document.getElementById('aiContent').innerHTML = `
                    <div class="analysis-content">
                        <div style="white-space: pre-line; line-height: 1.8; font-size: 1.1rem;">${analysisText}</div>
                    </div>
                `;

            } catch (error) {
                console.error('AI åˆ†æéŒ¯èª¤:', error);
                document.getElementById('aiContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        AI åˆ†æå¤±æ•—ï¼š${error.message}
                    </div>
                `;
            } finally {
                // éš±è—è¼‰å…¥ä¸­
                document.getElementById('aiLoading').style.display = 'none';
            }
        }

        // ==================== è‡ªå‹•ç›£æ§åŠŸèƒ½ ====================
        
        let autoMonitorInterval = null;
        let autoMonitorData = {
            enabled: false,
            keywords: [],
            times: ['08:00', '17:00'],
            dateRange: 'today',
            notifyBrowser: true,
            notifySound: true,
            todaySearchCount: 0,
            todayResultCount: 0,
            todayNewCount: 0,
            lastSearchTime: null,
            searchHistory: [],
            seenTenders: new Set()
        };

        // è¼‰å…¥ç›£æ§è¨­å®š
        function loadMonitorSettings() {
            const saved = localStorage.getItem('autoMonitorData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    autoMonitorData = { ...autoMonitorData, ...data };
                    // å°‡ seenTenders å¾é™£åˆ—è½‰æ›å› Set
                    if (data.seenTenders && Array.isArray(data.seenTenders)) {
                        autoMonitorData.seenTenders = new Set(data.seenTenders);
                    }
                    
                    // æ›´æ–° UI
                    if (autoMonitorData.keywords.length > 0) {
                        document.getElementById('monitorKeywords').value = autoMonitorData.keywords.join('\n');
                    }
                    document.getElementById('monitorDateRange').value = autoMonitorData.dateRange;
                    document.getElementById('monitor08').checked = autoMonitorData.times.includes('08:00');
                    document.getElementById('monitor17').checked = autoMonitorData.times.includes('17:00');
                    document.getElementById('monitorNotifyBrowser').checked = autoMonitorData.notifyBrowser;
                    document.getElementById('monitorNotifySound').checked = autoMonitorData.notifySound;
                    
                    // æ›´æ–°çµ±è¨ˆ
                    updateMonitorStats();
                    
                    // å¦‚æœä¹‹å‰å·²å•Ÿç”¨ï¼Œé‡æ–°å•Ÿå‹•
                    if (autoMonitorData.enabled) {
                        startAutoMonitor();
                    }
                } catch (e) {
                    console.error('è¼‰å…¥ç›£æ§è¨­å®šå¤±æ•—:', e);
                }
            }
        }

        // å„²å­˜ç›£æ§è¨­å®š
        function saveMonitorSettings() {
            const keywords = document.getElementById('monitorKeywords').value
                .split('\n')
                .map(k => k.trim())
                .filter(k => k.length > 0);
            
            if (keywords.length === 0) {
                showNotification('å„²å­˜å¤±æ•—', 'è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹ç›£æ§é—œéµå­—', 'error');
                return;
            }
            
            autoMonitorData.keywords = keywords;
            autoMonitorData.dateRange = document.getElementById('monitorDateRange').value;
            autoMonitorData.notifyBrowser = document.getElementById('monitorNotifyBrowser').checked;
            autoMonitorData.notifySound = document.getElementById('monitorNotifySound').checked;
            
            // æ›´æ–°ç›£æ§æ™‚é–“
            const times = [];
            if (document.getElementById('monitor08').checked) times.push('08:00');
            if (document.getElementById('monitor17').checked) times.push('17:00');
            autoMonitorData.times = times;
            
            // å„²å­˜åˆ° localStorage (å°‡ Set è½‰æ›ç‚ºé™£åˆ—)
            const dataToSave = {
                ...autoMonitorData,
                seenTenders: Array.from(autoMonitorData.seenTenders)
            };
            localStorage.setItem('autoMonitorData', JSON.stringify(dataToSave));
            
            showNotification('å„²å­˜æˆåŠŸ', `å·²å„²å­˜ ${keywords.length} å€‹ç›£æ§é—œéµå­—`, 'success');
        }

        // åˆ‡æ›è‡ªå‹•ç›£æ§é¢æ¿
        function toggleAutoMonitor() {
            const section = document.getElementById('autoMonitorSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                // è«‹æ±‚ç€è¦½å™¨é€šçŸ¥æ¬Šé™
                if (document.getElementById('monitorNotifyBrowser').checked && 'Notification' in window) {
                    Notification.requestPermission();
                }
            } else {
                section.style.display = 'none';
            }
        }

        // å•Ÿå‹•è‡ªå‹•ç›£æ§
        function startAutoMonitor() {
            // å…ˆå„²å­˜è¨­å®š
            saveMonitorSettings();
            
            if (autoMonitorData.keywords.length === 0) {
                showNotification('å•Ÿå‹•å¤±æ•—', 'è«‹å…ˆè¨­å®šç›£æ§é—œéµå­—', 'error');
                return;
            }
            
            if (autoMonitorData.times.length === 0) {
                showNotification('å•Ÿå‹•å¤±æ•—', 'è«‹è‡³å°‘é¸æ“‡ä¸€å€‹è‡ªå‹•æœå°‹æ™‚é–“', 'error');
                return;
            }
            
            autoMonitorData.enabled = true;
            document.getElementById('monitorStatus').textContent = 'é‹ä½œä¸­';
            document.getElementById('monitorStatus').className = 'badge bg-success ms-2';
            
            // æ¸…é™¤èˆŠçš„å®šæ™‚å™¨
            if (autoMonitorInterval) {
                clearInterval(autoMonitorInterval);
            }
            
            // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦åŸ·è¡Œ
            autoMonitorInterval = setInterval(checkAndExecuteMonitor, 60000);
            
            // ç«‹å³æª¢æŸ¥ä¸€æ¬¡
            checkAndExecuteMonitor();
            
            // æ›´æ–°ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
            updateNextSearchTime();
            
            showNotification('ç›£æ§å·²å•Ÿå‹•', `å·²å•Ÿå‹•è‡ªå‹•ç›£æ§ï¼Œå°‡åœ¨ ${autoMonitorData.times.join('ã€')} è‡ªå‹•æœå°‹`, 'success');
        }

        // åœæ­¢è‡ªå‹•ç›£æ§
        function stopAutoMonitor() {
            autoMonitorData.enabled = false;
            document.getElementById('monitorStatus').textContent = 'å·²åœç”¨';
            document.getElementById('monitorStatus').className = 'badge bg-secondary ms-2';
            
            if (autoMonitorInterval) {
                clearInterval(autoMonitorInterval);
                autoMonitorInterval = null;
            }
            
            document.getElementById('nextAutoSearch').textContent = 'æœªå•Ÿç”¨';
            
            showNotification('ç›£æ§å·²åœæ­¢', 'è‡ªå‹•ç›£æ§å·²åœæ­¢', 'info');
        }

        // æª¢æŸ¥ä¸¦åŸ·è¡Œç›£æ§
        function checkAndExecuteMonitor() {
            if (!autoMonitorData.enabled) return;
            
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºè¨­å®šçš„åŸ·è¡Œæ™‚é–“
            if (autoMonitorData.times.includes(currentTime)) {
                executeAutoMonitor();
            }
            
            // æ›´æ–°ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
            updateNextSearchTime();
        }

        // åŸ·è¡Œè‡ªå‹•ç›£æ§æœå°‹
        async function executeAutoMonitor() {
            console.log('ğŸ¤– é–‹å§‹åŸ·è¡Œè‡ªå‹•ç›£æ§æœå°‹...');
            
            const keywords = autoMonitorData.keywords;
            let allResults = [];
            let newResults = [];
            
            // è¨­å®šæ—¥æœŸç¯„åœ
            setDateRange(autoMonitorData.dateRange);
            
            try {
                // é€ä¸€æœå°‹æ¯å€‹é—œéµå­—
                for (const keyword of keywords) {
                    console.log(`ğŸ” æœå°‹é—œéµå­—: ${keyword}`);
                    
                    // è¨­å®šæœå°‹æ¢ä»¶
                    document.getElementById('titleQuery').value = keyword;
                    
                    // åŸ·è¡Œæœå°‹ï¼ˆä¸é¡¯ç¤º UIï¼‰
                    const results = await searchAllData('title', keyword, 1);
                    
                    if (results && results.length > 0) {
                        // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°æ¨™æ¡ˆ
                        for (const result of results) {
                            const tenderId = `${result.unit_id}_${result.job_number}_${result.date}`;
                            if (!autoMonitorData.seenTenders.has(tenderId)) {
                                autoMonitorData.seenTenders.add(tenderId);
                                newResults.push({ ...result, keyword });
                            }
                        }
                        allResults = allResults.concat(results);
                    }
                    
                    // é¿å…è§¸ç™¼é€Ÿç‡é™åˆ¶ï¼Œæ¯å€‹é—œéµå­—ä¹‹é–“é–“éš” 1 ç§’
                    await new Promise(r => setTimeout(r, 1000));
                }
                
                // æ›´æ–°çµ±è¨ˆ
                autoMonitorData.todaySearchCount++;
                autoMonitorData.todayResultCount += allResults.length;
                autoMonitorData.todayNewCount += newResults.length;
                autoMonitorData.lastSearchTime = new Date().toISOString();
                
                // è¨˜éŒ„æœå°‹æ­·å²
                autoMonitorData.searchHistory.push({
                    time: new Date().toISOString(),
                    keywords: keywords.length,
                    results: allResults.length,
                    newResults: newResults.length
                });
                
                // åªä¿ç•™æœ€è¿‘ 30 ç­†è¨˜éŒ„
                if (autoMonitorData.searchHistory.length > 30) {
                    autoMonitorData.searchHistory = autoMonitorData.searchHistory.slice(-30);
                }
                
                // å„²å­˜è³‡æ–™
                const dataToSave = {
                    ...autoMonitorData,
                    seenTenders: Array.from(autoMonitorData.seenTenders)
                };
                localStorage.setItem('autoMonitorData', JSON.stringify(dataToSave));
                
                // æ›´æ–° UI çµ±è¨ˆ
                updateMonitorStats();
                
                // ç™¼é€é€šçŸ¥
                if (newResults.length > 0) {
                    notifyNewTenders(newResults);
                }
                
                console.log(`âœ… ç›£æ§æœå°‹å®Œæˆ: æ‰¾åˆ° ${allResults.length} ç­†çµæœï¼Œå…¶ä¸­ ${newResults.length} ç­†ç‚ºæ–°æ¨™æ¡ˆ`);
                
            } catch (error) {
                console.error('è‡ªå‹•ç›£æ§æœå°‹éŒ¯èª¤:', error);
                showNotification('ç›£æ§æœå°‹éŒ¯èª¤', error.message, 'error');
            }
        }

        // ç«‹å³æ¸¬è©¦ç›£æ§
        async function testAutoMonitor() {
            if (autoMonitorData.keywords.length === 0) {
                showNotification('æ¸¬è©¦å¤±æ•—', 'è«‹å…ˆè¨­å®šç›£æ§é—œéµå­—', 'error');
                return;
            }
            
            showNotification('é–‹å§‹æ¸¬è©¦', 'æ­£åœ¨åŸ·è¡Œæ¸¬è©¦æœå°‹...', 'info');
            await executeAutoMonitor();
            showNotification('æ¸¬è©¦å®Œæˆ', 'æ¸¬è©¦æœå°‹å·²å®Œæˆï¼Œè«‹æŸ¥çœ‹çµ±è¨ˆæ•¸æ“š', 'success');
        }

        // æ›´æ–°ä¸‹æ¬¡åŸ·è¡Œæ™‚é–“
        function updateNextSearchTime() {
            if (!autoMonitorData.enabled || autoMonitorData.times.length === 0) {
                document.getElementById('nextAutoSearch').textContent = 'æœªå•Ÿç”¨';
                return;
            }
            
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            let nextTime = null;
            let minDiff = Infinity;
            
            for (const time of autoMonitorData.times) {
                const [hours, minutes] = time.split(':').map(Number);
                const timeMinutes = hours * 60 + minutes;
                
                let diff = timeMinutes - currentMinutes;
                if (diff < 0) diff += 24 * 60; // æ˜å¤©
                
                if (diff < minDiff) {
                    minDiff = diff;
                    nextTime = time;
                }
            }
            
            const nextDate = new Date(now);
            if (minDiff >= 24 * 60 - currentMinutes) {
                nextDate.setDate(nextDate.getDate() + 1);
            }
            
            const nextTimeStr = `${nextDate.getFullYear()}/${nextDate.getMonth()+1}/${nextDate.getDate()} ${nextTime}`;
            document.getElementById('nextAutoSearch').textContent = nextTimeStr;
        }

        // æ›´æ–°ç›£æ§çµ±è¨ˆ
        function updateMonitorStats() {
            document.getElementById('monitorSearchCount').textContent = autoMonitorData.todaySearchCount;
            document.getElementById('monitorResultCount').textContent = autoMonitorData.todayResultCount;
            document.getElementById('monitorNewCount').textContent = autoMonitorData.todayNewCount;
            
            if (autoMonitorData.lastSearchTime) {
                const lastTime = new Date(autoMonitorData.lastSearchTime);
                document.getElementById('monitorLastTime').textContent = 
                    `${String(lastTime.getHours()).padStart(2, '0')}:${String(lastTime.getMinutes()).padStart(2, '0')}`;
            }
        }

        // é€šçŸ¥æ–°æ¨™æ¡ˆ
        function notifyNewTenders(newResults) {
            const count = newResults.length;
            const keywords = [...new Set(newResults.map(r => r.keyword))].join('ã€');
            
            // è²éŸ³é€šçŸ¥
            if (autoMonitorData.notifySound) {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi78OScTgwOUKfi8LZjHAY4kte2yn0sBSR3yPDekEAKFF607Oul');
                audio.play().catch(e => console.log('ç„¡æ³•æ’­æ”¾è²éŸ³:', e));
            }
            
            // ç€è¦½å™¨é€šçŸ¥
            if (autoMonitorData.notifyBrowser && 'Notification' in window && Notification.permission === 'granted') {
                new Notification('ğŸ”” ç™¼ç¾æ–°æ¨™æ¡ˆï¼', {
                    body: `æ‰¾åˆ° ${count} ç­†æ–°æ¨™æ¡ˆ\né—œéµå­—ï¼š${keywords}`,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><text y="20" font-size="20">ğŸ“‹</text></svg>',
                    tag: 'auto-monitor',
                    requireInteraction: true
                });
            }
            
            // é é¢é€šçŸ¥
            showNotification(
                'ğŸ‰ ç™¼ç¾æ–°æ¨™æ¡ˆï¼',
                `æ‰¾åˆ° ${count} ç­†æ–°æ¨™æ¡ˆ<br>é—œéµå­—ï¼š${keywords}<br><small>è«‹æŸ¥çœ‹æœå°‹çµæœ</small>`,
                'success'
            );
        }

        // é¡¯ç¤ºç›£æ§æ­·å²
        function showMonitorHistory() {
            if (autoMonitorData.searchHistory.length === 0) {
                showNotification('ç„¡æ­·å²è¨˜éŒ„', 'å°šæœªæœ‰ç›£æ§æœå°‹è¨˜éŒ„', 'info');
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-striped table-sm"><thead><tr><th>æ™‚é–“</th><th>é—œéµå­—æ•¸</th><th>æ‰¾åˆ°æ¨™æ¡ˆ</th><th>æ–°æ¨™æ¡ˆ</th></tr></thead><tbody>';
            
            autoMonitorData.searchHistory.slice().reverse().forEach(record => {
                const time = new Date(record.time);
                const timeStr = `${time.getMonth()+1}/${time.getDate()} ${String(time.getHours()).padStart(2,'0')}:${String(time.getMinutes()).padStart(2,'0')}`;
                html += `<tr>
                    <td>${timeStr}</td>
                    <td>${record.keywords}</td>
                    <td>${record.results}</td>
                    <td><strong class="text-success">${record.newResults}</strong></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            showNotification('ç›£æ§æ­·å²è¨˜éŒ„', html, 'info');
        }

        // æ¯å¤©å‡Œæ™¨é‡ç½®ä»Šæ—¥çµ±è¨ˆ
        setInterval(() => {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() === 0) {
                autoMonitorData.todaySearchCount = 0;
                autoMonitorData.todayResultCount = 0;
                autoMonitorData.todayNewCount = 0;
                updateMonitorStats();
            }
        }, 60000);

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–ç›£æ§è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            loadMonitorSettings();
        });

        // ==================== è‡ªå‹•ç›£æ§åŠŸèƒ½çµæŸ ====================

        // åˆ¤æ–·æ˜¯å¦ç‚ºæ±ºæ¨™å…¬å‘Šï¼ˆåŒæ™‚æª¢æŸ¥ brief.type èˆ‡ detail å¸¸è¦‹æ¬„ä½ï¼‰
        function isTenderAwarded(type, detail = {}) {
            const t = (type || '').toString();
            const candidates = [
                t,
                detail['æ¨™æ¡ˆé¡å‹'],
                detail['å…¬å‘Šç¨®é¡'],
                detail['å…¬å‘Šé¡å‹'],
                detail['æ‹›æ¨™/æ±ºæ¨™é¡åˆ¥'],
                detail['æ¡è³¼è³‡æ–™:å…¬å‘Šç¨®é¡'],
                detail['æ‹›æ¨™è³‡æ–™:å…¬å‘Šç¨®é¡'],
                detail['æ±ºæ¨™è³‡æ–™:å…¬å‘Šç¨®é¡']
            ].filter(Boolean).join(' ');
            return candidates.includes('æ±ºæ¨™å…¬å‘Š') || candidates.includes('ç„¡æ³•æ±ºæ¨™å…¬å‘Š') || candidates.includes('æ±ºæ¨™');
        }

        // ç²å–æ±ºæ¨™å“é …è³‡è¨Š
        function getAwardItems(detail) {
            if (!detail) return '';
            
            console.log('=== åˆ†ææ±ºæ¨™å“é …è³‡è¨Š ===');
            console.log('Detail keys:', Object.keys(detail).filter(k => k.includes('å“é …') || k.includes('æ±ºæ¨™') || k.includes('å¾—æ¨™')));
            
            // å°‹æ‰¾æ±ºæ¨™å“é …ç›¸é—œæ¬„ä½
            const awardItems = [];
            const itemCount = getAwardItemCount(detail);
            
            console.log('æ±ºæ¨™å“é …æ•¸:', itemCount);
            
            for (let i = 1; i <= itemCount; i++) {
                const item = extractAwardItem(detail, i);
                if (item) {
                    awardItems.push(item);
                    console.log(`ç¬¬${i}å“é …:`, item);
                }
            }
            
            if (awardItems.length === 0) {
                return '<p class="mt-3 text-muted">ç„¡æ±ºæ¨™å“é …è³‡æ–™</p>';
            }
            
            let html = `
                <div class="mt-3">
                    <h6><i class="fas fa-box me-2"></i>æ±ºæ¨™å“é …è³‡è¨Š</h6>
                    <div class="alert alert-info">
                        <strong>æ±ºæ¨™å“é …æ•¸ï¼š</strong>${itemCount} é …
                    </div>
            `;
            
            awardItems.forEach((item, index) => {
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-cube me-2"></i>ç¬¬${index + 1}å“é …</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr><td><strong>å“é …åç¨±</strong></td><td>${item.itemName || 'ç„¡è³‡æ–™'}</td></tr>
                                        <tr><td><strong>æ˜¯å¦ä»¥å–®åƒ¹åŠé ä¼°éœ€æ±‚æ•¸é‡ä¹‹ä¹˜ç©æ±ºå®šæœ€ä½æ¨™</strong></td><td>${item.isLowestBid || 'ç„¡è³‡æ–™'}</td></tr>
                                        <tr><td><strong>é ä¼°éœ€æ±‚æ•¸é‡</strong></td><td>${item.estimatedQuantity || 'ç„¡è³‡æ–™'}</td></tr>
                                        <tr><td><strong>åŸç”¢åœ°åœ‹åˆ¥</strong></td><td>${item.countryOfOrigin || 'ç„¡è³‡æ–™'}</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr><td><strong>å¾—æ¨™å» å•†</strong></td><td>${item.winningVendor || 'ç„¡è³‡æ–™'}</td></tr>
                                        <tr><td><strong>å¾—æ¨™å» å•†åŸå§‹æŠ•æ¨™é‡‘é¡</strong></td><td>${item.originalBidAmount || 'ç„¡è³‡æ–™'}</td></tr>
                                        <tr><td><strong>æ±ºæ¨™é‡‘é¡</strong></td><td>${item.awardAmount || 'ç„¡è³‡æ–™'}</td></tr>
                                        <tr><td><strong>åº•åƒ¹é‡‘é¡</strong></td><td>${item.reservePrice || 'ç„¡è³‡æ–™'}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // ç”¢ç”Ÿã€ŒæŸ¥çœ‹æ±ºæ¨™å“é …ã€æŒ‰éˆ•èˆ‡å¯æ”¶åˆå…§å®¹
        function renderAwardItemsSection(detail, jobNumber) {
            const base = (jobNumber || '').toString();
            const safeId = 'awardItems-' + (base.replace(/[^a-zA-Z0-9_-]/g, '') || ('x' + Date.now()));
            return `
                <div class="mt-3">
                    <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#${safeId}" aria-expanded="false" aria-controls="${safeId}">
                        <i class="fas fa-box-open me-1"></i>æŸ¥çœ‹æ±ºæ¨™å“é …
                    </button>
                    <div class="collapse mt-2" id="${safeId}">
                        ${getAwardItems(detail)}
                    </div>
                </div>
            `;
        }

        // ç²å–æ±ºæ¨™å“é …æ•¸é‡
        function getAwardItemCount(detail) {
            const possibleKeys = [
                'æ±ºæ¨™å“é …:æ±ºæ¨™å“é …æ•¸',
                'æ±ºæ¨™å“é …æ•¸',
                'å“é …æ•¸',
                'æ±ºæ¨™:å“é …æ•¸'
            ];
            
            for (const key of possibleKeys) {
                if (detail[key]) {
                    const count = parseInt(detail[key]);
                    if (!isNaN(count) && count > 0) {
                        return count;
                    }
                }
            }
            
            // å¦‚æœæ²’æ‰¾åˆ°æ˜ç¢ºçš„å“é …æ•¸ï¼Œå˜—è©¦å¾å“é …åç¨±æ¬„ä½æ¨ç®—
            let maxItem = 0;
            for (const key in detail) {
                if (key.includes('å“é …åç¨±') || key.includes('å“é …') && key.includes('åç¨±')) {
                    const match = key.match(/ç¬¬(\d+)å“é …/);
                    if (match) {
                        const itemNum = parseInt(match[1]);
                        if (itemNum > maxItem) {
                            maxItem = itemNum;
                        }
                    }
                }
            }
            
            return maxItem > 0 ? maxItem : 1; // é è¨­è‡³å°‘1é …
        }

        // æå–å–®ä¸€å“é …è³‡è¨Š
        function extractAwardItem(detail, itemIndex) {
            const item = {};
            
            // å“é …åç¨±
            const nameKeys = [
                `æ±ºæ¨™å“é …:ç¬¬${itemIndex}å“é …:å“é …åç¨±`,
                `ç¬¬${itemIndex}å“é …:å“é …åç¨±`,
                `å“é …${itemIndex}:å“é …åç¨±`,
                `æ±ºæ¨™å“é …${itemIndex}:å“é …åç¨±`
            ];
            item.itemName = findFieldValue(detail, nameKeys);
            
            // æ˜¯å¦ä»¥å–®åƒ¹åŠé ä¼°éœ€æ±‚æ•¸é‡ä¹‹ä¹˜ç©æ±ºå®šæœ€ä½æ¨™
            const lowestBidKeys = [
                `æ±ºæ¨™å“é …:ç¬¬${itemIndex}å“é …:æ˜¯å¦ä»¥å–®åƒ¹åŠé ä¼°éœ€æ±‚æ•¸é‡ä¹‹ä¹˜ç©æ±ºå®šæœ€ä½æ¨™`,
                `ç¬¬${itemIndex}å“é …:æ˜¯å¦ä»¥å–®åƒ¹åŠé ä¼°éœ€æ±‚æ•¸é‡ä¹‹ä¹˜ç©æ±ºå®šæœ€ä½æ¨™`,
                `å“é …${itemIndex}:æ˜¯å¦ä»¥å–®åƒ¹åŠé ä¼°éœ€æ±‚æ•¸é‡ä¹‹ä¹˜ç©æ±ºå®šæœ€ä½æ¨™`
            ];
            item.isLowestBid = findFieldValue(detail, lowestBidKeys);
            
            // å¾—æ¨™å» å•†
            const vendorKeys = [
                `æ±ºæ¨™å“é …:ç¬¬${itemIndex}å“é …:å¾—æ¨™å» å•†${itemIndex}`,
                `ç¬¬${itemIndex}å“é …:å¾—æ¨™å» å•†`,
                `å“é …${itemIndex}:å¾—æ¨™å» å•†`,
                `å¾—æ¨™å» å•†${itemIndex}:å» å•†åç¨±`
            ];
            item.winningVendor = findFieldValue(detail, vendorKeys);
            
            // é ä¼°éœ€æ±‚æ•¸é‡
            const quantityKeys = [
                `æ±ºæ¨™å“é …:ç¬¬${itemIndex}å“é …:é ä¼°éœ€æ±‚æ•¸é‡`,
                `ç¬¬${itemIndex}å“é …:é ä¼°éœ€æ±‚æ•¸é‡`,
                `å“é …${itemIndex}:é ä¼°éœ€æ±‚æ•¸é‡`
            ];
            item.estimatedQuantity = findFieldValue(detail, quantityKeys);
            
            // å¾—æ¨™å» å•†åŸå§‹æŠ•æ¨™é‡‘é¡ï¼ˆåƒ…æ¥å—å«æ•¸å­—çš„å€¼ï¼‰
            const originalBidKeys = [
                `æ±ºæ¨™å“é …:ç¬¬${itemIndex}å“é …:å¾—æ¨™å» å•†${itemIndex}:åŸå§‹æŠ•æ¨™é‡‘é¡`,
                `ç¬¬${itemIndex}å“é …:å¾—æ¨™å» å•†:åŸå§‹æŠ•æ¨™é‡‘é¡`,
                `å“é …${itemIndex}:å¾—æ¨™å» å•†:åŸå§‹æŠ•æ¨™é‡‘é¡`,
                `ç¬¬${itemIndex}å“é …:åŸå§‹æŠ•æ¨™é‡‘é¡`,
                `æ±ºæ¨™å“é …:ç¬¬${itemIndex}å“é …:åŸå§‹æŠ•æ¨™é‡‘é¡`,
                `å“é …${itemIndex}:åŸå§‹æŠ•æ¨™é‡‘é¡`,
                `ç¬¬${itemIndex}å“é …:æŠ•æ¨™é‡‘é¡`,
                `å“é …${itemIndex}:æŠ•æ¨™é‡‘é¡`
            ];
            item.originalBidAmount = findAmountValue(detail, originalBidKeys);
            
            // æ±ºæ¨™é‡‘é¡ï¼ˆåƒ…æ¥å—å«æ•¸å­—çš„å€¼ï¼‰
            const awardAmountKeys = [
                `æ±ºæ¨™å“é …:ç¬¬${itemIndex}å“é …:æ±ºæ¨™é‡‘é¡`,
                `ç¬¬${itemIndex}å“é …:æ±ºæ¨™é‡‘é¡`,
                `å“é …${itemIndex}:æ±ºæ¨™é‡‘é¡`,
                `ç¬¬${itemIndex}å“é …:å¾—æ¨™é‡‘é¡`,
                `å“é …${itemIndex}:å¾—æ¨™é‡‘é¡`
            ];
            item.awardAmount = findAmountValue(detail, awardAmountKeys);
            
            // åº•åƒ¹é‡‘é¡ï¼ˆåƒ…æ¥å—å«æ•¸å­—çš„å€¼ï¼‰
            const reservePriceKeys = [
                `æ±ºæ¨™å“é …:ç¬¬${itemIndex}å“é …:åº•åƒ¹é‡‘é¡`,
                `ç¬¬${itemIndex}å“é …:åº•åƒ¹é‡‘é¡`,
                `å“é …${itemIndex}:åº•åƒ¹é‡‘é¡`,
                `ç¬¬${itemIndex}å“é …:åº•åƒ¹`,
                `å“é …${itemIndex}:åº•åƒ¹`
            ];
            item.reservePrice = findAmountValue(detail, reservePriceKeys);
            
            // åŸç”¢åœ°åœ‹åˆ¥
            const countryKeys = [
                `æ±ºæ¨™å“é …:ç¬¬${itemIndex}å“é …:åŸç”¢åœ°åœ‹åˆ¥`,
                `ç¬¬${itemIndex}å“é …:åŸç”¢åœ°åœ‹åˆ¥`,
                `å“é …${itemIndex}:åŸç”¢åœ°åœ‹åˆ¥`
            ];
            item.countryOfOrigin = findFieldValue(detail, countryKeys);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•æœ‰æ•ˆè³‡æ–™
            const hasData = Object.values(item).some(value => value && value !== 'ç„¡è³‡æ–™');
            return hasData ? item : null;
        }

        // è¼”åŠ©å‡½æ•¸ï¼šå°‹æ‰¾æ¬„ä½å€¼
        function findFieldValue(detail, possibleKeys) {
            for (const key of possibleKeys) {
                if (detail[key] && detail[key] !== '' && detail[key] !== 'ç„¡è³‡æ–™') {
                    return detail[key];
                }
            }
            
            // æ¨¡ç³ŠåŒ¹é…
            for (const key in detail) {
                if (possibleKeys.some(possibleKey => key.includes(possibleKey.split(':').pop()))) {
                    if (detail[key] && detail[key] !== '' && detail[key] !== 'ç„¡è³‡æ–™') {
                        return detail[key];
                    }
                }
            }
            
            return 'ç„¡è³‡æ–™';
        }

        // è§£æé‡‘é¡ï¼šåªå›å‚³å«æ•¸å­—çš„æ¬„ä½ï¼Œéæ¿¾ã€Œæ˜¯/å¦/ç„¡è³‡æ–™ã€ç­‰éé‡‘é¡å€¼
        function parseAmountToText(value) {
            if (value == null) return '';
            const text = value.toString();
            // éæ¿¾å¸¸è¦‹éé‡‘é¡å­—æ¨£
            if (['æ˜¯','å¦','ç„¡','ç„¡è³‡æ–™','ä¸é©ç”¨','N/A'].some(w => text === w || text.includes(w))) {
                return '';
            }
            const match = text.match(/[\d,\.]+/);
            if (!match) return '';
            // åƒ…å–æ•´æ•¸é‡‘é¡ï¼ˆå»é™¤é€—é»ï¼‰
            const num = parseInt(match[0].replace(/[,\.]/g, ''));
            if (isNaN(num) || num <= 0) return '';
            return num.toLocaleString() + ' å…ƒ';
        }

        // å¾å¤šå€‹éµä¸­æ‰¾åˆ°ç¬¬ä¸€å€‹æœ‰æ•ˆé‡‘é¡ä¸¦æ ¼å¼åŒ–
        function findAmountValue(detail, possibleKeys) {
            for (const key of possibleKeys) {
                if (detail[key] != null) {
                    const formatted = parseAmountToText(detail[key]);
                    if (formatted) return formatted;
                }
            }
            // å˜—è©¦æ¨¡ç³ŠåŒ¹é…
            for (const key in detail) {
                if (possibleKeys.some(possibleKey => key.includes(possibleKey.split(':').pop()))) {
                    const formatted = parseAmountToText(detail[key]);
                    if (formatted) return formatted;
                }
            }
            return 'ç„¡è³‡æ–™';
        }

        // ç²å–æ±ºæ¨™è³‡è¨Šï¼ˆæ›¿ä»£æ‹›æ¨™è³‡è¨Šï¼‰
        function getAwardInfo(detail) {
            if (!detail) return '<p class="mt-3 text-muted">ç„¡æ±ºæ¨™è³‡è¨Š</p>';
            
            console.log('=== åˆ†ææ±ºæ¨™è³‡è¨Š ===');
            console.log('Detail keys:', Object.keys(detail).filter(k => k.includes('æ±ºæ¨™') || k.includes('å¾—æ¨™')));
            
            return `
                <h6 class="mt-3"><i class="fas fa-trophy me-2"></i>æ±ºæ¨™è³‡è¨Š</h6>
                <table class="table table-sm">
                    <tr><td><strong>æ±ºæ¨™æ–¹å¼</strong></td><td>${getTenderField(detail, 'æ±ºæ¨™æ–¹å¼')}</td></tr>
                    <tr><td><strong>æ±ºæ¨™æ—¥æœŸ</strong></td><td>${getTenderField(detail, 'æ±ºæ¨™æ—¥æœŸ')}</td></tr>
                    <tr><td><strong>æ±ºæ¨™é‡‘é¡</strong></td><td>${getTenderField(detail, 'æ±ºæ¨™é‡‘é¡')}</td></tr>
                    <tr><td><strong>åº•åƒ¹é‡‘é¡</strong></td><td>${getTenderField(detail, 'åº•åƒ¹é‡‘é¡')}</td></tr>
                    <tr><td><strong>å¾—æ¨™å» å•†</strong></td><td>${getTenderField(detail, 'å¾—æ¨™å» å•†')}</td></tr>
                    <tr><td><strong>æ±ºæ¨™åŸå› </strong></td><td>${getTenderField(detail, 'æ±ºæ¨™åŸå› ')}</td></tr>
                </table>
            `;
        }

        // ç²å–æ‹›æ¨™è³‡è¨Šï¼ˆåƒ…ç”¨æ–¼éæ±ºæ¨™å…¬å‘Šï¼‰
        function getTenderInfo(detail) {
            if (!detail) return '<p class="mt-3 text-muted">ç„¡æ‹›æ¨™è³‡è¨Š</p>';
            
            return `
                <h6 class="mt-3"><i class="fas fa-clipboard-list me-2"></i>æ‹›æ¨™è³‡è¨Š</h6>
                <table class="table table-sm">
                    <tr><td><strong>æ‹›æ¨™æ–¹å¼</strong></td><td>${getTenderField(detail, 'æ‹›æ¨™æ–¹å¼')}</td></tr>
                    <tr><td><strong>æ±ºæ¨™æ–¹å¼</strong></td><td>${getTenderField(detail, 'æ±ºæ¨™æ–¹å¼')}</td></tr>
                    <tr><td><strong>é–‹æ¨™æ™‚é–“</strong></td><td>${getTenderField(detail, 'é–‹æ¨™æ™‚é–“')}</td></tr>
                    <tr><td><strong>é–‹æ¨™åœ°é»</strong></td><td>${getTenderField(detail, 'é–‹æ¨™åœ°é»')}</td></tr>
                    <tr><td><strong>æˆªæ­¢æŠ•æ¨™</strong></td><td>${getTenderField(detail, 'æˆªæ­¢æŠ•æ¨™')}</td></tr>
                    <tr><td><strong>æŠ¼æ¨™é‡‘</strong></td><td>${getTenderField(detail, 'æŠ¼æ¨™é‡‘')}</td></tr>
                </table>
            `;
        }

        // æ™ºèƒ½ç²å–æ‹›æ¨™è³‡è¨Šæ¬„ä½
        function getTenderField(detail, infoType) {
            if (!detail) return 'ç„¡è³‡æ–™';
            
            // å®šç¾©å„ç¨®å¯èƒ½çš„æ¬„ä½åç¨±
            const fieldMappings = {
                'æ‹›æ¨™æ–¹å¼': [
                    'æ‹›æ¨™è³‡æ–™:æ‹›æ¨™æ–¹å¼',
                    'æ‹›æ¨™æ–¹å¼',
                    'æ¡è³¼è³‡æ–™:æ‹›æ¨™æ–¹å¼',
                    'æ‹›æ¨™:æ‹›æ¨™æ–¹å¼'
                ],
                'æ±ºæ¨™æ–¹å¼': [
                    'æ‹›æ¨™è³‡æ–™:æ±ºæ¨™æ–¹å¼',
                    'æ±ºæ¨™æ–¹å¼',
                    'æ¡è³¼è³‡æ–™:æ±ºæ¨™æ–¹å¼',
                    'æ±ºæ¨™:æ±ºæ¨™æ–¹å¼',
                    'æ±ºæ¨™è³‡æ–™:æ±ºæ¨™æ–¹å¼'
                ],
                'æ±ºæ¨™æ—¥æœŸ': [
                    'æ±ºæ¨™è³‡æ–™:æ±ºæ¨™æ—¥æœŸ',
                    'æ±ºæ¨™æ—¥æœŸ',
                    'æ±ºæ¨™:æ±ºæ¨™æ—¥æœŸ',
                    'æ—¥æœŸ:æ±ºæ¨™æ—¥æœŸ'
                ],
                'æ±ºæ¨™é‡‘é¡': [
                    'æ±ºæ¨™è³‡æ–™:æ±ºæ¨™é‡‘é¡',
                    'æ±ºæ¨™é‡‘é¡',
                    'æ±ºæ¨™:æ±ºæ¨™é‡‘é¡',
                    'é‡‘é¡:æ±ºæ¨™é‡‘é¡',
                    'æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡'
                ],
                'åº•åƒ¹é‡‘é¡': [
                    'æ±ºæ¨™è³‡æ–™:åº•åƒ¹é‡‘é¡',
                    'åº•åƒ¹é‡‘é¡',
                    'æ±ºæ¨™:åº•åƒ¹é‡‘é¡',
                    'é‡‘é¡:åº•åƒ¹é‡‘é¡'
                ],
                'å¾—æ¨™å» å•†': [
                    'æ±ºæ¨™è³‡æ–™:å¾—æ¨™å» å•†',
                    'å¾—æ¨™å» å•†',
                    'æ±ºæ¨™:å¾—æ¨™å» å•†',
                    'å» å•†:å¾—æ¨™å» å•†',
                    'å¾—æ¨™å» å•†:å» å•†åç¨±'
                ],
                'æ±ºæ¨™åŸå› ': [
                    'æ±ºæ¨™è³‡æ–™:æ±ºæ¨™åŸå› ',
                    'æ±ºæ¨™åŸå› ',
                    'æ±ºæ¨™:æ±ºæ¨™åŸå› ',
                    'åŸå› :æ±ºæ¨™åŸå› '
                ],
                'é–‹æ¨™æ™‚é–“': [
                    'é ˜æŠ•é–‹æ¨™:é–‹æ¨™æ™‚é–“',
                    'é–‹æ¨™æ™‚é–“',
                    'é–‹æ¨™:é–‹æ¨™æ™‚é–“',
                    'æ™‚é–“:é–‹æ¨™æ™‚é–“'
                ],
                'é–‹æ¨™åœ°é»': [
                    'é ˜æŠ•é–‹æ¨™:é–‹æ¨™åœ°é»',
                    'é–‹æ¨™åœ°é»',
                    'é–‹æ¨™:é–‹æ¨™åœ°é»',
                    'åœ°é»:é–‹æ¨™åœ°é»'
                ],
                'æˆªæ­¢æŠ•æ¨™': [
                    'é ˜æŠ•é–‹æ¨™:æˆªæ­¢æŠ•æ¨™',
                    'æˆªæ­¢æŠ•æ¨™',
                    'æŠ•æ¨™:æˆªæ­¢æŠ•æ¨™',
                    'æ™‚é–“:æˆªæ­¢æŠ•æ¨™'
                ],
                'æŠ¼æ¨™é‡‘': [
                    'é ˜æŠ•é–‹æ¨™:æ˜¯å¦é ˆç¹³ç´æŠ¼æ¨™é‡‘:æŠ¼æ¨™é‡‘é¡åº¦',
                    'æŠ¼æ¨™é‡‘',
                    'æŠ¼æ¨™é‡‘é¡åº¦',
                    'æŠ•æ¨™:æŠ¼æ¨™é‡‘'
                ]
            };
            
            const possibleFields = fieldMappings[infoType] || [];
            
            // å˜—è©¦å„ç¨®æ¬„ä½åç¨±
            for (const field of possibleFields) {
                if (detail[field] && detail[field] !== '' && detail[field] !== 'ç„¡è³‡æ–™') {
                    return detail[field];
                }
            }
            
            // å¦‚æœæ²’æ‰¾åˆ°ï¼Œå˜—è©¦æ¨¡ç³ŠåŒ¹é…
            for (const key in detail) {
                if (key.includes(infoType) && detail[key] && detail[key] !== '' && detail[key] !== 'ç„¡è³‡æ–™') {
                    return detail[key];
                }
            }
            
            return 'ç„¡è³‡æ–™';
        }
    </script>
</body>
</html>
