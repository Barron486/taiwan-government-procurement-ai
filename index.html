<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>台灣政府採購公告查詢系統 - AI 分析版</title>
    
    <!-- API 配置 - 必須在其他 script 之前載入 -->
    <script src="config.js"></script>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
        }
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 1400px;
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .search-section {
            padding: 30px;
        }
        .time-shortcuts {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .time-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .time-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        .time-btn.active {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 15px 40px;
            font-weight: 600;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        .result-item {
            border: none;
            border-radius: 15px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            padding: 25px;
            transition: all 0.3s ease;
        }
        .result-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        .ai-analysis {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        .ai-loading {
            text-align: center;
            padding: 20px;
        }
        .spinner-border {
            width: 2rem;
            height: 2rem;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .company-btn {
            transition: all 0.2s ease;
        }
        .company-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .company-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            padding: 6px 12px;
            font-size: 0.8rem;
            margin: 2px;
            display: inline-block;
        }
        .ai-insights {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
        }
        .ai-insights h6 {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .date-range {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .date-range h6 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        .date-display {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1976d2;
        }
        
        /* 彈出式通知樣式 */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            max-width: 500px;
            width: 90%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease-out;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }
        
        .notification.success {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
        }
        
        .notification.info {
            background: linear-gradient(135deg, #339af0 0%, #228be6 100%);
            color: white;
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #ffd43b 0%, #fab005 100%);
            color: #333;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px 10px;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin: 0;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .notification-close:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        .notification-body {
            padding: 0 20px 15px;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .notification-actions {
            padding-top: 10px;
            margin-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        
        .notification-actions .btn {
            background: rgba(255,255,255,0.9);
            border: none;
            color: #333;
            font-weight: 600;
        }
        
        .notification-actions .btn:hover {
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .notification-actions .btn.btn-success {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 15px;
            }
            .time-shortcuts {
                justify-content: center;
            }
            .time-btn {
                flex: 1;
                min-width: 80px;
            }
        }
        /* 對話窗口樣式 */
        .chat-message {
            margin-bottom: 15px;
        }
        
        .user-message .message-content {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 18px 18px 4px 18px;
            display: inline-block;
            max-width: 80%;
            margin-left: auto;
        }
        
        .bot-message .message-content {
            background: #f8f9fa;
            color: #333;
            padding: 10px 15px;
            border-radius: 18px 18px 18px 4px;
            display: inline-block;
            max-width: 80%;
            border: 1px solid #dee2e6;
        }
        
        .chat-messages {
            scroll-behavior: smooth;
        }
        
        .message-text {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-search me-3"></i>台灣政府採購公告查詢系統</h1>
            <p><i class="fas fa-robot me-2"></i>AI 智能分析版 - 直接連接政府採購 API</p>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <!-- Search Form -->
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-search me-2"></i>搜尋條件
                    </h5>
                    
                    <!-- 搜尋關鍵字欄位 -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="titleQuery" class="form-label fw-bold">標案名稱</label>
                            <input type="text" class="form-control" id="titleQuery" placeholder="輸入標案名稱關鍵字">
                        </div>
                        <div class="col-md-3">
                            <label for="companyNameQuery" class="form-label fw-bold">公司名稱</label>
                            <input type="text" class="form-control" id="companyNameQuery" placeholder="輸入公司名稱關鍵字">
                        </div>
                        <div class="col-md-3">
                            <label for="companyIdQuery" class="form-label fw-bold">統一編號</label>
                            <input type="text" class="form-control" id="companyIdQuery" placeholder="輸入統一編號">
                        </div>
                        <div class="col-md-3">
                            <label for="unitQuery" class="form-label fw-bold">機關代碼</label>
                            <input type="text" class="form-control" id="unitQuery" placeholder="輸入機關代碼">
                        </div>
                    </div>
                    
                    <!-- 搜尋邏輯選擇 -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <label class="form-label fw-bold">搜尋邏輯</label>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="searchLogic" id="searchAnd" value="and" checked>
                                <label class="btn btn-outline-primary" for="searchAnd">
                                    <i class="fas fa-plus me-1"></i>AND (且)
                                </label>
                                
                                <input type="radio" class="btn-check" name="searchLogic" id="searchOr" value="or">
                                <label class="btn btn-outline-success" for="searchOr">
                                    <i class="fas fa-arrows-alt-h me-1"></i>OR (或)
                                </label>
                            </div>
                            <small class="form-text text-muted ms-2">
                                AND：所有條件都必須符合 | OR：任一條件符合即可
                            </small>
                        </div>
                    </div>
                    
                    <!-- 日期區間選擇 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="startDate" class="form-label fw-bold">開始日期</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-6">
                            <label for="endDate" class="form-label fw-bold">結束日期</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                    
                    <!-- 快速日期選擇和標案類型 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">快速選擇日期範圍</label>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('today')">今日</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('last3days')">近3天</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('last7days')">近7天</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('last30days')">近30天</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('thisYear')">本年至今</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setDateRange('all')">全部</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">標案類型</label>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="tenderType" id="allType" value="all" checked>
                                <label class="btn btn-outline-primary" for="allType">全部</label>
                                
                                <input type="radio" class="btn-check" name="tenderType" id="openType" value="open">
                                <label class="btn btn-outline-success" for="openType">開標</label>
                                
                                <input type="radio" class="btn-check" name="tenderType" id="awardType" value="award">
                                <label class="btn btn-outline-warning" for="awardType">決標</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- API Key 設定 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="geminiKey" class="form-label fw-bold">Gemini API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="geminiKey" placeholder="輸入您的 Gemini API Key">
                                <button class="btn btn-outline-info" type="button" onclick="showGeminiHelp()" title="如何取得 Gemini API Key">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="chatgptKey" class="form-label fw-bold">ChatGPT API Key</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="chatgptKey" placeholder="輸入您的 ChatGPT API Key">
                                <button class="btn btn-outline-info" type="button" onclick="showChatGPTHelp()" title="如何取得 ChatGPT API Key">
                                    <i class="fas fa-question-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 搜尋按鈕 -->
                    <div class="row">
                        <div class="col-12 d-flex justify-content-between align-items-center">
                            <div>
                                <button type="button" class="btn btn-primary btn-lg me-3" onclick="performSearch()">
                                    <i class="fas fa-search me-2"></i>搜尋標案
                                </button>
                                <button type="button" class="btn btn-success btn-lg me-3" onclick="performGeminiAgentSearch()" id="geminiAgentBtn" disabled>
                                    <i class="fas fa-robot me-2"></i>Gemini Agent 搜尋
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg me-3" onclick="clearSearch()">
                                    <i class="fas fa-times me-2"></i>清除
                                </button>
                                <button type="button" class="btn btn-info btn-lg me-3" onclick="showSearchHelp()">
                                    <i class="fas fa-question-circle me-2"></i>搜尋說明
                                </button>
                                <button type="button" class="btn btn-warning btn-lg" onclick="toggleAutoMonitor()">
                                    <i class="fas fa-clock me-2"></i>自動監控
                                </button>
                            </div>
                            <div class="text-muted small">
                                <i class="fas fa-info-circle me-1"></i>
                                可同時使用多個搜尋條件，系統會自動組合搜尋
                            </div>
                        </div>
                    </div>
                    
                    <!-- 自動監控設定區塊 -->
                    <div id="autoMonitorSection" class="mt-4" style="display: none;">
                        <div class="card border-warning">
                            <div class="card-header bg-warning bg-opacity-10 border-warning">
                                <h5 class="mb-0">
                                    <i class="fas fa-bell me-2"></i>自動監控設定
                                    <span class="badge bg-success ms-2" id="monitorStatus">已停用</span>
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- 監控關鍵字設定 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-tags me-1"></i>監控關鍵字
                                        <small class="text-muted">(每行一個關鍵字)</small>
                                    </label>
                                    <textarea class="form-control" id="monitorKeywords" rows="5" 
                                              placeholder="輸入要監控的關鍵字，每行一個&#10;例如：&#10;醫療設備&#10;資訊系統&#10;辦公用品"></textarea>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>系統會使用這些關鍵字搜尋標案名稱
                                    </small>
                                </div>
                                
                                <!-- 監控時間設定 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-clock me-1"></i>自動搜尋時間
                                    </label>
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="monitor08" checked>
                                                <label class="form-check-label" for="monitor08">
                                                    <i class="fas fa-sun me-1 text-warning"></i>每天 08:00 自動搜尋
                                                </label>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="monitor17" checked>
                                                <label class="form-check-label" for="monitor17">
                                                    <i class="fas fa-moon me-1 text-info"></i>每天 17:00 自動搜尋
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 監控範圍設定 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-calendar me-1"></i>搜尋範圍
                                    </label>
                                    <select class="form-select" id="monitorDateRange">
                                        <option value="today" selected>僅今日</option>
                                        <option value="last3days">最近3天</option>
                                        <option value="last7days">最近7天</option>
                                    </select>
                                </div>
                                
                                <!-- 通知設定 -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-bell me-1"></i>通知設定
                                    </label>
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="monitorNotifyBrowser" checked>
                                        <label class="form-check-label" for="monitorNotifyBrowser">
                                            <i class="fas fa-desktop me-1"></i>瀏覽器通知（需授權）
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="monitorNotifySound" checked>
                                        <label class="form-check-label" for="monitorNotifySound">
                                            <i class="fas fa-volume-up me-1"></i>聲音提醒
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- 下次執行時間顯示 -->
                                <div class="alert alert-info mb-4">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>下次自動搜尋時間：</strong>
                                    <span id="nextAutoSearch">未啟用</span>
                                </div>
                                
                                <!-- 控制按鈕 -->
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-success" onclick="startAutoMonitor()">
                                        <i class="fas fa-play me-1"></i>啟動監控
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="stopAutoMonitor()">
                                        <i class="fas fa-stop me-1"></i>停止監控
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="testAutoMonitor()">
                                        <i class="fas fa-vial me-1"></i>立即測試
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="saveMonitorSettings()">
                                        <i class="fas fa-save me-1"></i>儲存設定
                                    </button>
                                    <button type="button" class="btn btn-info" onclick="showMonitorHistory()">
                                        <i class="fas fa-history me-1"></i>監控記錄
                                    </button>
                                </div>
                                
                                <!-- 監控統計 -->
                                <div class="mt-4 p-3 bg-light rounded">
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <i class="fas fa-search fa-2x text-primary"></i>
                                            </div>
                                            <div class="fw-bold" id="monitorSearchCount">0</div>
                                            <small class="text-muted">今日搜尋次數</small>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <i class="fas fa-file-alt fa-2x text-success"></i>
                                            </div>
                                            <div class="fw-bold" id="monitorResultCount">0</div>
                                            <small class="text-muted">發現標案數</small>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <i class="fas fa-star fa-2x text-warning"></i>
                                            </div>
                                            <div class="fw-bold" id="monitorNewCount">0</div>
                                            <small class="text-muted">新增標案數</small>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-2">
                                                <i class="fas fa-clock fa-2x text-info"></i>
                                            </div>
                                            <div class="fw-bold" id="monitorLastTime">--:--</div>
                                            <small class="text-muted">最後搜尋時間</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="text-center mt-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">載入中...</span>
                </div>
                <p class="mt-3 mb-0">正在搜尋政府採購資料...</p>
            </div>

            <!-- AI Analysis Loading -->
            <div id="aiLoading" class="ai-loading" style="display: none;">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">AI 分析中...</span>
                </div>
                <p class="mt-3 mb-0"><i class="fas fa-robot me-2"></i>Gemini AI 正在分析標案內容...</p>
            </div>

            <!-- Messages -->
            <div id="messageArea"></div>

            <!-- Search Results -->
            <div id="searchResults" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-list me-2"></i>搜尋結果</h5>
                            <div class="d-flex align-items-center">
                                <div id="resultStats" class="text-muted me-3"></div>
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearSearchResults()" title="清除搜尋結果">
                                    <i class="fas fa-times me-1"></i>清除結果
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 搜尋結果過濾器 -->
                        <div class="row mb-3" id="resultFilters" style="display: none;">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">過濾標案類型</label>
                                <div class="btn-group" role="group">
                                    <input type="radio" class="btn-check" name="resultFilter" id="filterAll" value="all" checked>
                                    <label class="btn btn-outline-primary" for="filterAll">全部</label>
                                    
                                    <input type="radio" class="btn-check" name="resultFilter" id="filterOpen" value="open">
                                    <label class="btn btn-outline-success" for="filterOpen">開標</label>
                                    
                                    <input type="radio" class="btn-check" name="resultFilter" id="filterAward" value="award">
                                    <label class="btn btn-outline-danger" for="filterAward">決標</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">排序方式</label>
                                <select class="form-select" id="sortBy" onchange="sortResults()">
                                    <option value="date_desc">日期（新到舊）</option>
                                    <option value="date_asc">日期（舊到新）</option>
                                    <option value="title">標案名稱</option>
                                    <option value="unit">機關名稱</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div id="resultStats" class="text-muted me-3"></div>
                            <div class="d-flex align-items-center gap-2">
                                <label for="pageSize" class="form-label mb-0">每頁顯示</label>
                                <select id="pageSize" class="form-select form-select-sm" style="width: auto;" onchange="changePageSize(this.value)">
                                    <option value="10">10筆</option>
                                    <option value="50">50筆</option>
                                    <option value="100">100筆</option>
                                </select>
                            </div>
                        </div>
                        <div id="resultsList"></div>
                        <div id="pagination" class="mt-4"></div>
                    </div>
                </div>
            </div>

            <!-- AI Analysis Results -->
            <div id="aiAnalysisResults" class="mt-4" style="display: none;">
                <div class="ai-analysis">
                    <h5><i class="fas fa-robot me-2"></i>Gemini AI 分析結果</h5>
                    <div id="aiContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI 對話窗口 -->
    <div class="modal fade" id="chatModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-comments me-2"></i>AI 對話助手</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="chatMessages" class="chat-messages" style="height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: #f8f9fa;">
                        <!-- 對話內容將在這裡顯示 -->
                    </div>
                    <div class="input-group">
                        <input type="text" id="chatInput" class="form-control" placeholder="請輸入您的問題..." onkeypress="handleChatKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendChatMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = 'https://pcc-api.openfun.app/api';
        // API 配置：根據環境自動切換
        const USE_PROXY = window.API_CONFIG && window.API_CONFIG.getApiBase();
        const API_PROXY = USE_PROXY || null;
        const API_BASES = USE_PROXY ? [] : [
            'https://pcc-api.openfun.app/api',
            'https://pcc.g0v.ronny.tw/api'
        ];

        console.log('🔧 API 模式:', USE_PROXY ? '使用 Vercel 代理' : '直接呼叫 API');

        // 以多個 API_BASES 進行逾時+重試+備援切換（或使用代理）
        async function fetchFromApis(path, options = {}, timeoutMs = 10000, retriesPerBase = 2) {
            let lastError = null;
            const tried = [];
            
            // 如果使用代理模式
            if (API_PROXY) {
                const url = window.API_CONFIG.buildUrl(path, extractParams(path));
                tried.push(url);
                
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
                    
                    const resp = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!resp.ok) {
                        const errorText = await resp.text();
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText} - ${errorText}`);
                    }
                    
                    console.log('✅ API 代理請求成功');
                    return { resp, url };
                    
                } catch (err) {
                    lastError = err;
                    console.error('❌ API 代理請求失敗:', err.message);
                    throw new Error(`API 代理失敗: ${err.message}`);
                }
            }
            
            // 直接 API 模式（本地開發）
            for (const base of API_BASES) {
                for (let attempt = 1; attempt <= retriesPerBase; attempt++) {
                    const url = `${base}${path}`;
                    tried.push(url);
                    
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
                        
                        const resp = await fetch(url, { 
                            ...options, 
                            signal: controller.signal 
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!resp.ok) {
                            const errorText = await resp.text();
                            throw new Error(`HTTP ${resp.status}: ${resp.statusText} - ${errorText}`);
                        }
                        
                        return { resp, url };
                    } catch (err) {
                        lastError = err;
                        console.warn(`API 請求失敗 (來源: ${base}, 嘗試 ${attempt}/${retriesPerBase}): ${err.message}`);
                        
                        // 如果還有重試機會，等待後重試
                        if (attempt < retriesPerBase) {
                            await new Promise(r => setTimeout(r, attempt * 800));
                        }
                    }
                }
            }
            
            const errorMessage = `所有 API 來源均失敗。最後錯誤: ${lastError?.message || '未知錯誤'}. 已嘗試來源: ${tried.join(' , ')}`;
            throw new Error(errorMessage);
        }
        
        // 從路徑中提取參數
        function extractParams(path) {
            const params = {};
            if (path.includes('?')) {
                const [basePath, queryString] = path.split('?');
                const urlParams = new URLSearchParams(queryString);
                for (const [key, value] of urlParams) {
                    params[key] = value;
                }
                // 返回沒有參數的路徑
                return params;
            }
            return {};
        }
        let currentTimeRange = 0; // 0 = 今日
        let searchResults = [];
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 設置預設日期為今日
            setDateRange('today');
            
            // 添加過濾器事件監聽器
            document.querySelectorAll('input[name="resultFilter"]').forEach(radio => {
                radio.addEventListener('change', filterAndDisplayResults);
            });
            
            // 監聽 Gemini API Key 輸入
            const geminiKeyInput = document.getElementById('geminiKey');
            const geminiAgentBtn = document.getElementById('geminiAgentBtn');
            
            geminiKeyInput.addEventListener('input', function() {
                if (this.value.trim().length > 0) {
                    geminiAgentBtn.disabled = false;
                    geminiAgentBtn.classList.remove('btn-success');
                    geminiAgentBtn.classList.add('btn-success');
                } else {
                    geminiAgentBtn.disabled = true;
                    geminiAgentBtn.classList.remove('btn-success');
                    geminiAgentBtn.classList.add('btn-secondary');
                }
            });
            
            showMessage('歡迎使用 AI 智能分析版！請輸入搜尋條件開始搜尋。', 'success');
        });

        // 設置時間範圍
        function setTimeRange(days) {
            currentTimeRange = days;
            
            // 更新按鈕狀態
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateDateDisplay();
        }

        // 更新日期顯示
        function updateDateDisplay() {
            const today = new Date();
            const dateDisplay = document.getElementById('dateDisplay');
            
            if (currentTimeRange === 0) {
                const todayStr = formatDate(today);
                dateDisplay.textContent = `搜尋今日 (${todayStr}) 的標案`;
            } else if (currentTimeRange === 'custom') {
                dateDisplay.textContent = '自訂時間範圍';
            } else {
                const startDate = new Date(today);
                startDate.setDate(today.getDate() - currentTimeRange);
                const startStr = formatDate(startDate);
                const endStr = formatDate(today);
                dateDisplay.textContent = `搜尋 ${startStr} 至 ${endStr} 的標案`;
            }
        }

        // 格式化日期
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}年${month}月${day}日`;
        }

        // 顯示自訂範圍
        function showCustomRange() {
            const startDate = prompt('請輸入開始日期 (YYYYMMDD):', '20241201');
            const endDate = prompt('請輸入結束日期 (YYYYMMDD):', '20241219');
            
            if (startDate && endDate) {
                currentTimeRange = 'custom';
                document.getElementById('dateDisplay').textContent = 
                    `搜尋 ${startDate} 至 ${endDate} 的標案`;
            }
        }

        // 更新表單欄位
        function updateFormFields() {
            const searchType = document.getElementById('searchType').value;
            const unitInput = document.getElementById('unitInput');
            
            if (searchType === 'unit') {
                unitInput.style.display = 'block';
            } else {
                unitInput.style.display = 'none';
            }
        }

        // 清除表單
        function clearSearch() {
            document.getElementById('titleQuery').value = '';
            document.getElementById('companyNameQuery').value = '';
            document.getElementById('companyIdQuery').value = '';
            document.getElementById('unitQuery').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('allType').checked = true; // 重置為全部
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('aiAnalysisResults').style.display = 'none';
            document.getElementById('messageArea').innerHTML = '';
            showMessage('表單已清除，請重新輸入搜尋條件。', 'success');
        }
        
        // 設定日期範圍
        function setDateRange(range) {
            const today = new Date();
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            switch(range) {
                case 'today':
                    const todayStr = today.toISOString().split('T')[0];
                    startDateInput.value = todayStr;
                    endDateInput.value = todayStr;
                    break;
                case 'last3days':
                    const threeDaysAgo = new Date(today);
                    threeDaysAgo.setDate(today.getDate() - 3);
                    startDateInput.value = threeDaysAgo.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    break;
                case 'last7days':
                    const sevenDaysAgo = new Date(today);
                    sevenDaysAgo.setDate(today.getDate() - 7);
                    startDateInput.value = sevenDaysAgo.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    break;
                case 'last30days':
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(today.getDate() - 30);
                    startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    break;
                case 'thisYear':
                    const thisYear = today.getFullYear();
                    const yearStart = new Date(thisYear, 0, 1); // 1月1日
                    startDateInput.value = yearStart.toISOString().split('T')[0];
                    endDateInput.value = today.toISOString().split('T')[0];
                    break;
                case 'all':
                    startDateInput.value = '';
                    endDateInput.value = '';
                    break;
            }
        }
        
        // 過濾日期範圍
        function filterByDateRange(results, startDate, endDate) {
            return results.filter(record => {
                const recordDate = record.date.toString();
                const recordDateStr = recordDate.substring(0, 4) + '-' + 
                                    recordDate.substring(4, 6) + '-' + 
                                    recordDate.substring(6, 8);
                
                if (startDate && recordDateStr < startDate) return false;
                if (endDate && recordDateStr > endDate) return false;
                return true;
            });
        }
        
        // 過濾標案類型
        function filterByTenderType(results, tenderType) {
            return results.filter(record => {
                const type = record.brief?.type || '';
                
                if (tenderType === 'open') {
                    // 開標：包含「公開招標」、「公開取得」等招標階段
                    return type.includes('公開招標') || 
                           type.includes('公開取得') || 
                           type.includes('公開徵求') ||
                           type.includes('限制性招標') ||
                           type.includes('選擇性招標') ||
                           type.includes('招標公告');
                } else if (tenderType === 'award') {
                    // 決標：包含「決標」、「得標」等決標階段
                    return type.includes('決標') || 
                           type.includes('得標') ||
                           type.includes('定期契約') ||
                           type.includes('開口合約') ||
                           type.includes('無法決標');
                }
                
                return true;
            });
        }
        
        // 去重複
        function removeDuplicates(results) {
            const seen = new Set();
            return results.filter(record => {
                const key = record.job_number + '_' + record.unit_id;
                if (seen.has(key)) {
                    return false;
                }
                seen.add(key);
                return true;
            });
        }
        
        // 根據公司名稱過濾結果（AND 邏輯用）
        function filterByCompanyName(results, companyName) {
            return results.filter(record => {
                const companies = record.brief?.companies?.names || [];
                return companies.some(name => 
                    name.toLowerCase().includes(companyName.toLowerCase())
                );
            });
        }
        
        // 根據統一編號過濾結果（AND 邏輯用）
        function filterByCompanyId(results, companyId) {
            return results.filter(record => {
                const companies = record.brief?.companies?.ids || [];
                return companies.some(id => 
                    id.includes(companyId)
                );
            });
        }
        
        // 根據機關代碼過濾結果（AND 邏輯用）
        function filterByUnitId(results, unitId) {
            return results.filter(record => {
                return record.unit_id && record.unit_id.includes(unitId);
            });
        }
        
        // 顯示搜尋說明
        function showSearchHelp() {
            const helpText = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>搜尋說明</h6>
                    <ul class="mb-0">
                        <li><strong>搜尋邏輯：</strong>
                            <ul>
                                <li><strong>AND (且)：</strong>所有填寫的條件都必須符合，結果更精確</li>
                                <li><strong>OR (或)：</strong>任一條件符合即可，結果更廣泛</li>
                            </ul>
                        </li>
                        <li><strong>搜尋欄位：</strong>
                            <ul>
                                <li><strong>標案名稱：</strong>搜尋標案標題中包含的關鍵字</li>
                                <li><strong>公司名稱：</strong>搜尋投標廠商名稱</li>
                                <li><strong>統一編號：</strong>搜尋特定公司的統一編號</li>
                                <li><strong>機關代碼：</strong>搜尋特定機關的標案</li>
                            </ul>
                        </li>
                        <li><strong>Gemini Agent 搜尋：</strong>
                            <ul>
                                <li><strong>智能分析：</strong>AI 會分析標案特徵並找出同類型案件</li>
                                <li><strong>自動擴展：</strong>根據分析結果自動搜尋相關關鍵字</li>
                                <li><strong>智能排序：</strong>按相關性重新排序搜尋結果</li>
                                <li><strong>需要 API Key：</strong>必須先設定 Gemini API Key</li>
                            </ul>
                        </li>
                        <li><strong>日期範圍：</strong>可選擇開始和結束日期來篩選標案發布時間</li>
                        <li><strong>快速選擇：</strong>使用快速按鈕快速設定常用的日期範圍（包含「本年至今」）</li>
                    </ul>
                </div>
            `;
            showMessage(helpText, 'info');
        }
        
        // 顯示 Gemini API Key 說明
        function showGeminiHelp() {
            const helpText = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-key me-2"></i>如何取得 Gemini API Key</h6>
                    <ol>
                        <li>前往 <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-decoration-none">Google AI Studio</a></li>
                        <li>使用您的 Google 帳號登入</li>
                        <li>點擊「Create API Key」按鈕</li>
                        <li>複製生成的 API Key</li>
                        <li>將 API Key 貼到上方輸入框中</li>
                    </ol>
                    <p class="mb-0 mt-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            設定 API Key 後即可使用 AI 對話和分析功能
                        </small>
                    </p>
                </div>
            `;
            showMessage(helpText, 'info');
        }

        // 顯示訊息
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const alertClass = type === 'error' ? 'alert-danger' : type === 'warning' ? 'alert-warning' : 'alert-success';
            
            // 錯誤訊息添加複製按鈕
            const copyButton = type === 'error' ? `
                <button class="btn btn-outline-danger btn-sm mt-2" onclick="copyMessageAreaError()" title="複製錯誤訊息">
                    <i class="fas fa-copy me-1"></i>複製錯誤訊息
                </button>
            ` : '';
            
            messageArea.innerHTML = `
                <div class="alert ${alertClass}">
                    <div class="alert-message">${message}</div>
                    ${copyButton}
                </div>
            `;
            
            // 成功訊息自動消失，錯誤訊息保留讓使用者手動關閉
            if (type === 'success') {
                setTimeout(() => {
                    messageArea.innerHTML = '';
                }, 3000);
            }
        }
        
        // 複製 messageArea 中的錯誤訊息
        async function copyMessageAreaError() {
            const messageArea = document.getElementById('messageArea');
            const alertMessage = messageArea.querySelector('.alert-message');
            if (!alertMessage) return;
            
            const textContent = alertMessage.textContent || alertMessage.innerText || '';
            
            try {
                await navigator.clipboard.writeText(textContent);
                const copyBtn = messageArea.querySelector('button');
                if (copyBtn) {
                    const originalHTML = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>已複製';
                    copyBtn.classList.remove('btn-outline-danger');
                    copyBtn.classList.add('btn-success');
                    setTimeout(() => {
                        copyBtn.innerHTML = originalHTML;
                        copyBtn.classList.add('btn-outline-danger');
                        copyBtn.classList.remove('btn-success');
                    }, 2000);
                }
            } catch (error) {
                alert('複製失敗，請手動複製錯誤訊息');
            }
        }

        // 執行搜尋
        async function performSearch() {
            // 取得所有搜尋條件
            const titleQuery = document.getElementById('titleQuery').value.trim();
            const companyNameQuery = document.getElementById('companyNameQuery').value.trim();
            const companyIdQuery = document.getElementById('companyIdQuery').value.trim();
            const unitQuery = document.getElementById('unitQuery').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const tenderType = document.querySelector('input[name="tenderType"]:checked').value;
            const searchLogic = document.querySelector('input[name="searchLogic"]:checked').value;
            
            console.log('搜尋條件:', { titleQuery, companyNameQuery, companyIdQuery, unitQuery, tenderType, searchLogic });
            
            // 檢查是否有任何搜尋條件
            if (!titleQuery && !companyNameQuery && !companyIdQuery && !unitQuery) {
                showMessage('請至少輸入一個搜尋條件', 'error');
                return;
            }
            
            showLoading(true);
            hideMessage();
            
            try {
                let allResults = [];
                let searchCount = 0;
                
                // 根據搜尋邏輯決定搜尋方式
                if (searchLogic === 'and') {
                    // AND 邏輯：所有條件都必須符合
                    console.log('使用 AND 邏輯搜尋');
                    
                    // 先搜尋第一個條件
                    let currentResults = [];
                    if (titleQuery) {
                        console.log('開始標案名稱搜尋:', titleQuery);
                        currentResults = await searchAllPages('title', titleQuery);
                        console.log('標案名稱搜尋結果:', currentResults.length, '筆');
                        searchCount++;
                    } else if (companyNameQuery) {
                        console.log('開始公司名稱搜尋:', companyNameQuery);
                        currentResults = await searchAllPages('companyname', companyNameQuery);
                        console.log('公司名稱搜尋結果:', currentResults.length, '筆');
                        searchCount++;
                    } else if (companyIdQuery) {
                        console.log('開始統一編號搜尋:', companyIdQuery);
                        currentResults = await searchAllPages('companyid', companyIdQuery);
                        console.log('統一編號搜尋結果:', currentResults.length, '筆');
                        searchCount++;
                    } else if (unitQuery) {
                        console.log('開始機關代碼搜尋:', unitQuery);
                        currentResults = await searchAllPages('unit', unitQuery);
                        console.log('機關代碼搜尋結果:', currentResults.length, '筆');
                        searchCount++;
                    }
                    
                    // 對結果進行其他條件的過濾
                    if (companyNameQuery && currentResults.length > 0) {
                        currentResults = filterByCompanyName(currentResults, companyNameQuery);
                        console.log('公司名稱過濾後:', currentResults.length, '筆');
                    }
                    if (companyIdQuery && currentResults.length > 0) {
                        currentResults = filterByCompanyId(currentResults, companyIdQuery);
                        console.log('統一編號過濾後:', currentResults.length, '筆');
                    }
                    if (unitQuery && currentResults.length > 0) {
                        currentResults = filterByUnitId(currentResults, unitQuery);
                        console.log('機關代碼過濾後:', currentResults.length, '筆');
                    }
                    
                    allResults = currentResults;
                    
                } else {
                    // OR 邏輯：任一條件符合即可
                    console.log('使用 OR 邏輯搜尋');
                    
                    // 根據標案名稱搜尋
                    if (titleQuery) {
                        console.log('開始標案名稱搜尋:', titleQuery);
                        const results = await searchAllPages('title', titleQuery);
                        console.log('標案名稱搜尋結果:', results.length, '筆');
                        allResults = allResults.concat(results);
                        searchCount++;
                    }
                    
                    // 根據公司名稱搜尋
                    if (companyNameQuery) {
                        console.log('開始公司名稱搜尋:', companyNameQuery);
                        const results = await searchAllPages('companyname', companyNameQuery);
                        console.log('公司名稱搜尋結果:', results.length, '筆');
                        allResults = allResults.concat(results);
                        searchCount++;
                    }
                    
                    // 根據統一編號搜尋
                    if (companyIdQuery) {
                        console.log('開始統一編號搜尋:', companyIdQuery);
                        const results = await searchAllPages('companyid', companyIdQuery);
                        console.log('統一編號搜尋結果:', results.length, '筆');
                        allResults = allResults.concat(results);
                        searchCount++;
                    }
                    
                    // 根據機關代碼搜尋
                    if (unitQuery) {
                        console.log('開始機關代碼搜尋:', unitQuery);
                        const results = await searchAllPages('unit', unitQuery);
                        console.log('機關代碼搜尋結果:', results.length, '筆');
                        allResults = allResults.concat(results);
                        searchCount++;
                    }
                    
                    console.log('合併前總結果:', allResults.length, '筆');
                    
                    // 去重複
                    allResults = removeDuplicates(allResults);
                    console.log('去重複後:', allResults.length, '筆');
                }
                
                // 過濾日期範圍
                if (startDate || endDate) {
                    allResults = filterByDateRange(allResults, startDate, endDate);
                    console.log('日期過濾後:', allResults.length, '筆');
                }
                
                // 過濾標案類型
                if (tenderType !== 'all') {
                    allResults = filterByTenderType(allResults, tenderType);
                    console.log('類型過濾後:', allResults.length, '筆');
                }
                
                if (allResults.length > 0) {
                    searchResults = allResults;
                    displayResults(allResults);
                    
                    const typeText = tenderType === 'all' ? '' : `（${tenderType === 'open' ? '開標' : '決標'}）`;
                    const logicText = searchLogic === 'and' ? 'AND' : 'OR';
                    showMessage(`搜尋完成！找到 ${allResults.length} 筆資料${typeText}（使用 ${logicText} 邏輯，${searchCount} 個搜尋條件）`, 'success');
                    
                    // 已取消自動 AI 分析，如需分析請手動點擊「AI 分析」按鈕
                } else {
                    console.log('沒有找到符合條件的資料');
                    showMessage('沒有找到符合條件的資料', 'error');
                }
                
            } catch (error) {
                console.error('搜尋錯誤:', error);
                showMessage(`搜尋時發生錯誤：${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Gemini Agent 智能搜尋
        async function performGeminiAgentSearch() {
            const geminiKey = document.getElementById('geminiKey').value.trim();
            if (!geminiKey) {
                showMessage('請先輸入 Gemini API Key 才能使用 Agent 搜尋功能', 'error');
                return;
            }

            const titleQuery = document.getElementById('titleQuery').value.trim();
            if (!titleQuery) {
                showMessage('請先輸入標案名稱關鍵字，Agent 會根據此關鍵字搜尋同類型案件', 'error');
                return;
            }

            showLoading(true);
            hideMessage();

            try {
                showMessage('Gemini Agent 正在分析標案類型並搜尋相似案件...', 'info');

                // 1. 先進行基本搜尋獲取樣本資料
                let sampleResults = await searchAllPages('title', titleQuery);
                console.log('初始搜尋結果:', sampleResults.length, '筆');
                
                if (sampleResults.length === 0) {
                    // 如果沒有找到結果，嘗試更廣泛的搜尋
                    showMessage('正在嘗試更廣泛的搜尋...', 'info');
                    
                    // 嘗試搜尋部分關鍵字
                    const words = titleQuery.split(/\s+/).filter(word => word.length > 1);
                    let broaderResults = [];
                    
                    for (const word of words.slice(0, 3)) {
                        try {
                            const wordResults = await searchAllPages('title', word);
                            broaderResults = broaderResults.concat(wordResults);
                            console.log(`關鍵字 "${word}" 搜尋結果:`, wordResults.length, '筆');
                        } catch (error) {
                            console.warn(`關鍵字 "${word}" 搜尋失敗:`, error);
                        }
                    }
                    
                    if (broaderResults.length === 0) {
                        showMessage('未找到相關標案，請嘗試其他關鍵字', 'error');
                        return;
                    }
                    
                    // 使用更廣泛的搜尋結果作為樣本
                    sampleResults = broaderResults.slice(0, 10);
                    console.log('使用更廣泛搜尋結果:', sampleResults.length, '筆');
                }

                // 2. 使用 Gemini 分析標案特徵
                const analysisPrompt = `
請分析以下政府採購標案的特徵，並提供相關的搜尋關鍵字建議：

標案資料：
${JSON.stringify(sampleResults.slice(0, 5), null, 2)}

請分析：
1. 標案的主要類型和領域
2. 相關的技術關鍵字
3. 可能涉及的產品或服務類別
4. 相關的機關類型
5. 建議的搜尋關鍵字（至少5個）

請以 JSON 格式回應，包含以下欄位：
{
  "category": "標案類別",
  "keywords": ["關鍵字1", "關鍵字2", "關鍵字3"],
  "related_terms": ["相關術語1", "相關術語2"],
  "product_types": ["產品類型1", "產品類型2"],
  "agency_types": ["機關類型1", "機關類型2"]
}
`;

                const analysisResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: analysisPrompt
                            }]
                        }]
                    })
                });

                if (!analysisResponse.ok) {
                    throw new Error(`Gemini API 錯誤: ${analysisResponse.status}`);
                }

                const analysisData = await analysisResponse.json();
                const analysisText = analysisData.candidates[0].content.parts[0].text;
                
                // 解析 Gemini 回應
                let analysis;
                try {
                    // 提取 JSON 部分
                    const jsonMatch = analysisText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        analysis = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error('無法解析 Gemini 回應');
                    }
                } catch (parseError) {
                    console.error('解析 Gemini 回應失敗:', parseError);
                    // 使用備用方案
                    analysis = {
                        category: "政府採購標案",
                        keywords: [titleQuery, "採購", "標案", "招標", "決標"],
                        related_terms: [titleQuery],
                        product_types: ["服務", "產品"],
                        agency_types: ["政府機關"]
                    };
                }

                console.log('Gemini 分析結果:', analysis);

                // 3. 根據分析結果進行擴展搜尋
                let allAgentResults = [...sampleResults];
                const searchKeywords = analysis.keywords || [titleQuery];

                // 搜尋相關關鍵字
                for (const keyword of searchKeywords.slice(0, 3)) { // 限制搜尋數量避免過多請求
                    if (keyword !== titleQuery) {
                        try {
                            const keywordResults = await searchAllPages('title', keyword);
                            allAgentResults = allAgentResults.concat(keywordResults);
                            console.log(`關鍵字 "${keyword}" 搜尋結果:`, keywordResults.length, '筆');
                        } catch (error) {
                            console.warn(`關鍵字 "${keyword}" 搜尋失敗:`, error);
                        }
                    }
                }

                // 4. 去重複並過濾
                allAgentResults = removeDuplicates(allAgentResults);
                console.log('去重複後結果:', allAgentResults.length, '筆');

                // 5. 使用 Gemini 進行智能排序
                const rankingPrompt = `
請根據以下標案與原始搜尋關鍵字 "${titleQuery}" 的相關性進行排序：

標案列表：
${JSON.stringify(allAgentResults.slice(0, 20), null, 2)}

請回傳排序後的標案索引陣列（最相關的在前），格式：[0, 5, 2, 8, ...]
`;

                try {
                    const rankingResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: rankingPrompt
                                }]
                            }]
                        })
                    });

                    if (rankingResponse.ok) {
                        const rankingData = await rankingResponse.json();
                        const rankingText = rankingData.candidates[0].content.parts[0].text;
                        const rankingMatch = rankingText.match(/\[[\d\s,]+\]/);
                        if (rankingMatch) {
                            const ranking = JSON.parse(rankingMatch[0]);
                            // 重新排序結果
                            const sortedResults = ranking.map(index => allAgentResults[index]).filter(Boolean);
                            allAgentResults = [...sortedResults, ...allAgentResults.filter((_, index) => !ranking.includes(index))];
                        }
                    }
                } catch (rankingError) {
                    console.warn('智能排序失敗，使用原始順序:', rankingError);
                }

                // 6. 顯示結果
                if (allAgentResults.length > 0) {
                    searchResults = allAgentResults;
                    displayResults(allAgentResults, true);

                    // 在搜尋結果區域顯示 Gemini Agent 分析結果
                    const searchResultsDiv = document.getElementById('searchResults');
                    if (searchResultsDiv) {
                        const geminiAnalysisDiv = document.createElement('div');
                        geminiAnalysisDiv.className = 'gemini-analysis mb-4';
                        geminiAnalysisDiv.innerHTML = `
                            <div class="alert alert-success">
                                <h6><i class="fas fa-robot me-2"></i>Gemini Agent 分析結果</h6>
                                <p><strong>標案類別：</strong>${analysis.category}</p>
                                <p><strong>相關關鍵字：</strong>${analysis.keywords.join(', ')}</p>
                                <p><strong>找到 ${allAgentResults.length} 筆相關標案</strong></p>
                            </div>
                        `;
                        searchResultsDiv.insertBefore(geminiAnalysisDiv, searchResultsDiv.firstChild);
                    }

                    showMessage(`Gemini Agent 搜尋完成！找到 ${allAgentResults.length} 筆相關標案`, 'success');
                } else {
                    showMessage('Gemini Agent 未找到相關標案', 'error');
                }

            } catch (error) {
                console.error('Gemini Agent 搜尋錯誤:', error);
                showMessage(`Gemini Agent 搜尋失敗：${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 根據時間範圍搜尋
        async function searchByTimeRange(searchType, query, page) {
            // 直接搜尋所有資料，不限制日期
            return await searchAllData(searchType, query, page);
        }
        
        // 搜尋所有資料（不限制日期）
        async function searchAllData(searchType, query, page) {
            let path = '';
            let params = new URLSearchParams();
            
            if (searchType === 'unit') {
                path = '/listbyunit';
                params.append('unit_id', query);
            } else {
                switch(searchType) {
                    case 'companyname':
                        path = '/searchbycompanyname';
                        params.append('query', query);
                        break;
                    case 'companyid':
                        path = '/searchbycompanyid';
                        params.append('query', query);
                        break;
                    case 'title':
                        path = '/searchbytitle';
                        params.append('query', query);
                        break;
                }
            }
            
            params.append('page', page);
            
            const fullPath = `${path}?${params.toString()}`;
            console.log(`API 調用路徑: ${fullPath}`);
            
            const { resp: response, url: usedUrl } = await fetchFromApis(fullPath, {
                method: 'GET',
                headers: { 'Accept': 'application/json' }
            }, 10000, 1);  // 減少重試次數從 2 次到 1 次
            
            console.log(`成功使用 API: ${usedUrl}`);
            
            const data = await response.json();
            console.log(`API 回應:`, data);
            
            // 儲存搜尋結果的總筆數和分頁資訊
            window.searchMeta = {
                totalRecords: data.total_records || 0,
                totalPages: data.total_pages || 0,
                currentPage: parseInt(page) || 1,
                query: query,
                searchType: searchType
            };
            
            return data.records || [];
        }
        
        // 搜尋所有頁面的資料（限制最多20頁以獲取更多結果）
        async function searchAllPages(searchType, query) {
            let allResults = [];
            let page = 1;
            let hasMorePages = true;
            let maxPages = 20; // 增加頁數限制以獲取更多結果
            
            console.log(`開始搜尋 ${searchType}: ${query}`);
            
            while (hasMorePages && page <= maxPages) {
                try {
                    console.log(`搜尋第 ${page} 頁...`);
                    const results = await searchAllData(searchType, query, page);
                    console.log(`第 ${page} 頁找到 ${results.length} 筆資料`);
                    
                    if (results && results.length > 0) {
                        allResults = allResults.concat(results);
                    }
                    
                    // 檢查是否還有更多頁面
                    if (window.searchMeta && page < window.searchMeta.totalPages && page < maxPages) {
                        page++;
                    } else {
                        hasMorePages = false;
                    }
                } catch (error) {
                    console.error(`搜尋第 ${page} 頁時發生錯誤:`, error);
                    hasMorePages = false;
                }
            }
            
            console.log(`搜尋完成，總共找到 ${allResults.length} 筆資料`);
            return allResults;
        }

        // 按日期搜尋
        async function searchByDate(searchType, query, date) {
            let url = '';
            let params = new URLSearchParams();
            
            if (searchType === 'unit') {
                url = `${API_BASE}/listbyunit`;
                params.append('unit_id', query);
            } else {
                // 先搜尋，然後過濾日期
                switch(searchType) {
                    case 'companyname':
                        url = `${API_BASE}/searchbycompanyname`;
                        params.append('query', query);
                        break;
                    case 'companyid':
                        url = `${API_BASE}/searchbycompanyid`;
                        params.append('query', query);
                        break;
                    case 'title':
                        url = `${API_BASE}/searchbytitle`;
                        params.append('query', query);
                        break;
                }
            }
            
            const response = await fetch(`${url}?${params.toString()}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (searchType === 'unit') {
                return data.records || [];
            } else {
                // 過濾指定日期的結果
                const targetDate = date.replace(/-/g, '');
                return (data.records || []).filter(record => record.date === targetDate);
            }
        }

        // 格式化日期為 API 格式
        function formatDateForAPI(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        // 顯示載入動畫
        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        // 隱藏訊息
        function hideMessage() {
            document.getElementById('messageArea').innerHTML = '';
        }

        // 顯示搜尋結果
        function displayResults(results, isGeminiSearch = false) {
            const resultsDiv = document.getElementById('searchResults');
            const resultsList = document.getElementById('resultsList');
            const resultStats = document.getElementById('resultStats');
            const resultFilters = document.getElementById('resultFilters');
            
            resultsDiv.style.display = 'block';
            resultFilters.style.display = 'block';
            resultsList.innerHTML = '';
            
            // 儲存原始結果
            window.allSearchResults = results;
            window.isGeminiSearch = isGeminiSearch;
            
            const searchType = isGeminiSearch ? 'Gemini Agent 搜尋' : '一般搜尋';
            
            // 統計開標和決標數量
            const openCount = results.filter(r => r.brief?.type && (r.brief.type.includes('開標') || r.brief.type.includes('招標'))).length;
            const awardCount = results.filter(r => r.brief?.type && (r.brief.type.includes('決標') || r.brief.type.includes('得標'))).length;
            
            resultStats.innerHTML = `
                <div class="row text-center">
                    <div class="col-4">
                        <div class="stats-card">
                            <div class="stats-number">${results.length}</div>
                            <div class="stats-label">總計</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stats-card">
                            <div class="stats-number text-primary">${openCount}</div>
                            <div class="stats-label">開標</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stats-card">
                            <div class="stats-number text-danger">${awardCount}</div>
                            <div class="stats-label">決標</div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">${searchType}</small>
                </div>
            `;
            

            // 顯示結果
            filterAndDisplayResults();
        }
        
        // 分頁狀態
        let pageSize = 10;
        let currentPage = 1;

        function changePageSize(value) {
            pageSize = parseInt(value) || 10;
            currentPage = 1;
            filterAndDisplayResults();
        }

        function goToPage(page) {
            currentPage = page;
            filterAndDisplayResults();
        }

        // 過濾和顯示結果
        function filterAndDisplayResults() {
            const resultsList = document.getElementById('resultsList');
            const filterType = document.querySelector('input[name="resultFilter"]:checked').value;
            const sortBy = document.getElementById('sortBy').value;
            
            let filteredResults = [...window.allSearchResults];
            
            // 過濾標案類型
            if (filterType !== 'all') {
                filteredResults = filterByTenderType(filteredResults, filterType);
            }
            
            // 排序
            filteredResults = sortResultsBy(filteredResults, sortBy);
            
            // 分頁
            const total = filteredResults.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;
            const start = (currentPage - 1) * pageSize;
            const end = Math.min(start + pageSize, total);

            // 顯示當頁
            resultsList.innerHTML = '';
            filteredResults.slice(start, end).forEach((record, idx) => {
                const resultItem = createResultItem(record, start + idx, window.isGeminiSearch || false);
                resultsList.appendChild(resultItem);
            });

            // 分頁 UI
            const pagination = document.getElementById('pagination');
            const createPageBtn = (label, page, disabled = false, active = false) => {
                return `<li class=\"page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}\"><a class=\"page-link\" href=\"javascript:void(0)\" onclick=\"${!disabled ? `goToPage(${page})` : ''}\">${label}</a></li>`;
            };
            let pagesHtml = '<nav><ul class="pagination pagination-sm">';
            pagesHtml += createPageBtn('«', 1, currentPage === 1);
            pagesHtml += createPageBtn('‹', Math.max(1, currentPage - 1), currentPage === 1);
            const windowSize = 5;
            const startPage = Math.max(1, currentPage - Math.floor(windowSize / 2));
            const endPage = Math.min(totalPages, startPage + windowSize - 1);
            for (let p = startPage; p <= endPage; p++) {
                pagesHtml += createPageBtn(p, p, false, p === currentPage);
            }
            pagesHtml += createPageBtn('›', Math.min(totalPages, currentPage + 1), currentPage === totalPages);
            pagesHtml += createPageBtn('»', totalPages, currentPage === totalPages);
            pagesHtml += '</ul></nav>';
            pagination.innerHTML = pagesHtml;
            
            // 更新統計
            const resultStats = document.getElementById('resultStats');
            resultStats.innerHTML = `
                <div class="stats-card">
                    <div class="stats-number">${total === 0 ? 0 : (start + 1)}-${end}</div>
                    <div class="stats-label">顯示標案（共 ${total} 筆）</div>
                </div>
            `;
        }
        
        // 排序結果
        function sortResults() {
            filterAndDisplayResults();
        }
        
        // 根據條件排序
        function sortResultsBy(results, sortBy) {
            return results.sort((a, b) => {
                switch (sortBy) {
                    case 'date_desc':
                        return b.date - a.date;
                    case 'date_asc':
                        return a.date - b.date;
                    case 'title':
                        return (a.brief?.title || '').localeCompare(b.brief?.title || '');
                    case 'unit':
                        return (a.unit_name || '').localeCompare(b.unit_name || '');
                    default:
                        return 0;
                }
            });
        }

        // 創建結果項目
        function createResultItem(record, index, isGeminiSearch = false) {
            const div = document.createElement('div');
            div.className = 'result-item';
            
            const brief = record.brief || {};
            const companies = brief.companies || {};
            
            // 構建政府採購網連結
            const govUrl = buildGovUrl(record);
            
            // 如果沒有政府採購網連結，嘗試異步獲取詳細資訊
            if (govUrl === '#' || govUrl.includes('pcc.g0v.ronny.tw')) {
                // 異步獲取詳細資訊來構建正確的連結
                fetchTenderDetailForUrl(record.unit_id, record.job_number).then(detailUrl => {
                    if (detailUrl && detailUrl !== '#') {
                        // 更新連結
                        const link = div.querySelector('a');
                        if (link) {
                            link.href = detailUrl;
                        }
                    }
                }).catch(error => {
                    console.log('無法獲取詳細資訊:', error);
                });
            }
            
            // 判斷是否為決標類型
            const isAward = brief.type && (brief.type.includes('決標') || brief.type.includes('得標'));
            const badgeClass = isAward ? 'bg-danger' : 'bg-primary';
            const titleClass = isAward ? 'text-danger' : 'text-primary';
            
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h5 class="mb-0">
                        <a href="${govUrl}" target="_blank" class="${titleClass} text-decoration-none">
                            ${brief.title || '無標題'}
                            <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                        </a>
                        ${isGeminiSearch ? '<span class="text-warning ms-2" title="Gemini 推薦"><i class="fas fa-star"></i></span>' : ''}
                    </h5>
                    <span class="badge ${badgeClass}">${brief.type || '未知類型'}</span>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <small class="text-muted"><i class="fas fa-calendar me-1"></i>日期: ${record.date || '未知'}</small>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted"><i class="fas fa-building me-1"></i>機關: ${record.unit_name || '未知'}</small>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted"><i class="fas fa-hashtag me-1"></i>代碼: ${record.job_number || '未知'}</small>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted"><i class="fas fa-coins me-1"></i>預算: <span class="budget-amount" data-unit-id="${record.unit_id || ''}" data-job-number="${record.job_number || ''}">${(record.detail && record.detail['採購資料:預算金額']) ? record.detail['採購資料:預算金額'] : '載入中…'}</span></small>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-12">
                        <small class="text-muted"><i class="fas fa-tag me-1"></i>分類: ${brief.category || '未知'}</small>
                    </div>
                </div>
                ${companies.names && companies.names.length > 0 ? `
                    <div class="mb-3">
                        <strong><i class="fas fa-users me-1"></i>相關公司:</strong>
                        <div class="mt-2">
                            ${companies.names.map(name => `<button class="btn btn-outline-info btn-sm me-2 mb-1 company-btn" onclick="openCompanyAnalysis('${name}')" title="點擊在新分頁中分析 ${name} 的得標情況">${name}</button>`).join('')}
                        </div>
                    </div>
                ` : ''}
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary btn-sm" onclick="showDetail('${record.unit_id}', '${record.job_number}', '${record.date}')">
                        <i class="fas fa-info-circle me-1"></i>詳細資料
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="startChat('${brief.title || '無標題'}', '${record.unit_name || '未知機關'}', '${brief.type || '未知類型'}')">
                        <i class="fas fa-comments me-1"></i>AI 對話
                    </button>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="分享標案">
                            <i class="fas fa-share-alt me-1"></i>分享
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="shareToLineAsync('${(brief.title || '無標題').replace(/'/g, "\\'")}', '${(record.unit_name || '未知機關').replace(/'/g, "\\'")}', '${record.unit_id || ''}', '${record.job_number || ''}')">
                                <i class="fab fa-line text-success me-2"></i>分享到 Line
                            </a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="shareToGmailAsync('${(brief.title || '無標題').replace(/'/g, "\\'")}', '${(record.unit_name || '未知機關').replace(/'/g, "\\'")}', '${record.job_number || '未知'}', '${record.unit_id || ''}', '${record.job_number || ''}')">
                                <i class="fas fa-envelope text-danger me-2"></i>分享到 Gmail
                            </a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="copyLinkAsync('${(brief.title || '無標題').replace(/'/g, "\\'")}', '${record.unit_id || ''}', '${record.job_number || ''}')">
                                <i class="fas fa-copy text-primary me-2"></i>複製連結
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="${buildGovUrl(record)}" target="_blank">
                                <i class="fas fa-external-link-alt me-2"></i>前往政府採購網頁面
                            </a></li>
                        </ul>
                    </div>
                </div>
            `;
            
            // 非同步載入預算金額（使用本專案 API），含快取與重試
            try {
                const budgetSpan = div.querySelector('.budget-amount');
                const unitId = budgetSpan?.dataset.unitId;
                const jobNumber = budgetSpan?.dataset.jobNumber;
                if (budgetSpan && unitId && jobNumber && budgetSpan.textContent.includes('載入中')) {
                    loadAndFillBudget(budgetSpan, unitId, jobNumber);
                }
            } catch (e) {
                console.warn('載入預算金額時發生例外:', e);
            }

            return div;
        }

        const budgetCache = new Map();
        async function loadAndFillBudget(el, unitId, jobNumber) {
            const cacheKey = `${unitId}::${jobNumber}`;
            if (budgetCache.has(cacheKey)) {
                el.textContent = budgetCache.get(cacheKey);
                return;
            }
            try {
                // 只使用 fetchFromApis 的內建重試機制（1次重試），避免過多 API 請求
                const { resp } = await fetchFromApis(`/tender?unit_id=${encodeURIComponent(unitId)}&job_number=${encodeURIComponent(jobNumber)}`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                }, 10000, 1);  // 每個來源只重試 1 次
                const data = await resp.json();
                const rec = (data.records && data.records[0]) || data;
                const amount = rec?.detail?.['採購資料:預算金額'] || rec?.brief?.budget || '';
                if (amount) {
                    budgetCache.set(cacheKey, amount);
                    el.textContent = amount;
                } else {
                    el.textContent = '無資料';
                }
            } catch (err) {
                console.warn('預算金額載入失敗（可能是速率限制）：', unitId, jobNumber);
                el.textContent = '點擊詳細查看';
                el.title = `點擊「詳細資料」查看完整資訊`;
            }
        }

        // 獲取標案詳細資訊來構建正確的政府採購網連結
        async function fetchTenderDetailForUrl(unitId, jobNumber) {
            try {
                const response = await fetch(`${API_BASE}/tender?unit_id=${unitId}&job_number=${jobNumber}`);
                if (!response.ok) {
                    return '#';
                }
                
                const data = await response.json();
                const record = data.records && data.records.length > 0 ? data.records[0] : data;
                
                // 使用詳細資訊構建正確的連結
                return buildGovUrl(record);
            } catch (error) {
                console.error('獲取標案詳細資訊失敗:', error);
                return '#';
            }
        }

        // 取得標案識別碼 pkPmsMain（若有詳細資料）
        function getPkPmsMain(record) {
            if (record && record.detail && record.detail.pkPmsMain) {
                return record.detail.pkPmsMain;
            }
            return '';
        }

        // 構建政府採購網 URL
        function buildGovUrl(record) {
            // 優先使用 detail.url 中的政府採購網連結
            if (record.detail && record.detail.url && record.detail.url.startsWith('https://web.pcc.gov.tw')) {
                return record.detail.url;
            }
            // 如果有 pkPmsMain，構建政府採購網連結
            if (record.detail && record.detail.pkPmsMain) {
                return `https://web.pcc.gov.tw/tps/QueryTender/query/searchTenderDetail?pkPmsMain=${record.detail.pkPmsMain}`;
            }
            // 如果有直接的 url 欄位且是政府採購網連結
            if (record.url && record.url.startsWith('https://web.pcc.gov.tw')) {
                return record.url;
            }
            // 備用方案：使用 pcc.g0v.ronny.tw 的 tender.html
            if (record.job_number && record.unit_id && record.date) {
                const dateStr = record.date.toString();
                const filename = record.filename || 'unknown';
                return `https://pcc.g0v.ronny.tw/tender.html?unit_id=${record.unit_id}&job_number=${record.job_number}&date=${dateStr}&filename=${filename}`;
            } else if (record.url) {
                if (record.url.startsWith('http')) {
                    return record.url;
                } else {
                    return `https://pcc.g0v.ronny.tw${record.url}`;
                }
            }
            return '#';
        }

        // 關閉詳細資料模態框
        function closeDetailModal() {
            const modal = document.getElementById('detailModal');
            if (modal) {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) {
                    bsModal.hide();
                }
            }
        }

        // 切換標案記錄分頁
        function switchTenderRecord(index) {
            if (!window.tenderRecords || !window.tenderRecords[index]) {
                return;
            }
            
            const record = window.tenderRecords[index];
            const brief = record.brief || {};
            const detail = record.detail || {};
            
            // 格式化日期
            const dateStr = record.date ? record.date.toString() : '';
            const formattedDate = dateStr ? `${dateStr.substring(0,4)}年${dateStr.substring(4,6)}月${dateStr.substring(6,8)}日` : '無資料';
            
            // 更新內容
            const content = document.getElementById('tenderDetailContent');
            if (content) {
                content.innerHTML = `
                    <h6>基本資訊</h6>
                    <table class="table table-sm">
                        <tr><td><strong>標案名稱</strong></td><td>${brief.title || '無資料'}</td></tr>
                        <tr><td><strong>標案類型</strong></td><td>${brief.type || '無資料'}</td></tr>
                        <tr><td><strong>發布日期</strong></td><td>${formattedDate}</td></tr>
                        <tr><td><strong>機關名稱</strong></td><td>${detail['機關資料:機關名稱'] || '無資料'}</td></tr>
                        <tr><td><strong>標案編號</strong></td><td>${record.job_number || '無資料'}</td></tr>
                        <tr><td><strong>機關代碼</strong></td><td>${record.unit_id || '無資料'}</td></tr>
                        <tr><td><strong>分類</strong></td><td>${brief.category || '無資料'}</td></tr>
                        <tr><td><strong>預算金額</strong></td><td>${detail['採購資料:預算金額'] || '無資料'}</td></tr>
                    </table>
                    
                    ${isTenderAwarded(brief.type, detail) ? getAwardInfo(detail) : getTenderInfo(detail)}

                    ${isTenderAwarded(brief.type, detail) ? renderAwardItemsSection(detail, record.job_number || '') : ''}
                    
                    <div class="mt-3">
                        <h6>重要時間提醒</h6>
                        <div class="d-flex gap-2 flex-wrap">
                            ${detail['領投開標:開標時間'] ? `
                                <button class="btn btn-outline-primary btn-sm" 
                                        onclick="addToCalendar('${brief.title || '標案'} - 開標', '${detail['領投開標:開標時間']}', '${detail['領投開標:開標地點'] || detail['機關資料:機關名稱'] || '政府機關'}', '${buildGovUrl(record)}')">
                                    <i class="fas fa-calendar-plus me-1"></i>開標時間加入行事曆
                                </button>
                            ` : ''}
                            ${detail['領投開標:截止投標'] ? `
                                <button class="btn btn-outline-warning btn-sm" 
                                        onclick="addToCalendar('${brief.title || '標案'} - 截止投標', '${detail['領投開標:截止投標']}', '${detail['領投開標:開標地點'] || detail['機關資料:機關名稱'] || '政府機關'}', '${buildGovUrl(record)}')">
                                    <i class="fas fa-calendar-times me-1"></i>截止投標加入行事曆
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${brief.companies?.names?.length > 0 ? `
                        <h6 class="mt-3">相關公司</h6>
                        <ul>
                            ${brief.companies.names.map(name => `<li>${name}</li>`).join('')}
                        </ul>
                    ` : '<p class="mt-3">無相關公司資料</p>'}
                    
                    <div class="mt-3">
                        <a href="${buildGovUrl(record)}" target="_blank" class="btn btn-primary me-2">
                            <i class="fas fa-external-link-alt me-1"></i>查看完整標案頁面
                        </a>
                        <button class="btn btn-secondary me-2" onclick="closeDetailModal()">
                            <i class="fas fa-times me-1"></i>關閉此頁面
                        </button>
                    </div>
                `;
            }
            
            // 更新按鈕狀態
            document.querySelectorAll('[data-record-index]').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.recordIndex) === index) {
                    btn.classList.add('active');
                }
            });
        }

        // 顯示詳細資料
        async function showDetail(unitId, jobNumber, date) {
            try {
                showMessage('正在載入標案詳細資料...', 'info');

                const { resp, url } = await fetchFromApis(`/tender?unit_id=${encodeURIComponent(unitId)}&job_number=${encodeURIComponent(jobNumber)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                }, 12000, 1);  // 減少重試次數從 2 次到 1 次

                console.log('成功使用 API:', url);
                console.log('API 回應狀態:', resp.status, resp.statusText);
                const data = await resp.json();
                console.log('API 回應資料:', data);
                
                // 取得所有記錄
                const records = data.records || [data];
                const currentRecord = records[0];
                const brief = currentRecord.brief || {};
                const detail = currentRecord.detail || {};
                
                // 格式化日期
                const dateStr = currentRecord.date ? currentRecord.date.toString() : date.toString();
                const formattedDate = `${dateStr.substring(0,4)}年${dateStr.substring(4,6)}月${dateStr.substring(6,8)}日`;
                
                // 生成分頁按鈕
                const paginationButtons = records.length > 1 ? `
                    <div class="mb-3">
                        <h6>標案進度分頁</h6>
                        <div class="btn-group" role="group">
                            ${records.map((record, index) => {
                                const recordDate = record.date ? record.date.toString() : '';
                                const recordFormattedDate = recordDate ? `${recordDate.substring(0,4)}年${recordDate.substring(4,6)}月${recordDate.substring(6,8)}日` : '';
                                const recordType = record.brief?.type || '無資料';
                                const isActive = index === 0 ? 'active' : '';
                                return `
                                    <button type="button" class="btn btn-outline-primary btn-sm ${isActive}" 
                                            onclick="switchTenderRecord(${index})" 
                                            data-record-index="${index}">
                                        ${recordFormattedDate}<br>
                                        <small>${recordType}</small>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : '';
                
                // 顯示詳細資料
                const detailHtml = `
                    <div class="modal fade" id="detailModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">標案詳細資料</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    ${paginationButtons}
                                    
                                    <div id="tenderDetailContent">
                                        <h6>基本資訊</h6>
                                        <table class="table table-sm">
                                            <tr><td><strong>標案名稱</strong></td><td>${brief.title || '無資料'}</td></tr>
                                            <tr><td><strong>標案類型</strong></td><td>${brief.type || '無資料'}</td></tr>
                                            <tr><td><strong>發布日期</strong></td><td>${formattedDate}</td></tr>
                                            <tr><td><strong>機關名稱</strong></td><td>${detail['機關資料:機關名稱'] || '無資料'}</td></tr>
                                            <tr><td><strong>標案編號</strong></td><td>${currentRecord.job_number || '無資料'}</td></tr>
                                            <tr><td><strong>機關代碼</strong></td><td>${currentRecord.unit_id || '無資料'}</td></tr>
                                            <tr><td><strong>分類</strong></td><td>${brief.category || '無資料'}</td></tr>
                                            <tr><td><strong>預算金額</strong></td><td>${detail['採購資料:預算金額'] || '無資料'}</td></tr>
                                        </table>
                                        
                                        ${isTenderAwarded(brief.type, detail) ? getAwardInfo(detail) : getTenderInfo(detail)}
                                        
                                        <div class="mt-3">
                                            <h6>重要時間提醒</h6>
                                            <div class="d-flex gap-2 flex-wrap">
                                                ${detail['領投開標:開標時間'] ? `
                                                    <button class="btn btn-outline-primary btn-sm" 
                                                            onclick="addToCalendar('${brief.title || '標案'} - 開標', '${detail['領投開標:開標時間']}', '${detail['領投開標:開標地點'] || detail['機關資料:機關名稱'] || '政府機關'}', '${buildGovUrl(currentRecord)}')">
                                                        <i class="fas fa-calendar-plus me-1"></i>開標時間加入行事曆
                                                    </button>
                                                ` : ''}
                                                ${detail['領投開標:截止投標'] ? `
                                                    <button class="btn btn-outline-warning btn-sm" 
                                                            onclick="addToCalendar('${brief.title || '標案'} - 截止投標', '${detail['領投開標:截止投標']}', '${detail['領投開標:開標地點'] || detail['機關資料:機關名稱'] || '政府機關'}', '${buildGovUrl(currentRecord)}')">
                                                        <i class="fas fa-calendar-times me-1"></i>截止投標加入行事曆
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                        
                                        ${isTenderAwarded(brief.type, detail) ? renderAwardItemsSection(detail, currentRecord.job_number || currentRecord.brief?.job_number || '') : ''}
                                        
                                        ${brief.companies?.names?.length > 0 ? `
                                            <h6 class="mt-3">相關公司</h6>
                                            <ul>
                                                ${brief.companies.names.map(name => `<li>${name}</li>`).join('')}
                                            </ul>
                                        ` : '<p class="mt-3">無相關公司資料</p>'}
                                        
                                        <div class="mt-3">
                                            <a href="${buildGovUrl(currentRecord)}" target="_blank" class="btn btn-primary me-2">
                                                <i class="fas fa-external-link-alt me-1"></i>查看完整標案頁面
                                            </a>
                                            <button class="btn btn-secondary me-2" onclick="closeDetailModal()">
                                                <i class="fas fa-times me-1"></i>關閉此頁面
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 儲存記錄資料供分頁使用
                window.tenderRecords = records;
                
                // 移除舊的 modal（包括 backdrop）
                const oldModal = document.getElementById('detailModal');
                if (oldModal) {
                    console.log('移除舊的 modal');
                    const bsModal = bootstrap.Modal.getInstance(oldModal);
                    if (bsModal) {
                        bsModal.dispose();
                    }
                    oldModal.remove();
                }
                // 移除可能殘留的 backdrop
                document.querySelectorAll('.modal-backdrop').forEach(backdrop => {
                    console.log('移除殘留的 backdrop');
                    backdrop.remove();
                });
                
                // 確保 body 沒有 modal-open class
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                // 添加新的 modal
                console.log('添加新的 modal');
                document.body.insertAdjacentHTML('beforeend', detailHtml);
                
                // 顯示 modal
                const modalElement = document.getElementById('detailModal');
                if (!modalElement) {
                    throw new Error('無法創建 modal 元素');
                }
                
                console.log('初始化 Bootstrap Modal');
                try {
                    const modal = new bootstrap.Modal(modalElement, {
                        backdrop: true,
                        keyboard: true,
                        focus: true
                    });
                    
                    console.log('顯示 modal');
                    modal.show();
                    
                    // 監聽 modal 顯示事件
                    modalElement.addEventListener('shown.bs.modal', function () {
                        console.log('Modal 已成功顯示');
                    });
                    
                    // 監聽 modal 隱藏事件
                    modalElement.addEventListener('hidden.bs.modal', function () {
                        console.log('Modal 已關閉');
                        // 清理
                        modalElement.remove();
                        document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
                    });
                    
                } catch (modalError) {
                    console.error('Modal 初始化錯誤:', modalError);
                    throw new Error(`Modal 初始化失敗: ${modalError.message}`);
                }
                
                // 清除載入訊息
                hideMessage();
                console.log('詳細資料載入完成');
                
            } catch (error) {
                console.error('載入詳細資料錯誤:', error);
                
                let errorMessage = '載入詳細資料失敗：<br>';
                
                // 解析錯誤訊息
                if (error.message.includes('所有 API 來源均失敗')) {
                    errorMessage += '無法連接到任何 API 來源<br>';
                    errorMessage += `<small class="text-muted">錯誤詳情：${error.message}</small>`;
                } else if (error.name === 'AbortError') {
                    errorMessage += '請求超時，請檢查網路連線';
                } else if (error.message.includes('HTTP')) {
                    errorMessage += `API 回應錯誤：${error.message}`;
                } else {
                    errorMessage += `${error.message}`;
                }
                
                errorMessage += `<br><br><small class="text-muted">標案資訊：${unitId} / ${jobNumber}</small>`;
                errorMessage += `<br><small class="text-muted">建議：稍後再試，或嘗試重新整理頁面</small>`;
                
                showNotification('載入詳細資料失敗', errorMessage, 'error');
            }
        }

        // 非同步取得官方連結（優先取得 pkPmsMain）
        const urlCache = new Map();
        async function getOfficialUrl(unitId, jobNumber) {
            const cacheKey = `${unitId}::${jobNumber}`;
            if (urlCache.has(cacheKey)) {
                return urlCache.get(cacheKey);
            }
            try {
                const { resp } = await fetchFromApis(`/tender?unit_id=${encodeURIComponent(unitId)}&job_number=${encodeURIComponent(jobNumber)}`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                }, 10000, 1);
                const data = await resp.json();
                const rec = (data.records && data.records[0]) || data;
                const url = buildGovUrl(rec);
                urlCache.set(cacheKey, url);
                return url;
            } catch (err) {
                console.warn('無法取得官方連結，使用備用:', err);
                return `https://pcc.g0v.ronny.tw/tender.html?unit_id=${unitId}&job_number=${jobNumber}`;
            }
        }

        // 分享到 Line（非同步取得官方連結）
        async function shareToLineAsync(title, unitName, unitId, jobNumber) {
            showNotification('正在準備分享連結...', 'info');
            const govUrl = await getOfficialUrl(unitId, jobNumber);
            const message = `📋 ${title}\n🏢 機關：${unitName}\n🔗 連結：${govUrl}`;
            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
            window.open(lineUrl, '_blank');
            showNotification('已開啟 Line 分享', '請選擇要分享的對象', 'success');
        }

        // 分享到 Gmail（非同步取得官方連結）
        async function shareToGmailAsync(title, unitName, jobNumber, unitId, jobNum) {
            showNotification('正在準備分享連結...', 'info');
            const govUrl = await getOfficialUrl(unitId, jobNum);
            const subject = `政府採購標案：${title}`;
            const body = `
政府採購標案資訊

標案名稱：${title}
機關名稱：${unitName}
案號：${jobNumber}

詳細資料連結：
${govUrl}

---
此郵件由政府採購標案查詢系統自動產生
            `.trim();
            
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(gmailUrl, '_blank');
            showNotification('已開啟 Gmail', '請填寫收件人', 'success');
        }

        // 複製官方連結（非同步取得）
        async function copyLinkAsync(title, unitId, jobNumber) {
            showNotification('正在取得官方連結...', 'info');
            const govUrl = await getOfficialUrl(unitId, jobNumber);
            try {
                await navigator.clipboard.writeText(govUrl);
                showNotification('連結已複製', `已複製「${title}」的官方連結到剪貼簿`, 'success');
            } catch (error) {
                // 備用方案：使用傳統的複製方法
                const textArea = document.createElement('textarea');
                textArea.value = govUrl;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    showNotification('連結已複製', `已複製「${title}」的官方連結到剪貼簿`, 'success');
                } catch (err) {
                    showNotification('複製失敗', '無法複製連結，請手動複製', 'error');
                }
                
                document.body.removeChild(textArea);
            }
        }

        // 加入 Google Calendar
        function addToCalendar(title, dateStr, unit, url) {
            try {
                // 確保 URL 是正確的政府採購網連結
                const govUrl = buildGovUrl({url: url});
                
                // 解析日期字串 (格式: 114/10/03 15:30 或 114/10/17 17:00)
                let year, month, day, hour, minute;
                
                if (dateStr && dateStr.includes('/')) {
                    const parts = dateStr.split(' ');
                    const datePart = parts[0]; // 114/10/03
                    const timePart = parts[1] || '09:00'; // 15:30 或預設 09:00
                    
                    const [y, m, d] = datePart.split('/');
                    const [h, min] = timePart.split(':');
                    
                    // 民國年轉西元年
                    year = parseInt(y) + 1911;
                    month = m.padStart(2, '0');
                    day = d.padStart(2, '0');
                    hour = h.padStart(2, '0');
                    minute = min.padStart(2, '0');
                } else {
                    // 如果沒有日期，使用當前日期
                    const now = new Date();
                    year = now.getFullYear();
                    month = String(now.getMonth() + 1).padStart(2, '0');
                    day = String(now.getDate()).padStart(2, '0');
                    hour = '09';
                    minute = '00';
                }
                
                // 構建 Google Calendar URL
                const startDate = `${year}${month}${day}T${hour}${minute}00`;
                const endDate = `${year}${month}${day}T${String(parseInt(hour) + 1).padStart(2, '0')}${minute}00`;
                
                const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDate}/${endDate}&details=${encodeURIComponent(`機關：${unit}\n標案連結：${govUrl}`)}&location=${encodeURIComponent(unit)}`;
                
                // 打開 Google Calendar
                window.open(calendarUrl, '_blank');
                
                showMessage('已開啟 Google Calendar 新增事件頁面', 'success');
                
            } catch (error) {
                console.error('加入行事曆錯誤:', error);
                showMessage(`加入行事曆失敗：${error.message}`, 'error');
            }
        }
        
        // 開始 AI 對話
        function startChat(title, unit, type) {
            const chatModal = document.getElementById('chatModal');
            if (chatModal) {
                const modal = new bootstrap.Modal(chatModal);
                modal.show();
                
                // 設定對話上下文
                window.currentChatContext = {
                    title: title,
                    unit: unit,
                    type: type
                };
                
                // 清空對話記錄
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `
                    <div class="chat-message bot-message">
                        <div class="message-content">
                            <strong>AI 助手：</strong>您好！我是您的政府採購標案 AI 助手。我可以幫您分析標案資訊、回答相關問題，或提供投標建議。
                            <br><br>
                            <strong>當前標案：</strong>${title}<br>
                            <strong>機關：</strong>${unit}<br>
                            <strong>類型：</strong>${type}
                            <br><br>
                            請告訴我您想了解什麼？
                        </div>
                    </div>
                `;
            } else {
                showMessage('對話功能尚未初始化，請先設定 Gemini API Key', 'error');
            }
        }

        // 處理對話輸入鍵盤事件
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
        
        // 發送對話訊息
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // 清空輸入框
            input.value = '';
            
            // 檢查是否有 Gemini API Key
            const geminiKey = document.getElementById('geminiKey').value.trim();
            if (!geminiKey) {
                addChatMessage('user', message);
                addChatMessage('bot', '請先在搜尋區域設定 Gemini API Key 才能使用對話功能。');
                return;
            }
            
            // 添加用戶訊息
            addChatMessage('user', message);
            
            // 顯示載入中
            const loadingId = addChatMessage('bot', '正在思考中...', true);
            
            try {
                // 構建對話提示
                const context = window.currentChatContext || {};
                const prompt = `你是政府採購標案的專業 AI 助手。請根據以下標案資訊回答用戶問題：

標案名稱：${context.title || '未知'}
機關：${context.unit || '未知'}
類型：${context.type || '未知'}

用戶問題：${message}

請用繁體中文回答，提供專業、實用的建議。如果問題與標案無關，請禮貌地引導用戶回到標案相關話題。`;
                
                // 調用 Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API 錯誤: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || '抱歉，我無法生成回應。';
                
                // 更新載入中的訊息
                updateChatMessage(loadingId, 'bot', aiResponse);
                
            } catch (error) {
                console.error('對話錯誤:', error);
                updateChatMessage(loadingId, 'bot', `抱歉，發生錯誤：${error.message}`);
            }
        }
        
        // 添加對話訊息
        function addChatMessage(sender, message, isLoading = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `chat-message ${sender}-message mb-3`;
            
            const senderName = sender === 'user' ? '您' : 'AI 助手';
            const messageClass = sender === 'user' ? 'text-end' : 'text-start';
            
            messageDiv.innerHTML = `
                <div class="message-content ${messageClass}">
                    <strong>${senderName}：</strong>
                    <div class="message-text">${message}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return messageId;
        }
        
        // 更新對話訊息
        function updateChatMessage(messageId, sender, message) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                const messageText = messageDiv.querySelector('.message-text');
                if (messageText) {
                    messageText.innerHTML = message;
                }
            }
        }



        // 開啟公司分析頁面
        function openCompanyAnalysis(companyName) {
            // 在新分頁中開啟公司分析頁面（不再強制要求 API Key）
            const geminiKey = document.getElementById('geminiKey').value.trim();
            const analysisUrl = geminiKey 
                ? `company_analysis.html?company=${encodeURIComponent(companyName)}&key=${encodeURIComponent(geminiKey)}`
                : `company_analysis.html?company=${encodeURIComponent(companyName)}`;
            
            // 在新分頁中開啟
            window.open(analysisUrl, '_blank');
            
            showNotification('分析開始', `正在新分頁中分析 ${companyName} 的得標情況...`, 'info');
        }

        // 清除搜尋結果
        function clearSearchResults() {
            // 隱藏搜尋結果區域
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('resultFilters').style.display = 'none';
            
            // 清空結果列表
            document.getElementById('resultsList').innerHTML = '';
            
            // 清空統計資料
            document.getElementById('resultStats').innerHTML = '';
            
            // 清空全域變數
            window.allSearchResults = [];
            window.isGeminiSearch = false;
            
            // 確保搜尋按鈕和輸入框可用
            document.querySelectorAll('input, button').forEach(element => {
                element.disabled = false;
            });
            
            // 顯示清除訊息
            showNotification('清除完成', '搜尋結果已清除，可以進行新的搜尋', 'success');
        }

        // 顯示 Gemini API Key 幫助
        function showGeminiHelp() {
            const helpText = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-robot me-2"></i>如何取得 Gemini API Key</h6>
                    <ol>
                        <li>前往 <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></li>
                        <li>使用 Google 帳號登入</li>
                        <li>點擊「Create API Key」</li>
                        <li>複製產生的 API Key 並貼到上方欄位</li>
                    </ol>
                    <p class="mb-0"><strong>注意：</strong>API Key 用於 AI 對話和智能分析功能，不會儲存在本機。</p>
                </div>
            `;
            showMessage(helpText, 'info');
        }

        // 顯示 ChatGPT API Key 幫助
        function showChatGPTHelp() {
            const helpText = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-comments me-2"></i>如何取得 ChatGPT API Key</h6>
                    <ol>
                        <li>前往 <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a></li>
                        <li>使用 OpenAI 帳號登入（如無帳號請先註冊）</li>
                        <li>點擊「Create new secret key」</li>
                        <li>複製產生的 API Key 並貼到上方欄位</li>
                    </ol>
                    <p class="mb-0"><strong>注意：</strong>API Key 用於 ChatGPT 對話功能，請妥善保管，不會儲存在本機。</p>
                </div>
            `;
            showMessage(helpText, 'info');
        }

        // 複製錯誤訊息到剪貼簿
        async function copyErrorMessage() {
            const notification = document.querySelector('.notification.error .notification-body');
            if (!notification) return;
            
            // 移除 HTML 標籤，只保留文字內容
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = notification.innerHTML;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';
            
            try {
                await navigator.clipboard.writeText(textContent);
                // 顯示複製成功的小提示
                const copyBtn = document.querySelector('.copy-error-btn');
                if (copyBtn) {
                    const originalHTML = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>已複製';
                    copyBtn.classList.add('btn-success');
                    copyBtn.classList.remove('btn-outline-secondary');
                    setTimeout(() => {
                        copyBtn.innerHTML = originalHTML;
                        copyBtn.classList.remove('btn-success');
                        copyBtn.classList.add('btn-outline-secondary');
                    }, 2000);
                }
            } catch (error) {
                // 備用方案：使用傳統的複製方法
                const textArea = document.createElement('textarea');
                textArea.value = textContent;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    alert('錯誤訊息已複製到剪貼簿');
                } catch (err) {
                    alert('複製失敗，請手動複製錯誤訊息');
                }
                
                document.body.removeChild(textArea);
            }
        }

        // 顯示彈出式通知
        function showNotification(title, message, type = 'info', duration = 5000) {
            // 移除現有的通知
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // 創建通知元素
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconMap = {
                'error': 'fas fa-exclamation-triangle',
                'success': 'fas fa-check-circle',
                'info': 'fas fa-info-circle',
                'warning': 'fas fa-exclamation-circle'
            };
            
            // 錯誤訊息添加複製按鈕
            const errorActions = type === 'error' ? `
                <div class="notification-actions">
                    <button class="btn btn-sm copy-error-btn" onclick="copyErrorMessage()" title="複製錯誤訊息以便回報問題">
                        <i class="fas fa-copy me-1"></i>複製錯誤訊息
                    </button>
                </div>
            ` : '';
            
            notification.innerHTML = `
                <div class="notification-header">
                    <h6 class="notification-title">
                        <i class="${iconMap[type] || 'fas fa-info-circle'} me-2"></i>${title}
                    </h6>
                    <button class="notification-close" onclick="closeNotification()" title="關閉">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="notification-body">
                    <div class="notification-message">${message}</div>
                    ${errorActions}
                </div>
            `;
            
            // 添加到頁面
            document.body.appendChild(notification);
            
            // 自動關閉（除了錯誤通知）
            if (type !== 'error' && duration > 0) {
                setTimeout(() => {
                    closeNotification();
                }, duration);
            }
        }

        // 關閉通知
        function closeNotification() {
            const notification = document.querySelector('.notification');
            if (notification) {
                notification.style.animation = 'slideUp 0.3s ease-out';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }
        }

        // 添加關閉動畫
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideUp {
                from {
                    opacity: 1;
                    transform: translateX(-50%) translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(-50%) translateY(-20px);
                }
            }
        `;
        document.head.appendChild(style);

        // 顯示訊息（兼容舊版本）
        function showMessage(message, type = 'info') {
            showNotification('系統訊息', message, type);
        }

        // 隱藏訊息（兼容舊版本）
        function hideMessage() {
            closeNotification();
        }

        // 執行 AI 分析
        async function performAIAnalysis(results, geminiKey) {
            if (!results || results.length === 0) {
                return;
            }

            try {
                // 顯示 AI 分析載入中
                document.getElementById('aiLoading').style.display = 'block';
                document.getElementById('aiAnalysisResults').style.display = 'block';

                // 構建分析提示
                const analysisPrompt = `請分析以下政府採購標案資料：

標案資料：
${JSON.stringify(results.slice(0, 10), null, 2)}

請提供以下分析：

1. **標案類型分析**
   - 開標與決標案件比例
   - 主要標案類型分布

2. **機關分析**
   - 主要發包機關
   - 機關類型分布

3. **時間趨勢分析**
   - 標案發布時間分布
   - 是否有季節性趨勢

4. **金額分析**
   - 標案金額分布
   - 高金額標案特徵

5. **關鍵洞察**
   - 重要發現
   - 建議關注的標案

請以專業、簡潔的方式呈現分析結果，使用繁體中文。`;

                // 調用 Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: analysisPrompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Gemini API 錯誤: ${response.status}`);
                }

                const data = await response.json();
                const analysisText = data.candidates[0].content.parts[0].text;

                // 顯示分析結果
                document.getElementById('aiContent').innerHTML = `
                    <div class="analysis-content">
                        <div style="white-space: pre-line; line-height: 1.8; font-size: 1.1rem;">${analysisText}</div>
                    </div>
                `;

            } catch (error) {
                console.error('AI 分析錯誤:', error);
                document.getElementById('aiContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        AI 分析失敗：${error.message}
                    </div>
                `;
            } finally {
                // 隱藏載入中
                document.getElementById('aiLoading').style.display = 'none';
            }
        }

        // ==================== 自動監控功能 ====================
        
        let autoMonitorInterval = null;
        let autoMonitorData = {
            enabled: false,
            keywords: [],
            times: ['08:00', '17:00'],
            dateRange: 'today',
            notifyBrowser: true,
            notifySound: true,
            todaySearchCount: 0,
            todayResultCount: 0,
            todayNewCount: 0,
            lastSearchTime: null,
            searchHistory: [],
            seenTenders: new Set()
        };

        // 載入監控設定
        function loadMonitorSettings() {
            const saved = localStorage.getItem('autoMonitorData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    autoMonitorData = { ...autoMonitorData, ...data };
                    // 將 seenTenders 從陣列轉換回 Set
                    if (data.seenTenders && Array.isArray(data.seenTenders)) {
                        autoMonitorData.seenTenders = new Set(data.seenTenders);
                    }
                    
                    // 更新 UI
                    if (autoMonitorData.keywords.length > 0) {
                        document.getElementById('monitorKeywords').value = autoMonitorData.keywords.join('\n');
                    }
                    document.getElementById('monitorDateRange').value = autoMonitorData.dateRange;
                    document.getElementById('monitor08').checked = autoMonitorData.times.includes('08:00');
                    document.getElementById('monitor17').checked = autoMonitorData.times.includes('17:00');
                    document.getElementById('monitorNotifyBrowser').checked = autoMonitorData.notifyBrowser;
                    document.getElementById('monitorNotifySound').checked = autoMonitorData.notifySound;
                    
                    // 更新統計
                    updateMonitorStats();
                    
                    // 如果之前已啟用，重新啟動
                    if (autoMonitorData.enabled) {
                        startAutoMonitor();
                    }
                } catch (e) {
                    console.error('載入監控設定失敗:', e);
                }
            }
        }

        // 儲存監控設定
        function saveMonitorSettings() {
            const keywords = document.getElementById('monitorKeywords').value
                .split('\n')
                .map(k => k.trim())
                .filter(k => k.length > 0);
            
            if (keywords.length === 0) {
                showNotification('儲存失敗', '請至少輸入一個監控關鍵字', 'error');
                return;
            }
            
            autoMonitorData.keywords = keywords;
            autoMonitorData.dateRange = document.getElementById('monitorDateRange').value;
            autoMonitorData.notifyBrowser = document.getElementById('monitorNotifyBrowser').checked;
            autoMonitorData.notifySound = document.getElementById('monitorNotifySound').checked;
            
            // 更新監控時間
            const times = [];
            if (document.getElementById('monitor08').checked) times.push('08:00');
            if (document.getElementById('monitor17').checked) times.push('17:00');
            autoMonitorData.times = times;
            
            // 儲存到 localStorage (將 Set 轉換為陣列)
            const dataToSave = {
                ...autoMonitorData,
                seenTenders: Array.from(autoMonitorData.seenTenders)
            };
            localStorage.setItem('autoMonitorData', JSON.stringify(dataToSave));
            
            showNotification('儲存成功', `已儲存 ${keywords.length} 個監控關鍵字`, 'success');
        }

        // 切換自動監控面板
        function toggleAutoMonitor() {
            const section = document.getElementById('autoMonitorSection');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                // 請求瀏覽器通知權限
                if (document.getElementById('monitorNotifyBrowser').checked && 'Notification' in window) {
                    Notification.requestPermission();
                }
            } else {
                section.style.display = 'none';
            }
        }

        // 啟動自動監控
        function startAutoMonitor() {
            // 先儲存設定
            saveMonitorSettings();
            
            if (autoMonitorData.keywords.length === 0) {
                showNotification('啟動失敗', '請先設定監控關鍵字', 'error');
                return;
            }
            
            if (autoMonitorData.times.length === 0) {
                showNotification('啟動失敗', '請至少選擇一個自動搜尋時間', 'error');
                return;
            }
            
            autoMonitorData.enabled = true;
            document.getElementById('monitorStatus').textContent = '運作中';
            document.getElementById('monitorStatus').className = 'badge bg-success ms-2';
            
            // 清除舊的定時器
            if (autoMonitorInterval) {
                clearInterval(autoMonitorInterval);
            }
            
            // 每分鐘檢查一次是否需要執行
            autoMonitorInterval = setInterval(checkAndExecuteMonitor, 60000);
            
            // 立即檢查一次
            checkAndExecuteMonitor();
            
            // 更新下次執行時間
            updateNextSearchTime();
            
            showNotification('監控已啟動', `已啟動自動監控，將在 ${autoMonitorData.times.join('、')} 自動搜尋`, 'success');
        }

        // 停止自動監控
        function stopAutoMonitor() {
            autoMonitorData.enabled = false;
            document.getElementById('monitorStatus').textContent = '已停用';
            document.getElementById('monitorStatus').className = 'badge bg-secondary ms-2';
            
            if (autoMonitorInterval) {
                clearInterval(autoMonitorInterval);
                autoMonitorInterval = null;
            }
            
            document.getElementById('nextAutoSearch').textContent = '未啟用';
            
            showNotification('監控已停止', '自動監控已停止', 'info');
        }

        // 檢查並執行監控
        function checkAndExecuteMonitor() {
            if (!autoMonitorData.enabled) return;
            
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            // 檢查是否為設定的執行時間
            if (autoMonitorData.times.includes(currentTime)) {
                executeAutoMonitor();
            }
            
            // 更新下次執行時間
            updateNextSearchTime();
        }

        // 執行自動監控搜尋
        async function executeAutoMonitor() {
            console.log('🤖 開始執行自動監控搜尋...');
            
            const keywords = autoMonitorData.keywords;
            let allResults = [];
            let newResults = [];
            
            // 設定日期範圍
            setDateRange(autoMonitorData.dateRange);
            
            try {
                // 逐一搜尋每個關鍵字
                for (const keyword of keywords) {
                    console.log(`🔍 搜尋關鍵字: ${keyword}`);
                    
                    // 設定搜尋條件
                    document.getElementById('titleQuery').value = keyword;
                    
                    // 執行搜尋（不顯示 UI）
                    const results = await searchAllData('title', keyword, 1);
                    
                    if (results && results.length > 0) {
                        // 檢查是否為新標案
                        for (const result of results) {
                            const tenderId = `${result.unit_id}_${result.job_number}_${result.date}`;
                            if (!autoMonitorData.seenTenders.has(tenderId)) {
                                autoMonitorData.seenTenders.add(tenderId);
                                newResults.push({ ...result, keyword });
                            }
                        }
                        allResults = allResults.concat(results);
                    }
                    
                    // 避免觸發速率限制，每個關鍵字之間間隔 1 秒
                    await new Promise(r => setTimeout(r, 1000));
                }
                
                // 更新統計
                autoMonitorData.todaySearchCount++;
                autoMonitorData.todayResultCount += allResults.length;
                autoMonitorData.todayNewCount += newResults.length;
                autoMonitorData.lastSearchTime = new Date().toISOString();
                
                // 記錄搜尋歷史
                autoMonitorData.searchHistory.push({
                    time: new Date().toISOString(),
                    keywords: keywords.length,
                    results: allResults.length,
                    newResults: newResults.length
                });
                
                // 只保留最近 30 筆記錄
                if (autoMonitorData.searchHistory.length > 30) {
                    autoMonitorData.searchHistory = autoMonitorData.searchHistory.slice(-30);
                }
                
                // 儲存資料
                const dataToSave = {
                    ...autoMonitorData,
                    seenTenders: Array.from(autoMonitorData.seenTenders)
                };
                localStorage.setItem('autoMonitorData', JSON.stringify(dataToSave));
                
                // 更新 UI 統計
                updateMonitorStats();
                
                // 發送通知
                if (newResults.length > 0) {
                    notifyNewTenders(newResults);
                }
                
                console.log(`✅ 監控搜尋完成: 找到 ${allResults.length} 筆結果，其中 ${newResults.length} 筆為新標案`);
                
            } catch (error) {
                console.error('自動監控搜尋錯誤:', error);
                showNotification('監控搜尋錯誤', error.message, 'error');
            }
        }

        // 立即測試監控
        async function testAutoMonitor() {
            if (autoMonitorData.keywords.length === 0) {
                showNotification('測試失敗', '請先設定監控關鍵字', 'error');
                return;
            }
            
            showNotification('開始測試', '正在執行測試搜尋...', 'info');
            await executeAutoMonitor();
            showNotification('測試完成', '測試搜尋已完成，請查看統計數據', 'success');
        }

        // 更新下次執行時間
        function updateNextSearchTime() {
            if (!autoMonitorData.enabled || autoMonitorData.times.length === 0) {
                document.getElementById('nextAutoSearch').textContent = '未啟用';
                return;
            }
            
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            let nextTime = null;
            let minDiff = Infinity;
            
            for (const time of autoMonitorData.times) {
                const [hours, minutes] = time.split(':').map(Number);
                const timeMinutes = hours * 60 + minutes;
                
                let diff = timeMinutes - currentMinutes;
                if (diff < 0) diff += 24 * 60; // 明天
                
                if (diff < minDiff) {
                    minDiff = diff;
                    nextTime = time;
                }
            }
            
            const nextDate = new Date(now);
            if (minDiff >= 24 * 60 - currentMinutes) {
                nextDate.setDate(nextDate.getDate() + 1);
            }
            
            const nextTimeStr = `${nextDate.getFullYear()}/${nextDate.getMonth()+1}/${nextDate.getDate()} ${nextTime}`;
            document.getElementById('nextAutoSearch').textContent = nextTimeStr;
        }

        // 更新監控統計
        function updateMonitorStats() {
            document.getElementById('monitorSearchCount').textContent = autoMonitorData.todaySearchCount;
            document.getElementById('monitorResultCount').textContent = autoMonitorData.todayResultCount;
            document.getElementById('monitorNewCount').textContent = autoMonitorData.todayNewCount;
            
            if (autoMonitorData.lastSearchTime) {
                const lastTime = new Date(autoMonitorData.lastSearchTime);
                document.getElementById('monitorLastTime').textContent = 
                    `${String(lastTime.getHours()).padStart(2, '0')}:${String(lastTime.getMinutes()).padStart(2, '0')}`;
            }
        }

        // 通知新標案
        function notifyNewTenders(newResults) {
            const count = newResults.length;
            const keywords = [...new Set(newResults.map(r => r.keyword))].join('、');
            
            // 聲音通知
            if (autoMonitorData.notifySound) {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi78OScTgwOUKfi8LZjHAY4kte2yn0sBSR3yPDekEAKFF607Oul');
                audio.play().catch(e => console.log('無法播放聲音:', e));
            }
            
            // 瀏覽器通知
            if (autoMonitorData.notifyBrowser && 'Notification' in window && Notification.permission === 'granted') {
                new Notification('🔔 發現新標案！', {
                    body: `找到 ${count} 筆新標案\n關鍵字：${keywords}`,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><text y="20" font-size="20">📋</text></svg>',
                    tag: 'auto-monitor',
                    requireInteraction: true
                });
            }
            
            // 頁面通知
            showNotification(
                '🎉 發現新標案！',
                `找到 ${count} 筆新標案<br>關鍵字：${keywords}<br><small>請查看搜尋結果</small>`,
                'success'
            );
        }

        // 顯示監控歷史
        function showMonitorHistory() {
            if (autoMonitorData.searchHistory.length === 0) {
                showNotification('無歷史記錄', '尚未有監控搜尋記錄', 'info');
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-striped table-sm"><thead><tr><th>時間</th><th>關鍵字數</th><th>找到標案</th><th>新標案</th></tr></thead><tbody>';
            
            autoMonitorData.searchHistory.slice().reverse().forEach(record => {
                const time = new Date(record.time);
                const timeStr = `${time.getMonth()+1}/${time.getDate()} ${String(time.getHours()).padStart(2,'0')}:${String(time.getMinutes()).padStart(2,'0')}`;
                html += `<tr>
                    <td>${timeStr}</td>
                    <td>${record.keywords}</td>
                    <td>${record.results}</td>
                    <td><strong class="text-success">${record.newResults}</strong></td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            
            showNotification('監控歷史記錄', html, 'info');
        }

        // 每天凌晨重置今日統計
        setInterval(() => {
            const now = new Date();
            if (now.getHours() === 0 && now.getMinutes() === 0) {
                autoMonitorData.todaySearchCount = 0;
                autoMonitorData.todayResultCount = 0;
                autoMonitorData.todayNewCount = 0;
                updateMonitorStats();
            }
        }, 60000);

        // 頁面載入時初始化監控設定
        document.addEventListener('DOMContentLoaded', function() {
            loadMonitorSettings();
        });

        // ==================== 自動監控功能結束 ====================

        // 判斷是否為決標公告（同時檢查 brief.type 與 detail 常見欄位）
        function isTenderAwarded(type, detail = {}) {
            const t = (type || '').toString();
            const candidates = [
                t,
                detail['標案類型'],
                detail['公告種類'],
                detail['公告類型'],
                detail['招標/決標類別'],
                detail['採購資料:公告種類'],
                detail['招標資料:公告種類'],
                detail['決標資料:公告種類']
            ].filter(Boolean).join(' ');
            return candidates.includes('決標公告') || candidates.includes('無法決標公告') || candidates.includes('決標');
        }

        // 獲取決標品項資訊
        function getAwardItems(detail) {
            if (!detail) return '';
            
            console.log('=== 分析決標品項資訊 ===');
            console.log('Detail keys:', Object.keys(detail).filter(k => k.includes('品項') || k.includes('決標') || k.includes('得標')));
            
            // 尋找決標品項相關欄位
            const awardItems = [];
            const itemCount = getAwardItemCount(detail);
            
            console.log('決標品項數:', itemCount);
            
            for (let i = 1; i <= itemCount; i++) {
                const item = extractAwardItem(detail, i);
                if (item) {
                    awardItems.push(item);
                    console.log(`第${i}品項:`, item);
                }
            }
            
            if (awardItems.length === 0) {
                return '<p class="mt-3 text-muted">無決標品項資料</p>';
            }
            
            let html = `
                <div class="mt-3">
                    <h6><i class="fas fa-box me-2"></i>決標品項資訊</h6>
                    <div class="alert alert-info">
                        <strong>決標品項數：</strong>${itemCount} 項
                    </div>
            `;
            
            awardItems.forEach((item, index) => {
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-cube me-2"></i>第${index + 1}品項</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr><td><strong>品項名稱</strong></td><td>${item.itemName || '無資料'}</td></tr>
                                        <tr><td><strong>是否以單價及預估需求數量之乘積決定最低標</strong></td><td>${item.isLowestBid || '無資料'}</td></tr>
                                        <tr><td><strong>預估需求數量</strong></td><td>${item.estimatedQuantity || '無資料'}</td></tr>
                                        <tr><td><strong>原產地國別</strong></td><td>${item.countryOfOrigin || '無資料'}</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr><td><strong>得標廠商</strong></td><td>${item.winningVendor || '無資料'}</td></tr>
                                        <tr><td><strong>得標廠商原始投標金額</strong></td><td>${item.originalBidAmount || '無資料'}</td></tr>
                                        <tr><td><strong>決標金額</strong></td><td>${item.awardAmount || '無資料'}</td></tr>
                                        <tr><td><strong>底價金額</strong></td><td>${item.reservePrice || '無資料'}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // 產生「查看決標品項」按鈕與可收合內容
        function renderAwardItemsSection(detail, jobNumber) {
            const base = (jobNumber || '').toString();
            const safeId = 'awardItems-' + (base.replace(/[^a-zA-Z0-9_-]/g, '') || ('x' + Date.now()));
            return `
                <div class="mt-3">
                    <button class="btn btn-outline-info btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#${safeId}" aria-expanded="false" aria-controls="${safeId}">
                        <i class="fas fa-box-open me-1"></i>查看決標品項
                    </button>
                    <div class="collapse mt-2" id="${safeId}">
                        ${getAwardItems(detail)}
                    </div>
                </div>
            `;
        }

        // 獲取決標品項數量
        function getAwardItemCount(detail) {
            const possibleKeys = [
                '決標品項:決標品項數',
                '決標品項數',
                '品項數',
                '決標:品項數'
            ];
            
            for (const key of possibleKeys) {
                if (detail[key]) {
                    const count = parseInt(detail[key]);
                    if (!isNaN(count) && count > 0) {
                        return count;
                    }
                }
            }
            
            // 如果沒找到明確的品項數，嘗試從品項名稱欄位推算
            let maxItem = 0;
            for (const key in detail) {
                if (key.includes('品項名稱') || key.includes('品項') && key.includes('名稱')) {
                    const match = key.match(/第(\d+)品項/);
                    if (match) {
                        const itemNum = parseInt(match[1]);
                        if (itemNum > maxItem) {
                            maxItem = itemNum;
                        }
                    }
                }
            }
            
            return maxItem > 0 ? maxItem : 1; // 預設至少1項
        }

        // 提取單一品項資訊
        function extractAwardItem(detail, itemIndex) {
            const item = {};
            
            // 品項名稱
            const nameKeys = [
                `決標品項:第${itemIndex}品項:品項名稱`,
                `第${itemIndex}品項:品項名稱`,
                `品項${itemIndex}:品項名稱`,
                `決標品項${itemIndex}:品項名稱`
            ];
            item.itemName = findFieldValue(detail, nameKeys);
            
            // 是否以單價及預估需求數量之乘積決定最低標
            const lowestBidKeys = [
                `決標品項:第${itemIndex}品項:是否以單價及預估需求數量之乘積決定最低標`,
                `第${itemIndex}品項:是否以單價及預估需求數量之乘積決定最低標`,
                `品項${itemIndex}:是否以單價及預估需求數量之乘積決定最低標`
            ];
            item.isLowestBid = findFieldValue(detail, lowestBidKeys);
            
            // 得標廠商
            const vendorKeys = [
                `決標品項:第${itemIndex}品項:得標廠商${itemIndex}`,
                `第${itemIndex}品項:得標廠商`,
                `品項${itemIndex}:得標廠商`,
                `得標廠商${itemIndex}:廠商名稱`
            ];
            item.winningVendor = findFieldValue(detail, vendorKeys);
            
            // 預估需求數量
            const quantityKeys = [
                `決標品項:第${itemIndex}品項:預估需求數量`,
                `第${itemIndex}品項:預估需求數量`,
                `品項${itemIndex}:預估需求數量`
            ];
            item.estimatedQuantity = findFieldValue(detail, quantityKeys);
            
            // 得標廠商原始投標金額（僅接受含數字的值）
            const originalBidKeys = [
                `決標品項:第${itemIndex}品項:得標廠商${itemIndex}:原始投標金額`,
                `第${itemIndex}品項:得標廠商:原始投標金額`,
                `品項${itemIndex}:得標廠商:原始投標金額`,
                `第${itemIndex}品項:原始投標金額`,
                `決標品項:第${itemIndex}品項:原始投標金額`,
                `品項${itemIndex}:原始投標金額`,
                `第${itemIndex}品項:投標金額`,
                `品項${itemIndex}:投標金額`
            ];
            item.originalBidAmount = findAmountValue(detail, originalBidKeys);
            
            // 決標金額（僅接受含數字的值）
            const awardAmountKeys = [
                `決標品項:第${itemIndex}品項:決標金額`,
                `第${itemIndex}品項:決標金額`,
                `品項${itemIndex}:決標金額`,
                `第${itemIndex}品項:得標金額`,
                `品項${itemIndex}:得標金額`
            ];
            item.awardAmount = findAmountValue(detail, awardAmountKeys);
            
            // 底價金額（僅接受含數字的值）
            const reservePriceKeys = [
                `決標品項:第${itemIndex}品項:底價金額`,
                `第${itemIndex}品項:底價金額`,
                `品項${itemIndex}:底價金額`,
                `第${itemIndex}品項:底價`,
                `品項${itemIndex}:底價`
            ];
            item.reservePrice = findAmountValue(detail, reservePriceKeys);
            
            // 原產地國別
            const countryKeys = [
                `決標品項:第${itemIndex}品項:原產地國別`,
                `第${itemIndex}品項:原產地國別`,
                `品項${itemIndex}:原產地國別`
            ];
            item.countryOfOrigin = findFieldValue(detail, countryKeys);
            
            // 檢查是否有任何有效資料
            const hasData = Object.values(item).some(value => value && value !== '無資料');
            return hasData ? item : null;
        }

        // 輔助函數：尋找欄位值
        function findFieldValue(detail, possibleKeys) {
            for (const key of possibleKeys) {
                if (detail[key] && detail[key] !== '' && detail[key] !== '無資料') {
                    return detail[key];
                }
            }
            
            // 模糊匹配
            for (const key in detail) {
                if (possibleKeys.some(possibleKey => key.includes(possibleKey.split(':').pop()))) {
                    if (detail[key] && detail[key] !== '' && detail[key] !== '無資料') {
                        return detail[key];
                    }
                }
            }
            
            return '無資料';
        }

        // 解析金額：只回傳含數字的欄位，過濾「是/否/無資料」等非金額值
        function parseAmountToText(value) {
            if (value == null) return '';
            const text = value.toString();
            // 過濾常見非金額字樣
            if (['是','否','無','無資料','不適用','N/A'].some(w => text === w || text.includes(w))) {
                return '';
            }
            const match = text.match(/[\d,\.]+/);
            if (!match) return '';
            // 僅取整數金額（去除逗點）
            const num = parseInt(match[0].replace(/[,\.]/g, ''));
            if (isNaN(num) || num <= 0) return '';
            return num.toLocaleString() + ' 元';
        }

        // 從多個鍵中找到第一個有效金額並格式化
        function findAmountValue(detail, possibleKeys) {
            for (const key of possibleKeys) {
                if (detail[key] != null) {
                    const formatted = parseAmountToText(detail[key]);
                    if (formatted) return formatted;
                }
            }
            // 嘗試模糊匹配
            for (const key in detail) {
                if (possibleKeys.some(possibleKey => key.includes(possibleKey.split(':').pop()))) {
                    const formatted = parseAmountToText(detail[key]);
                    if (formatted) return formatted;
                }
            }
            return '無資料';
        }

        // 獲取決標資訊（替代招標資訊）
        function getAwardInfo(detail) {
            if (!detail) return '<p class="mt-3 text-muted">無決標資訊</p>';
            
            console.log('=== 分析決標資訊 ===');
            console.log('Detail keys:', Object.keys(detail).filter(k => k.includes('決標') || k.includes('得標')));
            
            return `
                <h6 class="mt-3"><i class="fas fa-trophy me-2"></i>決標資訊</h6>
                <table class="table table-sm">
                    <tr><td><strong>決標方式</strong></td><td>${getTenderField(detail, '決標方式')}</td></tr>
                    <tr><td><strong>決標日期</strong></td><td>${getTenderField(detail, '決標日期')}</td></tr>
                    <tr><td><strong>決標金額</strong></td><td>${getTenderField(detail, '決標金額')}</td></tr>
                    <tr><td><strong>底價金額</strong></td><td>${getTenderField(detail, '底價金額')}</td></tr>
                    <tr><td><strong>得標廠商</strong></td><td>${getTenderField(detail, '得標廠商')}</td></tr>
                    <tr><td><strong>決標原因</strong></td><td>${getTenderField(detail, '決標原因')}</td></tr>
                </table>
            `;
        }

        // 獲取招標資訊（僅用於非決標公告）
        function getTenderInfo(detail) {
            if (!detail) return '<p class="mt-3 text-muted">無招標資訊</p>';
            
            return `
                <h6 class="mt-3"><i class="fas fa-clipboard-list me-2"></i>招標資訊</h6>
                <table class="table table-sm">
                    <tr><td><strong>招標方式</strong></td><td>${getTenderField(detail, '招標方式')}</td></tr>
                    <tr><td><strong>決標方式</strong></td><td>${getTenderField(detail, '決標方式')}</td></tr>
                    <tr><td><strong>開標時間</strong></td><td>${getTenderField(detail, '開標時間')}</td></tr>
                    <tr><td><strong>開標地點</strong></td><td>${getTenderField(detail, '開標地點')}</td></tr>
                    <tr><td><strong>截止投標</strong></td><td>${getTenderField(detail, '截止投標')}</td></tr>
                    <tr><td><strong>押標金</strong></td><td>${getTenderField(detail, '押標金')}</td></tr>
                </table>
            `;
        }

        // 智能獲取招標資訊欄位
        function getTenderField(detail, infoType) {
            if (!detail) return '無資料';
            
            // 定義各種可能的欄位名稱
            const fieldMappings = {
                '招標方式': [
                    '招標資料:招標方式',
                    '招標方式',
                    '採購資料:招標方式',
                    '招標:招標方式'
                ],
                '決標方式': [
                    '招標資料:決標方式',
                    '決標方式',
                    '採購資料:決標方式',
                    '決標:決標方式',
                    '決標資料:決標方式'
                ],
                '決標日期': [
                    '決標資料:決標日期',
                    '決標日期',
                    '決標:決標日期',
                    '日期:決標日期'
                ],
                '決標金額': [
                    '決標資料:決標金額',
                    '決標金額',
                    '決標:決標金額',
                    '金額:決標金額',
                    '決標資料:總決標金額'
                ],
                '底價金額': [
                    '決標資料:底價金額',
                    '底價金額',
                    '決標:底價金額',
                    '金額:底價金額'
                ],
                '得標廠商': [
                    '決標資料:得標廠商',
                    '得標廠商',
                    '決標:得標廠商',
                    '廠商:得標廠商',
                    '得標廠商:廠商名稱'
                ],
                '決標原因': [
                    '決標資料:決標原因',
                    '決標原因',
                    '決標:決標原因',
                    '原因:決標原因'
                ],
                '開標時間': [
                    '領投開標:開標時間',
                    '開標時間',
                    '開標:開標時間',
                    '時間:開標時間'
                ],
                '開標地點': [
                    '領投開標:開標地點',
                    '開標地點',
                    '開標:開標地點',
                    '地點:開標地點'
                ],
                '截止投標': [
                    '領投開標:截止投標',
                    '截止投標',
                    '投標:截止投標',
                    '時間:截止投標'
                ],
                '押標金': [
                    '領投開標:是否須繳納押標金:押標金額度',
                    '押標金',
                    '押標金額度',
                    '投標:押標金'
                ]
            };
            
            const possibleFields = fieldMappings[infoType] || [];
            
            // 嘗試各種欄位名稱
            for (const field of possibleFields) {
                if (detail[field] && detail[field] !== '' && detail[field] !== '無資料') {
                    return detail[field];
                }
            }
            
            // 如果沒找到，嘗試模糊匹配
            for (const key in detail) {
                if (key.includes(infoType) && detail[key] && detail[key] !== '' && detail[key] !== '無資料') {
                    return detail[key];
                }
            }
            
            return '無資料';
        }
    </script>
</body>
</html>
