<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AD14E05A 標案測試</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .api-response {
            background-color: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 1rem;
            margin: 1rem 0;
        }
        .detection-log {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fas fa-search me-2"></i>AD14E05A 標案測試
        </h1>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle me-2"></i>標案資訊</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>標案編號：</strong>AD14E05A</p>
                        <p><strong>標案名稱：</strong>PD-L1檢測免疫染色試劑(含一級抗體)附儀器等2項開口合約</p>
                        <p><strong>機關：</strong>國立臺灣大學醫學院附設醫院癌醫中心分院</p>
                        <p><strong>機關代碼：</strong>A.9.51.1.9</p>
                        <p><strong>決標日期：</strong>2025年10月22日</p>
                        <p><strong>得標廠商：</strong>成信新貿易股份有限公司</p>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs me-2"></i>測試控制</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testAD14E05A()">
                            <i class="fas fa-play me-2"></i>測試 AD14E05A 標案
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="clearResults()">
                            <i class="fas fa-trash me-2"></i>清除結果
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="testResults" class="mt-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function testAD14E05A() {
            const resultsDiv = document.getElementById('testResults');
            
            resultsDiv.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>AD14E05A 標案測試結果</h5>
                    </div>
                    <div class="card-body">
                        <div class="detection-log">
                            <h6>🔍 測試過程：</h6>
                            <div id="detectionLog"></div>
                        </div>
                        <div class="api-response">
                            <h6>📊 測試結果：</h6>
                            <div id="detectionResult"></div>
                        </div>
                    </div>
                </div>
            `;

            // 清空 console 並重新導向到頁面
            console.clear();
            const originalLog = console.log;
            const logContainer = document.getElementById('detectionLog');
            console.log = function(...args) {
                originalLog.apply(console, args);
                logContainer.innerHTML += args.join(' ') + '<br>';
            };

            try {
                console.log('開始測試 AD14E05A 標案...');
                
                // 搜尋策略
                const searchStrategies = [
                    { name: 'AD14E05A 案號搜尋', url: 'https://pcc-api.openfun.app/api/searchbytitle?query=AD14E05A&page=1' },
                    { name: 'PD-L1檢測搜尋', url: 'https://pcc-api.openfun.app/api/searchbytitle?query=PD-L1檢測免疫染色試劑&page=1' },
                    { name: '成信新貿易搜尋', url: 'https://pcc-api.openfun.app/api/searchbycompanyname?query=成信新貿易&page=1' },
                    { name: '台大醫院癌醫中心搜尋', url: 'https://pcc-api.openfun.app/api/searchbytitle?query=國立臺灣大學醫學院附設醫院癌醫中心分院&page=1' }
                ];
                
                let foundRecord = null;
                let searchStrategy = '';
                
                for (const strategy of searchStrategies) {
                    console.log(`\n=== ${strategy.name} ===`);
                    console.log('搜尋 URL:', strategy.url);
                    
                    try {
                        const searchResponse = await fetch(strategy.url);
                        const searchData = await searchResponse.json();
                        
                        console.log('搜尋結果:', searchData);
                        
                        if (searchData && searchData.length > 0) {
                            console.log(`搜尋到 ${searchData.length} 筆結果`);
                            
                            // 尋找相關案件
                            const relevantRecord = searchData.find(record => {
                                const title = record.brief?.title || '';
                                const jobNumber = record.job_number || '';
                                const unitName = record.unit_name || '';
                                
                                console.log(`檢查案件: ${title} | ${jobNumber} | ${unitName}`);
                                
                                return (
                                    title.includes('PD-L1') ||
                                    title.includes('免疫染色試劑') ||
                                    jobNumber.includes('AD14E05A') ||
                                    unitName.includes('台大醫院') ||
                                    unitName.includes('癌醫中心')
                                );
                            });
                            
                            if (relevantRecord) {
                                foundRecord = relevantRecord;
                                searchStrategy = strategy.name;
                                console.log('✓ 找到相關案件:', relevantRecord);
                                break;
                            } else {
                                console.log('✗ 此搜尋策略未找到相關案件');
                                console.log('前3筆結果:', searchData.slice(0, 3).map(r => ({
                                    title: r.brief?.title,
                                    job_number: r.job_number,
                                    unit_name: r.unit_name
                                })));
                            }
                        } else {
                            console.log('✗ 此搜尋策略無結果');
                        }
                    } catch (error) {
                        console.log('✗ 此搜尋策略失敗:', error.message);
                    }
                }
                
                if (foundRecord) {
                    console.log(`\n=== 使用 ${searchStrategy} 找到案件 ===`);
                    
                    // 獲取詳細資料
                    let detailData = null;
                    
                    if (foundRecord.detail && Object.keys(foundRecord.detail).length > 0) {
                        console.log('使用 record 中現有的 detail 資料');
                        detailData = foundRecord.detail;
                    } else {
                        console.log('使用傳統方式獲取詳細資料');
                        const detailUrl = `https://pcc-api.openfun.app/api/tender?unit_id=${foundRecord.unit_id}&job_number=${foundRecord.job_number}`;
                        console.log('詳細資料 URL:', detailUrl);
                        
                        const detailResponse = await fetch(detailUrl);
                        detailData = await detailResponse.json();
                    }
                    
                    console.log('詳細資料:', detailData);
                    
                    // 分析資料結構
                    console.log('\n=== 資料結構分析 ===');
                    console.log('Detail keys:', Object.keys(detailData || {}));
                    console.log('金額相關欄位:', Object.keys(detailData || {}).filter(k => k.includes('金額') || k.includes('決標')));
                    console.log('廠商相關欄位:', Object.keys(detailData || {}).filter(k => k.includes('廠商') || k.includes('投標')));
                    
                    // 顯示結果
                    const resultContainer = document.getElementById('detectionResult');
                    resultContainer.innerHTML = `
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>標案資訊</h6>
                            <p><strong>搜尋策略：</strong>${searchStrategy}</p>
                            <p><strong>標題：</strong>${foundRecord.brief?.title || '無標題'}</p>
                            <p><strong>案號：</strong>${foundRecord.job_number}</p>
                            <p><strong>機關：</strong>${foundRecord.unit_name}</p>
                            <p><strong>日期：</strong>${foundRecord.date}</p>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Detail 欄位列表：</h6>
                            <div class="code-block">${JSON.stringify(detailData, null, 2)}</div>
                        </div>
                    `;
                } else {
                    console.log('未找到 AD14E05A 相關案件');
                    document.getElementById('detectionResult').innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>未找到案件</h6>
                            <p>無法找到 AD14E05A 標案的相關資料。</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('測試過程中發生錯誤:', error);
                document.getElementById('detectionResult').innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>測試失敗</h6>
                        <p>錯誤訊息: ${error.message}</p>
                    </div>
                `;
            }

            // 恢復原始 console.log
            console.log = originalLog;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }
    </script>
</body>
</html>
