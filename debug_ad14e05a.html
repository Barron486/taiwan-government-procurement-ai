<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AD14E05A æ¨™æ¡ˆæ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .api-response {
            background-color: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 1rem;
            margin: 1rem 0;
        }
        .detection-log {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fas fa-search me-2"></i>AD14E05A æ¨™æ¡ˆæ¸¬è©¦
        </h1>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle me-2"></i>æ¨™æ¡ˆè³‡è¨Š</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>æ¨™æ¡ˆç·¨è™Ÿï¼š</strong>AD14E05A</p>
                        <p><strong>æ¨™æ¡ˆåç¨±ï¼š</strong>PD-L1æª¢æ¸¬å…ç–«æŸ“è‰²è©¦åŠ‘(å«ä¸€ç´šæŠ—é«”)é™„å„€å™¨ç­‰2é …é–‹å£åˆç´„</p>
                        <p><strong>æ©Ÿé—œï¼š</strong>åœ‹ç«‹è‡ºç£å¤§å­¸é†«å­¸é™¢é™„è¨­é†«é™¢ç™Œé†«ä¸­å¿ƒåˆ†é™¢</p>
                        <p><strong>æ©Ÿé—œä»£ç¢¼ï¼š</strong>A.9.51.1.9</p>
                        <p><strong>æ±ºæ¨™æ—¥æœŸï¼š</strong>2025å¹´10æœˆ22æ—¥</p>
                        <p><strong>å¾—æ¨™å» å•†ï¼š</strong>æˆä¿¡æ–°è²¿æ˜“è‚¡ä»½æœ‰é™å…¬å¸</p>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs me-2"></i>æ¸¬è©¦æ§åˆ¶</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testAD14E05A()">
                            <i class="fas fa-play me-2"></i>æ¸¬è©¦ AD14E05A æ¨™æ¡ˆ
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="clearResults()">
                            <i class="fas fa-trash me-2"></i>æ¸…é™¤çµæœ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="testResults" class="mt-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function testAD14E05A() {
            const resultsDiv = document.getElementById('testResults');
            
            resultsDiv.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>AD14E05A æ¨™æ¡ˆæ¸¬è©¦çµæœ</h5>
                    </div>
                    <div class="card-body">
                        <div class="detection-log">
                            <h6>ğŸ” æ¸¬è©¦éç¨‹ï¼š</h6>
                            <div id="detectionLog"></div>
                        </div>
                        <div class="api-response">
                            <h6>ğŸ“Š æ¸¬è©¦çµæœï¼š</h6>
                            <div id="detectionResult"></div>
                        </div>
                    </div>
                </div>
            `;

            // æ¸…ç©º console ä¸¦é‡æ–°å°å‘åˆ°é é¢
            console.clear();
            const originalLog = console.log;
            const logContainer = document.getElementById('detectionLog');
            console.log = function(...args) {
                originalLog.apply(console, args);
                logContainer.innerHTML += args.join(' ') + '<br>';
            };

            try {
                console.log('é–‹å§‹æ¸¬è©¦ AD14E05A æ¨™æ¡ˆ...');
                
                // æœå°‹ç­–ç•¥
                const searchStrategies = [
                    { name: 'AD14E05A æ¡ˆè™Ÿæœå°‹', url: 'https://pcc-api.openfun.app/api/searchbytitle?query=AD14E05A&page=1' },
                    { name: 'PD-L1æª¢æ¸¬æœå°‹', url: 'https://pcc-api.openfun.app/api/searchbytitle?query=PD-L1æª¢æ¸¬å…ç–«æŸ“è‰²è©¦åŠ‘&page=1' },
                    { name: 'æˆä¿¡æ–°è²¿æ˜“æœå°‹', url: 'https://pcc-api.openfun.app/api/searchbycompanyname?query=æˆä¿¡æ–°è²¿æ˜“&page=1' },
                    { name: 'å°å¤§é†«é™¢ç™Œé†«ä¸­å¿ƒæœå°‹', url: 'https://pcc-api.openfun.app/api/searchbytitle?query=åœ‹ç«‹è‡ºç£å¤§å­¸é†«å­¸é™¢é™„è¨­é†«é™¢ç™Œé†«ä¸­å¿ƒåˆ†é™¢&page=1' }
                ];
                
                let foundRecord = null;
                let searchStrategy = '';
                
                for (const strategy of searchStrategies) {
                    console.log(`\n=== ${strategy.name} ===`);
                    console.log('æœå°‹ URL:', strategy.url);
                    
                    try {
                        const searchResponse = await fetch(strategy.url);
                        const searchData = await searchResponse.json();
                        
                        console.log('æœå°‹çµæœ:', searchData);
                        
                        if (searchData && searchData.length > 0) {
                            console.log(`æœå°‹åˆ° ${searchData.length} ç­†çµæœ`);
                            
                            // å°‹æ‰¾ç›¸é—œæ¡ˆä»¶
                            const relevantRecord = searchData.find(record => {
                                const title = record.brief?.title || '';
                                const jobNumber = record.job_number || '';
                                const unitName = record.unit_name || '';
                                
                                console.log(`æª¢æŸ¥æ¡ˆä»¶: ${title} | ${jobNumber} | ${unitName}`);
                                
                                return (
                                    title.includes('PD-L1') ||
                                    title.includes('å…ç–«æŸ“è‰²è©¦åŠ‘') ||
                                    jobNumber.includes('AD14E05A') ||
                                    unitName.includes('å°å¤§é†«é™¢') ||
                                    unitName.includes('ç™Œé†«ä¸­å¿ƒ')
                                );
                            });
                            
                            if (relevantRecord) {
                                foundRecord = relevantRecord;
                                searchStrategy = strategy.name;
                                console.log('âœ“ æ‰¾åˆ°ç›¸é—œæ¡ˆä»¶:', relevantRecord);
                                break;
                            } else {
                                console.log('âœ— æ­¤æœå°‹ç­–ç•¥æœªæ‰¾åˆ°ç›¸é—œæ¡ˆä»¶');
                                console.log('å‰3ç­†çµæœ:', searchData.slice(0, 3).map(r => ({
                                    title: r.brief?.title,
                                    job_number: r.job_number,
                                    unit_name: r.unit_name
                                })));
                            }
                        } else {
                            console.log('âœ— æ­¤æœå°‹ç­–ç•¥ç„¡çµæœ');
                        }
                    } catch (error) {
                        console.log('âœ— æ­¤æœå°‹ç­–ç•¥å¤±æ•—:', error.message);
                    }
                }
                
                if (foundRecord) {
                    console.log(`\n=== ä½¿ç”¨ ${searchStrategy} æ‰¾åˆ°æ¡ˆä»¶ ===`);
                    
                    // ç²å–è©³ç´°è³‡æ–™
                    let detailData = null;
                    
                    if (foundRecord.detail && Object.keys(foundRecord.detail).length > 0) {
                        console.log('ä½¿ç”¨ record ä¸­ç¾æœ‰çš„ detail è³‡æ–™');
                        detailData = foundRecord.detail;
                    } else {
                        console.log('ä½¿ç”¨å‚³çµ±æ–¹å¼ç²å–è©³ç´°è³‡æ–™');
                        const detailUrl = `https://pcc-api.openfun.app/api/tender?unit_id=${foundRecord.unit_id}&job_number=${foundRecord.job_number}`;
                        console.log('è©³ç´°è³‡æ–™ URL:', detailUrl);
                        
                        const detailResponse = await fetch(detailUrl);
                        detailData = await detailResponse.json();
                    }
                    
                    console.log('è©³ç´°è³‡æ–™:', detailData);
                    
                    // åˆ†æè³‡æ–™çµæ§‹
                    console.log('\n=== è³‡æ–™çµæ§‹åˆ†æ ===');
                    console.log('Detail keys:', Object.keys(detailData || {}));
                    console.log('é‡‘é¡ç›¸é—œæ¬„ä½:', Object.keys(detailData || {}).filter(k => k.includes('é‡‘é¡') || k.includes('æ±ºæ¨™')));
                    console.log('å» å•†ç›¸é—œæ¬„ä½:', Object.keys(detailData || {}).filter(k => k.includes('å» å•†') || k.includes('æŠ•æ¨™')));
                    
                    // é¡¯ç¤ºçµæœ
                    const resultContainer = document.getElementById('detectionResult');
                    resultContainer.innerHTML = `
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>æ¨™æ¡ˆè³‡è¨Š</h6>
                            <p><strong>æœå°‹ç­–ç•¥ï¼š</strong>${searchStrategy}</p>
                            <p><strong>æ¨™é¡Œï¼š</strong>${foundRecord.brief?.title || 'ç„¡æ¨™é¡Œ'}</p>
                            <p><strong>æ¡ˆè™Ÿï¼š</strong>${foundRecord.job_number}</p>
                            <p><strong>æ©Ÿé—œï¼š</strong>${foundRecord.unit_name}</p>
                            <p><strong>æ—¥æœŸï¼š</strong>${foundRecord.date}</p>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Detail æ¬„ä½åˆ—è¡¨ï¼š</h6>
                            <div class="code-block">${JSON.stringify(detailData, null, 2)}</div>
                        </div>
                    `;
                } else {
                    console.log('æœªæ‰¾åˆ° AD14E05A ç›¸é—œæ¡ˆä»¶');
                    document.getElementById('detectionResult').innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>æœªæ‰¾åˆ°æ¡ˆä»¶</h6>
                            <p>ç„¡æ³•æ‰¾åˆ° AD14E05A æ¨™æ¡ˆçš„ç›¸é—œè³‡æ–™ã€‚</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
                document.getElementById('detectionResult').innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>æ¸¬è©¦å¤±æ•—</h6>
                        <p>éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
                    </div>
                `;
            }

            // æ¢å¾©åŸå§‹ console.log
            console.log = originalLog;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }
    </script>
</body>
</html>
