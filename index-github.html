<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£æ”¿åºœæ¡è³¼å…¬å‘ŠæŸ¥è©¢ç³»çµ± - AI æ™ºèƒ½åˆ†æç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', sans-serif;
        }
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 30px;
        }
        .search-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        .result-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        .loading-spinner {
            display: none;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <div class="search-header">
                <h1><i class="fas fa-search me-3"></i>å°ç£æ”¿åºœæ¡è³¼å…¬å‘ŠæŸ¥è©¢ç³»çµ±</h1>
                <p class="mb-0">AI æ™ºèƒ½åˆ†æç‰ˆ - GitHub Pages ç‰ˆæœ¬</p>
                <small class="text-light">æ³¨æ„ï¼šæ­¤ç‰ˆæœ¬ä½¿ç”¨ç›´æ¥ API å‘¼å«ï¼Œå¯èƒ½å—åˆ° CORS é™åˆ¶</small>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-search me-2"></i>æœå°‹æ¨™æ¡ˆ</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="searchQuery" class="form-label">é—œéµå­—</label>
                                <input type="text" class="form-control" id="searchQuery" placeholder="è¼¸å…¥æ¨™æ¡ˆé—œéµå­—...">
                            </div>
                            <div class="mb-3">
                                <label for="geminiKey" class="form-label">Gemini API Keyï¼ˆé¸å¡«ï¼‰</label>
                                <input type="password" class="form-control" id="geminiKey" placeholder="è¼¸å…¥æ‚¨çš„ Gemini API Key ä»¥å•Ÿç”¨ AI åˆ†æ">
                                <div class="form-text">ç•™ç©ºå°‡è·³é AI åˆ†æåŠŸèƒ½</div>
                            </div>
                            <button class="btn btn-primary" onclick="performSearch()">
                                <i class="fas fa-search me-2"></i>é–‹å§‹æœå°‹
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-info-circle me-2"></i>ä½¿ç”¨èªªæ˜</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>æœå°‹æ”¿åºœæ¡è³¼æ¨™æ¡ˆ</li>
                                <li><i class="fas fa-check text-success me-2"></i>æŸ¥çœ‹æ¨™æ¡ˆè©³ç´°è³‡è¨Š</li>
                                <li><i class="fas fa-check text-success me-2"></i>AI æ™ºèƒ½åˆ†æï¼ˆéœ€ API Keyï¼‰</li>
                                <li><i class="fas fa-check text-success me-2"></i>åˆ†äº«æ¨™æ¡ˆè³‡è¨Š</li>
                            </ul>
                            <div class="alert alert-warning">
                                <small>
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    <strong>GitHub Pages ç‰ˆæœ¬é™åˆ¶ï¼š</strong><br>
                                    â€¢ å¯èƒ½å—åˆ° CORS é™åˆ¶<br>
                                    â€¢ å»ºè­°ä½¿ç”¨ Vercel ç‰ˆæœ¬ä»¥ç²å¾—æœ€ä½³é«”é©—
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="loadingSection" class="text-center mt-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                </div>
                <p class="mt-2">æ­£åœ¨æœå°‹æ¨™æ¡ˆï¼Œè«‹ç¨å€™...</p>
            </div>

            <div id="resultsSection" style="display: none;">
                <h3 class="mt-4 mb-3">æœå°‹çµæœ</h3>
                <div id="searchResults"></div>
            </div>

            <div id="aiAnalysisSection" style="display: none;">
                <h3 class="mt-4 mb-3">AI æ™ºèƒ½åˆ†æ</h3>
                <div id="aiAnalysis"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // GitHub Pages ç‰ˆæœ¬ - ç›´æ¥ä½¿ç”¨ APIï¼ˆå¯èƒ½å— CORS é™åˆ¶ï¼‰
        const API_BASES = [
            'https://pcc-api.openfun.app/api',
            'https://pcc.g0v.ronny.tw/api'
        ];

        console.log('ğŸ”§ GitHub Pages æ¨¡å¼ï¼šç›´æ¥ API å‘¼å«ï¼ˆå¯èƒ½å— CORS é™åˆ¶ï¼‰');

        // ç°¡åŒ–çš„ API è«‹æ±‚å‡½å¼
        async function fetchFromApis(path, options = {}, timeoutMs = 10000, retriesPerBase = 1) {
            let lastError = null;
            const tried = [];
            
            for (const base of API_BASES) {
                for (let attempt = 1; attempt <= retriesPerBase; attempt++) {
                    const url = `${base}${path}`;
                    tried.push(url);
                    
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
                        
                        const resp = await fetch(url, { 
                            ...options, 
                            signal: controller.signal 
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!resp.ok) {
                            const errorText = await resp.text();
                            throw new Error(`HTTP ${resp.status}: ${resp.statusText} - ${errorText}`);
                        }
                        
                        return { resp, url };
                    } catch (err) {
                        lastError = err;
                        console.warn(`API è«‹æ±‚å¤±æ•— (ä¾†æº: ${base}, å˜—è©¦ ${attempt}/${retriesPerBase}): ${err.message}`);
                        
                        if (attempt < retriesPerBase) {
                            await new Promise(r => setTimeout(r, attempt * 800));
                        }
                    }
                }
            }
            
            const errorMessage = `æ‰€æœ‰ API ä¾†æºå‡å¤±æ•—ã€‚æœ€å¾ŒéŒ¯èª¤: ${lastError?.message || 'æœªçŸ¥éŒ¯èª¤'}. å·²å˜—è©¦ä¾†æº: ${tried.join(' , ')}`;
            throw new Error(errorMessage);
        }

        // åŸ·è¡Œæœå°‹
        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const geminiKey = document.getElementById('geminiKey').value.trim();
            
            if (!query) {
                alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('aiAnalysisSection').style.display = 'none';

            try {
                // æœå°‹æ¨™æ¡ˆ
                const { resp } = await fetchFromApis(`/searchbytitle?query=${encodeURIComponent(query)}&page=1`);
                const data = await resp.json();
                
                if (data && data.length > 0) {
                    displayResults(data);
                    
                    // å¦‚æœæœ‰ Gemini API Keyï¼ŒåŸ·è¡Œ AI åˆ†æ
                    if (geminiKey) {
                        await performAIAnalysis(query, geminiKey, data);
                    }
                } else {
                    showMessage('æœªæ‰¾åˆ°ç›¸é—œæ¨™æ¡ˆ', 'warning');
                }
            } catch (error) {
                console.error('æœå°‹éŒ¯èª¤:', error);
                showMessage(`æœå°‹å¤±æ•—ï¼š${error.message}`, 'error');
            } finally {
                document.getElementById('loadingSection').style.display = 'none';
            }
        }

        // é¡¯ç¤ºæœå°‹çµæœ
        function displayResults(results) {
            const resultsHtml = results.slice(0, 10).map((record, index) => {
                const brief = record.brief || {};
                const detail = record.detail || {};
                
                return `
                    <div class="card result-card">
                        <div class="card-body">
                            <h6 class="card-title">${brief.title || 'ç„¡æ¨™é¡Œ'}</h6>
                            <p class="card-text text-muted">
                                <i class="fas fa-hashtag me-1"></i>æ¡ˆè™Ÿ: ${record.job_number || 'æœªçŸ¥'} | 
                                <i class="fas fa-calendar me-1"></i>æ—¥æœŸ: ${record.date || 'æœªçŸ¥'} | 
                                <i class="fas fa-building me-1"></i>æ©Ÿé—œ: ${record.unit_name || 'æœªçŸ¥'}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge ${brief.type && brief.type.includes('æ±ºæ¨™') ? 'bg-danger' : 'bg-primary'}">${brief.type || 'æœªçŸ¥é¡å‹'}</span>
                                <button class="btn btn-outline-primary btn-sm" onclick="showDetail('${record.unit_id}', '${record.job_number}')">
                                    <i class="fas fa-eye me-1"></i>æŸ¥çœ‹è©³æƒ…
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('searchResults').innerHTML = resultsHtml;
            document.getElementById('resultsSection').style.display = 'block';
        }

        // é¡¯ç¤ºæ¨™æ¡ˆè©³æƒ…
        async function showDetail(unitId, jobNumber) {
            try {
                const { resp } = await fetchFromApis(`/tender?unit_id=${unitId}&job_number=${jobNumber}`);
                const detail = await resp.json();
                
                // é€™è£¡å¯ä»¥å¯¦ä½œè©³æƒ…é¡¯ç¤ºé‚è¼¯
                alert(`æ¨™æ¡ˆè©³æƒ…ï¼š${JSON.stringify(detail, null, 2)}`);
            } catch (error) {
                console.error('è¼‰å…¥è©³æƒ…éŒ¯èª¤:', error);
                alert(`è¼‰å…¥è©³æƒ…å¤±æ•—ï¼š${error.message}`);
            }
        }

        // AI åˆ†æ
        async function performAIAnalysis(query, geminiKey, results) {
            try {
                const analysisPrompt = `è«‹åˆ†æä»¥ä¸‹æ”¿åºœæ¡è³¼æ¨™æ¡ˆæœå°‹çµæœï¼Œæä¾›å°ˆæ¥­çš„å¸‚å ´æ´å¯Ÿå’Œå»ºè­°ï¼š

æœå°‹é—œéµå­—ï¼š${query}
æ¨™æ¡ˆæ•¸é‡ï¼š${results.length}

è«‹æä¾›ï¼š
1. å¸‚å ´è¶¨å‹¢åˆ†æ
2. æ¨™æ¡ˆé¡å‹åˆ†å¸ƒ
3. æ©Ÿé—œæ¡è³¼æ¨¡å¼
4. æŠ•æ¨™å»ºè­°

è«‹ç”¨ç¹é«”ä¸­æ–‡å›ç­”ï¼Œä¸¦ä¿æŒå°ˆæ¥­å’Œå®¢è§€çš„èªèª¿ã€‚`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: analysisPrompt
                            }]
                        }]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const analysis = data.candidates[0].content.parts[0].text;
                    
                    document.getElementById('aiAnalysis').innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <h6><i class="fas fa-robot me-2"></i>AI æ™ºèƒ½åˆ†æ</h6>
                                <div class="analysis-content">${analysis.replace(/\n/g, '<br>')}</div>
                            </div>
                        </div>
                    `;
                    document.getElementById('aiAnalysisSection').style.display = 'block';
                } else {
                    throw new Error('AI åˆ†æè«‹æ±‚å¤±æ•—');
                }
            } catch (error) {
                console.error('AI åˆ†æéŒ¯èª¤:', error);
                showMessage(`AI åˆ†æå¤±æ•—ï¼š${error.message}`, 'warning');
            }
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type) {
            const alertClass = type === 'error' ? 'error-message' : 
                              type === 'warning' ? 'alert-warning' : 'success-message';
            
            const messageHtml = `
                <div class="${alertClass}">
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 
                                       type === 'warning' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
                    ${message}
                </div>
            `;
            
            document.getElementById('resultsSection').innerHTML = messageHtml;
            document.getElementById('resultsSection').style.display = 'block';
        }
    </script>
</body>
</html>
