<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>複數廠商得標檢測測試</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .api-response {
            background-color: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 1rem;
            margin: 1rem 0;
        }
        .detection-log {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fas fa-search me-2"></i>複數廠商得標檢測測試
        </h1>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs me-2"></i>檢測邏輯說明</h5>
                    </div>
                    <div class="card-body">
                        <h6>1. 搜尋投標廠商欄位</h6>
                        <div class="code-block">// 搜尋包含 "投標廠商:投標廠商" 和 ":廠商名稱" 的欄位
for (const key in detail) {
    if (key.includes('投標廠商:投標廠商') && key.includes(':廠商名稱')) {
        // 提取廠商資訊
    }
}</div>

                        <h6>2. 提取決標金額</h6>
                        <div class="code-block">// 嘗試多種金額欄位格式
const possibleAmountKeys = [
    `投標廠商:投標廠商${vendorIndex}:決標金額`,
    `投標廠商:投標廠商${vendorIndex}:得標金額`,
    `決標資料:決標廠商${vendorIndex}:決標金額`,
    `決標資料:決標廠商${vendorIndex}:得標金額`
];</div>

                        <h6>3. 判斷複數廠商</h6>
                        <div class="code-block">// 如果找到超過1家有決標金額的廠商
if (allVendors.length > 1) {
    return {
        isMultiple: true,
        allVendors: allVendors,
        targetCompanyAwards: targetCompanyAwards,
        totalTargetAmount: totalTargetAmount
    };
}</div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-database me-2"></i>API 資料結構</h5>
                    </div>
                    <div class="card-body">
                        <h6>政府採購 API 回傳的 detail 欄位範例：</h6>
                        <div class="code-block">{
  "投標廠商:投標廠商1:廠商名稱": "台積電股份有限公司",
  "投標廠商:投標廠商1:決標金額": "2,000,000",
  "投標廠商:投標廠商1:品項名稱": "設備A",
  
  "投標廠商:投標廠商2:廠商名稱": "聯發科技股份有限公司", 
  "投標廠商:投標廠商2:決標金額": "1,500,000",
  "投標廠商:投標廠商2:品項名稱": "設備B",
  
  "投標廠商:投標廠商3:廠商名稱": "台積電股份有限公司",
  "投標廠商:投標廠商3:決標金額": "800,000", 
  "投標廠商:投標廠商3:品項名稱": "設備C"
}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-play me-2"></i>實際測試</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="companyName" class="form-label">測試公司名稱：</label>
                            <input type="text" class="form-control" id="companyName" value="台積電" placeholder="輸入公司名稱">
                        </div>
                        <button class="btn btn-primary" onclick="testDetection()">
                            <i class="fas fa-play me-2"></i>開始測試
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="clearResults()">
                            <i class="fas fa-trash me-2"></i>清除結果
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="testResults" class="mt-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 複製 hasMultipleAwardedVendors 函數
        function hasMultipleAwardedVendors(detail, targetCompanyName) {
            const allVendors = [];
            const targetCompanyAwards = [];
            
            console.log('=== 檢測複數廠商決標 ===');
            console.log('目標公司:', targetCompanyName);
            console.log('Detail keys:', Object.keys(detail).filter(k => k.includes('投標廠商')));
            
            // 檢查所有投標廠商欄位
            for (const key in detail) {
                if (key.includes('投標廠商:投標廠商') && key.includes(':廠商名稱')) {
                    const vendorName = detail[key];
                    const vendorNumber = key.match(/投標廠商:投標廠商(\d+):廠商名稱/);
                    if (vendorNumber && vendorName) {
                        const vendorIndex = parseInt(vendorNumber[1]);
                        
                        // 嘗試多種方式獲取決標金額
                        let amount = null;
                        const possibleAmountKeys = [
                            `投標廠商:投標廠商${vendorIndex}:決標金額`,
                            `投標廠商:投標廠商${vendorIndex}:得標金額`,
                            `決標資料:決標廠商${vendorIndex}:決標金額`,
                            `決標資料:決標廠商${vendorIndex}:得標金額`
                        ];
                        
                        for (const amountKey of possibleAmountKeys) {
                            if (detail[amountKey]) {
                                amount = detail[amountKey];
                                console.log(`找到金額: ${vendorName} - ${amountKey} = ${amount}`);
                                break;
                            }
                        }
                        
                        // 如果沒找到，檢查是否有 "決標品項" 相關欄位
                        if (!amount) {
                            for (const itemKey in detail) {
                                if (itemKey.includes(`投標廠商${vendorIndex}`) && 
                                    (itemKey.includes('決標') || itemKey.includes('得標')) && 
                                    itemKey.includes('金額')) {
                                    amount = detail[itemKey];
                                    console.log(`找到金額(通配): ${vendorName} - ${itemKey} = ${amount}`);
                                    break;
                                }
                            }
                        }
                        
                        // 只有決標金額不為空或0的才算得標廠商
                        if (amount && amount !== '0' && amount !== '' && amount !== 'NT$0') {
                            const vendor = {
                                index: vendorIndex,
                                name: vendorName,
                                amount: amount,
                                item: detail[`投標廠商:投標廠商${vendorIndex}:品項名稱`] || 
                                      detail[`決標資料:決標廠商${vendorIndex}:品項名稱`] || 
                                      `品項${vendorIndex}`
                            };
                            
                            allVendors.push(vendor);
                            
                            // 檢查是否為目標公司（更寬鬆的匹配）
                            if (targetCompanyName) {
                                // 移除公司類型後綴進行比較
                                const cleanTargetName = targetCompanyName
                                    .replace(/股份有限公司|有限公司|企業有限公司|企業股份有限公司/g, '')
                                    .trim();
                                const cleanVendorName = vendorName
                                    .replace(/股份有限公司|有限公司|企業有限公司|企業股份有限公司/g, '')
                                    .trim();
                                
                                if (cleanVendorName.includes(cleanTargetName) || cleanTargetName.includes(cleanVendorName)) {
                                    targetCompanyAwards.push(vendor);
                                    console.log(`✓ 匹配目標公司: ${vendorName}`);
                                }
                            }
                        }
                    }
                }
            }
            
            console.log('✓ 檢測到的所有得標廠商:', allVendors.length, '家');
            console.log('✓ 目標公司得標品項:', targetCompanyAwards.length, '項');
            
            // 如果有複數廠商決標
            if (allVendors.length > 1) {
                console.log('✓ 確認為複數廠商決標案件');
                
                // 計算目標公司總金額
                let totalTargetAmount = 0;
                if (targetCompanyAwards.length > 0) {
                    totalTargetAmount = targetCompanyAwards.reduce((sum, award) => {
                        const numAmount = parseFloat(award.amount?.replace(/[^\d.-]/g, '') || 0);
                        return sum + numAmount;
                    }, 0);
                    console.log('✓ 目標公司總決標金額:', totalTargetAmount);
                }
                
                return {
                    isMultiple: true,
                    allVendors: allVendors,
                    targetCompanyAwards: targetCompanyAwards,
                    totalTargetAmount: totalTargetAmount
                };
            }
            
            console.log('✗ 非複數廠商決標案件');
            return null;
        }

        // 模擬 API 資料
        const mockApiData = {
            "投標廠商:投標廠商1:廠商名稱": "台積電股份有限公司",
            "投標廠商:投標廠商1:決標金額": "2,000,000",
            "投標廠商:投標廠商1:品項名稱": "半導體設備A",
            
            "投標廠商:投標廠商2:廠商名稱": "聯發科技股份有限公司", 
            "投標廠商:投標廠商2:決標金額": "1,500,000",
            "投標廠商:投標廠商2:品項名稱": "晶片設計工具",
            
            "投標廠商:投標廠商3:廠商名稱": "台積電股份有限公司",
            "投標廠商:投標廠商3:決標金額": "800,000", 
            "投標廠商:投標廠商3:品項名稱": "測試設備",
            
            "決標資料:總決標金額": "4,300,000",
            "採購資料:預算金額": "5,000,000"
        };

        function testDetection() {
            const companyName = document.getElementById('companyName').value;
            const resultsDiv = document.getElementById('testResults');
            
            resultsDiv.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>檢測結果</h5>
                    </div>
                    <div class="card-body">
                        <div class="detection-log">
                            <h6>🔍 檢測過程：</h6>
                            <div id="detectionLog"></div>
                        </div>
                        <div class="api-response">
                            <h6>📊 檢測結果：</h6>
                            <div id="detectionResult"></div>
                        </div>
                    </div>
                </div>
            `;

            // 清空 console 並重新導向到頁面
            console.clear();
            const originalLog = console.log;
            const logContainer = document.getElementById('detectionLog');
            console.log = function(...args) {
                originalLog.apply(console, args);
                logContainer.innerHTML += args.join(' ') + '<br>';
            };

            // 執行檢測
            const result = hasMultipleAwardedVendors(mockApiData, companyName);
            
            // 顯示結果
            const resultContainer = document.getElementById('detectionResult');
            if (result) {
                resultContainer.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle me-2"></i>複數廠商決標案件</h6>
                        <p><strong>總得標廠商：</strong>${result.allVendors.length} 家</p>
                        <p><strong>目標公司得標品項：</strong>${result.targetCompanyAwards.length} 項</p>
                        <p><strong>目標公司總金額：</strong>NT$ ${result.totalTargetAmount.toLocaleString()}</p>
                    </div>
                    
                    <h6>所有得標廠商：</h6>
                    <ul class="list-group">
                        ${result.allVendors.map(vendor => `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${vendor.name}</strong><br>
                                    <small class="text-muted">${vendor.item}</small>
                                </div>
                                <span class="badge bg-primary rounded-pill">NT$ ${parseInt(vendor.amount.replace(/,/g, '')).toLocaleString()}</span>
                            </li>
                        `).join('')}
                    </ul>
                    
                    <h6 class="mt-3">目標公司得標品項：</h6>
                    <ul class="list-group">
                        ${result.targetCompanyAwards.map(award => `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${award.name}</strong><br>
                                    <small class="text-muted">${award.item}</small>
                                </div>
                                <span class="badge bg-success rounded-pill">NT$ ${parseInt(award.amount.replace(/,/g, '')).toLocaleString()}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
            } else {
                resultContainer.innerHTML = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>非複數廠商決標案件</h6>
                        <p>此案件只有單一廠商得標，或目標公司未得標。</p>
                    </div>
                `;
            }

            // 恢復原始 console.log
            console.log = originalLog;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }
    </script>
</body>
</html>
