<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¤‡æ•¸å» å•†å¾—æ¨™æª¢æ¸¬æ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .api-response {
            background-color: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 1rem;
            margin: 1rem 0;
        }
        .detection-log {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fas fa-search me-2"></i>è¤‡æ•¸å» å•†å¾—æ¨™æª¢æ¸¬æ¸¬è©¦
        </h1>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs me-2"></i>æª¢æ¸¬é‚è¼¯èªªæ˜</h5>
                    </div>
                    <div class="card-body">
                        <h6>1. æœå°‹æŠ•æ¨™å» å•†æ¬„ä½</h6>
                        <div class="code-block">// æœå°‹åŒ…å« "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†" å’Œ ":å» å•†åç¨±" çš„æ¬„ä½
for (const key in detail) {
    if (key.includes('æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†') && key.includes(':å» å•†åç¨±')) {
        // æå–å» å•†è³‡è¨Š
    }
}</div>

                        <h6>2. æå–æ±ºæ¨™é‡‘é¡</h6>
                        <div class="code-block">// å˜—è©¦å¤šç¨®é‡‘é¡æ¬„ä½æ ¼å¼
const possibleAmountKeys = [
    `æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†${vendorIndex}:æ±ºæ¨™é‡‘é¡`,
    `æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†${vendorIndex}:å¾—æ¨™é‡‘é¡`,
    `æ±ºæ¨™è³‡æ–™:æ±ºæ¨™å» å•†${vendorIndex}:æ±ºæ¨™é‡‘é¡`,
    `æ±ºæ¨™è³‡æ–™:æ±ºæ¨™å» å•†${vendorIndex}:å¾—æ¨™é‡‘é¡`
];</div>

                        <h6>3. åˆ¤æ–·è¤‡æ•¸å» å•†</h6>
                        <div class="code-block">// å¦‚æœæ‰¾åˆ°è¶…é1å®¶æœ‰æ±ºæ¨™é‡‘é¡çš„å» å•†
if (allVendors.length > 1) {
    return {
        isMultiple: true,
        allVendors: allVendors,
        targetCompanyAwards: targetCompanyAwards,
        totalTargetAmount: totalTargetAmount
    };
}</div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-database me-2"></i>API è³‡æ–™çµæ§‹</h5>
                    </div>
                    <div class="card-body">
                        <h6>æ”¿åºœæ¡è³¼ API å›å‚³çš„ detail æ¬„ä½ç¯„ä¾‹ï¼š</h6>
                        <div class="code-block">{
  "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:å» å•†åç¨±": "å°ç©é›»è‚¡ä»½æœ‰é™å…¬å¸",
  "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡": "2,000,000",
  "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:å“é …åç¨±": "è¨­å‚™A",
  
  "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†2:å» å•†åç¨±": "è¯ç™¼ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸", 
  "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†2:æ±ºæ¨™é‡‘é¡": "1,500,000",
  "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†2:å“é …åç¨±": "è¨­å‚™B",
  
  "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†3:å» å•†åç¨±": "å°ç©é›»è‚¡ä»½æœ‰é™å…¬å¸",
  "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†3:æ±ºæ¨™é‡‘é¡": "800,000", 
  "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†3:å“é …åç¨±": "è¨­å‚™C"
}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-play me-2"></i>å¯¦éš›æ¸¬è©¦</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="companyName" class="form-label">æ¸¬è©¦å…¬å¸åç¨±ï¼š</label>
                            <input type="text" class="form-control" id="companyName" value="å°ç©é›»" placeholder="è¼¸å…¥å…¬å¸åç¨±">
                        </div>
                        <button class="btn btn-primary" onclick="testDetection()">
                            <i class="fas fa-play me-2"></i>é–‹å§‹æ¸¬è©¦
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="clearResults()">
                            <i class="fas fa-trash me-2"></i>æ¸…é™¤çµæœ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="testResults" class="mt-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // è¤‡è£½ hasMultipleAwardedVendors å‡½æ•¸
        function hasMultipleAwardedVendors(detail, targetCompanyName) {
            const allVendors = [];
            const targetCompanyAwards = [];
            
            console.log('=== æª¢æ¸¬è¤‡æ•¸å» å•†æ±ºæ¨™ ===');
            console.log('ç›®æ¨™å…¬å¸:', targetCompanyName);
            console.log('Detail keys:', Object.keys(detail).filter(k => k.includes('æŠ•æ¨™å» å•†')));
            
            // æª¢æŸ¥æ‰€æœ‰æŠ•æ¨™å» å•†æ¬„ä½
            for (const key in detail) {
                if (key.includes('æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†') && key.includes(':å» å•†åç¨±')) {
                    const vendorName = detail[key];
                    const vendorNumber = key.match(/æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†(\d+):å» å•†åç¨±/);
                    if (vendorNumber && vendorName) {
                        const vendorIndex = parseInt(vendorNumber[1]);
                        
                        // å˜—è©¦å¤šç¨®æ–¹å¼ç²å–æ±ºæ¨™é‡‘é¡
                        let amount = null;
                        const possibleAmountKeys = [
                            `æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†${vendorIndex}:æ±ºæ¨™é‡‘é¡`,
                            `æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†${vendorIndex}:å¾—æ¨™é‡‘é¡`,
                            `æ±ºæ¨™è³‡æ–™:æ±ºæ¨™å» å•†${vendorIndex}:æ±ºæ¨™é‡‘é¡`,
                            `æ±ºæ¨™è³‡æ–™:æ±ºæ¨™å» å•†${vendorIndex}:å¾—æ¨™é‡‘é¡`
                        ];
                        
                        for (const amountKey of possibleAmountKeys) {
                            if (detail[amountKey]) {
                                amount = detail[amountKey];
                                console.log(`æ‰¾åˆ°é‡‘é¡: ${vendorName} - ${amountKey} = ${amount}`);
                                break;
                            }
                        }
                        
                        // å¦‚æœæ²’æ‰¾åˆ°ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ "æ±ºæ¨™å“é …" ç›¸é—œæ¬„ä½
                        if (!amount) {
                            for (const itemKey in detail) {
                                if (itemKey.includes(`æŠ•æ¨™å» å•†${vendorIndex}`) && 
                                    (itemKey.includes('æ±ºæ¨™') || itemKey.includes('å¾—æ¨™')) && 
                                    itemKey.includes('é‡‘é¡')) {
                                    amount = detail[itemKey];
                                    console.log(`æ‰¾åˆ°é‡‘é¡(é€šé…): ${vendorName} - ${itemKey} = ${amount}`);
                                    break;
                                }
                            }
                        }
                        
                        // åªæœ‰æ±ºæ¨™é‡‘é¡ä¸ç‚ºç©ºæˆ–0çš„æ‰ç®—å¾—æ¨™å» å•†
                        if (amount && amount !== '0' && amount !== '' && amount !== 'NT$0') {
                            const vendor = {
                                index: vendorIndex,
                                name: vendorName,
                                amount: amount,
                                item: detail[`æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†${vendorIndex}:å“é …åç¨±`] || 
                                      detail[`æ±ºæ¨™è³‡æ–™:æ±ºæ¨™å» å•†${vendorIndex}:å“é …åç¨±`] || 
                                      `å“é …${vendorIndex}`
                            };
                            
                            allVendors.push(vendor);
                            
                            // æª¢æŸ¥æ˜¯å¦ç‚ºç›®æ¨™å…¬å¸ï¼ˆæ›´å¯¬é¬†çš„åŒ¹é…ï¼‰
                            if (targetCompanyName) {
                                // ç§»é™¤å…¬å¸é¡å‹å¾Œç¶´é€²è¡Œæ¯”è¼ƒ
                                const cleanTargetName = targetCompanyName
                                    .replace(/è‚¡ä»½æœ‰é™å…¬å¸|æœ‰é™å…¬å¸|ä¼æ¥­æœ‰é™å…¬å¸|ä¼æ¥­è‚¡ä»½æœ‰é™å…¬å¸/g, '')
                                    .trim();
                                const cleanVendorName = vendorName
                                    .replace(/è‚¡ä»½æœ‰é™å…¬å¸|æœ‰é™å…¬å¸|ä¼æ¥­æœ‰é™å…¬å¸|ä¼æ¥­è‚¡ä»½æœ‰é™å…¬å¸/g, '')
                                    .trim();
                                
                                if (cleanVendorName.includes(cleanTargetName) || cleanTargetName.includes(cleanVendorName)) {
                                    targetCompanyAwards.push(vendor);
                                    console.log(`âœ“ åŒ¹é…ç›®æ¨™å…¬å¸: ${vendorName}`);
                                }
                            }
                        }
                    }
                }
            }
            
            console.log('âœ“ æª¢æ¸¬åˆ°çš„æ‰€æœ‰å¾—æ¨™å» å•†:', allVendors.length, 'å®¶');
            console.log('âœ“ ç›®æ¨™å…¬å¸å¾—æ¨™å“é …:', targetCompanyAwards.length, 'é …');
            
            // å¦‚æœæœ‰è¤‡æ•¸å» å•†æ±ºæ¨™
            if (allVendors.length > 1) {
                console.log('âœ“ ç¢ºèªç‚ºè¤‡æ•¸å» å•†æ±ºæ¨™æ¡ˆä»¶');
                
                // è¨ˆç®—ç›®æ¨™å…¬å¸ç¸½é‡‘é¡
                let totalTargetAmount = 0;
                if (targetCompanyAwards.length > 0) {
                    totalTargetAmount = targetCompanyAwards.reduce((sum, award) => {
                        const numAmount = parseFloat(award.amount?.replace(/[^\d.-]/g, '') || 0);
                        return sum + numAmount;
                    }, 0);
                    console.log('âœ“ ç›®æ¨™å…¬å¸ç¸½æ±ºæ¨™é‡‘é¡:', totalTargetAmount);
                }
                
                return {
                    isMultiple: true,
                    allVendors: allVendors,
                    targetCompanyAwards: targetCompanyAwards,
                    totalTargetAmount: totalTargetAmount
                };
            }
            
            console.log('âœ— éè¤‡æ•¸å» å•†æ±ºæ¨™æ¡ˆä»¶');
            return null;
        }

        // æ¨¡æ“¬ API è³‡æ–™
        const mockApiData = {
            "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:å» å•†åç¨±": "å°ç©é›»è‚¡ä»½æœ‰é™å…¬å¸",
            "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡": "2,000,000",
            "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:å“é …åç¨±": "åŠå°é«”è¨­å‚™A",
            
            "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†2:å» å•†åç¨±": "è¯ç™¼ç§‘æŠ€è‚¡ä»½æœ‰é™å…¬å¸", 
            "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†2:æ±ºæ¨™é‡‘é¡": "1,500,000",
            "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†2:å“é …åç¨±": "æ™¶ç‰‡è¨­è¨ˆå·¥å…·",
            
            "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†3:å» å•†åç¨±": "å°ç©é›»è‚¡ä»½æœ‰é™å…¬å¸",
            "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†3:æ±ºæ¨™é‡‘é¡": "800,000", 
            "æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†3:å“é …åç¨±": "æ¸¬è©¦è¨­å‚™",
            
            "æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡": "4,300,000",
            "æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡": "5,000,000"
        };

        function testDetection() {
            const companyName = document.getElementById('companyName').value;
            const resultsDiv = document.getElementById('testResults');
            
            resultsDiv.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>æª¢æ¸¬çµæœ</h5>
                    </div>
                    <div class="card-body">
                        <div class="detection-log">
                            <h6>ğŸ” æª¢æ¸¬éç¨‹ï¼š</h6>
                            <div id="detectionLog"></div>
                        </div>
                        <div class="api-response">
                            <h6>ğŸ“Š æª¢æ¸¬çµæœï¼š</h6>
                            <div id="detectionResult"></div>
                        </div>
                    </div>
                </div>
            `;

            // æ¸…ç©º console ä¸¦é‡æ–°å°å‘åˆ°é é¢
            console.clear();
            const originalLog = console.log;
            const logContainer = document.getElementById('detectionLog');
            console.log = function(...args) {
                originalLog.apply(console, args);
                logContainer.innerHTML += args.join(' ') + '<br>';
            };

            // åŸ·è¡Œæª¢æ¸¬
            const result = hasMultipleAwardedVendors(mockApiData, companyName);
            
            // é¡¯ç¤ºçµæœ
            const resultContainer = document.getElementById('detectionResult');
            if (result) {
                resultContainer.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle me-2"></i>è¤‡æ•¸å» å•†æ±ºæ¨™æ¡ˆä»¶</h6>
                        <p><strong>ç¸½å¾—æ¨™å» å•†ï¼š</strong>${result.allVendors.length} å®¶</p>
                        <p><strong>ç›®æ¨™å…¬å¸å¾—æ¨™å“é …ï¼š</strong>${result.targetCompanyAwards.length} é …</p>
                        <p><strong>ç›®æ¨™å…¬å¸ç¸½é‡‘é¡ï¼š</strong>NT$ ${result.totalTargetAmount.toLocaleString()}</p>
                    </div>
                    
                    <h6>æ‰€æœ‰å¾—æ¨™å» å•†ï¼š</h6>
                    <ul class="list-group">
                        ${result.allVendors.map(vendor => `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${vendor.name}</strong><br>
                                    <small class="text-muted">${vendor.item}</small>
                                </div>
                                <span class="badge bg-primary rounded-pill">NT$ ${parseInt(vendor.amount.replace(/,/g, '')).toLocaleString()}</span>
                            </li>
                        `).join('')}
                    </ul>
                    
                    <h6 class="mt-3">ç›®æ¨™å…¬å¸å¾—æ¨™å“é …ï¼š</h6>
                    <ul class="list-group">
                        ${result.targetCompanyAwards.map(award => `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${award.name}</strong><br>
                                    <small class="text-muted">${award.item}</small>
                                </div>
                                <span class="badge bg-success rounded-pill">NT$ ${parseInt(award.amount.replace(/,/g, '')).toLocaleString()}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
            } else {
                resultContainer.innerHTML = `
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>éè¤‡æ•¸å» å•†æ±ºæ¨™æ¡ˆä»¶</h6>
                        <p>æ­¤æ¡ˆä»¶åªæœ‰å–®ä¸€å» å•†å¾—æ¨™ï¼Œæˆ–ç›®æ¨™å…¬å¸æœªå¾—æ¨™ã€‚</p>
                    </div>
                `;
            }

            // æ¢å¾©åŸå§‹ console.log
            console.log = originalLog;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }
    </script>
</body>
</html>
