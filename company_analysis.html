<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å¸å¾—æ¨™åˆ†æï¼ˆè¿‘3å¹´ï¼‰- æ”¿åºœæ¡è³¼æ¨™æ¡ˆæŸ¥è©¢ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', sans-serif;
        }
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 30px;
        }
        .company-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        .analysis-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .loading-spinner {
            text-align: center;
            padding: 40px;
        }
        .analysis-result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        .year-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.2s ease;
        }
        .year-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- å…¬å¸æ¨™é¡Œå€åŸŸ -->
            <div class="company-header">
                <h1><i class="fas fa-building me-3"></i><span id="companyName">è¼‰å…¥ä¸­...</span></h1>
                <p class="mb-1">ç«¶çˆ­å°æ‰‹æƒ…å ±åˆ†æå ±å‘Šï¼ˆè¿‘3å¹´ï¼‰</p>
                <p class="mb-0"><small><i class="fas fa-shield-alt me-1"></i>ç¾…æ°è¨ºæ–· Roche Diagnostics å¸‚å ´æƒ…å ±åˆ†æ</small></p>
            </div>

            <!-- è¼‰å…¥ä¸­ -->
            <div id="loadingSection" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                </div>
                <p class="mt-3 mb-0"><i class="fas fa-robot me-2"></i>Gemini AI æ­£åœ¨åˆ†æå…¬å¸å¾—æ¨™è³‡æ–™...</p>
            </div>

            <!-- åˆ†æçµæœå€åŸŸ -->
            <div id="analysisSection" style="display: none;">
                <!-- åŸºæœ¬çµ±è¨ˆ -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="totalTenders">0</div>
                            <div>ç¸½å¾—æ¨™æ¡ˆä»¶</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="totalAmount">0</div>
                            <div>ç¸½å¾—æ¨™é‡‘é¡</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="avgAmount">0</div>
                            <div>å¹³å‡å¾—æ¨™é‡‘é¡</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="yearRange">0</div>
                            <div>åˆ†æå¹´ä»½ç¯„åœ</div>
                        </div>
                    </div>
                </div>

                <!-- å¹´åº¦çµ±è¨ˆ -->
                <div class="card analysis-card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>å¹´åº¦å¾—æ¨™çµ±è¨ˆ</h5>
                    </div>
                    <div class="card-body">
                        <div id="yearlyStats"></div>
                    </div>
                </div>

                <!-- Gemini AI åˆ†æ -->
                <div class="card analysis-card">
                    <div class="card-header" style="background: linear-gradient(135deg, #0066cc 0%, #003d7a 100%); color: white;">
                        <h5><i class="fas fa-shield-alt me-2"></i>ç¾…æ°è¨ºæ–· - ç«¶çˆ­å°æ‰‹æƒ…å ±åˆ†æ</h5>
                        <small>Powered by Gemini AI</small>
                    </div>
                    <div class="card-body">
                        <div id="geminiAnalysis" class="analysis-result">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin me-2"></i>æ­£åœ¨é€²è¡Œ AI åˆ†æ...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¾—æ¨™æ¡ˆä»¶æ¸…å–® -->
                <div class="card analysis-card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>å¾—æ¨™æ¡ˆä»¶æ¸…å–®</h5>
                    </div>
                    <div class="card-body">
                        <div id="tenderList"></div>
                    </div>
                </div>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div id="errorSection" style="display: none;">
                <div class="alert alert-warning">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>æœå°‹çµæœ</h5>
                    <div id="errorMessage" style="white-space: pre-line; line-height: 1.8;"></div>
                    <div class="mt-4">
                        <button class="btn btn-primary" onclick="location.reload()">
                            <i class="fas fa-redo me-1"></i>é‡æ–°æœå°‹
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="window.location.href='index.html'">
                            <i class="fas fa-home me-1"></i>è¿”å›ä¸»é 
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="window.close()">
                            <i class="fas fa-times me-1"></i>é—œé–‰
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'https://pcc-api.openfun.app/api';
        let companyData = null;
        let geminiKey = null;

        // å¾ URL åƒæ•¸ç²å–å…¬å¸åç¨±å’Œ Gemini API Key
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                companyName: urlParams.get('company') || '',
                geminiKey: urlParams.get('key') || ''
            };
        }

        // åˆå§‹åŒ–é é¢
        async function initPage() {
            const { companyName, geminiKey: key } = getUrlParams();
            
            if (!companyName) {
                showError('æœªæŒ‡å®šå…¬å¸åç¨±');
                return;
            }

            if (!key) {
                showError('æœªæä¾› Gemini API Key');
                return;
            }

            geminiKey = key;
            document.getElementById('companyName').textContent = companyName;
            
            try {
                await loadCompanyData(companyName);
                await performGeminiAnalysis(companyName);
            } catch (error) {
                console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
                // æä¾›æ›´å‹å–„çš„éŒ¯èª¤è¨Šæ¯å’Œé‡è©¦é¸é …
                showError(`åˆå§‹åŒ–å¤±æ•—ï¼š${error.message}
                
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-redo me-1"></i>é‡æ–°è¼‰å…¥
                    </button>
                    <button class="btn btn-secondary ms-2" onclick="window.close()">
                        <i class="fas fa-times me-1"></i>é—œé–‰
                    </button>
                </div>`);
            }
        }

        // è¼‰å…¥å…¬å¸è³‡æ–™
        async function loadCompanyData(companyName) {
            try {
                showMessage('æ­£åœ¨æœå°‹å…¬å¸å¾—æ¨™è³‡æ–™...', 'info');
                
                let results = [];
                let apiConnectionError = false;
                
                // å˜—è©¦å¤šç¨®æœå°‹æ–¹å¼ï¼ˆæ”¹é€²ç‰ˆï¼‰
                const searchStrategies = [
                    // 1. å®Œæ•´å…¬å¸åç¨±æœå°‹
                    { type: 'companyname', query: companyName, desc: 'å®Œæ•´å…¬å¸åç¨±' },
                    
                    // 2. ç§»é™¤å…¬å¸é¡å‹å¾Œç¶´
                    { type: 'companyname', query: companyName.replace(/è‚¡ä»½æœ‰é™å…¬å¸|æœ‰é™å…¬å¸|ä¼æ¥­æœ‰é™å…¬å¸|ä¼æ¥­è‚¡ä»½æœ‰é™å…¬å¸/g, '').trim(), desc: 'ç§»é™¤å…¬å¸é¡å‹' },
                    
                    // 3. ç§»é™¤æ‹¬è™Ÿå…§å®¹
                    { type: 'companyname', query: companyName.replace(/\(.*\)/g, '').replace(/ï¼ˆ.*ï¼‰/g, '').trim(), desc: 'ç§»é™¤æ‹¬è™Ÿå…§å®¹' },
                    
                    // 4. ç§»é™¤æ‹¬è™Ÿå’Œå…¬å¸é¡å‹
                    { type: 'companyname', query: companyName.replace(/\(.*\)/g, '').replace(/ï¼ˆ.*ï¼‰/g, '').replace(/è‚¡ä»½æœ‰é™å…¬å¸|æœ‰é™å…¬å¸|ä¼æ¥­æœ‰é™å…¬å¸|ä¼æ¥­è‚¡ä»½æœ‰é™å…¬å¸/g, '').trim(), desc: 'ç§»é™¤æ‹¬è™Ÿå’Œå…¬å¸é¡å‹' }
                ];
                
                // æå–ä¸­æ–‡éƒ¨åˆ†
                const chineseMatch = companyName.match(/([\u4e00-\u9fff]+)/g);
                if (chineseMatch && chineseMatch.length > 0) {
                    // ä½¿ç”¨æ‰€æœ‰ä¸­æ–‡ç‰‡æ®µçµ„åˆ
                    chineseMatch.forEach((segment, index) => {
                        if (segment.length >= 2) {
                            // æ·»åŠ å®Œæ•´ç‰‡æ®µ
                            searchStrategies.push({ 
                                type: 'companyname', 
                                query: segment, 
                                desc: `ä¸­æ–‡ç‰‡æ®µ${index+1}: ${segment}` 
                            });
                            
                            // ç§»é™¤å…¬å¸é¡å‹å¾Œç¶´
                            const cleanSegment = segment.replace(/è‚¡ä»½æœ‰é™å…¬å¸|æœ‰é™å…¬å¸|ä¼æ¥­æœ‰é™å…¬å¸|ä¼æ¥­è‚¡ä»½æœ‰é™å…¬å¸/g, '').trim();
                            if (cleanSegment && cleanSegment !== segment && cleanSegment.length >= 2) {
                                searchStrategies.push({ 
                                    type: 'companyname', 
                                    query: cleanSegment, 
                                    desc: `ä¸­æ–‡ç‰‡æ®µ${index+1}ï¼ˆç°¡åŒ–ï¼‰: ${cleanSegment}` 
                                });
                            }
                            
                            // å˜—è©¦å‰å¹¾å€‹å­—ï¼ˆå¦‚æœç‰‡æ®µå¤ é•·ï¼‰
                            if (segment.length >= 4) {
                                searchStrategies.push({ 
                                    type: 'companyname', 
                                    query: segment.substring(0, 3), 
                                    desc: `ä¸­æ–‡é—œéµå­—ï¼ˆå‰3å­—ï¼‰: ${segment.substring(0, 3)}` 
                                });
                            }
                            if (segment.length >= 3) {
                                searchStrategies.push({ 
                                    type: 'companyname', 
                                    query: segment.substring(0, 2), 
                                    desc: `ä¸­æ–‡é—œéµå­—ï¼ˆå‰2å­—ï¼‰: ${segment.substring(0, 2)}` 
                                });
                            }
                        }
                    });
                }
                
                // æå–è‹±æ–‡éƒ¨åˆ†
                const englishMatch = companyName.match(/\(([^)]+)\)/);
                if (englishMatch) {
                    searchStrategies.push({ type: 'companyname', query: englishMatch[1], desc: 'è‹±æ–‡åç¨±ï¼ˆæ‹¬è™Ÿå…§ï¼‰' });
                    
                    // è‹±æ–‡åç¨±çš„ç¬¬ä¸€å€‹å–®å­—
                    const firstWord = englishMatch[1].split(/\s+/)[0];
                    if (firstWord && firstWord.length >= 2) {
                        searchStrategies.push({ type: 'companyname', query: firstWord, desc: 'è‹±æ–‡é—œéµå­—ï¼ˆç¬¬ä¸€å–®å­—ï¼‰' });
                    }
                }
                
                // å˜—è©¦ä½¿ç”¨ title æœå°‹ï¼ˆæ¨™æ¡ˆåç¨±ä¸­å¯èƒ½åŒ…å«å…¬å¸åç¨±ï¼‰
                const mainName = companyName.replace(/\(.*\)/g, '').replace(/ï¼ˆ.*ï¼‰/g, '').replace(/è‚¡ä»½æœ‰é™å…¬å¸|æœ‰é™å…¬å¸|ä¼æ¥­æœ‰é™å…¬å¸|ä¼æ¥­è‚¡ä»½æœ‰é™å…¬å¸/g, '').trim();
                if (mainName.length >= 2) {
                    searchStrategies.push({ type: 'title', query: mainName, desc: `æ¨™æ¡ˆåç¨±æœå°‹: ${mainName}` });
                }
                
                // å˜—è©¦å„ç¨®æœå°‹ç­–ç•¥
                for (const strategy of searchStrategies) {
                    if (strategy.query && strategy.query.length > 1) {
                        try {
                            console.log(`å˜—è©¦æœå°‹ç­–ç•¥: ${strategy.desc} - "${strategy.query}"`);
                            const strategyResults = await searchAllPages(strategy.type, strategy.query);
                            console.log(`${strategy.desc} æœå°‹çµæœ:`, strategyResults.length, 'ç­†');
                            
                            if (strategyResults && strategyResults.length > 0) {
                                results = results.concat(strategyResults);
                                // å¦‚æœæˆåŠŸå–å¾—çµæœï¼Œè¡¨ç¤º API é€£æ¥æ­£å¸¸
                                apiConnectionError = false;
                            }
                        } catch (error) {
                            console.warn(`${strategy.desc} æœå°‹å¤±æ•—:`, error);
                            // è¨˜éŒ„é€£æ¥éŒ¯èª¤ï¼Œä½†ä¸ç«‹å³ä¸­æ­¢
                            if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                                apiConnectionError = true;
                                console.error('APIé€£æ¥å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç¶²è·¯å•é¡Œæˆ–APIæœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨');
                            }
                        }
                    }
                }
                
                // å»é‡è¤‡
                const uniqueResults = [];
                const seen = new Set();
                for (const result of results) {
                    const key = `${result.unit_id}-${result.job_number}-${result.date}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueResults.push(result);
                    }
                }
                
                console.log('å»é‡è¤‡å¾Œç¸½çµæœ:', uniqueResults.length, 'ç­†');
                
                if (uniqueResults.length === 0) {
                    // æä¾›æ›´è©³ç´°çš„è¨ºæ–·è³‡è¨Š
                    console.log('æ²’æœ‰æ‰¾åˆ°ä»»ä½•çµæœï¼ŒapiConnectionError:', apiConnectionError);
                    console.log('å·²å˜—è©¦çš„æœå°‹ç­–ç•¥æ•¸é‡:', searchStrategies.length);
                    
                    let diagnosticInfo = `æœªæ‰¾åˆ°ã€Œ${companyName}ã€çš„ç›¸é—œæ¨™æ¡ˆç´€éŒ„ã€‚\n\n`;
                    
                    if (apiConnectionError) {
                        // API é€£æ¥å•é¡Œ - æä¾›è¨ºæ–·å’Œæ¸¬è©¦é€£çµ
                        diagnosticInfo += `âš ï¸ åµæ¸¬åˆ° API é€£æ¥å•é¡Œ\n\n`;
                        diagnosticInfo += `å¯èƒ½åŸå› ï¼š\n`;
                        diagnosticInfo += `- ç¶²è·¯é€£ç·šä¸ç©©å®š\n`;
                        diagnosticInfo += `- API æœå‹™æš«æ™‚ç„¡æ³•ä½¿ç”¨\n`;
                        diagnosticInfo += `- ç€è¦½å™¨å®‰å…¨è¨­å®šé˜»æ“‹è«‹æ±‚\n\n`;
                        diagnosticInfo += `å»ºè­°æ“ä½œï¼š\n`;
                        diagnosticInfo += `1. æª¢æŸ¥ç¶²è·¯é€£ç·š\n`;
                        diagnosticInfo += `2. é‡æ–°æ•´ç†é é¢ (F5)\n`;
                        diagnosticInfo += `3. é–‹å•Ÿç€è¦½å™¨é–‹ç™¼è€…å·¥å…· (F12) æŸ¥çœ‹è©³ç´°éŒ¯èª¤\n`;
                        diagnosticInfo += `4. ç¨å¾Œå†è©¦\n`;
                    } else {
                        // æ‰¾ä¸åˆ°è³‡æ–™ - æä¾›è©³ç´°çš„æœå°‹å ±å‘Šå’Œå»ºè­°
                        diagnosticInfo += `âœ“ API é€£æ¥æ­£å¸¸\n`;
                        diagnosticInfo += `âœ“ å·²å˜—è©¦ ${searchStrategies.length} ç¨®æœå°‹ç­–ç•¥\n\n`;
                        
                        diagnosticInfo += `ğŸ“‹ æœå°‹ç­–ç•¥è©³æƒ…ï¼š\n`;
                        diagnosticInfo += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
                        searchStrategies.forEach((s, i) => {
                            if (i < 10) { // é¡¯ç¤ºå‰10å€‹ç­–ç•¥
                                diagnosticInfo += `${i+1}. ${s.desc}\n   æŸ¥è©¢: "${s.query}" (é¡å‹: ${s.type})\n`;
                            }
                        });
                        if (searchStrategies.length > 10) {
                            diagnosticInfo += `... ä»¥åŠå…¶ä»– ${searchStrategies.length - 10} ç¨®è®Šé«”\n`;
                        }
                        diagnosticInfo += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
                        
                        diagnosticInfo += `ğŸ’¡ å»ºè­°è§£æ±ºæ–¹å¼ï¼š\n\n`;
                        diagnosticInfo += `1ï¸âƒ£ ä½¿ç”¨ä¸»é é¢æœå°‹åŠŸèƒ½\n`;
                        diagnosticInfo += `   - å›åˆ°ä¸»é é¢ (index.html)\n`;
                        diagnosticInfo += `   - å˜—è©¦æœå°‹ç›¸é—œæ¨™æ¡ˆ\n`;
                        diagnosticInfo += `   - æŸ¥çœ‹ã€Œç›¸é—œå…¬å¸ã€æ¨™ç±¤æ‰¾åˆ°è©²å…¬å¸\n\n`;
                        diagnosticInfo += `2ï¸âƒ£ ç¢ºèªå…¬å¸åç¨±\n`;
                        diagnosticInfo += `   - æª¢æŸ¥å…¬å¸åç¨±æ‹¼å¯«\n`;
                        diagnosticInfo += `   - å˜—è©¦ä¸åŒçš„å…¬å¸åç¨±æ ¼å¼\n`;
                        diagnosticInfo += `   - ä½¿ç”¨çµ±ä¸€ç·¨è™Ÿæœå°‹ï¼ˆå¦‚æœæœ‰ï¼‰\n\n`;
                        diagnosticInfo += `3ï¸âƒ£ å¯èƒ½çš„æƒ…æ³\n`;
                        diagnosticInfo += `   - è©²å…¬å¸å¯èƒ½ä½¿ç”¨ä¸åŒåç¨±åƒèˆ‡æ¨™æ¡ˆ\n`;
                        diagnosticInfo += `   - è©²å…¬å¸å¯èƒ½æ²’æœ‰æ”¿åºœæ¡è³¼è¨˜éŒ„\n`;
                        diagnosticInfo += `   - è©²å…¬å¸å¯èƒ½ä½¿ç”¨ä»£ç†å•†æˆ–ç¶“éŠ·å•†åç¾©\n`;
                    }
                    
                    throw new Error(diagnosticInfo);
                }

                // å‹•æ…‹éæ¿¾è¿‘3å¹´çš„æ¡ˆä»¶ï¼ˆå¾ä»Šå¤©å¾€å‰æ¨3å¹´ï¼‰
                const currentDate = new Date();
                const threeYearsAgo = new Date(currentDate);
                threeYearsAgo.setFullYear(currentDate.getFullYear() - 3);
                
                console.log('ç•¶å‰æ—¥æœŸ:', currentDate.toLocaleDateString());
                console.log('ä¸‰å¹´å‰æ—¥æœŸ:', threeYearsAgo.toLocaleDateString());
                
                const recentResults = uniqueResults.filter(record => {
                    if (!record.date) {
                        console.log('è¨˜éŒ„ç¼ºå°‘æ—¥æœŸ:', record.job_number);
                        return false;
                    }
                    
                    try {
                        const dateStr = record.date.toString();
                        // è§£æ YYYYMMDD æ ¼å¼çš„æ—¥æœŸ
                        const year = parseInt(dateStr.substring(0, 4));
                        const month = parseInt(dateStr.substring(4, 6));
                        const day = parseInt(dateStr.substring(6, 8));
                        
                        // é©—è­‰æ—¥æœŸæœ‰æ•ˆæ€§
                        if (isNaN(year) || isNaN(month) || isNaN(day)) {
                            console.log('ç„¡æ•ˆæ—¥æœŸæ ¼å¼:', dateStr, record.job_number);
                            return false;
                        }
                        
                        const recordDate = new Date(year, month - 1, day);
                        
                        // æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨è¿‘3å¹´ç¯„åœå…§
                        const isInRange = recordDate >= threeYearsAgo && recordDate <= currentDate;
                        
                        if (!isInRange) {
                            console.log('è¨˜éŒ„ä¸åœ¨è¿‘3å¹´ç¯„åœ:', {
                                job_number: record.job_number,
                                date: dateStr,
                                recordDate: recordDate.toLocaleDateString(),
                                isInRange
                            });
                        }
                        
                        return isInRange;
                    } catch (error) {
                        console.error('æ—¥æœŸè§£æéŒ¯èª¤:', error, record.date, record.job_number);
                        return false;
                    }
                });
                
                console.log('è¿‘3å¹´æ¡ˆä»¶æ•¸é‡:', recentResults.length, 'ç­†');
                
                // éæ¿¾å‡ºæ±ºæ¨™æ¡ˆä»¶ï¼ˆæ’é™¤ç„¡æ³•æ±ºæ¨™å…¬å‘Šï¼‰
                const tenderResults = recentResults.filter(r => {
                    const type = r.brief?.type || '';
                    return type.includes('æ±ºæ¨™') && !type.includes('ç„¡æ³•æ±ºæ¨™');
                });
                
                console.log('è¿‘3å¹´æ±ºæ¨™æ¡ˆä»¶æ•¸é‡:', tenderResults.length, 'ç­†');
                
                if (tenderResults.length === 0) {
                    // å¦‚æœæ²’æœ‰æ±ºæ¨™æ¡ˆä»¶ï¼Œé¡¯ç¤ºæ‰€æœ‰è¿‘3å¹´çš„æ¡ˆä»¶
                    console.log('æ²’æœ‰æ±ºæ¨™æ¡ˆä»¶ï¼Œé¡¯ç¤ºæ‰€æœ‰è¿‘3å¹´çš„æ¡ˆä»¶');
                    const allResults = recentResults.slice(0, 20);
                    companyData = allResults;
                    
                    // è¨ˆç®—çµ±è¨ˆè³‡æ–™ï¼ˆåŒ…å«æ‰€æœ‰æ¡ˆä»¶ï¼‰
                    calculateStats(allResults);
                    
                    // é¡¯ç¤ºå¹´åº¦çµ±è¨ˆï¼ˆåŒ…å«æ‰€æœ‰æ¡ˆä»¶ï¼‰
                    displayYearlyStats(allResults);
                    
                    // é¡¯ç¤ºæ¡ˆä»¶æ¸…å–®ï¼ˆåŒ…å«æ‰€æœ‰æ¡ˆä»¶ï¼‰
                    displayTenderList(allResults);
                    
                    // éš±è—è¼‰å…¥ä¸­ï¼Œé¡¯ç¤ºåˆ†æçµæœ
                    document.getElementById('loadingSection').style.display = 'none';
                    document.getElementById('analysisSection').style.display = 'block';
                    
                    // é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
                    showMessage(`æ‰¾åˆ° ${allResults.length} ç­†è¿‘3å¹´ç›¸é—œæ¨™æ¡ˆï¼Œä½†æ²’æœ‰æ±ºæ¨™æ¡ˆä»¶ã€‚å°‡é¡¯ç¤ºæ‰€æœ‰æ‰¾åˆ°çš„æ¡ˆä»¶ã€‚`, 'warning');
                    return;
                }

                // ç²å–æ¯å€‹æ¨™æ¡ˆçš„å®Œæ•´è©³ç´°è³‡æ–™ï¼ˆå–æ‰€æœ‰è¿‘3å¹´æ±ºæ¨™æ¡ˆä»¶ï¼‰
                showMessage(`æ­£åœ¨è¼‰å…¥æ¨™æ¡ˆè©³ç´°è³‡æ–™... (å…± ${tenderResults.length} ç­†)`, 'info');
                
                // ç‚ºäº†ç¢ºä¿å®Œæ•´æ€§ï¼Œæˆ‘å€‘å–æ‰€æœ‰è¿‘3å¹´çš„æ±ºæ¨™æ¡ˆä»¶ï¼ˆæœ€å¤š100ç­†ï¼‰
                const recordsToProcess = tenderResults.slice(0, Math.min(100, tenderResults.length));
                console.log(`æº–å‚™è™•ç† ${recordsToProcess.length} ç­†æ±ºæ¨™æ¡ˆä»¶`);
                
                const detailedResults = await Promise.all(
                    recordsToProcess.map(async (record) => {
                        try {
                            const detailResponse = await fetch(`${API_BASE}/tender?unit_id=${record.unit_id}&job_number=${record.job_number}`);
                            if (detailResponse.ok) {
                                const detailData = await detailResponse.json();
                                const detailRecord = detailData.records?.[0] || detailData;
                                
                                // æ™ºèƒ½åˆä½µè©³ç´°è³‡æ–™
                                let mergedDetail = record.detail || {};
                                
                                // å¦‚æœ detailRecord æœ‰ detail å±¬æ€§ï¼Œåˆä½µå®ƒ
                                if (detailRecord.detail && typeof detailRecord.detail === 'object') {
                                    mergedDetail = { ...mergedDetail, ...detailRecord.detail };
                                }
                                // å¦‚æœ detailRecord æœ¬èº«å°±æ˜¯ detail å°è±¡ï¼ˆåŒ…å«æ±ºæ¨™ç›¸é—œæ¬„ä½ï¼‰
                                else if (detailRecord && typeof detailRecord === 'object') {
                                    // æª¢æŸ¥æ˜¯å¦åŒ…å«æ±ºæ¨™ç›¸é—œæ¬„ä½
                                    const hasDetailFields = Object.keys(detailRecord).some(key => 
                                        key.includes('æ±ºæ¨™') || key.includes('æŠ•æ¨™') || key.includes('æ¡è³¼') || key.includes('æ©Ÿé—œ')
                                    );
                                    if (hasDetailFields) {
                                        mergedDetail = { ...mergedDetail, ...detailRecord };
                                    }
                                }
                                
                                const mergedRecord = {
                                    ...record,
                                    detail: mergedDetail,
                                    url: detailRecord.url || record.url,
                                    pkPmsMain: detailRecord.pkPmsMain || record.pkPmsMain
                                };
                                
                                console.log(`åˆä½µ ${record.job_number} è©³ç´°è³‡æ–™:`, {
                                    original_detail_keys: Object.keys(record.detail || {}),
                                    detailRecord_keys: Object.keys(detailRecord),
                                    detailRecord_detail_keys: detailRecord.detail ? Object.keys(detailRecord.detail) : [],
                                    merged_detail_keys: Object.keys(mergedDetail),
                                    has_award_amount: !!(mergedDetail['æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡'] || mergedDetail['æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡'])
                                });
                                return mergedRecord;
                            }
                        } catch (error) {
                            console.error(`è¼‰å…¥ ${record.job_number} è©³ç´°è³‡æ–™éŒ¯èª¤:`, error);
                        }
                        return record;
                    })
                );

                companyData = detailedResults;
                
                // è¨ˆç®—çµ±è¨ˆè³‡æ–™
                calculateStats(detailedResults);
                
                // é¡¯ç¤ºå¹´åº¦çµ±è¨ˆ
                displayYearlyStats(detailedResults);
                
                // é¡¯ç¤ºå¾—æ¨™æ¡ˆä»¶æ¸…å–®
                displayTenderList(detailedResults);
                
                // éš±è—è¼‰å…¥ä¸­ï¼Œé¡¯ç¤ºåˆ†æçµæœ
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('analysisSection').style.display = 'block';
                
            } catch (error) {
                console.error('è¼‰å…¥å…¬å¸è³‡æ–™éŒ¯èª¤:', error);
                throw error;
            }
        }

        // è¨ˆç®—çµ±è¨ˆè³‡æ–™
        function calculateStats(results) {
            let totalAmount = 0;
            let validAmountCount = 0;
            const years = new Set();
            
            results.forEach(record => {
                const year = record.date ? record.date.toString().substring(0, 4) : 'æœªçŸ¥';
                years.add(year);
                
                // å„ªå…ˆä½¿ç”¨æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡
                let amount = '0';
                if (record.detail?.['æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡']) {
                    amount = record.detail['æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡'];
                } else if (record.detail?.['æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡']) {
                    amount = record.detail['æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡'];
                } else if (record.detail?.['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡']) {
                    amount = record.detail['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡'];
                }
                
                const amountMatch = amount.toString().match(/[\d,]+/);
                if (amountMatch) {
                    const numericAmount = parseInt(amountMatch[0].replace(/,/g, ''));
                    totalAmount += numericAmount;
                    validAmountCount++;
                }
            });

            const avgAmount = validAmountCount > 0 ? Math.round(totalAmount / validAmountCount) : 0;
            const yearRange = years.size;

            document.getElementById('totalTenders').textContent = results.length;
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + ' å…ƒ';
            document.getElementById('avgAmount').textContent = avgAmount.toLocaleString() + ' å…ƒ';
            document.getElementById('yearRange').textContent = yearRange + ' å¹´';
        }

        // é¡¯ç¤ºå¹´åº¦çµ±è¨ˆï¼ˆè¿‘3å¹´ï¼‰
        function displayYearlyStats(results) {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            
            // å‹•æ…‹è¨ˆç®—è¿‘3å¹´å€é–“ï¼ˆå¾ç•¶å‰æ—¥æœŸå¾€å‰æ¨3å¹´ï¼‰
            const threeYearsAgo = new Date(currentDate);
            threeYearsAgo.setFullYear(currentYear - 3);
            
            console.log('å¹´åº¦çµ±è¨ˆï¼šç•¶å‰æ—¥æœŸ', currentDate.toLocaleDateString());
            console.log('å¹´åº¦çµ±è¨ˆï¼šä¸‰å¹´å‰æ—¥æœŸ', threeYearsAgo.toLocaleDateString());
            
            const yearlyStats = {};
            const allYears = new Set();
            
            // å…ˆæ”¶é›†æ‰€æœ‰æœ‰è³‡æ–™çš„å¹´ä»½
            results.forEach(record => {
                if (record.date) {
                    const dateStr = record.date.toString();
                    const year = dateStr.substring(0, 4);
                    const yearNum = parseInt(year);
                    
                    // é©—è­‰å¹´ä»½æœ‰æ•ˆæ€§
                    if (!isNaN(yearNum) && yearNum >= 2000 && yearNum <= currentYear) {
                        allYears.add(yearNum);
                    }
                }
            });
            
            // æ‰¾å‡ºè¿‘3å¹´ç¯„åœå…§çš„æ‰€æœ‰å¹´ä»½ï¼ˆå¾ä¸‰å¹´å‰çš„å¹´ä»½åˆ°ç•¶å‰å¹´ä»½ï¼‰
            const threeYearsAgoYear = threeYearsAgo.getFullYear();
            const recentYears = Array.from(allYears).filter(year => {
                return year >= threeYearsAgoYear && year <= currentYear;
            }).sort((a, b) => b - a);
            
            console.log('æ‰€æœ‰å¹´ä»½:', Array.from(allYears).sort((a, b) => b - a));
            console.log('è¿‘3å¹´å¹´ä»½:', recentYears);
            
            console.log('è¿‘3å¹´ç¯„åœå…§æ‰¾åˆ°çš„å¹´ä»½:', recentYears);
            
            // çµ±è¨ˆå„å¹´åº¦è³‡æ–™
            results.forEach(record => {
                if (!record.date) return;
                
                const year = record.date.toString().substring(0, 4);
                const yearNum = parseInt(year);
                
                // åªè™•ç†è¿‘3å¹´ç¯„åœå…§çš„è³‡æ–™
                if (!recentYears.includes(yearNum)) {
                    return;
                }
                
                // å„ªå…ˆä½¿ç”¨æ±ºæ¨™é‡‘é¡ï¼Œå‚™ç”¨é ç®—é‡‘é¡
                let amount = '0';
                if (record.detail?.['æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡']) {
                    amount = record.detail['æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡'];
                } else if (record.detail?.['æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡']) {
                    amount = record.detail['æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡'];
                } else if (record.detail?.['æ¡è³¼è³‡æ–™:æ±ºæ¨™é‡‘é¡']) {
                    amount = record.detail['æ¡è³¼è³‡æ–™:æ±ºæ¨™é‡‘é¡'];
                } else if (record.detail?.['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡']) {
                    amount = record.detail['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡'];
                }
                
                if (!yearlyStats[year]) {
                    yearlyStats[year] = { count: 0, totalAmount: 0 };
                }
                yearlyStats[year].count++;
                
                const amountMatch = amount.toString().match(/[\d,]+/);
                if (amountMatch) {
                    const numericAmount = parseInt(amountMatch[0].replace(/,/g, ''));
                    yearlyStats[year].totalAmount += numericAmount;
                }
            });

            // ç¢ºä¿è¿‘3å¹´éƒ½æœ‰è³‡æ–™ï¼ˆå³ä½¿ç‚º0ï¼‰
            recentYears.forEach(year => {
                if (!yearlyStats[year]) {
                    yearlyStats[year] = { count: 0, totalAmount: 0 };
                }
            });

            // è¨ˆç®—è¿‘3å¹´ç¸½è¨ˆ
            let total3YearCount = 0;
            let total3YearAmount = 0;
            
            recentYears.forEach(year => {
                const stats = yearlyStats[year];
                total3YearCount += stats.count;
                total3YearAmount += stats.totalAmount;
            });
            
            const yearlyHtml = `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-chart-line me-2"></i>è¿‘3å¹´å¾—æ¨™çµ±è¨ˆç¸½è¦½ (${recentYears[recentYears.length-1] || currentYear-2}å¹´ - ${currentYear}å¹´)</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>ç¸½æ¡ˆä»¶æ•¸ï¼š</strong>${total3YearCount} ä»¶
                                </div>
                                <div class="col-md-6">
                                    <strong>ç¸½æ±ºæ¨™é‡‘é¡ï¼š</strong><span class="text-success">${total3YearAmount.toLocaleString()}</span> å…ƒ
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ${recentYears.map(year => {
                    const stats = yearlyStats[year];
                    const isCurrentYear = year === currentYear;
                    const yearLabel = isCurrentYear ? `${year}å¹´ï¼ˆä»Šå¹´ï¼‰` : `${year}å¹´`;
                    const yearClass = isCurrentYear ? 'text-primary' : 'text-secondary';
                    
                    return `
                        <div class="year-card mb-3">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6 class="${yearClass}">${yearLabel}</h6>
                                </div>
                                <div class="col-md-3">
                                    <strong>${stats.count}</strong> ä»¶æ¡ˆä»¶
                                </div>
                                <div class="col-md-6">
                                    <strong class="text-success">${stats.totalAmount.toLocaleString()}</strong> å…ƒ
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;

            document.getElementById('yearlyStats').innerHTML = yearlyHtml;
        }

        // é¡¯ç¤ºå¾—æ¨™æ¡ˆä»¶æ¸…å–®ï¼ˆé¡¯ç¤ºæ‰€æœ‰è¿‘3å¹´çš„æ¡ˆä»¶ï¼‰
        function displayTenderList(results) {
            console.log('é¡¯ç¤ºå¾—æ¨™æ¡ˆä»¶æ¸…å–®ï¼Œå…±', results.length, 'ç­†è³‡æ–™');
            
            // é¡¯ç¤ºæ‰€æœ‰è¿‘3å¹´çš„æ¡ˆä»¶ï¼ˆæœ€å¤š100ç­†ï¼‰
            const displayCount = Math.min(100, results.length);
            console.log(`æº–å‚™é¡¯ç¤º ${displayCount} ç­†æ¡ˆä»¶`);
            
            const tenderHtml = results.slice(0, displayCount).map((record, index) => {
                const brief = record.brief || {};
                const detail = record.detail || {};
                const dateStr = record.date ? record.date.toString() : '';
                const formattedDate = dateStr ? `${dateStr.substring(0,4)}å¹´${dateStr.substring(4,6)}æœˆ${dateStr.substring(6,8)}æ—¥` : 'æœªçŸ¥';
                
                // èª¿è©¦ï¼šè¼¸å‡º detail æ‰€æœ‰æ¬„ä½
                console.log(`æ¨™æ¡ˆ ${index + 1} (${record.job_number}):`, {
                    detail_keys: Object.keys(detail),
                    url: record.url,
                    has_pkPmsMain: !!detail.pkPmsMain
                });
                
                // æ§‹å»ºæ”¿åºœæ¡è³¼ç¶²é€£çµ
                const govUrl = buildGovUrl(record);
                console.log(`æ¨™æ¡ˆ ${index + 1} é€£çµ:`, govUrl);
                console.log(`æ¨™æ¡ˆ ${index + 1} å®Œæ•´record:`, record);
                
                // ç²å–é‡‘é¡ï¼ˆå„ªå…ˆä½¿ç”¨æ±ºæ¨™é‡‘é¡ï¼Œå‚™ç”¨é ç®—é‡‘é¡ï¼‰
                let tenderAmount = 'é‡‘é¡æœªçŸ¥';
                let amountType = '';
                
                // 1. å„ªå…ˆä½¿ç”¨æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡
                if (detail['æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡']) {
                    tenderAmount = detail['æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡'];
                    amountType = 'æ±ºæ¨™é‡‘é¡';
                    console.log(`æ‰¾åˆ°æ±ºæ¨™é‡‘é¡: æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡ = ${tenderAmount}`);
                }
                // 2. å‚™ç”¨ï¼šä½¿ç”¨æŠ•æ¨™å» å•†çš„æ±ºæ¨™é‡‘é¡
                else if (detail['æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡']) {
                    tenderAmount = detail['æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡'];
                    amountType = 'æ±ºæ¨™é‡‘é¡';
                    console.log(`æ‰¾åˆ°æ±ºæ¨™é‡‘é¡: æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡ = ${tenderAmount}`);
                }
                // 3. å‚™ç”¨ï¼šä½¿ç”¨æ¡è³¼è³‡æ–™çš„æ±ºæ¨™é‡‘é¡
                else if (detail['æ¡è³¼è³‡æ–™:æ±ºæ¨™é‡‘é¡']) {
                    tenderAmount = detail['æ¡è³¼è³‡æ–™:æ±ºæ¨™é‡‘é¡'];
                    amountType = 'æ±ºæ¨™é‡‘é¡';
                    console.log(`æ‰¾åˆ°æ±ºæ¨™é‡‘é¡: æ¡è³¼è³‡æ–™:æ±ºæ¨™é‡‘é¡ = ${tenderAmount}`);
                }
                // 4. å‚™ç”¨ï¼šä½¿ç”¨é ç®—é‡‘é¡
                else if (detail['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡']) {
                    tenderAmount = detail['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡'];
                    amountType = 'é ç®—é‡‘é¡';
                    console.log(`æ‰¾åˆ°é ç®—é‡‘é¡: æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡ = ${tenderAmount}`);
                }
                // 5. æœ€å¾Œå‚™ç”¨ï¼šéæ­·æ‰€æœ‰æ¬„ä½å°‹æ‰¾é‡‘é¡
                else {
                    for (const key in detail) {
                        if (key.includes('æ±ºæ¨™é‡‘é¡') || key.includes('ç¸½æ±ºæ¨™é‡‘é¡') || key.includes('å¾—æ¨™é‡‘é¡')) {
                            const value = detail[key];
                            if (value && value.toString().match(/[\d,]+/)) {
                                tenderAmount = value;
                                amountType = 'æ±ºæ¨™é‡‘é¡';
                                console.log(`æ‰¾åˆ°é‡‘é¡æ¬„ä½: ${key} = ${value}`);
                                break;
                            }
                        }
                    }
                }
                
                console.log(`æ¨™æ¡ˆ ${index + 1} é‡‘é¡:`, tenderAmount);
                
                // ç²å–æ¨™æ¡ˆæ¡ˆè™Ÿ
                const jobNumber = record.job_number || 'æœªçŸ¥æ¡ˆè™Ÿ';
                
                // ç²å–æ±ºæ¨™æ—¥æœŸ
                const tenderDate = detail['æ±ºæ¨™è³‡æ–™:æ±ºæ¨™æ—¥æœŸ'] || detail['ç„¡æ³•æ±ºæ¨™å…¬å‘Š:ç„¡æ³•æ±ºæ¨™å…¬å‘Šæ—¥æœŸ'] || formattedDate;
                
                // ç²å–ç¬¬å¹¾æ¬¡æ±ºæ¨™
                const tenderSequence = detail['æ‹›æ¨™è³‡æ–™:æ–°å¢å…¬å‘Šå‚³è¼¸æ¬¡æ•¸'] || detail['ç„¡æ³•æ±ºæ¨™å…¬å‘Š:æ–°å¢å…¬å‘Šå‚³è¼¸æ¬¡æ•¸'] || '1';
                
                return `
                    <div class="card mb-2">
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="card-title">
                                        <a href="${govUrl}" target="_blank" class="text-decoration-none text-primary">
                                            ${brief.title || 'ç„¡æ¨™é¡Œ'}
                                            <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                                        </a>
                                    </h6>
                                    <p class="card-text text-muted mb-1">
                                        <i class="fas fa-hashtag me-1"></i>æ¡ˆè™Ÿ: ${jobNumber} | 
                                        <i class="fas fa-calendar me-1"></i>æ±ºæ¨™æ—¥æœŸ: ${tenderDate} | 
                                        <i class="fas fa-sort-numeric-up me-1"></i>ç¬¬${tenderSequence}æ¬¡æ±ºæ¨™
                                    </p>
                                    <p class="card-text text-muted mb-1">
                                        <i class="fas fa-building me-1"></i>${record.unit_name || 'æœªçŸ¥æ©Ÿé—œ'}
                                    </p>
                                    <div class="mt-2">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="åˆ†äº«æ¨™æ¡ˆ">
                                                <i class="fas fa-share-alt me-1"></i>åˆ†äº«
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="shareToLine('${(brief.title || 'ç„¡æ¨™é¡Œ').replace(/'/g, "\\'")}', '${(record.unit_name || 'æœªçŸ¥æ©Ÿé—œ').replace(/'/g, "\\'")}', '${govUrl}')">
                                                    <i class="fab fa-line text-success me-2"></i>åˆ†äº«åˆ° Line
                                                </a></li>
                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="shareToGmail('${(brief.title || 'ç„¡æ¨™é¡Œ').replace(/'/g, "\\'")}', '${(record.unit_name || 'æœªçŸ¥æ©Ÿé—œ').replace(/'/g, "\\'")}', '${jobNumber}', '${govUrl}')">
                                                    <i class="fas fa-envelope text-danger me-2"></i>åˆ†äº«åˆ° Gmail
                                                </a></li>
                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="copyLink('${govUrl}', '${(brief.title || 'ç„¡æ¨™é¡Œ').replace(/'/g, "\\'")}')">
                                                    <i class="fas fa-copy text-primary me-2"></i>è¤‡è£½é€£çµ
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge ${brief.type && brief.type.includes('æ±ºæ¨™') ? 'bg-danger' : 'bg-primary'}">${brief.type || 'æœªçŸ¥é¡å‹'}</span>
                                    <br>
                                    <strong class="text-success">${tenderAmount}</strong>
                                    ${amountType ? `<br><small class="text-muted">${amountType}</small>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // æ·»åŠ çµ±è¨ˆè³‡è¨Š
            const statsHtml = `
                <div class="alert alert-info mb-3">
                    <h6><i class="fas fa-info-circle me-2"></i>è³‡æ–™çµ±è¨ˆ</h6>
                    <p class="mb-0">é¡¯ç¤º <strong>${displayCount}</strong> ç­†è¿‘3å¹´æ±ºæ¨™æ¡ˆä»¶ï¼ˆå…± ${results.length} ç­†ï¼‰</p>
                </div>
            `;
            
            document.getElementById('tenderList').innerHTML = statsHtml + tenderHtml;
        }

        // æ§‹å»ºæ”¿åºœæ¡è³¼ç¶² URL
        function buildGovUrl(record) {
            // æª¢æŸ¥æ‰€æœ‰å¯èƒ½çš„ detail æ¬„ä½
            const detail = record.detail || {};
            
            console.log('æ§‹å»ºé€£çµï¼Œrecord:', record);
            console.log('detail.url:', detail.url);
            console.log('detail.pkPmsMain:', detail.pkPmsMain);
            
            // 1. å„ªå…ˆä½¿ç”¨ detail ä¸­çš„ url æ¬„ä½ï¼ˆå¦‚æœæ˜¯æ”¿åºœæ¡è³¼ç¶²é€£çµï¼‰
            if (detail.url && detail.url.startsWith('https://web.pcc.gov.tw')) {
                console.log('ä½¿ç”¨ detail.url:', detail.url);
                return detail.url;
            }
            
            // 2. æª¢æŸ¥ detail ä¸­çš„ pkPmsMain æ¬„ä½
            if (detail.pkPmsMain) {
                const govUrl = `https://web.pcc.gov.tw/tps/QueryTender/query/searchTenderDetail?pkPmsMain=${detail.pkPmsMain}`;
                console.log('ä½¿ç”¨ pkPmsMain æ§‹å»ºé€£çµ:', govUrl);
                return govUrl;
            }
            
            // 3. æª¢æŸ¥ detail ä¸­çš„æ‰€æœ‰æ¬„ä½ï¼Œæ‰¾å‡º pkPmsMain
            for (const key in detail) {
                if (key.includes('pkPmsMain') || key === 'pkPmsMain') {
                    const pkPmsMain = detail[key];
                    if (pkPmsMain) {
                        const govUrl = `https://web.pcc.gov.tw/tps/QueryTender/query/searchTenderDetail?pkPmsMain=${pkPmsMain}`;
                        console.log('åœ¨æ¬„ä½ä¸­æ‰¾åˆ° pkPmsMain:', key, '=', pkPmsMain, '->', govUrl);
                        return govUrl;
                    }
                }
            }
            
            // 4. æª¢æŸ¥æ‰€æœ‰åŒ…å« "æ±ºæ¨™è³‡æ–™" æˆ– "æ‹›æ¨™è³‡æ–™" çš„æ¬„ä½
            const relevantKeys = Object.keys(detail).filter(key => 
                key.includes('æ±ºæ¨™è³‡æ–™') || key.includes('æ‹›æ¨™è³‡æ–™') || key.includes('æ¡è³¼è³‡æ–™')
            );
            
            for (const key of relevantKeys) {
                const value = detail[key];
                if (typeof value === 'string' && value.includes('pkPmsMain')) {
                    const match = value.match(/pkPmsMain=([A-Za-z0-9]+)/);
                    if (match) {
                        const govUrl = `https://web.pcc.gov.tw/tps/QueryTender/query/searchTenderDetail?pkPmsMain=${match[1]}`;
                        console.log('åœ¨å­—ä¸²ä¸­æ‰¾åˆ° pkPmsMain:', key, '=', value, '->', govUrl);
                        return govUrl;
                    }
                }
            }
            
            // 5. ä½¿ç”¨ record çš„ url æ¬„ä½
            if (record.url && record.url.startsWith('https://web.pcc.gov.tw')) {
                console.log('ä½¿ç”¨ record.url:', record.url);
                return record.url;
            }
            
            // 6. å‚™ç”¨æ–¹æ¡ˆï¼šæ§‹å»º pcc.g0v.ronny.tw çš„ tender.html
            if (record.job_number && record.unit_id && record.date) {
                const dateStr = record.date.toString();
                const filename = record.filename || 'unknown';
                const fallbackUrl = `https://pcc.g0v.ronny.tw/tender.html?unit_id=${record.unit_id}&job_number=${record.job_number}&date=${dateStr}&filename=${filename}`;
                console.log('ä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ:', fallbackUrl);
                return fallbackUrl;
            } else if (record.url) {
                if (record.url.startsWith('http')) {
                    console.log('ä½¿ç”¨ record.url (http):', record.url);
                    return record.url;
                } else {
                    const fallbackUrl = `https://pcc.g0v.ronny.tw${record.url}`;
                    console.log('ä½¿ç”¨ record.url (ç›¸å°è·¯å¾‘):', fallbackUrl);
                    return fallbackUrl;
                }
            }
            
            // 7. æœ€å¾Œå‚™ç”¨æ–¹æ¡ˆ
            console.log('ç„¡æ³•æ§‹å»ºé€£çµï¼Œè¿”å› #');
            return '#';
        }

        // åŸ·è¡Œ Gemini AI åˆ†æ
        async function performGeminiAnalysis(companyName) {
            if (!geminiKey) {
                document.getElementById('geminiAnalysis').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        æœªæä¾› Gemini API Keyï¼Œç„¡æ³•é€²è¡Œ AI åˆ†æ
                    </div>
                `;
                return;
            }

            try {
                // é è™•ç†æ•¸æ“šï¼Œæå–é—œéµè³‡è¨Šä¸¦ç¢ºä¿æ±ºæ¨™é‡‘é¡æ¸…æ™°å¯è¦‹
                const processedData = companyData.slice(0, 20).map(record => {
                    const detail = record.detail || {};
                    
                    // æå–æ±ºæ¨™é‡‘é¡ï¼ˆæŒ‰å„ªå…ˆé †åºï¼‰
                    let awardAmount = null;
                    let amountSource = '';
                    
                    if (detail['æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡']) {
                        awardAmount = detail['æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡'];
                        amountSource = 'æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡';
                    } else if (detail['æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡']) {
                        awardAmount = detail['æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡'];
                        amountSource = 'æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡';
                    } else if (detail['æ¡è³¼è³‡æ–™:æ±ºæ¨™é‡‘é¡']) {
                        awardAmount = detail['æ¡è³¼è³‡æ–™:æ±ºæ¨™é‡‘é¡'];
                        amountSource = 'æ¡è³¼è³‡æ–™:æ±ºæ¨™é‡‘é¡';
                    } else if (detail['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡']) {
                        awardAmount = detail['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡'];
                        amountSource = 'æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡ï¼ˆå‚™ç”¨ï¼‰';
                    }
                    
                    // æå–æ•¸å­—é‡‘é¡
                    let numericAmount = 0;
                    if (awardAmount) {
                        const match = awardAmount.toString().match(/[\d,]+/);
                        if (match) {
                            numericAmount = parseInt(match[0].replace(/,/g, ''));
                        }
                    }
                    
                    return {
                        æ¨™æ¡ˆåç¨±: record.brief?.title || 'æœªçŸ¥',
                        æ¡ˆè™Ÿ: record.job_number,
                        æ©Ÿé—œåç¨±: record.unit_name,
                        æ±ºæ¨™æ—¥æœŸ: record.date,
                        æ¨™æ¡ˆé¡å‹: record.brief?.type || 'æœªçŸ¥',
                        æ±ºæ¨™é‡‘é¡: awardAmount,
                        æ±ºæ¨™é‡‘é¡_æ•¸å­—: numericAmount,
                        é‡‘é¡ä¾†æº: amountSource,
                        æ±ºæ¨™å» å•†: detail['æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:å» å•†åç¨±'] || companyName,
                        ç›¸é—œå…¬å¸: record.brief?.companies?.names || [],
                        // ä¿ç•™å®Œæ•´ detail ä»¥ä¾›æ·±å…¥åˆ†æ
                        detail: detail
                    };
                });
                
                // è®“ Gemini AI ä»¥ç¾…æ°è¨ºæ–·çš„è¦–è§’åˆ†æç«¶çˆ­å°æ‰‹
                const analysisPrompt = `# è§’è‰²è¨­å®š
ä½ æ˜¯ç¾…æ°è¨ºæ–·ï¼ˆRoche Diagnosticsï¼‰çš„å¸‚å ´æƒ…å ±åˆ†æå°ˆå®¶ï¼Œå°ˆé–€è² è²¬åˆ†æç«¶çˆ­å°æ‰‹åœ¨å°ç£æ”¿åºœæ¡è³¼å¸‚å ´çš„è¡¨ç¾ã€‚

# åˆ†æä»»å‹™
è«‹ä»¥ç¾…æ°è¨ºæ–·çš„ç«‹å ´ï¼Œæ·±å…¥åˆ†æç«¶çˆ­å°æ‰‹ã€Œ${companyName}ã€åœ¨è¿‘3å¹´ï¼ˆ${new Date().getFullYear()-2}å¹´è‡³${new Date().getFullYear()}å¹´ï¼‰çš„æ”¿åºœæ¡è³¼å¾—æ¨™æƒ…æ³ã€‚

# æ•¸æ“šä¾†æº
ä»¥ä¸‹æ˜¯ã€Œ${companyName}ã€è¿‘3å¹´çš„å®Œæ•´æ±ºæ¨™è³‡æ–™ï¼ˆå…± ${processedData.length} ç­†ï¼‰ï¼š

${JSON.stringify(processedData, null, 2)}

# åˆ†ææ¶æ§‹

## 1. ç«¶çˆ­å°æ‰‹æ¦‚æ³ï¼ˆ${companyName}ï¼‰
   - è¿‘3å¹´ç¸½å¾—æ¨™é‡‘é¡å’Œæˆé•·è¶¨å‹¢
   - å¸‚å ´å æœ‰ç‡ä¼°ç®—
   - ä¸»è¦ç«¶çˆ­é ˜åŸŸï¼ˆé«”å¤–è¨ºæ–·ã€å…ç–«åˆ†æã€ç”ŸåŒ–åˆ†æç­‰ï¼‰
   - å¾—æ¨™æ¡ˆä»¶è¦æ¨¡åˆ†æï¼ˆå¤§å‹vså°å‹æ¨™æ¡ˆï¼‰

## 2. ç«¶çˆ­å°æ‰‹å„ªå‹¢åˆ†æ
   ### 2.1 ç”¢å“å„ªå‹¢
   - å¾æ¨™æ¡ˆåç¨±åˆ†æå…¶ä¸»æ‰“ç”¢å“ç·š
   - æŠ€è¡“ç‰¹è‰²å’Œå‰µæ–°é»
   - èˆ‡ç¾…æ°ç”¢å“çš„ç›´æ¥ç«¶çˆ­é …ç›®
   
   ### 2.2 å¸‚å ´ç­–ç•¥å„ªå‹¢
   - ç›®æ¨™å®¢æˆ¶ç¾¤åˆ†æï¼ˆé†«å­¸ä¸­å¿ƒã€å€åŸŸé†«é™¢ã€åœ°å€é†«é™¢ï¼‰
   - å®šåƒ¹ç­–ç•¥ï¼ˆå¾æ±ºæ¨™é‡‘é¡æ¨ä¼°ï¼‰
   - å¸‚å ´æ»²é€ç‡è®ŠåŒ–è¶¨å‹¢
   
   ### 2.3 å®¢æˆ¶é—œä¿‚å„ªå‹¢
   - é•·æœŸåˆä½œé†«é™¢æ¸…å–®
   - å®¢æˆ¶å¿ èª åº¦åˆ†æ
   - æ–°å®¢æˆ¶é–‹ç™¼èƒ½åŠ›

## 3. ç«¶çˆ­å°æ‰‹åŠ£å‹¢åˆ†æ
   ### 3.1 ç”¢å“ç·šç¼ºå£
   - å°šæœªæ¶‰è¶³çš„è¨ºæ–·é ˜åŸŸ
   - ç”¢å“çµ„åˆä¸å®Œæ•´ä¹‹è™•
   - æŠ€è¡“é™åˆ¶
   
   ### 3.2 å¸‚å ´è¦†è“‹å¼±é»
   - æœªèƒ½é€²å…¥çš„é‡è¦é†«ç™‚æ©Ÿæ§‹
   - å€åŸŸå¸‚å ´ç©ºç™½é»
   - å®¢æˆ¶æµå¤±æƒ…æ³
   
   ### 3.3 ç­–ç•¥å¼±é»
   - å®šåƒ¹ç«¶çˆ­åŠ›ä¸è¶³ä¹‹è™•
   - æœå‹™å“è³ªå•é¡Œï¼ˆå¦‚æœ‰ï¼‰
   - ä¾›æ‡‰éˆæˆ–äº¤æœŸå•é¡Œ

## 4. ç¾…æ° vs ${companyName} ç›´æ¥å°æ¯”
   - ç”¢å“ç·šå®Œæ•´åº¦å°æ¯”
   - æŠ€è¡“å‰µæ–°èƒ½åŠ›å°æ¯”
   - å¸‚å ´è¦†è“‹ç¯„åœå°æ¯”
   - å®¢æˆ¶æ»¿æ„åº¦æ¨ä¼°å°æ¯”
   - å“ç‰Œå½±éŸ¿åŠ›å°æ¯”

## 5. ç¾…æ°çš„ç«¶çˆ­ç­–ç•¥å»ºè­°
   ### 5.1 é€²æ”»ç­–ç•¥
   - å¦‚ä½•æ¶å¥ªå°æ‰‹ç¾æœ‰å®¢æˆ¶
   - åœ¨å°æ‰‹å¼·å‹¢é ˜åŸŸçš„çªç ´é»
   - ç”¢å“å·®ç•°åŒ–å»ºè­°
   
   ### 5.2 é˜²å®ˆç­–ç•¥
   - å¦‚ä½•éå›ºç¾æœ‰å®¢æˆ¶
   - é é˜²å°æ‰‹çš„ç«¶çˆ­å¨è„…
   - æå‡å®¢æˆ¶è½‰æ›æˆæœ¬
   
   ### 5.3 å¸‚å ´æ©Ÿæœƒ
   - å°æ‰‹æœªè¦†è“‹çš„å¸‚å ´ç©ºé–“
   - æ–°èˆˆéœ€æ±‚çš„æŠŠæ¡
   - æ”¿ç­–æ©Ÿæœƒçš„åˆ©ç”¨

## 6. è¡Œå‹•è¨ˆç•«å»ºè­°
   - çŸ­æœŸï¼ˆ3-6å€‹æœˆï¼‰æ‡‰æ¡å–çš„å…·é«”è¡Œå‹•
   - ä¸­æœŸï¼ˆ6-12å€‹æœˆï¼‰çš„ç­–ç•¥éƒ¨ç½²
   - é•·æœŸï¼ˆ1-3å¹´ï¼‰çš„å¸‚å ´å¸ƒå±€

# åˆ†æè¦æ±‚
1. **å®¢è§€ä½†å…·ç«¶çˆ­æ€§**ï¼šåŸºæ–¼æ•¸æ“šå®¢è§€åˆ†æï¼Œä½†å§‹çµ‚ä»¥ç¾…æ°çš„åˆ©ç›Šç‚ºå‡ºç™¼é»
2. **å¯åŸ·è¡Œæ€§**ï¼šæä¾›å…·é«”ã€å¯æ“ä½œçš„å»ºè­°ï¼Œè€Œéæ³›æ³›è€Œè«‡
3. **æ•¸æ“šæ”¯æ’**ï¼šæ‰€æœ‰åˆ†æéƒ½è¦å¼•ç”¨å…·é«”çš„æ±ºæ¨™æ•¸æ“šä½è­‰
4. **ç­–ç•¥å°å‘**ï¼šä¸åªæ˜¯æè¿°ç¾æ³ï¼Œæ›´è¦æå‡ºå¦‚ä½•åˆ©ç”¨æƒ…å ±åˆ¶å®šç«¶çˆ­ç­–ç•¥
5. **ä¿æŒå°ˆæ¥­**ï¼šä½¿ç”¨å°ˆæ¥­çš„å¸‚å ´åˆ†æè¡“èªï¼Œé«”ç¾ç¾…æ°çš„å°ˆæ¥­æ°´æº–

è«‹ä»¥ç¹é«”ä¸­æ–‡æ’°å¯«å®Œæ•´çš„ç«¶çˆ­æƒ…å ±åˆ†æå ±å‘Šã€‚`;

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-goog-api-key': geminiKey
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: analysisPrompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Gemini API éŒ¯èª¤: ${response.status}`);
                }

                const data = await response.json();
                const analysisText = data.candidates[0].content.parts[0].text;

                document.getElementById('geminiAnalysis').innerHTML = `
                    <div class="analysis-content">
                        <div style="white-space: pre-line; line-height: 1.8; font-size: 1.1rem;">${analysisText}</div>
                    </div>
                `;

            } catch (error) {
                console.error('Gemini åˆ†æéŒ¯èª¤:', error);
                document.getElementById('geminiAnalysis').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        AI åˆ†æå¤±æ•—ï¼š${error.message}
                    </div>
                `;
            }
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            // å¯ä»¥åœ¨é€™è£¡æ·»åŠ è¦–è¦ºåŒ–è¨Šæ¯é¡¯ç¤º
        }

        // æœå°‹æ‰€æœ‰é é¢
        async function searchAllPages(searchType, query) {
            let allResults = [];
            let page = 1;
            const maxPages = 5; // é™åˆ¶æœ€å¤šæœå°‹5é 
            let consecutiveErrors = 0;

            while (page <= maxPages && consecutiveErrors < 2) {
                try {
                    const url = `${API_BASE}/searchby${searchType}?query=${encodeURIComponent(query)}&page=${page}`;
                    console.log(`æœå°‹ç¬¬ ${page} é :`, url);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0'
                        },
                        mode: 'cors',
                        credentials: 'omit',
                        cache: 'default'
                    });
                    
                    console.log(`ç¬¬ ${page} é å›æ‡‰:`, response.status, response.statusText);
                    
                    if (!response.ok) {
                        // å¦‚æœæ˜¯ 403ï¼Œåœ¨ç€è¦½å™¨ç’°å¢ƒä¸­å¯èƒ½ä»ç„¶å¯ä»¥æ­£å¸¸é‹ä½œ
                        if (response.status === 403) {
                            console.warn(`ç¬¬ ${page} é æ”¶åˆ° 403ï¼Œä½†åœ¨ç€è¦½å™¨ä¸­é€™é€šå¸¸æ˜¯æ­£å¸¸çš„`);
                            // 403 é€šå¸¸åªç™¼ç”Ÿåœ¨éç€è¦½å™¨ç’°å¢ƒï¼Œæ‰€ä»¥é€™è£¡æˆ‘å€‘è¨˜éŒ„ä½†ä¸æ‹‹å‡ºéŒ¯èª¤
                            consecutiveErrors++;
                            
                            // å¦‚æœæ˜¯ç¬¬ä¸€é å°± 403ï¼Œå¯èƒ½çœŸçš„æœ‰å•é¡Œ
                            if (page === 1) {
                                console.error('ç¬¬ä¸€é å°±æ”¶åˆ° 403ï¼Œå¯èƒ½ç¢ºå¯¦æœ‰ API é€£æ¥å•é¡Œ');
                                throw new Error('API é€£æ¥è¢«æ‹’çµ•ï¼ˆ403ï¼‰');
                            }
                        } else if (response.status === 404) {
                            console.log(`ç¬¬ ${page} é æ²’æœ‰æ›´å¤šè³‡æ–™`);
                            break;
                        } else {
                            console.warn(`ç¬¬ ${page} é å›æ‡‰ç•°å¸¸: ${response.status}`);
                            consecutiveErrors++;
                        }
                        
                        // å¦‚æœé€£çºŒéŒ¯èª¤ï¼Œåœæ­¢æœå°‹
                        if (consecutiveErrors >= 2) {
                            console.warn('é€£çºŒéŒ¯èª¤å¤ªå¤šï¼Œåœæ­¢æœå°‹');
                            break;
                        }
                        page++;
                        continue;
                    }
                    
                    // é‡ç½®éŒ¯èª¤è¨ˆæ•¸
                    consecutiveErrors = 0;
                    
                    const data = await response.json();
                    const records = data.records || [];
                    
                    console.log(`ç¬¬ ${page} é çµæœ:`, records.length, 'ç­†');
                    
                    if (records.length === 0) {
                        console.log('æ²’æœ‰æ›´å¤šçµæœï¼Œåœæ­¢æœå°‹');
                        break;
                    }
                    
                    allResults = allResults.concat(records);
                    page++;
                    
                } catch (error) {
                    console.error(`æœå°‹ç¬¬ ${page} é éŒ¯èª¤:`, error);
                    consecutiveErrors++;
                    
                    // ç¶²è·¯éŒ¯èª¤çš„è©³ç´°è¨ºæ–·
                    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        console.error('ç¶²è·¯è«‹æ±‚å¤±æ•— - å¯èƒ½æ˜¯ CORSã€ç¶²è·¯å•é¡Œæˆ– API æœå‹™ç•°å¸¸');
                        
                        // å¦‚æœæ˜¯ç¬¬ä¸€é å°±å¤±æ•—ï¼Œé€™æ˜¯åš´é‡å•é¡Œ
                        if (page === 1) {
                            throw new Error('ç„¡æ³•é€£æ¥åˆ° API æœå‹™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–ç¨å¾Œå†è©¦');
                        }
                    }
                    
                    // å¦‚æœå·²ç¶“æœ‰ä¸€äº›çµæœï¼Œå°±è¿”å›é€™äº›çµæœ
                    if (allResults.length > 0) {
                        console.log(`é›–ç„¶é‡åˆ°éŒ¯èª¤ï¼Œä½†å·²å–å¾— ${allResults.length} ç­†çµæœ`);
                        break;
                    }
                    
                    // å¦‚æœæ²’æœ‰ä»»ä½•çµæœä¸”é€£çºŒéŒ¯èª¤ï¼Œæ‹‹å‡ºéŒ¯èª¤
                    if (consecutiveErrors >= 2) {
                        throw error;
                    }
                    
                    page++;
                }
            }

            console.log(`ç¸½å…±æœå°‹åˆ° ${allResults.length} ç­†çµæœï¼ˆæœå°‹äº† ${page-1} é ï¼‰`);
            return allResults;
        }

        // é¡¯ç¤ºéŒ¯èª¤
        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        // åˆ†äº«åˆ° Line
        function shareToLine(title, unitName, govUrl) {
            const message = `ğŸ“‹ ${title}\nğŸ¢ æ©Ÿé—œï¼š${unitName}\nğŸ”— é€£çµï¼š${govUrl}`;
            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
            window.open(lineUrl, '_blank');
            console.log('å·²é–‹å•Ÿ Line åˆ†äº«');
        }

        // åˆ†äº«åˆ° Gmail
        function shareToGmail(title, unitName, jobNumber, govUrl) {
            const subject = `æ”¿åºœæ¡è³¼æ¨™æ¡ˆï¼š${title}`;
            const body = `
æ”¿åºœæ¡è³¼æ¨™æ¡ˆè³‡è¨Š

æ¨™æ¡ˆåç¨±ï¼š${title}
æ©Ÿé—œåç¨±ï¼š${unitName}
æ¡ˆè™Ÿï¼š${jobNumber}

è©³ç´°è³‡æ–™é€£çµï¼š
${govUrl}

---
æ­¤éƒµä»¶ç”±æ”¿åºœæ¡è³¼æ¨™æ¡ˆæŸ¥è©¢ç³»çµ±è‡ªå‹•ç”¢ç”Ÿ
            `.trim();
            
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(gmailUrl, '_blank');
            console.log('å·²é–‹å•Ÿ Gmail');
        }

        // è¤‡è£½é€£çµ
        async function copyLink(govUrl, title) {
            try {
                await navigator.clipboard.writeText(govUrl);
                alert(`å·²è¤‡è£½ã€Œ${title}ã€çš„é€£çµåˆ°å‰ªè²¼ç°¿`);
            } catch (error) {
                // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨å‚³çµ±çš„è¤‡è£½æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = govUrl;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    alert(`å·²è¤‡è£½ã€Œ${title}ã€çš„é€£çµåˆ°å‰ªè²¼ç°¿`);
                } catch (err) {
                    alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½é€£çµ');
                }
                
                document.body.removeChild(textArea);
            }
        }

        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type) {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
