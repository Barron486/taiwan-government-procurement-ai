<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公司得標分析（近3年）- 政府採購標案查詢系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', sans-serif;
        }
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 30px;
        }
        .company-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        .analysis-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .loading-spinner {
            text-align: center;
            padding: 40px;
        }
        .analysis-result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        .year-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.2s ease;
        }
        .year-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- 公司標題區域 -->
            <div class="company-header">
                <h1><i class="fas fa-building me-3"></i><span id="companyName">載入中...</span></h1>
                <p class="mb-1">競爭對手情報分析報告（近3年）</p>
                <p class="mb-0"><small><i class="fas fa-shield-alt me-1"></i>羅氏診斷 Roche Diagnostics 市場情報分析</small></p>
            </div>

            <!-- 載入中 -->
            <div id="loadingSection" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">載入中...</span>
                </div>
                <p class="mt-3 mb-0"><i class="fas fa-robot me-2"></i>Gemini AI 正在分析公司得標資料...</p>
            </div>

            <!-- 分析結果區域 -->
            <div id="analysisSection" style="display: none;">
                <!-- 基本統計 -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="totalTenders">0</div>
                            <div>總得標案件</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="totalAmount">0</div>
                            <div>總得標金額</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="avgAmount">0</div>
                            <div>平均得標金額</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="yearRange">0</div>
                            <div>分析年份範圍</div>
                        </div>
                    </div>
                </div>

                <!-- 年度統計 -->
                <div class="card analysis-card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>年度得標統計</h5>
                    </div>
                    <div class="card-body">
                        <div id="yearlyStats"></div>
                    </div>
                </div>

                <!-- Gemini AI 分析 -->
                <div class="card analysis-card">
                    <div class="card-header" style="background: linear-gradient(135deg, #0066cc 0%, #003d7a 100%); color: white;">
                        <h5><i class="fas fa-shield-alt me-2"></i>羅氏診斷 - 競爭對手情報分析</h5>
                        <small>Powered by Gemini AI</small>
                    </div>
                    <div class="card-body">
                        <div id="geminiAnalysis" class="analysis-result">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin me-2"></i>正在進行 AI 分析...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 得標案件清單 -->
                <div class="card analysis-card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>得標案件清單</h5>
                    </div>
                    <div class="card-body">
                        <div id="tenderList"></div>
                    </div>
                </div>
            </div>

            <!-- 錯誤訊息 -->
            <div id="errorSection" style="display: none;">
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>分析失敗</h5>
                    <p id="errorMessage"></p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-redo me-1"></i>重新載入
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'https://pcc-api.openfun.app/api';
        let companyData = null;
        let geminiKey = null;

        // 從 URL 參數獲取公司名稱和 Gemini API Key
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                companyName: urlParams.get('company') || '',
                geminiKey: urlParams.get('key') || ''
            };
        }

        // 初始化頁面
        async function initPage() {
            const { companyName, geminiKey: key } = getUrlParams();
            
            if (!companyName) {
                showError('未指定公司名稱');
                return;
            }

            if (!key) {
                showError('未提供 Gemini API Key');
                return;
            }

            geminiKey = key;
            document.getElementById('companyName').textContent = companyName;
            
            try {
                await loadCompanyData(companyName);
                await performGeminiAnalysis(companyName);
            } catch (error) {
                console.error('初始化錯誤:', error);
                // 提供更友善的錯誤訊息和重試選項
                showError(`初始化失敗：${error.message}
                
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-redo me-1"></i>重新載入
                    </button>
                    <button class="btn btn-secondary ms-2" onclick="window.close()">
                        <i class="fas fa-times me-1"></i>關閉
                    </button>
                </div>`);
            }
        }

        // 載入公司資料
        async function loadCompanyData(companyName) {
            try {
                showMessage('正在搜尋公司得標資料...', 'info');
                
                let results = [];
                let apiConnectionError = false;
                
                // 嘗試多種搜尋方式
                const searchStrategies = [
                    { type: 'companyname', query: companyName, desc: '完整公司名稱' },
                    { type: 'companyname', query: companyName.replace(/股份有限公司|有限公司|企業有限公司|企業股份有限公司/g, '').trim(), desc: '簡化公司名稱' },
                    { type: 'companyname', query: companyName.split(' ')[0], desc: '公司名稱第一部分' },
                    { type: 'companyname', query: companyName.replace(/\(.*\)/g, '').trim(), desc: '移除括號內容' },
                    { type: 'companyname', query: companyName.replace(/股份有限公司|有限公司|企業有限公司|企業股份有限公司|股份有限公司|有限公司/g, '').trim(), desc: '移除所有公司類型' },
                    { type: 'companyname', query: companyName.split('(')[0].trim(), desc: '移除括號前部分' }
                ];
                
                // 如果公司名稱包含英文，也嘗試搜尋英文部分
                const englishMatch = companyName.match(/\(([^)]+)\)/);
                if (englishMatch) {
                    searchStrategies.push({ type: 'companyname', query: englishMatch[1], desc: '英文公司名稱' });
                    searchStrategies.push({ type: 'companyname', query: englishMatch[1].split(' ')[0], desc: '英文公司名稱第一部分' });
                }
                
                // 嘗試搜尋關鍵字
                const keywords = companyName.match(/[\u4e00-\u9fff]+/g); // 提取中文字符
                if (keywords && keywords.length > 0) {
                    keywords.forEach(keyword => {
                        if (keyword.length >= 2) {
                            searchStrategies.push({ type: 'companyname', query: keyword, desc: `關鍵字: ${keyword}` });
                        }
                    });
                }
                
                // 嘗試各種搜尋策略
                for (const strategy of searchStrategies) {
                    if (strategy.query && strategy.query.length > 1) {
                        try {
                            console.log(`嘗試搜尋策略: ${strategy.desc} - "${strategy.query}"`);
                            const strategyResults = await searchAllPages(strategy.type, strategy.query);
                            console.log(`${strategy.desc} 搜尋結果:`, strategyResults.length, '筆');
                            
                            if (strategyResults && strategyResults.length > 0) {
                                results = results.concat(strategyResults);
                                // 如果成功取得結果，表示 API 連接正常
                                apiConnectionError = false;
                            }
                        } catch (error) {
                            console.warn(`${strategy.desc} 搜尋失敗:`, error);
                            // 記錄連接錯誤，但不立即中止
                            if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                                apiConnectionError = true;
                                console.error('API連接失敗，可能是網路問題或API服務暫時無法使用');
                            }
                        }
                    }
                }
                
                // 去重複
                const uniqueResults = [];
                const seen = new Set();
                for (const result of results) {
                    const key = `${result.unit_id}-${result.job_number}-${result.date}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueResults.push(result);
                    }
                }
                
                console.log('去重複後總結果:', uniqueResults.length, '筆');
                
                if (uniqueResults.length === 0) {
                    // 提供更詳細的診斷資訊
                    console.log('沒有找到任何結果，apiConnectionError:', apiConnectionError);
                    
                    let diagnosticInfo = `未找到「${companyName}」的相關標案紀錄。\n\n`;
                    
                    if (apiConnectionError) {
                        // API 連接問題 - 提供診斷和測試連結
                        diagnosticInfo += `⚠️ 偵測到可能的 API 連接問題\n\n`;
                        diagnosticInfo += `請先測試 API 是否正常運作：\n`;
                        diagnosticInfo += `1. 開啟瀏覽器開發者工具 (按 F12)\n`;
                        diagnosticInfo += `2. 查看 Console 和 Network 標籤\n`;
                        diagnosticInfo += `3. 或使用我們的調試工具：debug_api.html\n\n`;
                        diagnosticInfo += `如果 API 確實無法連接：\n`;
                        diagnosticInfo += `- 可能是網路問題\n`;
                        diagnosticInfo += `- 可能是 Cloudflare 防護（請在瀏覽器中開啟，而不是使用 curl 等工具）\n`;
                        diagnosticInfo += `- 建議稍後再試\n`;
                    } else {
                        // 找不到資料 - 提供搜尋建議
                        diagnosticInfo += `✓ API 連接正常，但未找到相關記錄\n\n`;
                        diagnosticInfo += `已嘗試的搜尋策略：\n`;
                        diagnosticInfo += searchStrategies.slice(0, 5).map(s => `- ${s.desc}: "${s.query}"`).join('\n');
                        if (searchStrategies.length > 5) {
                            diagnosticInfo += `\n... 以及其他 ${searchStrategies.length - 5} 個變體\n`;
                        }
                        diagnosticInfo += `\n\n建議解決方式：\n`;
                        diagnosticInfo += `1. 在主頁面搜尋相關標案，然後點擊「相關公司」標籤\n`;
                        diagnosticInfo += `2. 確認公司名稱是否正確\n`;
                        diagnosticInfo += `3. 該公司可能真的沒有政府採購記錄\n`;
                    }
                    
                    throw new Error(diagnosticInfo);
                }

                // 動態過濾近3年的案件（從今天往前推3年）
                const currentDate = new Date();
                const threeYearsAgo = new Date(currentDate);
                threeYearsAgo.setFullYear(currentDate.getFullYear() - 3);
                
                console.log('當前日期:', currentDate.toLocaleDateString());
                console.log('三年前日期:', threeYearsAgo.toLocaleDateString());
                
                const recentResults = uniqueResults.filter(record => {
                    if (!record.date) {
                        console.log('記錄缺少日期:', record.job_number);
                        return false;
                    }
                    
                    try {
                        const dateStr = record.date.toString();
                        // 解析 YYYYMMDD 格式的日期
                        const year = parseInt(dateStr.substring(0, 4));
                        const month = parseInt(dateStr.substring(4, 6));
                        const day = parseInt(dateStr.substring(6, 8));
                        
                        // 驗證日期有效性
                        if (isNaN(year) || isNaN(month) || isNaN(day)) {
                            console.log('無效日期格式:', dateStr, record.job_number);
                            return false;
                        }
                        
                        const recordDate = new Date(year, month - 1, day);
                        
                        // 檢查日期是否在近3年範圍內
                        const isInRange = recordDate >= threeYearsAgo && recordDate <= currentDate;
                        
                        if (!isInRange) {
                            console.log('記錄不在近3年範圍:', {
                                job_number: record.job_number,
                                date: dateStr,
                                recordDate: recordDate.toLocaleDateString(),
                                isInRange
                            });
                        }
                        
                        return isInRange;
                    } catch (error) {
                        console.error('日期解析錯誤:', error, record.date, record.job_number);
                        return false;
                    }
                });
                
                console.log('近3年案件數量:', recentResults.length, '筆');
                
                // 過濾出決標案件（排除無法決標公告）
                const tenderResults = recentResults.filter(r => {
                    const type = r.brief?.type || '';
                    return type.includes('決標') && !type.includes('無法決標');
                });
                
                console.log('近3年決標案件數量:', tenderResults.length, '筆');
                
                if (tenderResults.length === 0) {
                    // 如果沒有決標案件，顯示所有近3年的案件
                    console.log('沒有決標案件，顯示所有近3年的案件');
                    const allResults = recentResults.slice(0, 20);
                    companyData = allResults;
                    
                    // 計算統計資料（包含所有案件）
                    calculateStats(allResults);
                    
                    // 顯示年度統計（包含所有案件）
                    displayYearlyStats(allResults);
                    
                    // 顯示案件清單（包含所有案件）
                    displayTenderList(allResults);
                    
                    // 隱藏載入中，顯示分析結果
                    document.getElementById('loadingSection').style.display = 'none';
                    document.getElementById('analysisSection').style.display = 'block';
                    
                    // 顯示警告訊息
                    showMessage(`找到 ${allResults.length} 筆近3年相關標案，但沒有決標案件。將顯示所有找到的案件。`, 'warning');
                    return;
                }

                // 獲取每個標案的完整詳細資料（取所有近3年決標案件）
                showMessage(`正在載入標案詳細資料... (共 ${tenderResults.length} 筆)`, 'info');
                
                // 為了確保完整性，我們取所有近3年的決標案件（最多100筆）
                const recordsToProcess = tenderResults.slice(0, Math.min(100, tenderResults.length));
                console.log(`準備處理 ${recordsToProcess.length} 筆決標案件`);
                
                const detailedResults = await Promise.all(
                    recordsToProcess.map(async (record) => {
                        try {
                            const detailResponse = await fetch(`${API_BASE}/tender?unit_id=${record.unit_id}&job_number=${record.job_number}`);
                            if (detailResponse.ok) {
                                const detailData = await detailResponse.json();
                                const detailRecord = detailData.records?.[0] || detailData;
                                
                                // 智能合併詳細資料
                                let mergedDetail = record.detail || {};
                                
                                // 如果 detailRecord 有 detail 屬性，合併它
                                if (detailRecord.detail && typeof detailRecord.detail === 'object') {
                                    mergedDetail = { ...mergedDetail, ...detailRecord.detail };
                                }
                                // 如果 detailRecord 本身就是 detail 對象（包含決標相關欄位）
                                else if (detailRecord && typeof detailRecord === 'object') {
                                    // 檢查是否包含決標相關欄位
                                    const hasDetailFields = Object.keys(detailRecord).some(key => 
                                        key.includes('決標') || key.includes('投標') || key.includes('採購') || key.includes('機關')
                                    );
                                    if (hasDetailFields) {
                                        mergedDetail = { ...mergedDetail, ...detailRecord };
                                    }
                                }
                                
                                const mergedRecord = {
                                    ...record,
                                    detail: mergedDetail,
                                    url: detailRecord.url || record.url,
                                    pkPmsMain: detailRecord.pkPmsMain || record.pkPmsMain
                                };
                                
                                console.log(`合併 ${record.job_number} 詳細資料:`, {
                                    original_detail_keys: Object.keys(record.detail || {}),
                                    detailRecord_keys: Object.keys(detailRecord),
                                    detailRecord_detail_keys: detailRecord.detail ? Object.keys(detailRecord.detail) : [],
                                    merged_detail_keys: Object.keys(mergedDetail),
                                    has_award_amount: !!(mergedDetail['決標資料:總決標金額'] || mergedDetail['投標廠商:投標廠商1:決標金額'])
                                });
                                return mergedRecord;
                            }
                        } catch (error) {
                            console.error(`載入 ${record.job_number} 詳細資料錯誤:`, error);
                        }
                        return record;
                    })
                );

                companyData = detailedResults;
                
                // 計算統計資料
                calculateStats(detailedResults);
                
                // 顯示年度統計
                displayYearlyStats(detailedResults);
                
                // 顯示得標案件清單
                displayTenderList(detailedResults);
                
                // 隱藏載入中，顯示分析結果
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('analysisSection').style.display = 'block';
                
            } catch (error) {
                console.error('載入公司資料錯誤:', error);
                throw error;
            }
        }

        // 計算統計資料
        function calculateStats(results) {
            let totalAmount = 0;
            let validAmountCount = 0;
            const years = new Set();
            
            results.forEach(record => {
                const year = record.date ? record.date.toString().substring(0, 4) : '未知';
                years.add(year);
                
                // 優先使用決標資料:總決標金額
                let amount = '0';
                if (record.detail?.['決標資料:總決標金額']) {
                    amount = record.detail['決標資料:總決標金額'];
                } else if (record.detail?.['投標廠商:投標廠商1:決標金額']) {
                    amount = record.detail['投標廠商:投標廠商1:決標金額'];
                } else if (record.detail?.['採購資料:預算金額']) {
                    amount = record.detail['採購資料:預算金額'];
                }
                
                const amountMatch = amount.toString().match(/[\d,]+/);
                if (amountMatch) {
                    const numericAmount = parseInt(amountMatch[0].replace(/,/g, ''));
                    totalAmount += numericAmount;
                    validAmountCount++;
                }
            });

            const avgAmount = validAmountCount > 0 ? Math.round(totalAmount / validAmountCount) : 0;
            const yearRange = years.size;

            document.getElementById('totalTenders').textContent = results.length;
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + ' 元';
            document.getElementById('avgAmount').textContent = avgAmount.toLocaleString() + ' 元';
            document.getElementById('yearRange').textContent = yearRange + ' 年';
        }

        // 顯示年度統計（近3年）
        function displayYearlyStats(results) {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            
            // 動態計算近3年區間（從當前日期往前推3年）
            const threeYearsAgo = new Date(currentDate);
            threeYearsAgo.setFullYear(currentYear - 3);
            
            console.log('年度統計：當前日期', currentDate.toLocaleDateString());
            console.log('年度統計：三年前日期', threeYearsAgo.toLocaleDateString());
            
            const yearlyStats = {};
            const allYears = new Set();
            
            // 先收集所有有資料的年份
            results.forEach(record => {
                if (record.date) {
                    const dateStr = record.date.toString();
                    const year = dateStr.substring(0, 4);
                    const yearNum = parseInt(year);
                    
                    // 驗證年份有效性
                    if (!isNaN(yearNum) && yearNum >= 2000 && yearNum <= currentYear) {
                        allYears.add(yearNum);
                    }
                }
            });
            
            // 找出近3年範圍內的所有年份（從三年前的年份到當前年份）
            const threeYearsAgoYear = threeYearsAgo.getFullYear();
            const recentYears = Array.from(allYears).filter(year => {
                return year >= threeYearsAgoYear && year <= currentYear;
            }).sort((a, b) => b - a);
            
            console.log('所有年份:', Array.from(allYears).sort((a, b) => b - a));
            console.log('近3年年份:', recentYears);
            
            console.log('近3年範圍內找到的年份:', recentYears);
            
            // 統計各年度資料
            results.forEach(record => {
                if (!record.date) return;
                
                const year = record.date.toString().substring(0, 4);
                const yearNum = parseInt(year);
                
                // 只處理近3年範圍內的資料
                if (!recentYears.includes(yearNum)) {
                    return;
                }
                
                // 優先使用決標金額，備用預算金額
                let amount = '0';
                if (record.detail?.['決標資料:總決標金額']) {
                    amount = record.detail['決標資料:總決標金額'];
                } else if (record.detail?.['投標廠商:投標廠商1:決標金額']) {
                    amount = record.detail['投標廠商:投標廠商1:決標金額'];
                } else if (record.detail?.['採購資料:決標金額']) {
                    amount = record.detail['採購資料:決標金額'];
                } else if (record.detail?.['採購資料:預算金額']) {
                    amount = record.detail['採購資料:預算金額'];
                }
                
                if (!yearlyStats[year]) {
                    yearlyStats[year] = { count: 0, totalAmount: 0 };
                }
                yearlyStats[year].count++;
                
                const amountMatch = amount.toString().match(/[\d,]+/);
                if (amountMatch) {
                    const numericAmount = parseInt(amountMatch[0].replace(/,/g, ''));
                    yearlyStats[year].totalAmount += numericAmount;
                }
            });

            // 確保近3年都有資料（即使為0）
            recentYears.forEach(year => {
                if (!yearlyStats[year]) {
                    yearlyStats[year] = { count: 0, totalAmount: 0 };
                }
            });

            // 計算近3年總計
            let total3YearCount = 0;
            let total3YearAmount = 0;
            
            recentYears.forEach(year => {
                const stats = yearlyStats[year];
                total3YearCount += stats.count;
                total3YearAmount += stats.totalAmount;
            });
            
            const yearlyHtml = `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-chart-line me-2"></i>近3年得標統計總覽 (${recentYears[recentYears.length-1] || currentYear-2}年 - ${currentYear}年)</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>總案件數：</strong>${total3YearCount} 件
                                </div>
                                <div class="col-md-6">
                                    <strong>總決標金額：</strong><span class="text-success">${total3YearAmount.toLocaleString()}</span> 元
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ${recentYears.map(year => {
                    const stats = yearlyStats[year];
                    const isCurrentYear = year === currentYear;
                    const yearLabel = isCurrentYear ? `${year}年（今年）` : `${year}年`;
                    const yearClass = isCurrentYear ? 'text-primary' : 'text-secondary';
                    
                    return `
                        <div class="year-card mb-3">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6 class="${yearClass}">${yearLabel}</h6>
                                </div>
                                <div class="col-md-3">
                                    <strong>${stats.count}</strong> 件案件
                                </div>
                                <div class="col-md-6">
                                    <strong class="text-success">${stats.totalAmount.toLocaleString()}</strong> 元
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;

            document.getElementById('yearlyStats').innerHTML = yearlyHtml;
        }

        // 顯示得標案件清單（顯示所有近3年的案件）
        function displayTenderList(results) {
            console.log('顯示得標案件清單，共', results.length, '筆資料');
            
            // 顯示所有近3年的案件（最多100筆）
            const displayCount = Math.min(100, results.length);
            console.log(`準備顯示 ${displayCount} 筆案件`);
            
            const tenderHtml = results.slice(0, displayCount).map((record, index) => {
                const brief = record.brief || {};
                const detail = record.detail || {};
                const dateStr = record.date ? record.date.toString() : '';
                const formattedDate = dateStr ? `${dateStr.substring(0,4)}年${dateStr.substring(4,6)}月${dateStr.substring(6,8)}日` : '未知';
                
                // 調試：輸出 detail 所有欄位
                console.log(`標案 ${index + 1} (${record.job_number}):`, {
                    detail_keys: Object.keys(detail),
                    url: record.url,
                    has_pkPmsMain: !!detail.pkPmsMain
                });
                
                // 構建政府採購網連結
                const govUrl = buildGovUrl(record);
                console.log(`標案 ${index + 1} 連結:`, govUrl);
                console.log(`標案 ${index + 1} 完整record:`, record);
                
                // 獲取金額（優先使用決標金額，備用預算金額）
                let tenderAmount = '金額未知';
                let amountType = '';
                
                // 1. 優先使用決標資料:總決標金額
                if (detail['決標資料:總決標金額']) {
                    tenderAmount = detail['決標資料:總決標金額'];
                    amountType = '決標金額';
                    console.log(`找到決標金額: 決標資料:總決標金額 = ${tenderAmount}`);
                }
                // 2. 備用：使用投標廠商的決標金額
                else if (detail['投標廠商:投標廠商1:決標金額']) {
                    tenderAmount = detail['投標廠商:投標廠商1:決標金額'];
                    amountType = '決標金額';
                    console.log(`找到決標金額: 投標廠商:投標廠商1:決標金額 = ${tenderAmount}`);
                }
                // 3. 備用：使用採購資料的決標金額
                else if (detail['採購資料:決標金額']) {
                    tenderAmount = detail['採購資料:決標金額'];
                    amountType = '決標金額';
                    console.log(`找到決標金額: 採購資料:決標金額 = ${tenderAmount}`);
                }
                // 4. 備用：使用預算金額
                else if (detail['採購資料:預算金額']) {
                    tenderAmount = detail['採購資料:預算金額'];
                    amountType = '預算金額';
                    console.log(`找到預算金額: 採購資料:預算金額 = ${tenderAmount}`);
                }
                // 5. 最後備用：遍歷所有欄位尋找金額
                else {
                    for (const key in detail) {
                        if (key.includes('決標金額') || key.includes('總決標金額') || key.includes('得標金額')) {
                            const value = detail[key];
                            if (value && value.toString().match(/[\d,]+/)) {
                                tenderAmount = value;
                                amountType = '決標金額';
                                console.log(`找到金額欄位: ${key} = ${value}`);
                                break;
                            }
                        }
                    }
                }
                
                console.log(`標案 ${index + 1} 金額:`, tenderAmount);
                
                // 獲取標案案號
                const jobNumber = record.job_number || '未知案號';
                
                // 獲取決標日期
                const tenderDate = detail['決標資料:決標日期'] || detail['無法決標公告:無法決標公告日期'] || formattedDate;
                
                // 獲取第幾次決標
                const tenderSequence = detail['招標資料:新增公告傳輸次數'] || detail['無法決標公告:新增公告傳輸次數'] || '1';
                
                return `
                    <div class="card mb-2">
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="card-title">
                                        <a href="${govUrl}" target="_blank" class="text-decoration-none text-primary">
                                            ${brief.title || '無標題'}
                                            <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                                        </a>
                                    </h6>
                                    <p class="card-text text-muted mb-1">
                                        <i class="fas fa-hashtag me-1"></i>案號: ${jobNumber} | 
                                        <i class="fas fa-calendar me-1"></i>決標日期: ${tenderDate} | 
                                        <i class="fas fa-sort-numeric-up me-1"></i>第${tenderSequence}次決標
                                    </p>
                                    <p class="card-text text-muted mb-1">
                                        <i class="fas fa-building me-1"></i>${record.unit_name || '未知機關'}
                                    </p>
                                    <div class="mt-2">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="分享標案">
                                                <i class="fas fa-share-alt me-1"></i>分享
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="shareToLine('${(brief.title || '無標題').replace(/'/g, "\\'")}', '${(record.unit_name || '未知機關').replace(/'/g, "\\'")}', '${govUrl}')">
                                                    <i class="fab fa-line text-success me-2"></i>分享到 Line
                                                </a></li>
                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="shareToGmail('${(brief.title || '無標題').replace(/'/g, "\\'")}', '${(record.unit_name || '未知機關').replace(/'/g, "\\'")}', '${jobNumber}', '${govUrl}')">
                                                    <i class="fas fa-envelope text-danger me-2"></i>分享到 Gmail
                                                </a></li>
                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="copyLink('${govUrl}', '${(brief.title || '無標題').replace(/'/g, "\\'")}')">
                                                    <i class="fas fa-copy text-primary me-2"></i>複製連結
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge ${brief.type && brief.type.includes('決標') ? 'bg-danger' : 'bg-primary'}">${brief.type || '未知類型'}</span>
                                    <br>
                                    <strong class="text-success">${tenderAmount}</strong>
                                    ${amountType ? `<br><small class="text-muted">${amountType}</small>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // 添加統計資訊
            const statsHtml = `
                <div class="alert alert-info mb-3">
                    <h6><i class="fas fa-info-circle me-2"></i>資料統計</h6>
                    <p class="mb-0">顯示 <strong>${displayCount}</strong> 筆近3年決標案件（共 ${results.length} 筆）</p>
                </div>
            `;
            
            document.getElementById('tenderList').innerHTML = statsHtml + tenderHtml;
        }

        // 構建政府採購網 URL
        function buildGovUrl(record) {
            // 檢查所有可能的 detail 欄位
            const detail = record.detail || {};
            
            console.log('構建連結，record:', record);
            console.log('detail.url:', detail.url);
            console.log('detail.pkPmsMain:', detail.pkPmsMain);
            
            // 1. 優先使用 detail 中的 url 欄位（如果是政府採購網連結）
            if (detail.url && detail.url.startsWith('https://web.pcc.gov.tw')) {
                console.log('使用 detail.url:', detail.url);
                return detail.url;
            }
            
            // 2. 檢查 detail 中的 pkPmsMain 欄位
            if (detail.pkPmsMain) {
                const govUrl = `https://web.pcc.gov.tw/tps/QueryTender/query/searchTenderDetail?pkPmsMain=${detail.pkPmsMain}`;
                console.log('使用 pkPmsMain 構建連結:', govUrl);
                return govUrl;
            }
            
            // 3. 檢查 detail 中的所有欄位，找出 pkPmsMain
            for (const key in detail) {
                if (key.includes('pkPmsMain') || key === 'pkPmsMain') {
                    const pkPmsMain = detail[key];
                    if (pkPmsMain) {
                        const govUrl = `https://web.pcc.gov.tw/tps/QueryTender/query/searchTenderDetail?pkPmsMain=${pkPmsMain}`;
                        console.log('在欄位中找到 pkPmsMain:', key, '=', pkPmsMain, '->', govUrl);
                        return govUrl;
                    }
                }
            }
            
            // 4. 檢查所有包含 "決標資料" 或 "招標資料" 的欄位
            const relevantKeys = Object.keys(detail).filter(key => 
                key.includes('決標資料') || key.includes('招標資料') || key.includes('採購資料')
            );
            
            for (const key of relevantKeys) {
                const value = detail[key];
                if (typeof value === 'string' && value.includes('pkPmsMain')) {
                    const match = value.match(/pkPmsMain=([A-Za-z0-9]+)/);
                    if (match) {
                        const govUrl = `https://web.pcc.gov.tw/tps/QueryTender/query/searchTenderDetail?pkPmsMain=${match[1]}`;
                        console.log('在字串中找到 pkPmsMain:', key, '=', value, '->', govUrl);
                        return govUrl;
                    }
                }
            }
            
            // 5. 使用 record 的 url 欄位
            if (record.url && record.url.startsWith('https://web.pcc.gov.tw')) {
                console.log('使用 record.url:', record.url);
                return record.url;
            }
            
            // 6. 備用方案：構建 pcc.g0v.ronny.tw 的 tender.html
            if (record.job_number && record.unit_id && record.date) {
                const dateStr = record.date.toString();
                const filename = record.filename || 'unknown';
                const fallbackUrl = `https://pcc.g0v.ronny.tw/tender.html?unit_id=${record.unit_id}&job_number=${record.job_number}&date=${dateStr}&filename=${filename}`;
                console.log('使用備用方案:', fallbackUrl);
                return fallbackUrl;
            } else if (record.url) {
                if (record.url.startsWith('http')) {
                    console.log('使用 record.url (http):', record.url);
                    return record.url;
                } else {
                    const fallbackUrl = `https://pcc.g0v.ronny.tw${record.url}`;
                    console.log('使用 record.url (相對路徑):', fallbackUrl);
                    return fallbackUrl;
                }
            }
            
            // 7. 最後備用方案
            console.log('無法構建連結，返回 #');
            return '#';
        }

        // 執行 Gemini AI 分析
        async function performGeminiAnalysis(companyName) {
            if (!geminiKey) {
                document.getElementById('geminiAnalysis').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        未提供 Gemini API Key，無法進行 AI 分析
                    </div>
                `;
                return;
            }

            try {
                // 預處理數據，提取關鍵資訊並確保決標金額清晰可見
                const processedData = companyData.slice(0, 20).map(record => {
                    const detail = record.detail || {};
                    
                    // 提取決標金額（按優先順序）
                    let awardAmount = null;
                    let amountSource = '';
                    
                    if (detail['決標資料:總決標金額']) {
                        awardAmount = detail['決標資料:總決標金額'];
                        amountSource = '決標資料:總決標金額';
                    } else if (detail['投標廠商:投標廠商1:決標金額']) {
                        awardAmount = detail['投標廠商:投標廠商1:決標金額'];
                        amountSource = '投標廠商:投標廠商1:決標金額';
                    } else if (detail['採購資料:決標金額']) {
                        awardAmount = detail['採購資料:決標金額'];
                        amountSource = '採購資料:決標金額';
                    } else if (detail['採購資料:預算金額']) {
                        awardAmount = detail['採購資料:預算金額'];
                        amountSource = '採購資料:預算金額（備用）';
                    }
                    
                    // 提取數字金額
                    let numericAmount = 0;
                    if (awardAmount) {
                        const match = awardAmount.toString().match(/[\d,]+/);
                        if (match) {
                            numericAmount = parseInt(match[0].replace(/,/g, ''));
                        }
                    }
                    
                    return {
                        標案名稱: record.brief?.title || '未知',
                        案號: record.job_number,
                        機關名稱: record.unit_name,
                        決標日期: record.date,
                        標案類型: record.brief?.type || '未知',
                        決標金額: awardAmount,
                        決標金額_數字: numericAmount,
                        金額來源: amountSource,
                        決標廠商: detail['投標廠商:投標廠商1:廠商名稱'] || companyName,
                        相關公司: record.brief?.companies?.names || [],
                        // 保留完整 detail 以供深入分析
                        detail: detail
                    };
                });
                
                // 讓 Gemini AI 以羅氏診斷的視角分析競爭對手
                const analysisPrompt = `# 角色設定
你是羅氏診斷（Roche Diagnostics）的市場情報分析專家，專門負責分析競爭對手在台灣政府採購市場的表現。

# 分析任務
請以羅氏診斷的立場，深入分析競爭對手「${companyName}」在近3年（${new Date().getFullYear()-2}年至${new Date().getFullYear()}年）的政府採購得標情況。

# 數據來源
以下是「${companyName}」近3年的完整決標資料（共 ${processedData.length} 筆）：

${JSON.stringify(processedData, null, 2)}

# 分析架構

## 1. 競爭對手概況（${companyName}）
   - 近3年總得標金額和成長趨勢
   - 市場占有率估算
   - 主要競爭領域（體外診斷、免疫分析、生化分析等）
   - 得標案件規模分析（大型vs小型標案）

## 2. 競爭對手優勢分析
   ### 2.1 產品優勢
   - 從標案名稱分析其主打產品線
   - 技術特色和創新點
   - 與羅氏產品的直接競爭項目
   
   ### 2.2 市場策略優勢
   - 目標客戶群分析（醫學中心、區域醫院、地區醫院）
   - 定價策略（從決標金額推估）
   - 市場滲透率變化趨勢
   
   ### 2.3 客戶關係優勢
   - 長期合作醫院清單
   - 客戶忠誠度分析
   - 新客戶開發能力

## 3. 競爭對手劣勢分析
   ### 3.1 產品線缺口
   - 尚未涉足的診斷領域
   - 產品組合不完整之處
   - 技術限制
   
   ### 3.2 市場覆蓋弱點
   - 未能進入的重要醫療機構
   - 區域市場空白點
   - 客戶流失情況
   
   ### 3.3 策略弱點
   - 定價競爭力不足之處
   - 服務品質問題（如有）
   - 供應鏈或交期問題

## 4. 羅氏 vs ${companyName} 直接對比
   - 產品線完整度對比
   - 技術創新能力對比
   - 市場覆蓋範圍對比
   - 客戶滿意度推估對比
   - 品牌影響力對比

## 5. 羅氏的競爭策略建議
   ### 5.1 進攻策略
   - 如何搶奪對手現有客戶
   - 在對手強勢領域的突破點
   - 產品差異化建議
   
   ### 5.2 防守策略
   - 如何鞏固現有客戶
   - 預防對手的競爭威脅
   - 提升客戶轉換成本
   
   ### 5.3 市場機會
   - 對手未覆蓋的市場空間
   - 新興需求的把握
   - 政策機會的利用

## 6. 行動計畫建議
   - 短期（3-6個月）應採取的具體行動
   - 中期（6-12個月）的策略部署
   - 長期（1-3年）的市場布局

# 分析要求
1. **客觀但具競爭性**：基於數據客觀分析，但始終以羅氏的利益為出發點
2. **可執行性**：提供具體、可操作的建議，而非泛泛而談
3. **數據支撐**：所有分析都要引用具體的決標數據佐證
4. **策略導向**：不只是描述現況，更要提出如何利用情報制定競爭策略
5. **保持專業**：使用專業的市場分析術語，體現羅氏的專業水準

請以繁體中文撰寫完整的競爭情報分析報告。`;

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-goog-api-key': geminiKey
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: analysisPrompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Gemini API 錯誤: ${response.status}`);
                }

                const data = await response.json();
                const analysisText = data.candidates[0].content.parts[0].text;

                document.getElementById('geminiAnalysis').innerHTML = `
                    <div class="analysis-content">
                        <div style="white-space: pre-line; line-height: 1.8; font-size: 1.1rem;">${analysisText}</div>
                    </div>
                `;

            } catch (error) {
                console.error('Gemini 分析錯誤:', error);
                document.getElementById('geminiAnalysis').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        AI 分析失敗：${error.message}
                    </div>
                `;
            }
        }

        // 顯示訊息
        function showMessage(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            // 可以在這裡添加視覺化訊息顯示
        }

        // 搜尋所有頁面
        async function searchAllPages(searchType, query) {
            let allResults = [];
            let page = 1;
            const maxPages = 5; // 限制最多搜尋5頁
            let consecutiveErrors = 0;

            while (page <= maxPages && consecutiveErrors < 2) {
                try {
                    const url = `${API_BASE}/searchby${searchType}?query=${encodeURIComponent(query)}&page=${page}`;
                    console.log(`搜尋第 ${page} 頁:`, url);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'Mozilla/5.0'
                        },
                        mode: 'cors',
                        credentials: 'omit',
                        cache: 'default'
                    });
                    
                    console.log(`第 ${page} 頁回應:`, response.status, response.statusText);
                    
                    if (!response.ok) {
                        // 如果是 403，在瀏覽器環境中可能仍然可以正常運作
                        if (response.status === 403) {
                            console.warn(`第 ${page} 頁收到 403，但在瀏覽器中這通常是正常的`);
                            // 403 通常只發生在非瀏覽器環境，所以這裡我們記錄但不拋出錯誤
                            consecutiveErrors++;
                            
                            // 如果是第一頁就 403，可能真的有問題
                            if (page === 1) {
                                console.error('第一頁就收到 403，可能確實有 API 連接問題');
                                throw new Error('API 連接被拒絕（403）');
                            }
                        } else if (response.status === 404) {
                            console.log(`第 ${page} 頁沒有更多資料`);
                            break;
                        } else {
                            console.warn(`第 ${page} 頁回應異常: ${response.status}`);
                            consecutiveErrors++;
                        }
                        
                        // 如果連續錯誤，停止搜尋
                        if (consecutiveErrors >= 2) {
                            console.warn('連續錯誤太多，停止搜尋');
                            break;
                        }
                        page++;
                        continue;
                    }
                    
                    // 重置錯誤計數
                    consecutiveErrors = 0;
                    
                    const data = await response.json();
                    const records = data.records || [];
                    
                    console.log(`第 ${page} 頁結果:`, records.length, '筆');
                    
                    if (records.length === 0) {
                        console.log('沒有更多結果，停止搜尋');
                        break;
                    }
                    
                    allResults = allResults.concat(records);
                    page++;
                    
                } catch (error) {
                    console.error(`搜尋第 ${page} 頁錯誤:`, error);
                    consecutiveErrors++;
                    
                    // 網路錯誤的詳細診斷
                    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        console.error('網路請求失敗 - 可能是 CORS、網路問題或 API 服務異常');
                        
                        // 如果是第一頁就失敗，這是嚴重問題
                        if (page === 1) {
                            throw new Error('無法連接到 API 服務，請檢查網路連接或稍後再試');
                        }
                    }
                    
                    // 如果已經有一些結果，就返回這些結果
                    if (allResults.length > 0) {
                        console.log(`雖然遇到錯誤，但已取得 ${allResults.length} 筆結果`);
                        break;
                    }
                    
                    // 如果沒有任何結果且連續錯誤，拋出錯誤
                    if (consecutiveErrors >= 2) {
                        throw error;
                    }
                    
                    page++;
                }
            }

            console.log(`總共搜尋到 ${allResults.length} 筆結果（搜尋了 ${page-1} 頁）`);
            return allResults;
        }

        // 顯示錯誤
        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        // 分享到 Line
        function shareToLine(title, unitName, govUrl) {
            const message = `📋 ${title}\n🏢 機關：${unitName}\n🔗 連結：${govUrl}`;
            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
            window.open(lineUrl, '_blank');
            console.log('已開啟 Line 分享');
        }

        // 分享到 Gmail
        function shareToGmail(title, unitName, jobNumber, govUrl) {
            const subject = `政府採購標案：${title}`;
            const body = `
政府採購標案資訊

標案名稱：${title}
機關名稱：${unitName}
案號：${jobNumber}

詳細資料連結：
${govUrl}

---
此郵件由政府採購標案查詢系統自動產生
            `.trim();
            
            const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(gmailUrl, '_blank');
            console.log('已開啟 Gmail');
        }

        // 複製連結
        async function copyLink(govUrl, title) {
            try {
                await navigator.clipboard.writeText(govUrl);
                alert(`已複製「${title}」的連結到剪貼簿`);
            } catch (error) {
                // 備用方案：使用傳統的複製方法
                const textArea = document.createElement('textarea');
                textArea.value = govUrl;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    alert(`已複製「${title}」的連結到剪貼簿`);
                } catch (err) {
                    alert('複製失敗，請手動複製連結');
                }
                
                document.body.removeChild(textArea);
            }
        }

        // 顯示訊息
        function showMessage(message, type) {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
