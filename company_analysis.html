<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公司得標分析（近3年）- 政府採購標案查詢系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Microsoft JhengHei', sans-serif;
        }
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 30px;
        }
        .company-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }
        .analysis-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .loading-spinner {
            text-align: center;
            padding: 40px;
        }
        .analysis-result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        .year-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.2s ease;
        }
        .year-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- 公司標題區域 -->
            <div class="company-header">
                <h1><i class="fas fa-building me-3"></i><span id="companyName">載入中...</span></h1>
                <p class="mb-0">政府採購得標分析報告（近3年）</p>
            </div>

            <!-- 載入中 -->
            <div id="loadingSection" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">載入中...</span>
                </div>
                <p class="mt-3 mb-0"><i class="fas fa-robot me-2"></i>Gemini AI 正在分析公司得標資料...</p>
            </div>

            <!-- 分析結果區域 -->
            <div id="analysisSection" style="display: none;">
                <!-- 基本統計 -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="totalTenders">0</div>
                            <div>總得標案件</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="totalAmount">0</div>
                            <div>總得標金額</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="avgAmount">0</div>
                            <div>平均得標金額</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-number" id="yearRange">0</div>
                            <div>分析年份範圍</div>
                        </div>
                    </div>
                </div>

                <!-- 年度統計 -->
                <div class="card analysis-card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>年度得標統計</h5>
                    </div>
                    <div class="card-body">
                        <div id="yearlyStats"></div>
                    </div>
                </div>

                <!-- Gemini AI 分析 -->
                <div class="card analysis-card">
                    <div class="card-header">
                        <h5><i class="fas fa-star text-warning me-2"></i>Gemini AI 深度分析</h5>
                    </div>
                    <div class="card-body">
                        <div id="geminiAnalysis" class="analysis-result">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin me-2"></i>正在進行 AI 分析...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 得標案件清單 -->
                <div class="card analysis-card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>得標案件清單</h5>
                    </div>
                    <div class="card-body">
                        <div id="tenderList"></div>
                    </div>
                </div>
            </div>

            <!-- 錯誤訊息 -->
            <div id="errorSection" style="display: none;">
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>分析失敗</h5>
                    <p id="errorMessage"></p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-redo me-1"></i>重新載入
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'https://pcc-api.openfun.app/api';
        let companyData = null;
        let geminiKey = null;

        // 從 URL 參數獲取公司名稱和 Gemini API Key
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                companyName: urlParams.get('company') || '',
                geminiKey: urlParams.get('key') || ''
            };
        }

        // 初始化頁面
        async function initPage() {
            const { companyName, geminiKey: key } = getUrlParams();
            
            if (!companyName) {
                showError('未指定公司名稱');
                return;
            }

            if (!key) {
                showError('未提供 Gemini API Key');
                return;
            }

            geminiKey = key;
            document.getElementById('companyName').textContent = companyName;
            
            try {
                await loadCompanyData(companyName);
                await performGeminiAnalysis(companyName);
            } catch (error) {
                console.error('初始化錯誤:', error);
                showError(`初始化失敗：${error.message}`);
            }
        }

        // 測試API連接
        async function testAPIConnection() {
            try {
                const response = await fetch(`${API_BASE}/searchbycompanyname?query=測試&page=1`);
                return response.ok;
            } catch (error) {
                console.error('API連接測試失敗:', error);
                return false;
            }
        }

        // 載入公司資料
        async function loadCompanyData(companyName) {
            try {
                showMessage('正在搜尋公司得標資料...', 'info');
                
                // 先測試API連接
                const isAPIConnected = await testAPIConnection();
                if (!isAPIConnected) {
                    throw new Error('API服務暫時無法使用，請稍後再試。');
                }
                
                let results = [];
                
                // 嘗試多種搜尋方式
                const searchStrategies = [
                    { type: 'companyname', query: companyName, desc: '完整公司名稱' },
                    { type: 'companyname', query: companyName.replace(/股份有限公司|有限公司|企業有限公司|企業股份有限公司/g, '').trim(), desc: '簡化公司名稱' },
                    { type: 'companyname', query: companyName.split(' ')[0], desc: '公司名稱第一部分' },
                    { type: 'companyname', query: companyName.replace(/\(.*\)/g, '').trim(), desc: '移除括號內容' },
                    { type: 'companyname', query: companyName.replace(/股份有限公司|有限公司|企業有限公司|企業股份有限公司|股份有限公司|有限公司/g, '').trim(), desc: '移除所有公司類型' },
                    { type: 'companyname', query: companyName.split('(')[0].trim(), desc: '移除括號前部分' }
                ];
                
                // 如果公司名稱包含英文，也嘗試搜尋英文部分
                const englishMatch = companyName.match(/\(([^)]+)\)/);
                if (englishMatch) {
                    searchStrategies.push({ type: 'companyname', query: englishMatch[1], desc: '英文公司名稱' });
                    searchStrategies.push({ type: 'companyname', query: englishMatch[1].split(' ')[0], desc: '英文公司名稱第一部分' });
                }
                
                // 嘗試搜尋關鍵字
                const keywords = companyName.match(/[\u4e00-\u9fff]+/g); // 提取中文字符
                if (keywords && keywords.length > 0) {
                    keywords.forEach(keyword => {
                        if (keyword.length >= 2) {
                            searchStrategies.push({ type: 'companyname', query: keyword, desc: `關鍵字: ${keyword}` });
                        }
                    });
                }
                
                // 嘗試各種搜尋策略
                for (const strategy of searchStrategies) {
                    if (strategy.query && strategy.query.length > 1) {
                        try {
                            console.log(`嘗試搜尋策略: ${strategy.desc} - "${strategy.query}"`);
                            const strategyResults = await searchAllPages(strategy.type, strategy.query);
                            console.log(`${strategy.desc} 搜尋結果:`, strategyResults.length, '筆');
                            
                            if (strategyResults && strategyResults.length > 0) {
                                results = results.concat(strategyResults);
                            }
                        } catch (error) {
                            console.warn(`${strategy.desc} 搜尋失敗:`, error);
                            // 如果API完全無法連接，提供更詳細的錯誤訊息
                            if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                                console.error('API連接失敗，可能是網路問題或API服務暫時無法使用');
                            }
                        }
                    }
                }
                
                // 去重複
                const uniqueResults = [];
                const seen = new Set();
                for (const result of results) {
                    const key = `${result.unit_id}-${result.job_number}-${result.date}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniqueResults.push(result);
                    }
                }
                
                console.log('去重複後總結果:', uniqueResults.length, '筆');
                
                if (uniqueResults.length === 0) {
                    // 提供更詳細的診斷資訊
                    const diagnosticInfo = `
未找到 ${companyName} 的相關標案紀錄。

已嘗試的搜尋策略：
${searchStrategies.map(s => `- ${s.desc}: "${s.query}"`).join('\n')}

可能的原因：
1. API服務暫時無法使用
2. 公司名稱在政府採購網中的記錄方式不同
3. 該公司可能沒有政府採購相關記錄
4. 網路連接問題

建議：
1. 檢查網路連接
2. 嘗試使用不同的公司名稱變體
3. 稍後再試
                    `;
                    throw new Error(diagnosticInfo);
                }

                // 動態過濾近3年的案件
                const currentDate = new Date();
                const threeYearsAgo = new Date(currentDate);
                threeYearsAgo.setFullYear(currentDate.getFullYear() - 3);
                
                const recentResults = uniqueResults.filter(record => {
                    if (!record.date) return false;
                    
                    const recordDate = new Date(
                        parseInt(record.date.toString().substring(0, 4)),
                        parseInt(record.date.toString().substring(4, 6)) - 1,
                        parseInt(record.date.toString().substring(6, 8))
                    );
                    
                    return recordDate >= threeYearsAgo && recordDate <= currentDate;
                });
                
                console.log('近3年案件數量:', recentResults.length, '筆');
                
                // 過濾出決標案件（排除無法決標公告）
                const tenderResults = recentResults.filter(r => {
                    const type = r.brief?.type || '';
                    return type.includes('決標') && !type.includes('無法決標');
                });
                
                console.log('近3年決標案件數量:', tenderResults.length, '筆');
                
                if (tenderResults.length === 0) {
                    // 如果沒有決標案件，顯示所有近3年的案件
                    console.log('沒有決標案件，顯示所有近3年的案件');
                    const allResults = recentResults.slice(0, 20);
                    companyData = allResults;
                    
                    // 計算統計資料（包含所有案件）
                    calculateStats(allResults);
                    
                    // 顯示年度統計（包含所有案件）
                    displayYearlyStats(allResults);
                    
                    // 顯示案件清單（包含所有案件）
                    displayTenderList(allResults);
                    
                    // 隱藏載入中，顯示分析結果
                    document.getElementById('loadingSection').style.display = 'none';
                    document.getElementById('analysisSection').style.display = 'block';
                    
                    // 顯示警告訊息
                    showMessage(`找到 ${allResults.length} 筆近3年相關標案，但沒有決標案件。將顯示所有找到的案件。`, 'warning');
                    return;
                }

                // 獲取每個標案的完整詳細資料
                showMessage('正在載入標案詳細資料...', 'info');
                const detailedResults = await Promise.all(
                    tenderResults.slice(0, 20).map(async (record) => {
                        try {
                            const detailResponse = await fetch(`${API_BASE}/tender?unit_id=${record.unit_id}&job_number=${record.job_number}`);
                            if (detailResponse.ok) {
                                const detailData = await detailResponse.json();
                                const detailRecord = detailData.records?.[0] || detailData;
                                
                                // 智能合併詳細資料
                                let mergedDetail = record.detail || {};
                                
                                // 如果 detailRecord 有 detail 屬性，合併它
                                if (detailRecord.detail && typeof detailRecord.detail === 'object') {
                                    mergedDetail = { ...mergedDetail, ...detailRecord.detail };
                                }
                                // 如果 detailRecord 本身就是 detail 對象（包含決標相關欄位）
                                else if (detailRecord && typeof detailRecord === 'object') {
                                    // 檢查是否包含決標相關欄位
                                    const hasDetailFields = Object.keys(detailRecord).some(key => 
                                        key.includes('決標') || key.includes('投標') || key.includes('採購') || key.includes('機關')
                                    );
                                    if (hasDetailFields) {
                                        mergedDetail = { ...mergedDetail, ...detailRecord };
                                    }
                                }
                                
                                const mergedRecord = {
                                    ...record,
                                    detail: mergedDetail,
                                    url: detailRecord.url || record.url,
                                    pkPmsMain: detailRecord.pkPmsMain || record.pkPmsMain
                                };
                                
                                console.log(`合併 ${record.job_number} 詳細資料:`, {
                                    original_detail_keys: Object.keys(record.detail || {}),
                                    detailRecord_keys: Object.keys(detailRecord),
                                    detailRecord_detail_keys: detailRecord.detail ? Object.keys(detailRecord.detail) : [],
                                    merged_detail_keys: Object.keys(mergedDetail),
                                    has_award_amount: !!(mergedDetail['決標資料:總決標金額'] || mergedDetail['投標廠商:投標廠商1:決標金額'])
                                });
                                return mergedRecord;
                            }
                        } catch (error) {
                            console.error(`載入 ${record.job_number} 詳細資料錯誤:`, error);
                        }
                        return record;
                    })
                );

                companyData = detailedResults;
                
                // 計算統計資料
                calculateStats(detailedResults);
                
                // 顯示年度統計
                displayYearlyStats(detailedResults);
                
                // 顯示得標案件清單
                displayTenderList(detailedResults);
                
                // 隱藏載入中，顯示分析結果
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('analysisSection').style.display = 'block';
                
            } catch (error) {
                console.error('載入公司資料錯誤:', error);
                throw error;
            }
        }

        // 計算統計資料
        function calculateStats(results) {
            let totalAmount = 0;
            let validAmountCount = 0;
            const years = new Set();
            
            results.forEach(record => {
                const year = record.date ? record.date.toString().substring(0, 4) : '未知';
                years.add(year);
                
                // 優先使用決標資料:總決標金額
                let amount = '0';
                if (record.detail?.['決標資料:總決標金額']) {
                    amount = record.detail['決標資料:總決標金額'];
                } else if (record.detail?.['投標廠商:投標廠商1:決標金額']) {
                    amount = record.detail['投標廠商:投標廠商1:決標金額'];
                } else if (record.detail?.['採購資料:預算金額']) {
                    amount = record.detail['採購資料:預算金額'];
                }
                
                const amountMatch = amount.toString().match(/[\d,]+/);
                if (amountMatch) {
                    const numericAmount = parseInt(amountMatch[0].replace(/,/g, ''));
                    totalAmount += numericAmount;
                    validAmountCount++;
                }
            });

            const avgAmount = validAmountCount > 0 ? Math.round(totalAmount / validAmountCount) : 0;
            const yearRange = years.size;

            document.getElementById('totalTenders').textContent = results.length;
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + ' 元';
            document.getElementById('avgAmount').textContent = avgAmount.toLocaleString() + ' 元';
            document.getElementById('yearRange').textContent = yearRange + ' 年';
        }

        // 顯示年度統計（近3年）
        function displayYearlyStats(results) {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            
            // 動態計算近3年區間（從當前日期往前推3年）
            const threeYearsAgo = new Date(currentDate);
            threeYearsAgo.setFullYear(currentYear - 3);
            
            const yearlyStats = {};
            const allYears = new Set();
            
            // 先收集所有有資料的年份
            results.forEach(record => {
                if (record.date) {
                    const year = record.date.toString().substring(0, 4);
                    const yearNum = parseInt(year);
                    allYears.add(yearNum);
                }
            });
            
            // 找出近3年範圍內的所有年份
            const recentYears = Array.from(allYears).filter(year => {
                const recordDate = new Date(year, 0, 1);
                return recordDate >= threeYearsAgo && recordDate <= currentDate;
            }).sort((a, b) => b - a);
            
            console.log('近3年範圍內找到的年份:', recentYears);
            
            // 統計各年度資料
            results.forEach(record => {
                if (!record.date) return;
                
                const year = record.date.toString().substring(0, 4);
                const yearNum = parseInt(year);
                
                // 只處理近3年範圍內的資料
                if (!recentYears.includes(yearNum)) {
                    return;
                }
                
                // 優先使用決標金額，備用預算金額
                let amount = '0';
                if (record.detail?.['決標資料:總決標金額']) {
                    amount = record.detail['決標資料:總決標金額'];
                } else if (record.detail?.['投標廠商:投標廠商1:決標金額']) {
                    amount = record.detail['投標廠商:投標廠商1:決標金額'];
                } else if (record.detail?.['採購資料:決標金額']) {
                    amount = record.detail['採購資料:決標金額'];
                } else if (record.detail?.['採購資料:預算金額']) {
                    amount = record.detail['採購資料:預算金額'];
                }
                
                if (!yearlyStats[year]) {
                    yearlyStats[year] = { count: 0, totalAmount: 0 };
                }
                yearlyStats[year].count++;
                
                const amountMatch = amount.toString().match(/[\d,]+/);
                if (amountMatch) {
                    const numericAmount = parseInt(amountMatch[0].replace(/,/g, ''));
                    yearlyStats[year].totalAmount += numericAmount;
                }
            });

            // 確保近3年都有資料（即使為0）
            recentYears.forEach(year => {
                if (!yearlyStats[year]) {
                    yearlyStats[year] = { count: 0, totalAmount: 0 };
                }
            });

            // 計算近3年總計
            let total3YearCount = 0;
            let total3YearAmount = 0;
            
            recentYears.forEach(year => {
                const stats = yearlyStats[year];
                total3YearCount += stats.count;
                total3YearAmount += stats.totalAmount;
            });
            
            const yearlyHtml = `
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-chart-line me-2"></i>近3年得標統計總覽 (${recentYears[recentYears.length-1] || currentYear-2}年 - ${currentYear}年)</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>總案件數：</strong>${total3YearCount} 件
                                </div>
                                <div class="col-md-6">
                                    <strong>總決標金額：</strong><span class="text-success">${total3YearAmount.toLocaleString()}</span> 元
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                ${recentYears.map(year => {
                    const stats = yearlyStats[year];
                    const isCurrentYear = year === currentYear;
                    const yearLabel = isCurrentYear ? `${year}年（今年）` : `${year}年`;
                    const yearClass = isCurrentYear ? 'text-primary' : 'text-secondary';
                    
                    return `
                        <div class="year-card mb-3">
                            <div class="row">
                                <div class="col-md-3">
                                    <h6 class="${yearClass}">${yearLabel}</h6>
                                </div>
                                <div class="col-md-3">
                                    <strong>${stats.count}</strong> 件案件
                                </div>
                                <div class="col-md-6">
                                    <strong class="text-success">${stats.totalAmount.toLocaleString()}</strong> 元
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;

            document.getElementById('yearlyStats').innerHTML = yearlyHtml;
        }

        // 顯示得標案件清單
        function displayTenderList(results) {
            console.log('顯示得標案件清單，共', results.length, '筆資料');
            
            const tenderHtml = results.slice(0, 20).map((record, index) => {
                const brief = record.brief || {};
                const detail = record.detail || {};
                const dateStr = record.date ? record.date.toString() : '';
                const formattedDate = dateStr ? `${dateStr.substring(0,4)}年${dateStr.substring(4,6)}月${dateStr.substring(6,8)}日` : '未知';
                
                // 調試：輸出 detail 所有欄位
                console.log(`標案 ${index + 1} (${record.job_number}):`, {
                    detail_keys: Object.keys(detail),
                    url: record.url,
                    has_pkPmsMain: !!detail.pkPmsMain
                });
                
                // 構建政府採購網連結
                const govUrl = buildGovUrl(record);
                console.log(`標案 ${index + 1} 連結:`, govUrl);
                console.log(`標案 ${index + 1} 完整record:`, record);
                
                // 獲取金額（優先使用決標金額，備用預算金額）
                let tenderAmount = '金額未知';
                let amountType = '';
                
                // 1. 優先使用決標資料:總決標金額
                if (detail['決標資料:總決標金額']) {
                    tenderAmount = detail['決標資料:總決標金額'];
                    amountType = '決標金額';
                    console.log(`找到決標金額: 決標資料:總決標金額 = ${tenderAmount}`);
                }
                // 2. 備用：使用投標廠商的決標金額
                else if (detail['投標廠商:投標廠商1:決標金額']) {
                    tenderAmount = detail['投標廠商:投標廠商1:決標金額'];
                    amountType = '決標金額';
                    console.log(`找到決標金額: 投標廠商:投標廠商1:決標金額 = ${tenderAmount}`);
                }
                // 3. 備用：使用採購資料的決標金額
                else if (detail['採購資料:決標金額']) {
                    tenderAmount = detail['採購資料:決標金額'];
                    amountType = '決標金額';
                    console.log(`找到決標金額: 採購資料:決標金額 = ${tenderAmount}`);
                }
                // 4. 備用：使用預算金額
                else if (detail['採購資料:預算金額']) {
                    tenderAmount = detail['採購資料:預算金額'];
                    amountType = '預算金額';
                    console.log(`找到預算金額: 採購資料:預算金額 = ${tenderAmount}`);
                }
                // 5. 最後備用：遍歷所有欄位尋找金額
                else {
                    for (const key in detail) {
                        if (key.includes('決標金額') || key.includes('總決標金額') || key.includes('得標金額')) {
                            const value = detail[key];
                            if (value && value.toString().match(/[\d,]+/)) {
                                tenderAmount = value;
                                amountType = '決標金額';
                                console.log(`找到金額欄位: ${key} = ${value}`);
                                break;
                            }
                        }
                    }
                }
                
                console.log(`標案 ${index + 1} 金額:`, tenderAmount);
                
                // 獲取標案案號
                const jobNumber = record.job_number || '未知案號';
                
                // 獲取決標日期
                const tenderDate = detail['決標資料:決標日期'] || detail['無法決標公告:無法決標公告日期'] || formattedDate;
                
                // 獲取第幾次決標
                const tenderSequence = detail['招標資料:新增公告傳輸次數'] || detail['無法決標公告:新增公告傳輸次數'] || '1';
                
                return `
                    <div class="card mb-2">
                        <div class="card-body p-3">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="card-title">
                                        <a href="${govUrl}" target="_blank" class="text-decoration-none text-primary">
                                            ${brief.title || '無標題'}
                                            <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                                        </a>
                                    </h6>
                                    <p class="card-text text-muted mb-1">
                                        <i class="fas fa-hashtag me-1"></i>案號: ${jobNumber} | 
                                        <i class="fas fa-calendar me-1"></i>決標日期: ${tenderDate} | 
                                        <i class="fas fa-sort-numeric-up me-1"></i>第${tenderSequence}次決標
                                    </p>
                                    <p class="card-text text-muted mb-1">
                                        <i class="fas fa-building me-1"></i>${record.unit_name || '未知機關'}
                                    </p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge ${brief.type && brief.type.includes('決標') ? 'bg-danger' : 'bg-primary'}">${brief.type || '未知類型'}</span>
                                    <br>
                                    <strong class="text-success">${tenderAmount}</strong>
                                    ${amountType ? `<br><small class="text-muted">${amountType}</small>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('tenderList').innerHTML = tenderHtml;
        }

        // 構建政府採購網 URL
        function buildGovUrl(record) {
            // 檢查所有可能的 detail 欄位
            const detail = record.detail || {};
            
            console.log('構建連結，record:', record);
            console.log('detail.url:', detail.url);
            console.log('detail.pkPmsMain:', detail.pkPmsMain);
            
            // 1. 優先使用 detail 中的 url 欄位（如果是政府採購網連結）
            if (detail.url && detail.url.startsWith('https://web.pcc.gov.tw')) {
                console.log('使用 detail.url:', detail.url);
                return detail.url;
            }
            
            // 2. 檢查 detail 中的 pkPmsMain 欄位
            if (detail.pkPmsMain) {
                const govUrl = `https://web.pcc.gov.tw/tps/QueryTender/query/searchTenderDetail?pkPmsMain=${detail.pkPmsMain}`;
                console.log('使用 pkPmsMain 構建連結:', govUrl);
                return govUrl;
            }
            
            // 3. 檢查 detail 中的所有欄位，找出 pkPmsMain
            for (const key in detail) {
                if (key.includes('pkPmsMain') || key === 'pkPmsMain') {
                    const pkPmsMain = detail[key];
                    if (pkPmsMain) {
                        const govUrl = `https://web.pcc.gov.tw/tps/QueryTender/query/searchTenderDetail?pkPmsMain=${pkPmsMain}`;
                        console.log('在欄位中找到 pkPmsMain:', key, '=', pkPmsMain, '->', govUrl);
                        return govUrl;
                    }
                }
            }
            
            // 4. 檢查所有包含 "決標資料" 或 "招標資料" 的欄位
            const relevantKeys = Object.keys(detail).filter(key => 
                key.includes('決標資料') || key.includes('招標資料') || key.includes('採購資料')
            );
            
            for (const key of relevantKeys) {
                const value = detail[key];
                if (typeof value === 'string' && value.includes('pkPmsMain')) {
                    const match = value.match(/pkPmsMain=([A-Za-z0-9]+)/);
                    if (match) {
                        const govUrl = `https://web.pcc.gov.tw/tps/QueryTender/query/searchTenderDetail?pkPmsMain=${match[1]}`;
                        console.log('在字串中找到 pkPmsMain:', key, '=', value, '->', govUrl);
                        return govUrl;
                    }
                }
            }
            
            // 5. 使用 record 的 url 欄位
            if (record.url && record.url.startsWith('https://web.pcc.gov.tw')) {
                console.log('使用 record.url:', record.url);
                return record.url;
            }
            
            // 6. 備用方案：構建 pcc.g0v.ronny.tw 的 tender.html
            if (record.job_number && record.unit_id && record.date) {
                const dateStr = record.date.toString();
                const filename = record.filename || 'unknown';
                const fallbackUrl = `https://pcc.g0v.ronny.tw/tender.html?unit_id=${record.unit_id}&job_number=${record.job_number}&date=${dateStr}&filename=${filename}`;
                console.log('使用備用方案:', fallbackUrl);
                return fallbackUrl;
            } else if (record.url) {
                if (record.url.startsWith('http')) {
                    console.log('使用 record.url (http):', record.url);
                    return record.url;
                } else {
                    const fallbackUrl = `https://pcc.g0v.ronny.tw${record.url}`;
                    console.log('使用 record.url (相對路徑):', fallbackUrl);
                    return fallbackUrl;
                }
            }
            
            // 7. 最後備用方案
            console.log('無法構建連結，返回 #');
            return '#';
        }

        // 執行 Gemini AI 分析
        async function performGeminiAnalysis(companyName) {
            if (!geminiKey) {
                document.getElementById('geminiAnalysis').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        未提供 Gemini API Key，無法進行 AI 分析
                    </div>
                `;
                return;
            }

            try {
                // 預處理數據，提取關鍵資訊並確保決標金額清晰可見
                const processedData = companyData.slice(0, 20).map(record => {
                    const detail = record.detail || {};
                    
                    // 提取決標金額（按優先順序）
                    let awardAmount = null;
                    let amountSource = '';
                    
                    if (detail['決標資料:總決標金額']) {
                        awardAmount = detail['決標資料:總決標金額'];
                        amountSource = '決標資料:總決標金額';
                    } else if (detail['投標廠商:投標廠商1:決標金額']) {
                        awardAmount = detail['投標廠商:投標廠商1:決標金額'];
                        amountSource = '投標廠商:投標廠商1:決標金額';
                    } else if (detail['採購資料:決標金額']) {
                        awardAmount = detail['採購資料:決標金額'];
                        amountSource = '採購資料:決標金額';
                    } else if (detail['採購資料:預算金額']) {
                        awardAmount = detail['採購資料:預算金額'];
                        amountSource = '採購資料:預算金額（備用）';
                    }
                    
                    // 提取數字金額
                    let numericAmount = 0;
                    if (awardAmount) {
                        const match = awardAmount.toString().match(/[\d,]+/);
                        if (match) {
                            numericAmount = parseInt(match[0].replace(/,/g, ''));
                        }
                    }
                    
                    return {
                        標案名稱: record.brief?.title || '未知',
                        案號: record.job_number,
                        機關名稱: record.unit_name,
                        決標日期: record.date,
                        標案類型: record.brief?.type || '未知',
                        決標金額: awardAmount,
                        決標金額_數字: numericAmount,
                        金額來源: amountSource,
                        決標廠商: detail['投標廠商:投標廠商1:廠商名稱'] || companyName,
                        相關公司: record.brief?.companies?.names || [],
                        // 保留完整 detail 以供深入分析
                        detail: detail
                    };
                });
                
                // 讓 Gemini AI 直接使用搜尋 API 獲取近3年資料
                const analysisPrompt = `你是一個專業的政府採購分析師。請分析公司 "${companyName}" 近3年在政府採購網的得標情況。

請使用以下 API 端點搜尋該公司的近3年決標資料：
- 搜尋 API: https://pcc-api.openfun.app/api/searchbycompanyname?query=${encodeURIComponent(companyName)}&page=1
- 詳細資料 API: https://pcc-api.openfun.app/api/tender?unit_id={unit_id}&job_number={job_number}

以下是已經處理好的近3年資料，每筆記錄都包含：
- 標案名稱、案號、機關名稱、決標日期
- **決標金額**：已從 detail 中提取的決標金額（優先順序：決標資料:總決標金額 > 投標廠商:投標廠商1:決標金額 > 採購資料:決標金額 > 採購資料:預算金額）
- **決標金額_數字**：轉換為數字的決標金額，可直接用於統計計算
- 金額來源：標示金額是從哪個欄位提取的

資料如下：
${JSON.stringify(processedData, null, 2)}

請提供詳細的近3年分析報告，包含：

1. **近3年得標摘要**
   - 近3年總得標金額和案件數統計（請從 "決標資料:總決標金額" 或 "投標廠商:投標廠商1:決標金額" 欄位計算）
   - 各年度得標金額和案件數詳細統計（2024年、2023年、2022年）
   - 近3年得標時間分布和趨勢分析
   - 主要得標領域和產品類型變化

2. **各年度詳細統計分析**
   - 2024年：總案件數、總決標金額、平均案件金額
   - 2023年：總案件數、總決標金額、平均案件金額
   - 2022年：總案件數、總決標金額、平均案件金額
   - 年度間成長率分析（案件數成長率、金額成長率）

3. **近3年主要得標項目分析**
   - 最常得標的標案類型變化
   - 標案金額分布趨勢（從 "決標資料:總決標金額" 欄位分析）
   - 標案複雜度變化分析

4. **近3年合作醫院分析**
   - 主要合作醫院清單變化（從 "機關資料:機關名稱" 欄位分析）
   - 各醫院得標金額統計趨勢
   - 合作關係穩定性分析

5. **近3年競爭對手分析**
   - 經常一起參與投標的公司變化（從 "brief.companies.names" 欄位分析）
   - 競爭模式變化分析
   - 市場地位變化評估

6. **近3年趨勢洞察和建議**
   - 公司優勢變化分析
   - 近3年發展趨勢
   - 未來機會和風險評估

請以專業、詳細的方式呈現近3年分析結果，使用繁體中文。`;

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-goog-api-key': geminiKey
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: analysisPrompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Gemini API 錯誤: ${response.status}`);
                }

                const data = await response.json();
                const analysisText = data.candidates[0].content.parts[0].text;

                document.getElementById('geminiAnalysis').innerHTML = `
                    <div class="analysis-content">
                        <div style="white-space: pre-line; line-height: 1.8; font-size: 1.1rem;">${analysisText}</div>
                    </div>
                `;

            } catch (error) {
                console.error('Gemini 分析錯誤:', error);
                document.getElementById('geminiAnalysis').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        AI 分析失敗：${error.message}
                    </div>
                `;
            }
        }

        // 顯示訊息
        function showMessage(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            // 可以在這裡添加視覺化訊息顯示
        }

        // 搜尋所有頁面
        async function searchAllPages(searchType, query) {
            let allResults = [];
            let page = 1;
            const maxPages = 5; // 限制最多搜尋5頁

            while (page <= maxPages) {
                try {
                    const url = `${API_BASE}/searchby${searchType}?query=${encodeURIComponent(query)}&page=${page}`;
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        break;
                    }
                    
                    const data = await response.json();
                    const records = data.records || [];
                    
                    if (records.length === 0) {
                        break;
                    }
                    
                    allResults = allResults.concat(records);
                    page++;
                } catch (error) {
                    console.error(`搜尋第 ${page} 頁錯誤:`, error);
                    break;
                }
            }

            return allResults;
        }

        // 顯示錯誤
        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('analysisSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        // 顯示訊息
        function showMessage(message, type) {
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
