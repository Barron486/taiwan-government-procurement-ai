# 測試指南 - API 修復驗證

## 🎯 測試目標

驗證以下兩個主要問題已修復：
1. ✅ 公司分析頁面能正常載入和顯示資料
2. ✅ 搜尋結果的詳細資料能正常顯示

## 📋 前置準備

### 1. 啟動本地伺服器
```bash
cd /Users/Barron/taiwan-government-procurement-ai
python3 -m http.server 8000
```

### 2. 開啟瀏覽器開發者工具
- **Chrome/Edge**: 按 `F12` 或 `Cmd+Option+I` (Mac)
- **Firefox**: 按 `F12` 或 `Cmd+Option+K` (Mac)
- **Safari**: 啟用開發者選單後按 `Cmd+Option+C`

### 3. 切換到 Console 標籤
觀察 API 呼叫日誌和錯誤訊息

---

## 🧪 測試案例

### 測試 1: API 連線測試頁面

**目的**: 快速驗證 API 多來源備援機制是否運作

**步驟**:
1. 開啟 http://localhost:8000/test_api_connection.html
2. 點擊「執行搜尋測試」按鈕
3. 點擊「執行詳細資料測試」按鈕
4. 點擊「執行公司搜尋測試」按鈕

**預期結果**:
- ✅ 所有測試都顯示綠色成功訊息
- ✅ Console 中看到成功使用的 API URL
- ✅ 沒有紅色錯誤訊息

**如果失敗**:
- 檢查網路連線是否正常
- 查看 Console 中的錯誤訊息
- 確認至少有一個 API 來源可用

---

### 測試 2: 主頁面搜尋功能

**目的**: 驗證基本搜尋和詳細資料載入

**步驟**:
1. 開啟 http://localhost:8000/index.html
2. 輸入 Gemini API Key（如果尚未儲存）
3. 在「標案名稱」欄位輸入：`醫療`
4. 點擊「搜尋標案」按鈕
5. 等待搜尋結果出現

**預期結果**:
- ✅ 顯示「成功取得 X 筆搜尋結果」訊息
- ✅ 看到多筆搜尋結果卡片
- ✅ 每張卡片顯示：
  - 標案標題
  - 機關名稱
  - 發布日期
  - 標案類型
  - 預算金額（載入中 → 顯示金額或「無資料」）

**如果失敗**:
- 檢查 Console 是否有 API 錯誤
- 查看是否顯示「所有 API 來源均失敗」
- 嘗試使用不同的搜尋關鍵字

---

### 測試 3: 詳細資料載入

**目的**: 驗證詳細資料 modal 能正常開啟和顯示

**步驟**:
1. 在測試 2 的搜尋結果中
2. 點擊任一結果的「詳細資料」按鈕
3. 等待 modal 開啟

**預期結果**:
- ✅ Modal 成功開啟
- ✅ 顯示完整的標案資訊：
  - 基本資訊（標案名稱、類型、編號等）
  - 招標資訊（招標方式、決標方式、開標時間等）
  - 相關公司列表
  - 預算金額（不是「無資料」）
- ✅ 「官方網站連結」按鈕可點擊
- ✅ 「新增至行事曆」按鈕可用（如果有開標時間）
- ✅ Console 顯示：
  ```
  API 調用路徑: /tender?unit_id=...&job_number=...
  成功使用 API: https://pcc-api.openfun.app/api/...
  ```

**如果失敗**:
- 檢查 Console 錯誤訊息
- 確認顯示「載入詳細資料失敗：...」時的詳細錯誤
- 嘗試點擊不同的搜尋結果

---

### 測試 4: 產生分享連結

**目的**: 驗證分享功能和官方連結取得

**步驟**:
1. 在測試 2 的搜尋結果中
2. 點擊「產生分享連結」按鈕
3. 觀察按鈕文字變化和連結生成

**預期結果**:
- ✅ 按鈕顯示「⏳ 取得連結中...」
- ✅ 按鈕變為「✅ 已產生連結」
- ✅ 出現分享選項：
  - 📋 複製連結
  - 💬 分享至 Line
  - 📧 分享至 Gmail
- ✅ 點擊「複製連結」後：
  - 顯示「✅ 已複製連結」提示
  - 貼上連結應為：`https://web.pcc.gov.tw/...`（政府採購網）
- ✅ Console 顯示成功取得官方 URL

**如果失敗**:
- 查看是否顯示「無法取得該標案」錯誤
- 檢查 Console 中的 API 請求狀態
- 確認連結格式是否正確

---

### 測試 5: 公司分析頁面

**目的**: 驗證公司分析功能完全修復

**步驟**:
1. 在主頁面搜尋：公司名稱 = `台灣`
2. 找到有「相關公司」標籤的搜尋結果
3. 點擊「相關公司」標籤下的任一公司名稱
4. 等待公司分析頁面開啟

**預期結果**:
- ✅ 新視窗/分頁開啟公司分析頁面
- ✅ 顯示「正在搜尋公司得標資料...」訊息
- ✅ 載入完成後顯示：
  - **基本統計**：總得標案件、總得標金額、平均得標金額、分析年份範圍
  - **年度得標統計**：按年份分組的統計圖表
  - **Gemini AI 分析**：競爭對手情報分析
  - **得標案件清單**：近 3 年的得標記錄
- ✅ Console 顯示：
  ```
  嘗試搜尋策略: 完整公司名稱 - "台灣XX公司"
  搜尋第 1 頁: /searchbycompanyname?query=...
  成功使用 API: https://pcc-api.openfun.app/api/...
  ```

**如果失敗 - 情況 1: 沒有找到資料**
- ✅ 應顯示友善的空狀態訊息
- ✅ 提供建議（確認公司名稱、嘗試其他搜尋等）
- ✅ 有「重新載入」和「關閉」按鈕
- ❌ 不應顯示技術錯誤訊息或拋出異常

**如果失敗 - 情況 2: API 連接失敗**
- ✅ 應顯示「API 連接失敗」訊息
- ✅ 建議稍後再試
- ✅ 有重新載入選項
- ❌ 不應顯示堆疊追蹤或程式碼錯誤

---

### 測試 6: 無資料情況處理

**目的**: 驗證錯誤處理改善

**步驟**:
1. 開啟 http://localhost:8000/index.html
2. 搜尋一個不太可能存在的公司名稱，例如：`測試不存在的公司名稱123456789`
3. 如果有結果，點擊查看公司分析

**預期結果**:
- ✅ 公司分析頁面顯示友善訊息：
  - 標題：「沒有找到資料」
  - 圖示：搜尋圖示（不是錯誤圖示）
  - 說明：「未找到『...』的政府採購得標記錄」
  - 建議清單
  - 重新載入和關閉按鈕
- ✅ 沒有技術錯誤訊息
- ✅ 頁面不會崩潰或顯示空白

---

### 測試 7: API 備援機制

**目的**: 驗證多 API 來源切換機制

**步驟**:
1. 開啟開發者工具 Network 標籤
2. 執行任何搜尋操作
3. 觀察網路請求

**預期結果**:
- ✅ 看到多個 API 請求嘗試（如果第一個失敗）
- ✅ Console 顯示類似：
  ```
  API 請求失敗 (來源: https://pcc-api.openfun.app/api, 嘗試 1/2): ...
  API 請求失敗 (來源: https://pcc-api.openfun.app/api, 嘗試 2/2): ...
  API 請求失敗 (來源: https://pcc.g0v.ronny.tw/api, 嘗試 1/2): ...
  成功使用 API: https://pcc.g0v.ronny.tw/api/...
  ```
- ✅ 即使某些請求失敗，最終能取得資料

---

### 測試 8: 效能測試

**目的**: 確認 API 請求效能合理

**步驟**:
1. 清除瀏覽器快取
2. 重新整理主頁面
3. 執行搜尋並計時

**預期結果**:
- ✅ 初次搜尋完成時間：< 15 秒（正常網路）
- ✅ 詳細資料載入：< 10 秒
- ✅ 二次載入相同資料（有快取）：< 2 秒
- ✅ 頁面不會卡住或無回應

---

## 🐛 常見問題排查

### 問題 1: 所有 API 都失敗

**症狀**:
```
載入詳細資料失敗：所有 API 來源均失敗。最後錯誤: ...
```

**可能原因**:
1. 網路連線問題
2. API 服務暫時不可用
3. Cloudflare 防護阻擋

**解決方式**:
- 檢查網路連線
- 稍後再試
- 查看 https://github.com/openfunltd/pcc.g0v.ronny.tw/issues 確認服務狀態

---

### 問題 2: 詳細資料顯示「無資料」

**症狀**:
- 預算金額顯示「無資料」
- 其他欄位也是「無資料」

**可能原因**:
1. 該標案確實沒有這些資料
2. API 回應格式與預期不符

**解決方式**:
- 檢查 Console 中的 API 回應資料
- 嘗試查看其他標案
- 確認 `record.detail` 物件中有哪些欄位

---

### 問題 3: 公司分析頁面空白

**症狀**:
- 頁面完全空白
- 或只顯示標題沒有內容

**可能原因**:
1. JavaScript 錯誤
2. API Key 未提供
3. 公司名稱未正確傳遞

**解決方式**:
- 檢查 Console 錯誤
- 確認 URL 參數包含 `?company=公司名稱&key=API_KEY`
- 從主頁面重新進入（不要直接開啟 company_analysis.html）

---

### 問題 4: Gemini 分析無法執行

**症狀**:
- 顯示「未提供 Gemini API Key」
- 或 Gemini 分析一直載入

**可能原因**:
1. API Key 未設定或無效
2. API Key 額度已用完
3. Gemini API 服務問題

**解決方式**:
- 檢查 API Key 是否正確
- 查看 API Key 的配額使用狀況
- 確認 Console 中的 Gemini API 錯誤訊息

---

## ✅ 測試檢查清單

完成以下所有項目即表示修復成功：

### 基本功能
- [ ] 主頁面能正常開啟
- [ ] 搜尋功能正常
- [ ] 搜尋結果正確顯示
- [ ] 預算金額能正確載入

### 詳細資料
- [ ] 詳細資料 modal 能開啟
- [ ] 所有欄位正確顯示
- [ ] 官方連結正確
- [ ] 新增至行事曆功能正常

### 分享功能
- [ ] 產生分享連結功能正常
- [ ] 複製連結指向政府採購網
- [ ] Line/Gmail 分享功能正常

### 公司分析
- [ ] 公司分析頁面能正常載入
- [ ] 統計資料正確顯示
- [ ] Gemini 分析能執行
- [ ] 得標案件清單正確

### 錯誤處理
- [ ] 無資料時顯示友善訊息
- [ ] API 失敗時有明確錯誤提示
- [ ] 頁面不會崩潰

### API 備援
- [ ] Console 顯示 API 請求日誌
- [ ] 能看到重試機制運作
- [ ] 能看到成功使用的 API 來源

---

## 📊 測試報告範本

```
測試日期: ____________________
測試人員: ____________________
瀏覽器: ____________________
作業系統: ____________________

測試結果:
[ ] 測試 1: API 連線測試 - 通過/失敗
[ ] 測試 2: 主頁面搜尋 - 通過/失敗
[ ] 測試 3: 詳細資料載入 - 通過/失敗
[ ] 測試 4: 產生分享連結 - 通過/失敗
[ ] 測試 5: 公司分析頁面 - 通過/失敗
[ ] 測試 6: 無資料處理 - 通過/失敗
[ ] 測試 7: API 備援機制 - 通過/失敗
[ ] 測試 8: 效能測試 - 通過/失敗

問題記錄:
_______________________________________
_______________________________________
_______________________________________

總體評價:
[ ] 全部功能正常
[ ] 部分功能有問題
[ ] 主要功能失敗

備註:
_______________________________________
_______________________________________
```

---

## 🎓 除錯技巧

### 查看 API 請求細節
```javascript
// 在 Console 中執行
window.API_BASES
// 應顯示: ["https://pcc-api.openfun.app/api", "https://pcc.g0v.ronny.tw/api"]
```

### 手動測試 fetchFromApis
```javascript
// 在 Console 中執行
fetchFromApis('/searchbytitle?query=測試&page=1', {
    method: 'GET',
    headers: { 'Accept': 'application/json' }
}).then(({resp, url}) => {
    console.log('成功！使用:', url);
    return resp.json();
}).then(data => {
    console.log('資料:', data);
}).catch(err => {
    console.error('失敗:', err);
});
```

### 查看快取狀態
```javascript
// 在 Console 中執行

// 預算金額快取
console.log('預算金額快取項目數:', budgetCache?.size || 0);

// 官方連結快取
console.log('官方連結快取項目數:', urlCache?.size || 0);
```

---

## 📞 取得協助

如果測試過程中遇到問題：

1. **檢查 Console 錯誤** - 大部分問題的線索都在這裡
2. **查看 Network 標籤** - 了解 API 請求詳情
3. **閱讀 API_INFO.md** - 了解 API 限制和 Cloudflare 防護
4. **查看 FIXES_SUMMARY.md** - 了解修復的技術細節
5. **GitHub Issues** - https://github.com/openfunltd/pcc.g0v.ronny.tw/issues

祝測試順利！🎉

