<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAC11201 案件測試</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .api-response {
            background-color: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 1rem;
            margin: 1rem 0;
        }
        .detection-log {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fas fa-search me-2"></i>VAC11201 案件測試
        </h1>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle me-2"></i>案件資訊</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>案號：</strong>VAC11201</p>
                        <p><strong>日期：</strong>2022年12月09日</p>
                        <p><strong>機關：</strong>臺北榮民總醫院</p>
                        <p><strong>標題：</strong>112年度醫療儀器設備集中採購</p>
                        <p><strong>搜尋公司：</strong>正茂生物科技</p>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs me-2"></i>測試控制</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testVAC11201()">
                            <i class="fas fa-play me-2"></i>測試 VAC11201 案件
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="clearResults()">
                            <i class="fas fa-trash me-2"></i>清除結果
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="testResults" class="mt-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 複製相關函數
        function hasMultipleAwardedVendors(detail, targetCompanyName) {
            const allVendors = [];
            const targetCompanyAwards = [];
            
            console.log('=== 檢測複數廠商決標 ===');
            console.log('目標公司:', targetCompanyName);
            console.log('Detail keys:', Object.keys(detail).filter(k => k.includes('投標廠商')));
            
            // 檢查所有投標廠商欄位
            for (const key in detail) {
                if (key.includes('投標廠商:投標廠商') && key.includes(':廠商名稱')) {
                    const vendorName = detail[key];
                    const vendorNumber = key.match(/投標廠商:投標廠商(\d+):廠商名稱/);
                    if (vendorNumber && vendorName) {
                        const vendorIndex = parseInt(vendorNumber[1]);
                        
                        // 嘗試多種方式獲取決標金額
                        let amount = null;
                        const possibleAmountKeys = [
                            `投標廠商:投標廠商${vendorIndex}:決標金額`,
                            `投標廠商:投標廠商${vendorIndex}:得標金額`,
                            `決標資料:決標廠商${vendorIndex}:決標金額`,
                            `決標資料:決標廠商${vendorIndex}:得標金額`
                        ];
                        
                        for (const amountKey of possibleAmountKeys) {
                            if (detail[amountKey]) {
                                amount = detail[amountKey];
                                console.log(`找到金額: ${vendorName} - ${amountKey} = ${amount}`);
                                break;
                            }
                        }
                        
                        // 如果沒找到，檢查是否有 "決標品項" 相關欄位
                        if (!amount) {
                            for (const itemKey in detail) {
                                if (itemKey.includes(`投標廠商${vendorIndex}`) && 
                                    (itemKey.includes('決標') || itemKey.includes('得標')) && 
                                    itemKey.includes('金額')) {
                                    amount = detail[itemKey];
                                    console.log(`找到金額(通配): ${vendorName} - ${itemKey} = ${amount}`);
                                    break;
                                }
                            }
                        }
                        
                        // 只有決標金額不為空或0的才算得標廠商
                        if (amount && amount !== '0' && amount !== '' && amount !== 'NT$0') {
                            const vendor = {
                                index: vendorIndex,
                                name: vendorName,
                                amount: amount,
                                item: detail[`投標廠商:投標廠商${vendorIndex}:品項名稱`] || 
                                      detail[`決標資料:決標廠商${vendorIndex}:品項名稱`] || 
                                      `品項${vendorIndex}`
                            };
                            
                            allVendors.push(vendor);
                            
                            // 檢查是否為目標公司（更寬鬆的匹配）
                            if (targetCompanyName) {
                                // 移除公司類型後綴進行比較
                                const cleanTargetName = targetCompanyName
                                    .replace(/股份有限公司|有限公司|企業有限公司|企業股份有限公司/g, '')
                                    .trim();
                                const cleanVendorName = vendorName
                                    .replace(/股份有限公司|有限公司|企業有限公司|企業股份有限公司/g, '')
                                    .trim();
                                
                                if (cleanVendorName.includes(cleanTargetName) || cleanTargetName.includes(cleanVendorName)) {
                                    targetCompanyAwards.push(vendor);
                                    console.log(`✓ 匹配目標公司: ${vendorName}`);
                                }
                            }
                        }
                    }
                }
            }
            
            console.log('✓ 檢測到的所有得標廠商:', allVendors.length, '家');
            console.log('✓ 目標公司得標品項:', targetCompanyAwards.length, '項');
            
            // 如果有複數廠商決標
            if (allVendors.length > 1) {
                console.log('✓ 確認為複數廠商決標案件');
                
                // 計算目標公司總金額
                let totalTargetAmount = 0;
                if (targetCompanyAwards.length > 0) {
                    totalTargetAmount = targetCompanyAwards.reduce((sum, award) => {
                        const numAmount = parseFloat(award.amount?.replace(/[^\d.-]/g, '') || 0);
                        return sum + numAmount;
                    }, 0);
                    console.log('✓ 目標公司總決標金額:', totalTargetAmount);
                }
                
                return {
                    isMultiple: true,
                    allVendors: allVendors,
                    targetCompanyAwards: targetCompanyAwards,
                    totalTargetAmount: totalTargetAmount
                };
            }
            
            console.log('✗ 非複數廠商決標案件');
            return null;
        }

        function extractCompanyAmount(record, companyName) {
            const detail = record.detail || {};
            const brief = record.brief || {};
            
            console.log(`[金額提取] 開始提取 ${companyName} 的金額`);
            console.log(`[金額提取] Detail keys:`, Object.keys(detail).filter(k => k.includes('金額') || k.includes('決標')));
            console.log(`[金額提取] Brief amount:`, brief.amount);
            
            // 首先檢查是否為複數廠商決標
            const multipleVendors = hasMultipleAwardedVendors(detail, companyName);
            if (multipleVendors && multipleVendors.totalTargetAmount > 0) {
                console.log(`[金額提取] 複數廠商決標 - 該公司金額: ${multipleVendors.totalTargetAmount}`);
                return multipleVendors.totalTargetAmount;
            }
            
            // 嘗試多種決標金額欄位
            const possibleKeys = [
                '決標資料:總決標金額',
                '決標資料:決標金額',
                '投標廠商:投標廠商1:決標金額',
                '得標廠商:決標金額',
                '採購資料:決標金額',
                '決標資料:決標廠商1:決標金額',
                '決標資料:決標廠商1:得標金額'
            ];
            
            for (const key of possibleKeys) {
                if (detail[key]) {
                    const amountMatch = detail[key].toString().match(/[\d,]+/);
                    if (amountMatch) {
                        const numericAmount = parseInt(amountMatch[0].replace(/,/g, ''));
                        if (numericAmount > 0) {
                            console.log(`[金額提取] 找到決標金額 (${key}): ${numericAmount}`);
                            return numericAmount;
                        }
                    }
                }
            }
            
            // 如果沒有決標金額，嘗試從 brief 中取得
            if (brief.amount) {
                const amountMatch = brief.amount.toString().match(/[\d,]+/);
                if (amountMatch) {
                    const numericAmount = parseInt(amountMatch[0].replace(/,/g, ''));
                    if (numericAmount > 0) {
                        console.log(`[金額提取] 使用 brief.amount: ${numericAmount}`);
                        return numericAmount;
                    }
                }
            }
            
            // 最後使用預算金額
            if (detail['採購資料:預算金額']) {
                const amountMatch = detail['採購資料:預算金額'].toString().match(/[\d,]+/);
                if (amountMatch) {
                    const numericAmount = parseInt(amountMatch[0].replace(/,/g, ''));
                    if (numericAmount > 0) {
                        console.log(`[金額提取] 使用預算金額: ${numericAmount}`);
                        return numericAmount;
                    }
                }
            }
            
            console.log(`[金額提取] 未找到有效金額 - 所有欄位:`, Object.keys(detail));
            return 0;
        }

        async function testVAC11201() {
            const resultsDiv = document.getElementById('testResults');
            
            resultsDiv.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>VAC11201 案件測試結果</h5>
                    </div>
                    <div class="card-body">
                        <div class="detection-log">
                            <h6>🔍 檢測過程：</h6>
                            <div id="detectionLog"></div>
                        </div>
                        <div class="api-response">
                            <h6>📊 檢測結果：</h6>
                            <div id="detectionResult"></div>
                        </div>
                    </div>
                </div>
            `;

            // 清空 console 並重新導向到頁面
            console.clear();
            const originalLog = console.log;
            const logContainer = document.getElementById('detectionLog');
            console.log = function(...args) {
                originalLog.apply(console, args);
                logContainer.innerHTML += args.join(' ') + '<br>';
            };

            try {
                // 嘗試從 API 獲取 VAC11201 案件的詳細資料
                console.log('開始搜尋 VAC11201 案件...');
                
                // 使用政府採購 API 搜尋
                const searchUrl = 'https://pcc-api.openfun.app/api/searchbytitle?query=VAC11201&page=1';
                console.log('搜尋 URL:', searchUrl);
                
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();
                
                console.log('搜尋結果:', searchData);
                
                if (searchData && searchData.length > 0) {
                    const record = searchData[0];
                    console.log('找到案件:', record);
                    
                    // 獲取詳細資料
                    const detailUrl = `https://pcc-api.openfun.app/api/tender?unit_id=${record.unit_id}&job_number=${record.job_number}`;
                    console.log('詳細資料 URL:', detailUrl);
                    
                    const detailResponse = await fetch(detailUrl);
                    const detailData = await detailResponse.json();
                    
                    console.log('詳細資料:', detailData);
                    
                    // 測試金額提取
                    const mockRecord = {
                        brief: record.brief || {},
                        detail: detailData || {},
                        date: record.date,
                        job_number: record.job_number,
                        unit_id: record.unit_id
                    };
                    
                    console.log('\n=== 測試金額提取 ===');
                    const amount = extractCompanyAmount(mockRecord, '正茂生物科技');
                    console.log('提取到的金額:', amount);
                    
                    // 測試複數廠商檢測
                    console.log('\n=== 測試複數廠商檢測 ===');
                    const multipleVendors = hasMultipleAwardedVendors(detailData, '正茂生物科技');
                    console.log('複數廠商檢測結果:', multipleVendors);
                    
                    // 顯示結果
                    const resultContainer = document.getElementById('detectionResult');
                    resultContainer.innerHTML = `
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>案件資訊</h6>
                            <p><strong>標題：</strong>${record.brief?.title || '無標題'}</p>
                            <p><strong>案號：</strong>${record.job_number}</p>
                            <p><strong>機關：</strong>${record.unit_name}</p>
                            <p><strong>日期：</strong>${record.date}</p>
                        </div>
                        
                        <div class="alert ${amount > 0 ? 'alert-success' : 'alert-warning'}">
                            <h6><i class="fas fa-dollar-sign me-2"></i>金額提取結果</h6>
                            <p><strong>提取到的金額：</strong>${amount > 0 ? 'NT$ ' + amount.toLocaleString() : '未找到有效金額'}</p>
                        </div>
                        
                        <div class="alert ${multipleVendors ? 'alert-success' : 'alert-info'}">
                            <h6><i class="fas fa-users me-2"></i>複數廠商檢測結果</h6>
                            ${multipleVendors ? `
                                <p><strong>檢測結果：</strong>複數廠商決標案件</p>
                                <p><strong>總得標廠商：</strong>${multipleVendors.allVendors.length} 家</p>
                                <p><strong>目標公司得標品項：</strong>${multipleVendors.targetCompanyAwards.length} 項</p>
                                <p><strong>目標公司總金額：</strong>NT$ ${multipleVendors.totalTargetAmount.toLocaleString()}</p>
                            ` : `
                                <p><strong>檢測結果：</strong>非複數廠商決標案件</p>
                            `}
                        </div>
                        
                        <div class="mt-3">
                            <h6>Detail 欄位列表：</h6>
                            <div class="code-block">${JSON.stringify(detailData, null, 2)}</div>
                        </div>
                    `;
                } else {
                    console.log('未找到 VAC11201 案件');
                    document.getElementById('detectionResult').innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>未找到案件</h6>
                            <p>無法找到 VAC11201 案件的相關資料。</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('測試過程中發生錯誤:', error);
                document.getElementById('detectionResult').innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>測試失敗</h6>
                        <p>錯誤訊息: ${error.message}</p>
                    </div>
                `;
            }

            // 恢復原始 console.log
            console.log = originalLog;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }
    </script>
</body>
</html>
