<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAC11201 æ¡ˆä»¶æ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .api-response {
            background-color: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 1rem;
            margin: 1rem 0;
        }
        .detection-log {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">
            <i class="fas fa-search me-2"></i>VAC11201 æ¡ˆä»¶æ¸¬è©¦
        </h1>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle me-2"></i>æ¡ˆä»¶è³‡è¨Š</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>æ¡ˆè™Ÿï¼š</strong>VAC11201</p>
                        <p><strong>æ—¥æœŸï¼š</strong>2022å¹´12æœˆ09æ—¥</p>
                        <p><strong>æ©Ÿé—œï¼š</strong>è‡ºåŒ—æ¦®æ°‘ç¸½é†«é™¢</p>
                        <p><strong>æ¨™é¡Œï¼š</strong>112å¹´åº¦é†«ç™‚å„€å™¨è¨­å‚™é›†ä¸­æ¡è³¼</p>
                        <p><strong>æœå°‹å…¬å¸ï¼š</strong>æ­£èŒ‚ç”Ÿç‰©ç§‘æŠ€</p>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs me-2"></i>æ¸¬è©¦æ§åˆ¶</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testVAC11201()">
                            <i class="fas fa-play me-2"></i>æ¸¬è©¦ VAC11201 æ¡ˆä»¶
                        </button>
                        <button class="btn btn-secondary ms-2" onclick="clearResults()">
                            <i class="fas fa-trash me-2"></i>æ¸…é™¤çµæœ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="testResults" class="mt-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // è¤‡è£½ç›¸é—œå‡½æ•¸
        function hasMultipleAwardedVendors(detail, targetCompanyName) {
            const allVendors = [];
            const targetCompanyAwards = [];
            
            console.log('=== æª¢æ¸¬è¤‡æ•¸å» å•†æ±ºæ¨™ ===');
            console.log('ç›®æ¨™å…¬å¸:', targetCompanyName);
            console.log('Detail keys:', Object.keys(detail).filter(k => k.includes('æŠ•æ¨™å» å•†')));
            
            // æª¢æŸ¥æ‰€æœ‰æŠ•æ¨™å» å•†æ¬„ä½
            for (const key in detail) {
                if (key.includes('æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†') && key.includes(':å» å•†åç¨±')) {
                    const vendorName = detail[key];
                    const vendorNumber = key.match(/æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†(\d+):å» å•†åç¨±/);
                    if (vendorNumber && vendorName) {
                        const vendorIndex = parseInt(vendorNumber[1]);
                        
                        // å˜—è©¦å¤šç¨®æ–¹å¼ç²å–æ±ºæ¨™é‡‘é¡
                        let amount = null;
                        const possibleAmountKeys = [
                            `æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†${vendorIndex}:æ±ºæ¨™é‡‘é¡`,
                            `æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†${vendorIndex}:å¾—æ¨™é‡‘é¡`,
                            `æ±ºæ¨™è³‡æ–™:æ±ºæ¨™å» å•†${vendorIndex}:æ±ºæ¨™é‡‘é¡`,
                            `æ±ºæ¨™è³‡æ–™:æ±ºæ¨™å» å•†${vendorIndex}:å¾—æ¨™é‡‘é¡`
                        ];
                        
                        for (const amountKey of possibleAmountKeys) {
                            if (detail[amountKey]) {
                                amount = detail[amountKey];
                                console.log(`æ‰¾åˆ°é‡‘é¡: ${vendorName} - ${amountKey} = ${amount}`);
                                break;
                            }
                        }
                        
                        // å¦‚æœæ²’æ‰¾åˆ°ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰ "æ±ºæ¨™å“é …" ç›¸é—œæ¬„ä½
                        if (!amount) {
                            for (const itemKey in detail) {
                                if (itemKey.includes(`æŠ•æ¨™å» å•†${vendorIndex}`) && 
                                    (itemKey.includes('æ±ºæ¨™') || itemKey.includes('å¾—æ¨™')) && 
                                    itemKey.includes('é‡‘é¡')) {
                                    amount = detail[itemKey];
                                    console.log(`æ‰¾åˆ°é‡‘é¡(é€šé…): ${vendorName} - ${itemKey} = ${amount}`);
                                    break;
                                }
                            }
                        }
                        
                        // åªæœ‰æ±ºæ¨™é‡‘é¡ä¸ç‚ºç©ºæˆ–0çš„æ‰ç®—å¾—æ¨™å» å•†
                        if (amount && amount !== '0' && amount !== '' && amount !== 'NT$0') {
                            const vendor = {
                                index: vendorIndex,
                                name: vendorName,
                                amount: amount,
                                item: detail[`æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†${vendorIndex}:å“é …åç¨±`] || 
                                      detail[`æ±ºæ¨™è³‡æ–™:æ±ºæ¨™å» å•†${vendorIndex}:å“é …åç¨±`] || 
                                      `å“é …${vendorIndex}`
                            };
                            
                            allVendors.push(vendor);
                            
                            // æª¢æŸ¥æ˜¯å¦ç‚ºç›®æ¨™å…¬å¸ï¼ˆæ›´å¯¬é¬†çš„åŒ¹é…ï¼‰
                            if (targetCompanyName) {
                                // ç§»é™¤å…¬å¸é¡å‹å¾Œç¶´é€²è¡Œæ¯”è¼ƒ
                                const cleanTargetName = targetCompanyName
                                    .replace(/è‚¡ä»½æœ‰é™å…¬å¸|æœ‰é™å…¬å¸|ä¼æ¥­æœ‰é™å…¬å¸|ä¼æ¥­è‚¡ä»½æœ‰é™å…¬å¸/g, '')
                                    .trim();
                                const cleanVendorName = vendorName
                                    .replace(/è‚¡ä»½æœ‰é™å…¬å¸|æœ‰é™å…¬å¸|ä¼æ¥­æœ‰é™å…¬å¸|ä¼æ¥­è‚¡ä»½æœ‰é™å…¬å¸/g, '')
                                    .trim();
                                
                                if (cleanVendorName.includes(cleanTargetName) || cleanTargetName.includes(cleanVendorName)) {
                                    targetCompanyAwards.push(vendor);
                                    console.log(`âœ“ åŒ¹é…ç›®æ¨™å…¬å¸: ${vendorName}`);
                                }
                            }
                        }
                    }
                }
            }
            
            console.log('âœ“ æª¢æ¸¬åˆ°çš„æ‰€æœ‰å¾—æ¨™å» å•†:', allVendors.length, 'å®¶');
            console.log('âœ“ ç›®æ¨™å…¬å¸å¾—æ¨™å“é …:', targetCompanyAwards.length, 'é …');
            
            // å¦‚æœæœ‰è¤‡æ•¸å» å•†æ±ºæ¨™
            if (allVendors.length > 1) {
                console.log('âœ“ ç¢ºèªç‚ºè¤‡æ•¸å» å•†æ±ºæ¨™æ¡ˆä»¶');
                
                // è¨ˆç®—ç›®æ¨™å…¬å¸ç¸½é‡‘é¡
                let totalTargetAmount = 0;
                if (targetCompanyAwards.length > 0) {
                    totalTargetAmount = targetCompanyAwards.reduce((sum, award) => {
                        const numAmount = parseFloat(award.amount?.replace(/[^\d.-]/g, '') || 0);
                        return sum + numAmount;
                    }, 0);
                    console.log('âœ“ ç›®æ¨™å…¬å¸ç¸½æ±ºæ¨™é‡‘é¡:', totalTargetAmount);
                }
                
                return {
                    isMultiple: true,
                    allVendors: allVendors,
                    targetCompanyAwards: targetCompanyAwards,
                    totalTargetAmount: totalTargetAmount
                };
            }
            
            console.log('âœ— éè¤‡æ•¸å» å•†æ±ºæ¨™æ¡ˆä»¶');
            return null;
        }

        function extractCompanyAmount(record, companyName) {
            const detail = record.detail || {};
            const brief = record.brief || {};
            
            console.log(`[é‡‘é¡æå–] é–‹å§‹æå– ${companyName} çš„é‡‘é¡`);
            console.log(`[é‡‘é¡æå–] Detail keys:`, Object.keys(detail).filter(k => k.includes('é‡‘é¡') || k.includes('æ±ºæ¨™')));
            console.log(`[é‡‘é¡æå–] Brief amount:`, brief.amount);
            
            // é¦–å…ˆæª¢æŸ¥æ˜¯å¦ç‚ºè¤‡æ•¸å» å•†æ±ºæ¨™
            const multipleVendors = hasMultipleAwardedVendors(detail, companyName);
            if (multipleVendors && multipleVendors.totalTargetAmount > 0) {
                console.log(`[é‡‘é¡æå–] è¤‡æ•¸å» å•†æ±ºæ¨™ - è©²å…¬å¸é‡‘é¡: ${multipleVendors.totalTargetAmount}`);
                return multipleVendors.totalTargetAmount;
            }
            
            // å˜—è©¦å¤šç¨®æ±ºæ¨™é‡‘é¡æ¬„ä½
            const possibleKeys = [
                'æ±ºæ¨™è³‡æ–™:ç¸½æ±ºæ¨™é‡‘é¡',
                'æ±ºæ¨™è³‡æ–™:æ±ºæ¨™é‡‘é¡',
                'æŠ•æ¨™å» å•†:æŠ•æ¨™å» å•†1:æ±ºæ¨™é‡‘é¡',
                'å¾—æ¨™å» å•†:æ±ºæ¨™é‡‘é¡',
                'æ¡è³¼è³‡æ–™:æ±ºæ¨™é‡‘é¡',
                'æ±ºæ¨™è³‡æ–™:æ±ºæ¨™å» å•†1:æ±ºæ¨™é‡‘é¡',
                'æ±ºæ¨™è³‡æ–™:æ±ºæ¨™å» å•†1:å¾—æ¨™é‡‘é¡'
            ];
            
            for (const key of possibleKeys) {
                if (detail[key]) {
                    const amountMatch = detail[key].toString().match(/[\d,]+/);
                    if (amountMatch) {
                        const numericAmount = parseInt(amountMatch[0].replace(/,/g, ''));
                        if (numericAmount > 0) {
                            console.log(`[é‡‘é¡æå–] æ‰¾åˆ°æ±ºæ¨™é‡‘é¡ (${key}): ${numericAmount}`);
                            return numericAmount;
                        }
                    }
                }
            }
            
            // å¦‚æœæ²’æœ‰æ±ºæ¨™é‡‘é¡ï¼Œå˜—è©¦å¾ brief ä¸­å–å¾—
            if (brief.amount) {
                const amountMatch = brief.amount.toString().match(/[\d,]+/);
                if (amountMatch) {
                    const numericAmount = parseInt(amountMatch[0].replace(/,/g, ''));
                    if (numericAmount > 0) {
                        console.log(`[é‡‘é¡æå–] ä½¿ç”¨ brief.amount: ${numericAmount}`);
                        return numericAmount;
                    }
                }
            }
            
            // æœ€å¾Œä½¿ç”¨é ç®—é‡‘é¡
            if (detail['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡']) {
                const amountMatch = detail['æ¡è³¼è³‡æ–™:é ç®—é‡‘é¡'].toString().match(/[\d,]+/);
                if (amountMatch) {
                    const numericAmount = parseInt(amountMatch[0].replace(/,/g, ''));
                    if (numericAmount > 0) {
                        console.log(`[é‡‘é¡æå–] ä½¿ç”¨é ç®—é‡‘é¡: ${numericAmount}`);
                        return numericAmount;
                    }
                }
            }
            
            console.log(`[é‡‘é¡æå–] æœªæ‰¾åˆ°æœ‰æ•ˆé‡‘é¡ - æ‰€æœ‰æ¬„ä½:`, Object.keys(detail));
            return 0;
        }

        async function testVAC11201() {
            const resultsDiv = document.getElementById('testResults');
            
            resultsDiv.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>VAC11201 æ¡ˆä»¶æ¸¬è©¦çµæœ</h5>
                    </div>
                    <div class="card-body">
                        <div class="detection-log">
                            <h6>ğŸ” æª¢æ¸¬éç¨‹ï¼š</h6>
                            <div id="detectionLog"></div>
                        </div>
                        <div class="api-response">
                            <h6>ğŸ“Š æª¢æ¸¬çµæœï¼š</h6>
                            <div id="detectionResult"></div>
                        </div>
                    </div>
                </div>
            `;

            // æ¸…ç©º console ä¸¦é‡æ–°å°å‘åˆ°é é¢
            console.clear();
            const originalLog = console.log;
            const logContainer = document.getElementById('detectionLog');
            console.log = function(...args) {
                originalLog.apply(console, args);
                logContainer.innerHTML += args.join(' ') + '<br>';
            };

            try {
                // å˜—è©¦å¾ API ç²å– VAC11201 æ¡ˆä»¶çš„è©³ç´°è³‡æ–™
                console.log('é–‹å§‹æœå°‹ VAC11201 æ¡ˆä»¶...');
                
                // ä½¿ç”¨æ”¿åºœæ¡è³¼ API æœå°‹
                const searchUrl = 'https://pcc-api.openfun.app/api/searchbytitle?query=VAC11201&page=1';
                console.log('æœå°‹ URL:', searchUrl);
                
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();
                
                console.log('æœå°‹çµæœ:', searchData);
                
                if (searchData && searchData.length > 0) {
                    const record = searchData[0];
                    console.log('æ‰¾åˆ°æ¡ˆä»¶:', record);
                    
                    // ç²å–è©³ç´°è³‡æ–™
                    const detailUrl = `https://pcc-api.openfun.app/api/tender?unit_id=${record.unit_id}&job_number=${record.job_number}`;
                    console.log('è©³ç´°è³‡æ–™ URL:', detailUrl);
                    
                    const detailResponse = await fetch(detailUrl);
                    const detailData = await detailResponse.json();
                    
                    console.log('è©³ç´°è³‡æ–™:', detailData);
                    
                    // æ¸¬è©¦é‡‘é¡æå–
                    const mockRecord = {
                        brief: record.brief || {},
                        detail: detailData || {},
                        date: record.date,
                        job_number: record.job_number,
                        unit_id: record.unit_id
                    };
                    
                    console.log('\n=== æ¸¬è©¦é‡‘é¡æå– ===');
                    const amount = extractCompanyAmount(mockRecord, 'æ­£èŒ‚ç”Ÿç‰©ç§‘æŠ€');
                    console.log('æå–åˆ°çš„é‡‘é¡:', amount);
                    
                    // æ¸¬è©¦è¤‡æ•¸å» å•†æª¢æ¸¬
                    console.log('\n=== æ¸¬è©¦è¤‡æ•¸å» å•†æª¢æ¸¬ ===');
                    const multipleVendors = hasMultipleAwardedVendors(detailData, 'æ­£èŒ‚ç”Ÿç‰©ç§‘æŠ€');
                    console.log('è¤‡æ•¸å» å•†æª¢æ¸¬çµæœ:', multipleVendors);
                    
                    // é¡¯ç¤ºçµæœ
                    const resultContainer = document.getElementById('detectionResult');
                    resultContainer.innerHTML = `
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>æ¡ˆä»¶è³‡è¨Š</h6>
                            <p><strong>æ¨™é¡Œï¼š</strong>${record.brief?.title || 'ç„¡æ¨™é¡Œ'}</p>
                            <p><strong>æ¡ˆè™Ÿï¼š</strong>${record.job_number}</p>
                            <p><strong>æ©Ÿé—œï¼š</strong>${record.unit_name}</p>
                            <p><strong>æ—¥æœŸï¼š</strong>${record.date}</p>
                        </div>
                        
                        <div class="alert ${amount > 0 ? 'alert-success' : 'alert-warning'}">
                            <h6><i class="fas fa-dollar-sign me-2"></i>é‡‘é¡æå–çµæœ</h6>
                            <p><strong>æå–åˆ°çš„é‡‘é¡ï¼š</strong>${amount > 0 ? 'NT$ ' + amount.toLocaleString() : 'æœªæ‰¾åˆ°æœ‰æ•ˆé‡‘é¡'}</p>
                        </div>
                        
                        <div class="alert ${multipleVendors ? 'alert-success' : 'alert-info'}">
                            <h6><i class="fas fa-users me-2"></i>è¤‡æ•¸å» å•†æª¢æ¸¬çµæœ</h6>
                            ${multipleVendors ? `
                                <p><strong>æª¢æ¸¬çµæœï¼š</strong>è¤‡æ•¸å» å•†æ±ºæ¨™æ¡ˆä»¶</p>
                                <p><strong>ç¸½å¾—æ¨™å» å•†ï¼š</strong>${multipleVendors.allVendors.length} å®¶</p>
                                <p><strong>ç›®æ¨™å…¬å¸å¾—æ¨™å“é …ï¼š</strong>${multipleVendors.targetCompanyAwards.length} é …</p>
                                <p><strong>ç›®æ¨™å…¬å¸ç¸½é‡‘é¡ï¼š</strong>NT$ ${multipleVendors.totalTargetAmount.toLocaleString()}</p>
                            ` : `
                                <p><strong>æª¢æ¸¬çµæœï¼š</strong>éè¤‡æ•¸å» å•†æ±ºæ¨™æ¡ˆä»¶</p>
                            `}
                        </div>
                        
                        <div class="mt-3">
                            <h6>Detail æ¬„ä½åˆ—è¡¨ï¼š</h6>
                            <div class="code-block">${JSON.stringify(detailData, null, 2)}</div>
                        </div>
                    `;
                } else {
                    console.log('æœªæ‰¾åˆ° VAC11201 æ¡ˆä»¶');
                    document.getElementById('detectionResult').innerHTML = `
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>æœªæ‰¾åˆ°æ¡ˆä»¶</h6>
                            <p>ç„¡æ³•æ‰¾åˆ° VAC11201 æ¡ˆä»¶çš„ç›¸é—œè³‡æ–™ã€‚</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
                document.getElementById('detectionResult').innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>æ¸¬è©¦å¤±æ•—</h6>
                        <p>éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
                    </div>
                `;
            }

            // æ¢å¾©åŸå§‹ console.log
            console.log = originalLog;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
        }
    </script>
</body>
</html>
